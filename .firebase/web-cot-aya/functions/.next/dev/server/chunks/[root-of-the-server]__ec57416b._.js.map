{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 64, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/LENOVO/Documents/WEB%20DE%20cotizaciones/src/lib/firebase-admin.js"],"sourcesContent":["import admin from 'firebase-admin';\r\nimport dotenv from 'dotenv';\r\nimport { fileURLToPath } from 'url';\r\nimport { dirname, join } from 'path';\r\nimport fs from 'fs';\r\n\r\nconst __filename = fileURLToPath(import.meta.url);\r\nconst __dirname = dirname(__filename);\r\nconst rootDir = join(__dirname, '../../');\r\nconst envPath = join(rootDir, '.env');\r\n\r\nconsole.log('--- FIREBASE DEBUG ---');\r\nconsole.log('Project Root:', rootDir);\r\nconsole.log('Dotenv Path:', envPath);\r\nif (fs.existsSync(envPath)) {\r\n    console.log('.env file exists at this path.');\r\n    const result = dotenv.config({ path: envPath });\r\n    if (result.error) console.error('Dotenv Error:', result.error);\r\n    else console.log('Dotenv loaded successfully.');\r\n} else {\r\n    console.error('.env file DOES NOT exist at expected path.');\r\n}\r\nconsole.log('Project ID in process.env:', process.env.FIREBASE_PROJECT_ID || 'MISSING');\r\nconsole.log('----------------------');\r\n\r\nlet firestore = null;\r\nlet storage = null;\r\n\r\n// Initialize Firebase Admin\r\nif (!admin.apps.length) {\r\n    try {\r\n        if (process.env.FIREBASE_PROJECT_ID) {\r\n            const projectId = process.env.FIREBASE_PROJECT_ID.trim().replace(/^[\"']|[\"']$/g, '');\r\n            const clientEmail = process.env.FIREBASE_CLIENT_EMAIL?.trim().replace(/^[\"']|[\"']$/g, '');\r\n\r\n            let privateKey = process.env.FIREBASE_PRIVATE_KEY || '';\r\n            privateKey = privateKey.trim().replace(/^[\"']|[\"']$/g, '').replace(/\\\\n/g, '\\n');\r\n\r\n            admin.initializeApp({\r\n                credential: admin.credential.cert({\r\n                    projectId,\r\n                    clientEmail,\r\n                    privateKey,\r\n                }),\r\n                storageBucket: process.env.NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET?.trim().replace(/^[\"']|[\"']$/g, '')\r\n            });\r\n            firestore = admin.firestore();\r\n            storage = admin.storage();\r\n            console.log('Firebase initialized successfully!');\r\n        } else {\r\n            console.warn('Firebase Admin SDK not initialized: Missing credentials.');\r\n        }\r\n    } catch (error) {\r\n        console.error('Firebase admin initialization error', error);\r\n    }\r\n}\r\n\r\nif (admin.apps.length > 0) {\r\n    firestore = admin.firestore();\r\n    storage = admin.storage();\r\n}\r\n\r\nexport { firestore, storage, admin };\r\n"],"names":[],"mappings":";;;;;;AAAA;AACA;AACA;AACA;AACA;;;;;;;;;;;AAEA,MAAM,aAAa,IAAA,gHAAa,EAAC,8BAAY,GAAG;AAChD,MAAM,YAAY,IAAA,4GAAO,EAAC;AAC1B,MAAM,UAAU,IAAA,yGAAI,EAAC,WAAW;AAChC,MAAM,UAAU,IAAA,yGAAI,EAAC,SAAS;AAE9B,QAAQ,GAAG,CAAC;AACZ,QAAQ,GAAG,CAAC,iBAAiB;AAC7B,QAAQ,GAAG,CAAC,gBAAgB;AAC5B,IAAI,wGAAE,CAAC,UAAU,CAAC,UAAU;IACxB,QAAQ,GAAG,CAAC;IACZ,MAAM,SAAS,kJAAM,CAAC,MAAM,CAAC;QAAE,MAAM;IAAQ;IAC7C,IAAI,OAAO,KAAK,EAAE,QAAQ,KAAK,CAAC,iBAAiB,OAAO,KAAK;SACxD,QAAQ,GAAG,CAAC;AACrB,OAAO;IACH,QAAQ,KAAK,CAAC;AAClB;AACA,QAAQ,GAAG,CAAC,8BAA8B,QAAQ,GAAG,CAAC,mBAAmB,IAAI;AAC7E,QAAQ,GAAG,CAAC;AAEZ,IAAI,YAAY;AAChB,IAAI,UAAU;AAEd,4BAA4B;AAC5B,IAAI,CAAC,8LAAK,CAAC,IAAI,CAAC,MAAM,EAAE;IACpB,IAAI;QACA,IAAI,QAAQ,GAAG,CAAC,mBAAmB,EAAE;YACjC,MAAM,YAAY,QAAQ,GAAG,CAAC,mBAAmB,CAAC,IAAI,GAAG,OAAO,CAAC,gBAAgB;YACjF,MAAM,cAAc,QAAQ,GAAG,CAAC,qBAAqB,EAAE,OAAO,QAAQ,gBAAgB;YAEtF,IAAI,aAAa,QAAQ,GAAG,CAAC,oBAAoB,IAAI;YACrD,aAAa,WAAW,IAAI,GAAG,OAAO,CAAC,gBAAgB,IAAI,OAAO,CAAC,QAAQ;YAE3E,8LAAK,CAAC,aAAa,CAAC;gBAChB,YAAY,8LAAK,CAAC,UAAU,CAAC,IAAI,CAAC;oBAC9B;oBACA;oBACA;gBACJ;gBACA,oFAAgE,OAAO,QAAQ,gBAAgB;YACnG;YACA,YAAY,8LAAK,CAAC,SAAS;YAC3B,UAAU,8LAAK,CAAC,OAAO;YACvB,QAAQ,GAAG,CAAC;QAChB,OAAO;YACH,QAAQ,IAAI,CAAC;QACjB;IACJ,EAAE,OAAO,OAAO;QACZ,QAAQ,KAAK,CAAC,uCAAuC;IACzD;AACJ;AAEA,IAAI,8LAAK,CAAC,IAAI,CAAC,MAAM,GAAG,GAAG;IACvB,YAAY,8LAAK,CAAC,SAAS;IAC3B,UAAU,8LAAK,CAAC,OAAO;AAC3B"}},
    {"offset": {"line": 141, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/LENOVO/Documents/WEB%20DE%20cotizaciones/src/app/api/quotations/%5Bid%5D/route.js"],"sourcesContent":["import { firestore } from '@/lib/firebase-admin';\r\n\r\nexport async function GET(req, { params }) {\r\n    try {\r\n        const { id } = await params;\r\n\r\n        // Fetch everything in parallel without server-side sorting\r\n        const [quoteDoc, companySnap, clientSnap, settingsSnap] = await Promise.all([\r\n            firestore.collection('quotations').doc(id).get(),\r\n            firestore.collection('company_profiles').get(),\r\n            firestore.collection('client_profiles').get(),\r\n            firestore.collection('settings').doc('general_conditions').get()\r\n        ]);\r\n\r\n        if (!quoteDoc.exists) return Response.json({ error: 'Not found' }, { status: 404 });\r\n\r\n        const quotation = { id: quoteDoc.id, ...quoteDoc.data() };\r\n\r\n        // Sort Company Profiles in JS\r\n        const companyProfiles = companySnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));\r\n        companyProfiles.sort((a, b) => {\r\n            if (a.isDefault !== b.isDefault) return b.isDefault ? 1 : -1;\r\n            return (a.name || '').localeCompare(b.name || '');\r\n        });\r\n\r\n        // Sort Client Profiles in JS\r\n        const clientProfiles = clientSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));\r\n        clientProfiles.sort((a, b) => {\r\n            if (a.isDefault !== b.isDefault) return b.isDefault ? 1 : -1;\r\n            return (a.name || '').localeCompare(b.name || '');\r\n        });\r\n\r\n        // Determine general conditions from the quotation's selected company\r\n        let conditionsText = '';\r\n        const selectedCompanyId = quotation.companyProfileId || companyProfiles.find(cp => cp.isDefault)?.id;\r\n        const selectedCompany = companyProfiles.find(cp => cp.id === selectedCompanyId?.toString());\r\n\r\n        if (selectedCompany && selectedCompany.conditions) {\r\n            conditionsText = selectedCompany.conditions;\r\n        } else if (settingsSnap.exists) {\r\n            conditionsText = settingsSnap.data().text || '';\r\n        }\r\n\r\n        const generalConditions = { text: conditionsText };\r\n\r\n        return Response.json({\r\n            ...quotation,\r\n            companyProfiles,\r\n            clientProfiles,\r\n            generalConditions\r\n        });\r\n    } catch (error) {\r\n        console.error('API Error (quotation-detail):', error);\r\n        return Response.json({\r\n            error: 'Failed to fetch quotation',\r\n            details: error.message\r\n        }, { status: 500 });\r\n    }\r\n}\r\n\r\nexport async function PUT(req, { params }) {\r\n    try {\r\n        const { id } = await params;\r\n        const body = await req.json();\r\n\r\n        // In Firestore, we store everything in the same document\r\n        const updateData = {\r\n            ...body,\r\n            updatedAt: new Date().toISOString()\r\n        };\r\n\r\n        // Ensure total is calculated if not provided\r\n        if (body.items) {\r\n            updateData.total = body.items.reduce((acc, item) => acc + (parseFloat(item.quantity || 0) * parseFloat(item.price || 0)), 0);\r\n        }\r\n\r\n        await firestore.collection('quotations').doc(id).update(updateData);\r\n\r\n        return Response.json({ success: true });\r\n    } catch (error) {\r\n        console.error(error);\r\n        return Response.json({ error: 'Failed to update quotation' }, { status: 500 });\r\n    }\r\n}\r\n\r\nexport async function DELETE(req, { params }) {\r\n    try {\r\n        const { id } = await params;\r\n        await firestore.collection('quotations').doc(id).delete();\r\n        return Response.json({ success: true });\r\n    } catch (error) {\r\n        console.error(error);\r\n        return Response.json({ error: 'Failed to delete quotation' }, { status: 500 });\r\n    }\r\n}\r\n"],"names":[],"mappings":"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"}}]
}