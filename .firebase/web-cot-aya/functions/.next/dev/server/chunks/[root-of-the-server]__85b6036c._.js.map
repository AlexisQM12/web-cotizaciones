{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 64, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/LENOVO/Documents/WEB%20DE%20cotizaciones/src/lib/firebase-admin.js"],"sourcesContent":["import admin from 'firebase-admin';\r\nimport dotenv from 'dotenv';\r\nimport { fileURLToPath } from 'url';\r\nimport { dirname, join } from 'path';\r\nimport fs from 'fs';\r\n\r\nconst __filename = fileURLToPath(import.meta.url);\r\nconst __dirname = dirname(__filename);\r\nconst rootDir = join(__dirname, '../../');\r\nconst envPath = join(rootDir, '.env');\r\n\r\nconsole.log('--- FIREBASE DEBUG ---');\r\nconsole.log('Project Root:', rootDir);\r\nconsole.log('Dotenv Path:', envPath);\r\nif (fs.existsSync(envPath)) {\r\n    console.log('.env file exists at this path.');\r\n    const result = dotenv.config({ path: envPath });\r\n    if (result.error) console.error('Dotenv Error:', result.error);\r\n    else console.log('Dotenv loaded successfully.');\r\n} else {\r\n    console.error('.env file DOES NOT exist at expected path.');\r\n}\r\nconsole.log('Project ID in process.env:', process.env.FIREBASE_PROJECT_ID || 'MISSING');\r\nconsole.log('----------------------');\r\n\r\nlet firestore = null;\r\nlet storage = null;\r\n\r\n// Initialize Firebase Admin\r\nif (!admin.apps.length) {\r\n    try {\r\n        if (process.env.FIREBASE_PROJECT_ID) {\r\n            const projectId = process.env.FIREBASE_PROJECT_ID.trim().replace(/^[\"']|[\"']$/g, '');\r\n            const clientEmail = process.env.FIREBASE_CLIENT_EMAIL?.trim().replace(/^[\"']|[\"']$/g, '');\r\n\r\n            let privateKey = process.env.FIREBASE_PRIVATE_KEY || '';\r\n            privateKey = privateKey.trim().replace(/^[\"']|[\"']$/g, '').replace(/\\\\n/g, '\\n');\r\n\r\n            admin.initializeApp({\r\n                credential: admin.credential.cert({\r\n                    projectId,\r\n                    clientEmail,\r\n                    privateKey,\r\n                }),\r\n                storageBucket: process.env.NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET?.trim().replace(/^[\"']|[\"']$/g, '')\r\n            });\r\n            firestore = admin.firestore();\r\n            storage = admin.storage();\r\n            console.log('Firebase initialized successfully!');\r\n        } else {\r\n            console.warn('Firebase Admin SDK not initialized: Missing credentials.');\r\n        }\r\n    } catch (error) {\r\n        console.error('Firebase admin initialization error', error);\r\n    }\r\n}\r\n\r\nif (admin.apps.length > 0) {\r\n    firestore = admin.firestore();\r\n    storage = admin.storage();\r\n}\r\n\r\nexport { firestore, storage, admin };\r\n"],"names":[],"mappings":";;;;;;AAAA;AACA;AACA;AACA;AACA;;;;;;;;;;;AAEA,MAAM,aAAa,IAAA,gHAAa,EAAC,8BAAY,GAAG;AAChD,MAAM,YAAY,IAAA,4GAAO,EAAC;AAC1B,MAAM,UAAU,IAAA,yGAAI,EAAC,WAAW;AAChC,MAAM,UAAU,IAAA,yGAAI,EAAC,SAAS;AAE9B,QAAQ,GAAG,CAAC;AACZ,QAAQ,GAAG,CAAC,iBAAiB;AAC7B,QAAQ,GAAG,CAAC,gBAAgB;AAC5B,IAAI,wGAAE,CAAC,UAAU,CAAC,UAAU;IACxB,QAAQ,GAAG,CAAC;IACZ,MAAM,SAAS,kJAAM,CAAC,MAAM,CAAC;QAAE,MAAM;IAAQ;IAC7C,IAAI,OAAO,KAAK,EAAE,QAAQ,KAAK,CAAC,iBAAiB,OAAO,KAAK;SACxD,QAAQ,GAAG,CAAC;AACrB,OAAO;IACH,QAAQ,KAAK,CAAC;AAClB;AACA,QAAQ,GAAG,CAAC,8BAA8B,QAAQ,GAAG,CAAC,mBAAmB,IAAI;AAC7E,QAAQ,GAAG,CAAC;AAEZ,IAAI,YAAY;AAChB,IAAI,UAAU;AAEd,4BAA4B;AAC5B,IAAI,CAAC,8LAAK,CAAC,IAAI,CAAC,MAAM,EAAE;IACpB,IAAI;QACA,IAAI,QAAQ,GAAG,CAAC,mBAAmB,EAAE;YACjC,MAAM,YAAY,QAAQ,GAAG,CAAC,mBAAmB,CAAC,IAAI,GAAG,OAAO,CAAC,gBAAgB;YACjF,MAAM,cAAc,QAAQ,GAAG,CAAC,qBAAqB,EAAE,OAAO,QAAQ,gBAAgB;YAEtF,IAAI,aAAa,QAAQ,GAAG,CAAC,oBAAoB,IAAI;YACrD,aAAa,WAAW,IAAI,GAAG,OAAO,CAAC,gBAAgB,IAAI,OAAO,CAAC,QAAQ;YAE3E,8LAAK,CAAC,aAAa,CAAC;gBAChB,YAAY,8LAAK,CAAC,UAAU,CAAC,IAAI,CAAC;oBAC9B;oBACA;oBACA;gBACJ;gBACA,oFAAgE,OAAO,QAAQ,gBAAgB;YACnG;YACA,YAAY,8LAAK,CAAC,SAAS;YAC3B,UAAU,8LAAK,CAAC,OAAO;YACvB,QAAQ,GAAG,CAAC;QAChB,OAAO;YACH,QAAQ,IAAI,CAAC;QACjB;IACJ,EAAE,OAAO,OAAO;QACZ,QAAQ,KAAK,CAAC,uCAAuC;IACzD;AACJ;AAEA,IAAI,8LAAK,CAAC,IAAI,CAAC,MAAM,GAAG,GAAG;IACvB,YAAY,8LAAK,CAAC,SAAS;IAC3B,UAAU,8LAAK,CAAC,OAAO;AAC3B"}},
    {"offset": {"line": 141, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/LENOVO/Documents/WEB%20DE%20cotizaciones/src/app/api/company-profiles/route.js"],"sourcesContent":["import { firestore, storage } from '@/lib/firebase-admin';\r\n\r\nexport async function GET(req) {\r\n    try {\r\n        const snapshot = await firestore.collection('company_profiles').get();\r\n\r\n        let profiles = snapshot.docs.map(doc => ({\r\n            id: doc.id,\r\n            ...doc.data()\r\n        }));\r\n\r\n        // Sort: isDefault first, then name\r\n        profiles.sort((a, b) => {\r\n            if (a.isDefault !== b.isDefault) return b.isDefault ? 1 : -1;\r\n            return a.name.localeCompare(b.name);\r\n        });\r\n\r\n        return Response.json(profiles);\r\n    } catch (error) {\r\n        console.error('API Error (company-profiles):', error);\r\n        return Response.json({\r\n            error: 'Failed to fetch company profiles',\r\n            details: error.message\r\n        }, { status: 500 });\r\n    }\r\n}\r\n\r\nexport async function POST(req) {\r\n    try {\r\n        const formData = await req.formData();\r\n        const name = formData.get('name');\r\n        const address = formData.get('address');\r\n        const email = formData.get('email');\r\n        const phone = formData.get('phone');\r\n        const ruc = formData.get('ruc');\r\n        const website = formData.get('website');\r\n        const isDefault = formData.get('isDefault') === 'true';\r\n        const logoFile = formData.get('logo');\r\n        const accountsJson = formData.get('accounts') || '[]';\r\n        const conditions = formData.get('conditions') || '';\r\n\r\n        let accounts = [];\r\n        try {\r\n            accounts = JSON.parse(accountsJson);\r\n        } catch (e) {\r\n            console.error('Failed to parse accounts JSON', e);\r\n        }\r\n\r\n        let logoUrl = null;\r\n        if (logoFile && logoFile.size > 0) {\r\n            const buffer = Buffer.from(await logoFile.arrayBuffer());\r\n            const filename = `logos/${Date.now()}-${logoFile.name}`;\r\n            const file = storage.bucket().file(filename);\r\n\r\n            await file.save(buffer, {\r\n                metadata: { contentType: logoFile.type },\r\n                public: true\r\n            });\r\n\r\n            // Construct the Firebase standard download URL\r\n            const bucket = storage.bucket();\r\n            const encodedPath = encodeURIComponent(filename);\r\n            logoUrl = `https://firebasestorage.googleapis.com/v0/b/${bucket.name}/o/${encodedPath}?alt=media`;\r\n        }\r\n\r\n        const batch = firestore.batch();\r\n\r\n        // If this is set as default, unset others\r\n        if (isDefault) {\r\n            const defaultQuery = await firestore.collection('company_profiles').where('isDefault', '==', true).get();\r\n            defaultQuery.forEach(doc => {\r\n                batch.update(doc.ref, { isDefault: false });\r\n            });\r\n        }\r\n\r\n        const newProfileRef = firestore.collection('company_profiles').doc();\r\n        batch.set(newProfileRef, {\r\n            name,\r\n            address,\r\n            email,\r\n            phone,\r\n            ruc,\r\n            website,\r\n            logoUrl,\r\n            conditions,\r\n            isDefault,\r\n            accounts,\r\n            createdAt: new Date().toISOString()\r\n        });\r\n\r\n        await batch.commit();\r\n\r\n        return Response.json({ success: true, id: newProfileRef.id });\r\n    } catch (error) {\r\n        console.error(error);\r\n        return Response.json({ error: 'Failed to create company profile' }, { status: 500 });\r\n    }\r\n}\r\n"],"names":[],"mappings":"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"}}]
}