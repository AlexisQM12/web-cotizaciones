(globalThis.TURBOPACK||(globalThis.TURBOPACK=[])).push(["object"==typeof document?document.currentScript:void 0,67585,(e,t,n)=>{"use strict";Object.defineProperty(n,"__esModule",{value:!0}),Object.defineProperty(n,"BailoutToCSR",{enumerable:!0,get:function(){return i}});let r=e.r(32061);function i({reason:e,children:t}){if("u"<typeof window)throw Object.defineProperty(new r.BailoutToCSRError(e),"__NEXT_ERROR_CODE",{value:"E394",enumerable:!1,configurable:!0});return t}},9885,(e,t,n)=>{"use strict";function r(e){return e.split("/").map(e=>encodeURIComponent(e)).join("/")}Object.defineProperty(n,"__esModule",{value:!0}),Object.defineProperty(n,"encodeURIPath",{enumerable:!0,get:function(){return r}})},52157,(e,t,n)=>{"use strict";Object.defineProperty(n,"__esModule",{value:!0}),Object.defineProperty(n,"PreloadChunks",{enumerable:!0,get:function(){return l}});let r=e.r(43476),i=e.r(74080),s=e.r(63599),a=e.r(9885),o=e.r(43369);function l({moduleIds:e}){if("u">typeof window)return null;let t=s.workAsyncStorage.getStore();if(void 0===t)return null;let n=[];if(t.reactLoadableManifest&&e){let r=t.reactLoadableManifest;for(let t of e){if(!r[t])continue;let e=r[t].files;n.push(...e)}}if(0===n.length)return null;let l=(0,o.getDeploymentIdQueryOrEmptyString)();return(0,r.jsx)(r.Fragment,{children:n.map(e=>{let n=`${t.assetPrefix}/_next/${(0,a.encodeURIPath)(e)}${l}`;return e.endsWith(".css")?(0,r.jsx)("link",{precedence:"dynamic",href:n,rel:"stylesheet",as:"style",nonce:t.nonce},e):((0,i.preload)(n,{as:"script",fetchPriority:"low",nonce:t.nonce}),null)})})}},69093,(e,t,n)=>{"use strict";Object.defineProperty(n,"__esModule",{value:!0}),Object.defineProperty(n,"default",{enumerable:!0,get:function(){return u}});let r=e.r(43476),i=e.r(71645),s=e.r(67585),a=e.r(52157);function o(e){return{default:e&&"default"in e?e.default:e}}let l={loader:()=>Promise.resolve(o(()=>null)),loading:null,ssr:!0},u=function(e){let t={...l,...e},n=(0,i.lazy)(()=>t.loader().then(o)),u=t.loading;function h(e){let o=u?(0,r.jsx)(u,{isLoading:!0,pastDelay:!0,error:null}):null,l=!t.ssr||!!t.loading,h=l?i.Suspense:i.Fragment,c=t.ssr?(0,r.jsxs)(r.Fragment,{children:["u"<typeof window?(0,r.jsx)(a.PreloadChunks,{moduleIds:t.modules}):null,(0,r.jsx)(n,{...e})]}):(0,r.jsx)(s.BailoutToCSR,{reason:"next/dynamic",children:(0,r.jsx)(n,{...e})});return(0,r.jsx)(h,{...l?{fallback:o}:{},children:c})}return h.displayName="LoadableComponent",h}},70703,(e,t,n)=>{"use strict";Object.defineProperty(n,"__esModule",{value:!0}),Object.defineProperty(n,"default",{enumerable:!0,get:function(){return i}});let r=e.r(63141)._(e.r(69093));function i(e,t){let n={};"function"==typeof e&&(n.loader=e);let i={...n,...t};return(0,r.default)({...i,modules:i.loadableGenerated?.modules})}("function"==typeof n.default||"object"==typeof n.default&&null!==n.default)&&void 0===n.default.__esModule&&(Object.defineProperty(n.default,"__esModule",{value:!0}),Object.assign(n.default,n),t.exports=n.default)},54995,e=>{"use strict";let t;var n,r,i,s,a,o,l,u,h,c,d,f,m,g,p=e.i(43476),y=e.i(71645),w=e.i(18566),v=e.i(70703),b=e.i(74780),x=e.i(42554);let T=b.StyleSheet.create({page:{flexDirection:"column",backgroundColor:"#FFFFFF",padding:40,fontFamily:"Helvetica",fontSize:9,color:"#111"},headerContainer:{flexDirection:"row",justifyContent:"space-between",marginBottom:10},companyColumn:{width:"60%",flexDirection:"column",alignItems:"flex-start"},logo:{height:50,maxWidth:150,objectFit:"contain",objectPosition:"left",marginBottom:5},companyName:{fontSize:14,fontWeight:"bold",textTransform:"uppercase",color:"#333"},companyDetails:{fontSize:8,color:"#444",marginBottom:2},link:{color:"#007bff",textDecoration:"none"},quotationBox:{width:"40%",backgroundColor:"#f3f4f6",padding:0,alignItems:"center",justifyContent:"center"},quotationBoxInner:{width:"100%",paddingVertical:15,alignItems:"center"},rucText:{fontSize:10,fontWeight:"bold",marginBottom:5},docTitle:{fontSize:14,fontWeight:"bold",marginBottom:5},docNumber:{fontSize:12,fontWeight:"bold"},infoStrip:{flexDirection:"row",backgroundColor:"#f3f4f6",padding:4,marginBottom:10,borderTopWidth:2,borderTopColor:"#007acc",borderBottomWidth:1,borderBottomColor:"#ccc"},infoItem:{marginRight:40,flexDirection:"row"},infoLabel:{fontWeight:"bold",marginRight:5},sectionHeader:{fontSize:8,fontWeight:"bold",color:"#007acc",marginBottom:3,marginTop:6,textTransform:"uppercase"},clientContainer:{marginBottom:10,paddingBottom:5,borderBottomWidth:1,borderBottomColor:"#eee"},clientRow:{flexDirection:"row",marginBottom:3},clientLabel:{fontWeight:"bold",width:100},table:{width:"100%",marginTop:5},tableHeader:{flexDirection:"row",backgroundColor:"#f9fafb",borderBottomWidth:1,borderBottomColor:"#ccc",paddingVertical:6,paddingHorizontal:4},th:{fontWeight:"bold",fontSize:7,textTransform:"uppercase"},tableRow:{flexDirection:"row",borderBottomWidth:1,borderBottomColor:"#eee",paddingVertical:2,paddingHorizontal:4,minHeight:20,alignItems:"center"},colCode:{width:"8%"},colDesc:{width:"62%"},colQty:{width:"10%",textAlign:"center"},colPrice:{width:"10%",textAlign:"right"},colTotal:{width:"10%",textAlign:"right"},descContainer:{flexDirection:"row",alignItems:"flex-start"},itemImage:{width:30,height:30,marginRight:5,objectFit:"cover",borderRadius:2},itemTextContainer:{flex:1},itemTitle:{fontSize:8,marginBottom:2},itemDescText:{fontSize:7,color:"#555"},totalsContainer:{marginTop:10,alignSelf:"flex-end",width:"35%",paddingTop:5},totalRow:{flexDirection:"row",justifyContent:"space-between",paddingVertical:3},totalRowFinal:{flexDirection:"row",justifyContent:"space-between",paddingVertical:5,borderTopWidth:1,borderTopColor:"#000",marginTop:2},totalLabel:{fontWeight:"bold"},totalValue:{textAlign:"right"},totalAmountText:{fontSize:8,marginTop:5,textAlign:"right",fontStyle:"italic",width:"100%"},footerContainer:{marginTop:20,borderTopWidth:1,borderTopColor:"#ccc",paddingTop:10},notesText:{fontSize:7,lineHeight:1.4,textAlign:"justify",color:"#444"},paymentContainer:{marginTop:10,backgroundColor:"#f9fafb",padding:10,borderRadius:4},paymentRow:{flexDirection:"row",marginBottom:2},paymentLabel:{fontWeight:"bold",width:120,fontSize:7},paymentVal:{fontSize:7}}),I=({data:e})=>{let{clientName:t="",clientRuc:n="",clientAddress:r="",code:i="0000",items:s=[],company:a={},date:o=new Date().toLocaleDateString(),currency:l="Soles",notes:u="",serviceDescription:h=""}=e,c=s.reduce((e,t)=>e+parseFloat(t.price||0)*parseFloat(t.quantity||1),0),d=.18*c,f=c+d;return(0,p.jsx)(x.Document,{children:(0,p.jsxs)(x.Page,{size:"A4",style:T.page,children:[(0,p.jsxs)(x.View,{style:T.headerContainer,children:[(0,p.jsxs)(x.View,{style:T.companyColumn,children:[a.logoUrl&&(0,p.jsx)(x.Image,{src:a.logoUrl,style:T.logo}),(0,p.jsx)(x.Text,{style:T.companyName,children:a.name||"MI EMPRESA S.A.C."}),(0,p.jsx)(x.View,{style:{height:5}}),(0,p.jsx)(x.Text,{style:T.companyDetails,children:a.address||"Av. Principal 123, Lima, PerÃº"}),(0,p.jsxs)(x.Text,{style:T.companyDetails,children:["RUC: ",a.ruc||"20123456789"]}),(0,p.jsxs)(x.Text,{style:T.companyDetails,children:[a.email||"ventas@miempresa.com"," | ",a.phone||"999 888 777"]}),(0,p.jsx)(x.Text,{style:[T.companyDetails,T.link],children:a.website||"www.miempresa.com"})]}),(0,p.jsx)(x.View,{style:T.quotationBox,children:(0,p.jsxs)(x.View,{style:T.quotationBoxInner,children:[(0,p.jsxs)(x.Text,{style:T.rucText,children:["RUC ",a.ruc||"20000000001"]}),(0,p.jsx)(x.Text,{style:T.docTitle,children:"COTIZACIÃ“N"}),(0,p.jsx)(x.Text,{style:T.docNumber,children:i})]})})]}),(0,p.jsxs)(x.View,{style:T.infoStrip,children:[(0,p.jsxs)(x.View,{style:T.infoItem,children:[(0,p.jsx)(x.Text,{style:T.infoLabel,children:"FECHA EMISIÃ“N:"}),(0,p.jsx)(x.Text,{children:o})]}),(0,p.jsxs)(x.View,{style:T.infoItem,children:[(0,p.jsx)(x.Text,{style:T.infoLabel,children:"MONEDA:"}),(0,p.jsx)(x.Text,{children:l})]})]}),(0,p.jsx)(x.Text,{style:T.sectionHeader,children:"1. CLIENTE"}),(0,p.jsxs)(x.View,{style:T.clientContainer,children:[(0,p.jsxs)(x.View,{style:T.clientRow,children:[(0,p.jsx)(x.Text,{style:T.clientLabel,children:"RazÃ³n Social:"}),(0,p.jsx)(x.Text,{style:{flex:1},children:t})]}),n&&(0,p.jsxs)(x.View,{style:T.clientRow,children:[(0,p.jsx)(x.Text,{style:T.clientLabel,children:"RUC:"}),(0,p.jsx)(x.Text,{style:{flex:1},children:n})]}),r&&(0,p.jsxs)(x.View,{style:T.clientRow,children:[(0,p.jsx)(x.Text,{style:T.clientLabel,children:"DirecciÃ³n:"}),(0,p.jsx)(x.Text,{style:{flex:1},children:r})]})]}),h&&(0,p.jsxs)(x.View,{style:{marginBottom:10},children:[(0,p.jsx)(x.Text,{style:T.sectionHeader,children:"2. DESCRIPCIÃ“N DEL SERVICIO O PRODUCTO"}),(0,p.jsx)(x.View,{style:{padding:10,border:"1px solid #eee",borderRadius:4},children:(0,p.jsx)(x.Text,{style:{fontSize:9,lineHeight:1.4,color:"#444"},children:h})})]}),(0,p.jsx)(x.Text,{style:T.sectionHeader,children:"3. DETALLES DEL PRESUPUESTO"}),(0,p.jsxs)(x.View,{style:T.table,children:[(0,p.jsxs)(x.View,{style:T.tableHeader,children:[(0,p.jsx)(x.Text,{style:[T.th,T.colCode],children:"ITEM"}),(0,p.jsx)(x.Text,{style:[T.th,T.colDesc],children:"DESCRIPCIÃ“N"}),(0,p.jsx)(x.Text,{style:[T.th,T.colQty],children:"CANT"}),(0,p.jsx)(x.Text,{style:[T.th,T.colPrice],children:"PRECIO.U"}),(0,p.jsx)(x.Text,{style:[T.th,T.colTotal],children:"SUBTOTAL"})]}),s.map((e,t)=>{let n=parseFloat(e.price||0),r=parseFloat(e.quantity||1),i=n*r;return(0,p.jsxs)(x.View,{style:T.tableRow,children:[(0,p.jsx)(x.Text,{style:[T.colCode,{fontSize:8}],children:t+1}),(0,p.jsx)(x.View,{style:T.colDesc,children:(0,p.jsxs)(x.View,{style:T.descContainer,children:[e.imageUrl&&(0,p.jsx)(x.Image,{src:e.imageUrl,style:T.itemImage}),(0,p.jsxs)(x.View,{style:T.itemTextContainer,children:[(0,p.jsx)(x.Text,{style:T.itemTitle,children:e.name||e.description}),e.details&&e.details!==(e.name||e.description)&&(0,p.jsx)(x.Text,{style:T.itemDescText,children:e.details})]})]})}),(0,p.jsx)(x.Text,{style:[T.colQty,{fontSize:8}],children:r.toFixed(2)}),(0,p.jsxs)(x.Text,{style:[T.colPrice,{fontSize:8}],children:["S/ ",n.toFixed(2)]}),(0,p.jsxs)(x.Text,{style:[T.colTotal,{fontSize:8}],children:["S/ ",i.toFixed(2)]})]},t)})]}),(0,p.jsxs)(x.View,{style:T.totalsContainer,children:[(0,p.jsxs)(x.View,{style:T.totalRow,children:[(0,p.jsx)(x.Text,{style:[T.totalLabel,{fontSize:8}],children:"Subtotal"}),(0,p.jsxs)(x.Text,{style:[T.totalValue,{fontSize:8}],children:["S/ ",c.toFixed(2)]})]}),(0,p.jsxs)(x.View,{style:T.totalRow,children:[(0,p.jsx)(x.Text,{style:[T.totalLabel,{fontSize:8}],children:"IGV (18%)"}),(0,p.jsxs)(x.Text,{style:[T.totalValue,{fontSize:8}],children:["S/ ",d.toFixed(2)]})]}),(0,p.jsxs)(x.View,{style:T.totalRowFinal,children:[(0,p.jsx)(x.Text,{style:[T.totalLabel,{fontSize:10}],children:"IMPORTE TOTAL"}),(0,p.jsxs)(x.Text,{style:[T.totalValue,{fontSize:10,fontWeight:"bold"}],children:["S/ ",f.toFixed(2)]})]})]}),(0,p.jsxs)(x.Text,{style:T.totalAmountText,children:["Importe en letras: SON ",function(e){if(0===e)return"CERO";let t=["","UN","DOS","TRES","CUATRO","CINCO","SEIS","SIETE","OCHO","NUEVE"],n=["DIEZ","ONCE","DOCE","TRECE","CATORCE","QUINCE","DIECISEIS","DIECISIETE","DIECIOCHO","DIECINUEVE"],r=["","","VEINTE","TREINTA","CUARENTA","CINCUENTA","SESENTA","SETENTA","OCHENTA","NOVENTA"],i=["","CIENTO","DOSCIENTOS","TRESCIENTOS","CUATROCIENTOS","QUINIENTOS","SEISCIENTOS","SETECIENTOS","OCHOCIENTOS","NOVECIENTOS"];function s(e){let s="";if(e>=100){if(100===e)return"CIEN";s+=i[Math.floor(e/100)]+" ",e%=100}return e>=20?20===e?s+="VEINTE":e>20&&e<30?s+="VEINTI"+t[e-20]:(s+=r[Math.floor(e/10)],e%10>0&&(s+=" Y "+t[e%10])):e>=10?s+=n[e-10]:e>0&&(s+=t[e]),s.trim()}if(1e3===e)return"MIL";if(1e6===e)return"UN MILLON";let a="";if(e>=1e6){let t=Math.floor(e/1e6);a+=(1===t?"UN MILLON":s(t)+" MILLONES")+" ",e%=1e6}if(e>=1e3){let t=Math.floor(e/1e3);a+=(1===t?"MIL":s(t)+" MIL")+" ",e%=1e3}return e>0&&(a+=s(e)),a.trim().toUpperCase()}(Math.floor(f))," CON ",Math.round(f%1*100),"/100 SOLES"]}),(0,p.jsx)(x.Text,{style:[T.sectionHeader,{marginTop:10}],children:"4. NOTAS"}),(0,p.jsx)(x.View,{style:{borderTopWidth:1,borderTopColor:"#eee",paddingTop:5},children:(0,p.jsx)(x.Text,{style:T.notesText,children:u})}),(0,p.jsx)(x.Text,{style:T.sectionHeader,children:"5. CONDICIONES DE PAGO"}),(0,p.jsx)(x.View,{style:T.paymentContainer,children:(0,p.jsxs)(x.View,{style:T.paymentRow,children:[(0,p.jsx)(x.Text,{style:T.paymentLabel,children:"CUENTAS BANCARIAS:"}),(0,p.jsx)(x.View,{style:{flex:1},children:a.accounts&&a.accounts.length>0?a.accounts.map((e,t)=>(0,p.jsxs)(x.View,{style:{marginBottom:4},children:[(0,p.jsxs)(x.Text,{style:[T.paymentVal,{fontWeight:"bold"}],children:[e.bankName," - Cuenta Corriente - Soles"]}),(0,p.jsxs)(x.Text,{style:T.paymentVal,children:["NÂº: ",e.accountNumber]}),e.cci&&(0,p.jsxs)(x.Text,{style:T.paymentVal,children:["CCI: ",e.cci]})]},t)):(0,p.jsx)(x.Text,{style:T.paymentVal,children:"No hay cuentas configuradas."})})]})})]})})};var S=e.i(73518),E=e.i(88054);function _({activeUsers:e=[]}){let{user:t,signOut:n}=(0,S.useAuth)(),r=(0,w.useRouter)(),i=async()=>{await n(),r.push("/login")};if(!t)return null;let s=Array.from(new Map((e?.filter(e=>e.uid!==t?.uid)||[]).map(e=>[e.uid,e])).values());return(0,p.jsxs)("div",{style:{position:"fixed",left:0,top:0,bottom:0,width:"80px",background:"linear-gradient(180deg, #f8fafc 0%, #f1f5f9 100%)",display:"flex",flexDirection:"column",alignItems:"center",padding:"1.5rem 0",gap:"1.5rem",zIndex:100,borderRight:"1px solid #e2e8f0",boxShadow:"2px 0 8px rgba(0,0,0,0.05)",transition:"width 0.3s ease"},children:[(0,p.jsxs)("div",{style:{display:"flex",flexDirection:"column",alignItems:"center",gap:"0.5rem",paddingBottom:"1.5rem",borderBottom:"1px solid #e2e8f0",width:"100%"},children:[(0,p.jsxs)("div",{style:{position:"relative"},children:[t.photoURL?(0,p.jsx)("img",{src:t.photoURL,alt:t.displayName||t.firstName||"User",style:{width:"48px",height:"48px",borderRadius:"50%",border:"2px solid #10b981",boxShadow:"0 4px 8px rgba(16, 185, 129, 0.3)"},title:`${t.displayName||t.firstName||"Usuario"}
${t.email}`}):(0,p.jsx)("div",{style:{width:"48px",height:"48px",borderRadius:"50%",border:"2px solid #10b981",background:"linear-gradient(135deg, #10b981 0%, #059669 100%)",display:"flex",alignItems:"center",justifyContent:"center",color:"#ffffff",fontSize:"1.25rem",fontWeight:"700",boxShadow:"0 4px 8px rgba(16, 185, 129, 0.3)"},title:`${t.displayName||t.firstName||"Usuario"}
${t.email}`,children:(t.displayName||t.firstName||t.email||"?")[0].toUpperCase()}),(0,p.jsx)("div",{style:{position:"absolute",bottom:"-2px",right:"-2px",width:"14px",height:"14px",borderRadius:"50%",background:"#10b981",border:"2px solid #f8fafc",boxShadow:"0 0 8px rgba(16, 185, 129, 0.6)"}})]}),(0,p.jsx)("span",{style:{fontSize:"0.65rem",color:"#64748b",fontWeight:"500",textAlign:"center",maxWidth:"60px",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"},children:"TÃº"})]}),s.length>0&&(0,p.jsxs)("div",{style:{display:"flex",flexDirection:"column",alignItems:"center",gap:"1rem",width:"100%",flex:1,overflowY:"auto",paddingBottom:"1rem"},children:[(0,p.jsx)("div",{style:{fontSize:"0.65rem",color:"#64748b",fontWeight:"600",textTransform:"uppercase",letterSpacing:"0.05em",textAlign:"center"},children:"Editando"}),s.map((e,t)=>(0,p.jsxs)("div",{style:{position:"relative",display:"flex",flexDirection:"column",alignItems:"center",gap:"0.25rem"},children:[e.photoURL?(0,p.jsx)("img",{src:e.photoURL,alt:e.displayName||e.firstName||"User",style:{width:"40px",height:"40px",borderRadius:"50%",border:"2px solid #667eea",boxShadow:"0 2px 6px rgba(102, 126, 234, 0.3)"},title:e.displayName||e.firstName||e.email}):(0,p.jsx)("div",{style:{width:"40px",height:"40px",borderRadius:"50%",border:"2px solid #667eea",background:"linear-gradient(135deg, #667eea 0%, #764ba2 100%)",display:"flex",alignItems:"center",justifyContent:"center",color:"#ffffff",fontSize:"1rem",fontWeight:"600",boxShadow:"0 2px 6px rgba(102, 126, 234, 0.3)"},title:e.displayName||e.firstName||e.email,children:(e.displayName||e.firstName||e.email||"?")[0].toUpperCase()}),(0,p.jsx)("div",{style:{position:"absolute",bottom:"18px",right:"8px",width:"10px",height:"10px",borderRadius:"50%",background:"#667eea",border:"2px solid #f8fafc",boxShadow:"0 0 6px rgba(102, 126, 234, 0.6)"}}),(0,p.jsx)("span",{style:{fontSize:"0.6rem",color:"#64748b",fontWeight:"500",textAlign:"center",maxWidth:"60px",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"},children:(e.displayName||e.firstName||e.email?.split("@")[0]||"").substring(0,8)})]},`sidebar-user-${e.uid}-${t}`))]}),(0,p.jsx)("button",{onClick:i,style:{width:"48px",height:"48px",borderRadius:"12px",background:"rgba(239, 68, 68, 0.1)",border:"1px solid rgba(239, 68, 68, 0.2)",color:"#ef4444",cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"center",fontSize:"1.25rem",transition:"all 0.2s",marginTop:"auto"},onMouseOver:e=>{e.currentTarget.style.background="#ef4444",e.currentTarget.style.color="#ffffff",e.currentTarget.style.borderColor="#ef4444"},onMouseOut:e=>{e.currentTarget.style.background="rgba(239, 68, 68, 0.1)",e.currentTarget.style.color="#ef4444",e.currentTarget.style.borderColor="rgba(239, 68, 68, 0.2)"},title:"Cerrar SesiÃ³n",children:"ðŸšª"})]})}var C=e.i(92953),A=e.i(8070),N=e.i(47167),D=e.i(67034),k=e.i(97427),R="u">typeof globalThis?globalThis:"u">typeof window?window:e.g,P={};(function(){function e(){this.blockSize=-1,this.blockSize=64,this.g=[,,,,],this.C=Array(this.blockSize),this.o=this.h=0,this.u()}var t=function(){this.blockSize=-1};function i(){}function s(e,t,n){n||(n=0);let r=Array(16);if("string"==typeof t)for(var i=0;i<16;++i)r[i]=t.charCodeAt(n++)|t.charCodeAt(n++)<<8|t.charCodeAt(n++)<<16|t.charCodeAt(n++)<<24;else for(i=0;i<16;++i)r[i]=t[n++]|t[n++]<<8|t[n++]<<16|t[n++]<<24;t=e.g[0],n=e.g[1],i=e.g[2];let s=e.g[3],a;a=t+(s^n&(i^s))+r[0]+0xd76aa478|0,a=s+(i^(t=n+(a<<7|a>>>25))&(n^i))+r[1]+0xe8c7b756|0,a=i+(n^(s=t+(a<<12|a>>>20))&(t^n))+r[2]+0x242070db|0,a=n+(t^(i=s+(a<<17|a>>>15))&(s^t))+r[3]+0xc1bdceee|0,a=t+(s^(n=i+(a<<22|a>>>10))&(i^s))+r[4]+0xf57c0faf|0,a=s+(i^(t=n+(a<<7|a>>>25))&(n^i))+r[5]+0x4787c62a|0,a=i+(n^(s=t+(a<<12|a>>>20))&(t^n))+r[6]+0xa8304613|0,a=n+(t^(i=s+(a<<17|a>>>15))&(s^t))+r[7]+0xfd469501|0,a=t+(s^(n=i+(a<<22|a>>>10))&(i^s))+r[8]+0x698098d8|0,a=s+(i^(t=n+(a<<7|a>>>25))&(n^i))+r[9]+0x8b44f7af|0,a=i+(n^(s=t+(a<<12|a>>>20))&(t^n))+r[10]+0xffff5bb1|0,a=n+(t^(i=s+(a<<17|a>>>15))&(s^t))+r[11]+0x895cd7be|0,a=t+(s^(n=i+(a<<22|a>>>10))&(i^s))+r[12]+0x6b901122|0,a=s+(i^(t=n+(a<<7|a>>>25))&(n^i))+r[13]+0xfd987193|0,a=i+(n^(s=t+(a<<12|a>>>20))&(t^n))+r[14]+0xa679438e|0,a=n+(t^(i=s+(a<<17|a>>>15))&(s^t))+r[15]+0x49b40821|0,n=i+(a<<22|a>>>10),a=t+(i^s&(n^i))+r[1]+0xf61e2562|0,t=n+(a<<5|a>>>27),a=s+(n^i&(t^n))+r[6]+0xc040b340|0,s=t+(a<<9|a>>>23),a=i+(t^n&(s^t))+r[11]+0x265e5a51|0,i=s+(a<<14|a>>>18),a=n+(s^t&(i^s))+r[0]+0xe9b6c7aa|0,n=i+(a<<20|a>>>12),a=t+(i^s&(n^i))+r[5]+0xd62f105d|0,t=n+(a<<5|a>>>27),a=s+(n^i&(t^n))+r[10]+0x2441453|0,s=t+(a<<9|a>>>23),a=i+(t^n&(s^t))+r[15]+0xd8a1e681|0,i=s+(a<<14|a>>>18),a=n+(s^t&(i^s))+r[4]+0xe7d3fbc8|0,n=i+(a<<20|a>>>12),a=t+(i^s&(n^i))+r[9]+0x21e1cde6|0,t=n+(a<<5|a>>>27),a=s+(n^i&(t^n))+r[14]+0xc33707d6|0,s=t+(a<<9|a>>>23),a=i+(t^n&(s^t))+r[3]+0xf4d50d87|0,i=s+(a<<14|a>>>18),a=n+(s^t&(i^s))+r[8]+0x455a14ed|0,n=i+(a<<20|a>>>12),a=t+(i^s&(n^i))+r[13]+0xa9e3e905|0,t=n+(a<<5|a>>>27),a=s+(n^i&(t^n))+r[2]+0xfcefa3f8|0,s=t+(a<<9|a>>>23),a=i+(t^n&(s^t))+r[7]+0x676f02d9|0,i=s+(a<<14|a>>>18),a=n+(s^t&(i^s))+r[12]+0x8d2a4c8a|0,a=t+((n=i+(a<<20|a>>>12))^i^s)+r[5]+0xfffa3942|0,a=s+((t=n+(a<<4|a>>>28))^n^i)+r[8]+0x8771f681|0,a=i+((s=t+(a<<11|a>>>21))^t^n)+r[11]+0x6d9d6122|0,a=n+((i=s+(a<<16|a>>>16))^s^t)+r[14]+0xfde5380c|0,a=t+((n=i+(a<<23|a>>>9))^i^s)+r[1]+0xa4beea44|0,a=s+((t=n+(a<<4|a>>>28))^n^i)+r[4]+0x4bdecfa9|0,a=i+((s=t+(a<<11|a>>>21))^t^n)+r[7]+0xf6bb4b60|0,a=n+((i=s+(a<<16|a>>>16))^s^t)+r[10]+0xbebfbc70|0,a=t+((n=i+(a<<23|a>>>9))^i^s)+r[13]+0x289b7ec6|0,a=s+((t=n+(a<<4|a>>>28))^n^i)+r[0]+0xeaa127fa|0,a=i+((s=t+(a<<11|a>>>21))^t^n)+r[3]+0xd4ef3085|0,a=n+((i=s+(a<<16|a>>>16))^s^t)+r[6]+0x4881d05|0,a=t+((n=i+(a<<23|a>>>9))^i^s)+r[9]+0xd9d4d039|0,a=s+((t=n+(a<<4|a>>>28))^n^i)+r[12]+0xe6db99e5|0,a=i+((s=t+(a<<11|a>>>21))^t^n)+r[15]+0x1fa27cf8|0,a=n+((i=s+(a<<16|a>>>16))^s^t)+r[2]+0xc4ac5665|0,n=i+(a<<23|a>>>9),a=t+(i^(n|~s))+r[0]+0xf4292244|0,t=n+(a<<6|a>>>26),a=s+(n^(t|~i))+r[7]+0x432aff97|0,s=t+(a<<10|a>>>22),a=i+(t^(s|~n))+r[14]+0xab9423a7|0,i=s+(a<<15|a>>>17),a=n+(s^(i|~t))+r[5]+0xfc93a039|0,n=i+(a<<21|a>>>11),a=t+(i^(n|~s))+r[12]+0x655b59c3|0,t=n+(a<<6|a>>>26),a=s+(n^(t|~i))+r[3]+0x8f0ccc92|0,s=t+(a<<10|a>>>22),a=i+(t^(s|~n))+r[10]+0xffeff47d|0,i=s+(a<<15|a>>>17),a=n+(s^(i|~t))+r[1]+0x85845dd1|0,n=i+(a<<21|a>>>11),a=t+(i^(n|~s))+r[8]+0x6fa87e4f|0,t=n+(a<<6|a>>>26),a=s+(n^(t|~i))+r[15]+0xfe2ce6e0|0,s=t+(a<<10|a>>>22),a=i+(t^(s|~n))+r[6]+0xa3014314|0,i=s+(a<<15|a>>>17),a=n+(s^(i|~t))+r[13]+0x4e0811a1|0,n=i+(a<<21|a>>>11),a=t+(i^(n|~s))+r[4]+0xf7537e82|0,t=n+(a<<6|a>>>26),a=s+(n^(t|~i))+r[11]+0xbd3af235|0,s=t+(a<<10|a>>>22),a=i+(t^(s|~n))+r[2]+0x2ad7d2bb|0,i=s+(a<<15|a>>>17),a=n+(s^(i|~t))+r[9]+0xeb86d391|0,e.g[0]=e.g[0]+t|0,e.g[1]=e.g[1]+(i+(a<<21|a>>>11))|0,e.g[2]=e.g[2]+i|0,e.g[3]=e.g[3]+s|0}function a(e,t){this.h=t;let n=[],r=!0;for(let i=e.length-1;i>=0;i--){let s=0|e[i];r&&s==t||(n[i]=s,r=!1)}this.g=n}i.prototype=t.prototype,e.F=t.prototype,e.prototype=new i,e.prototype.constructor=e,e.D=function(e,n,r){for(var i=Array(arguments.length-2),s=2;s<arguments.length;s++)i[s-2]=arguments[s];return t.prototype[n].apply(e,i)},e.prototype.u=function(){this.g[0]=0x67452301,this.g[1]=0xefcdab89,this.g[2]=0x98badcfe,this.g[3]=0x10325476,this.o=this.h=0},e.prototype.v=function(e,t){void 0===t&&(t=e.length);let n=t-this.blockSize,r=this.C,i=this.h,a=0;for(;a<t;){if(0==i)for(;a<=n;)s(this,e,a),a+=this.blockSize;if("string"==typeof e){for(;a<t;)if(r[i++]=e.charCodeAt(a++),i==this.blockSize){s(this,r),i=0;break}}else for(;a<t;)if(r[i++]=e[a++],i==this.blockSize){s(this,r),i=0;break}}this.h=i,this.o+=t},e.prototype.A=function(){var e=Array((this.h<56?this.blockSize:2*this.blockSize)-this.h);e[0]=128;for(var t=1;t<e.length-8;++t)e[t]=0;t=8*this.o;for(var n=e.length-8;n<e.length;++n)e[n]=255&t,t/=256;for(this.v(e),e=Array(16),t=0,n=0;n<4;++n)for(let r=0;r<32;r+=8)e[t++]=this.g[n]>>>r&255;return e};var o,l={};function u(e){var t;return -128<=e&&e<128?(t=function(e){return new a([0|e],e<0?-1:0)},Object.prototype.hasOwnProperty.call(l,e)?l[e]:l[e]=t(e)):new a([0|e],e<0?-1:0)}function h(e){if(isNaN(e)||!isFinite(e))return c;if(e<0)return p(h(-e));let t=[],n=1;for(let r=0;e>=n;r++)t[r]=e/n|0,n*=0x100000000;return new a(t,0)}var c=u(0),d=u(1),f=u(0x1000000);function m(e){if(0!=e.h)return!1;for(let t=0;t<e.g.length;t++)if(0!=e.g[t])return!1;return!0}function g(e){return -1==e.h}function p(e){let t=e.g.length,n=[];for(let r=0;r<t;r++)n[r]=~e.g[r];return new a(n,~e.h).add(d)}function y(e,t){return e.add(p(t))}function w(e,t){for(;(65535&e[t])!=e[t];)e[t+1]+=e[t]>>>16,e[t]&=65535,t++}function v(e,t){this.g=e,this.h=t}function b(e,t){if(m(t))throw Error("division by zero");if(m(e))return new v(c,c);if(g(e))return t=b(p(e),t),new v(p(t.g),p(t.h));if(g(t))return t=b(e,p(t)),new v(p(t.g),t.h);if(e.g.length>30){if(g(e)||g(t))throw Error("slowDivide_ only works with positive integers.");for(var n=d,r=t;0>=r.l(e);)n=x(n),r=x(r);var i=T(n,1),s=T(r,1);for(r=T(r,2),n=T(n,2);!m(r);){var a=s.add(r);0>=a.l(e)&&(i=i.add(n),s=a),r=T(r,1),n=T(n,1)}return t=y(e,i.j(t)),new v(i,t)}for(i=c;e.l(t)>=0;){for(r=(r=Math.ceil(Math.log(n=Math.max(1,Math.floor(e.m()/t.m())))/Math.LN2))<=48?1:Math.pow(2,r-48),a=(s=h(n)).j(t);g(a)||a.l(e)>0;)n-=r,a=(s=h(n)).j(t);m(s)&&(s=d),i=i.add(s),e=y(e,a)}return new v(i,e)}function x(e){let t=e.g.length+1,n=[];for(let r=0;r<t;r++)n[r]=e.i(r)<<1|e.i(r-1)>>>31;return new a(n,e.h)}function T(e,t){let n=t>>5;t%=32;let r=e.g.length-n,i=[];for(let s=0;s<r;s++)i[s]=t>0?e.i(s+n)>>>t|e.i(s+n+1)<<32-t:e.i(s+n);return new a(i,e.h)}(o=a.prototype).m=function(){if(g(this))return-p(this).m();let e=0,t=1;for(let n=0;n<this.g.length;n++){let r=this.i(n);e+=(r>=0?r:0x100000000+r)*t,t*=0x100000000}return e},o.toString=function(e){if((e=e||10)<2||36<e)throw Error("radix out of range: "+e);if(m(this))return"0";if(g(this))return"-"+p(this).toString(e);let t=h(Math.pow(e,6));var n=this;let r="";for(;;){let i=b(n,t).g,s=(((n=y(n,i.j(t))).g.length>0?n.g[0]:n.h)>>>0).toString(e);if(m(n=i))return s+r;for(;s.length<6;)s="0"+s;r=s+r}},o.i=function(e){return e<0?0:e<this.g.length?this.g[e]:this.h},o.l=function(e){return g(e=y(this,e))?-1:+!m(e)},o.abs=function(){return g(this)?p(this):this},o.add=function(e){let t=Math.max(this.g.length,e.g.length),n=[],r=0;for(let i=0;i<=t;i++){let t=r+(65535&this.i(i))+(65535&e.i(i)),s=(t>>>16)+(this.i(i)>>>16)+(e.i(i)>>>16);r=s>>>16,t&=65535,s&=65535,n[i]=s<<16|t}return new a(n,-0x80000000&n[n.length-1]?-1:0)},o.j=function(e){if(m(this)||m(e))return c;if(g(this))return g(e)?p(this).j(p(e)):p(p(this).j(e));if(g(e))return p(this.j(p(e)));if(0>this.l(f)&&0>e.l(f))return h(this.m()*e.m());let t=this.g.length+e.g.length,n=[];for(var r=0;r<2*t;r++)n[r]=0;for(r=0;r<this.g.length;r++)for(let t=0;t<e.g.length;t++){let i=this.i(r)>>>16,s=65535&this.i(r),a=e.i(t)>>>16,o=65535&e.i(t);n[2*r+2*t]+=s*o,w(n,2*r+2*t),n[2*r+2*t+1]+=i*o,w(n,2*r+2*t+1),n[2*r+2*t+1]+=s*a,w(n,2*r+2*t+1),n[2*r+2*t+2]+=i*a,w(n,2*r+2*t+2)}for(e=0;e<t;e++)n[e]=n[2*e+1]<<16|n[2*e];for(e=t;e<2*t;e++)n[e]=0;return new a(n,0)},o.B=function(e){return b(this,e).h},o.and=function(e){let t=Math.max(this.g.length,e.g.length),n=[];for(let r=0;r<t;r++)n[r]=this.i(r)&e.i(r);return new a(n,this.h&e.h)},o.or=function(e){let t=Math.max(this.g.length,e.g.length),n=[];for(let r=0;r<t;r++)n[r]=this.i(r)|e.i(r);return new a(n,this.h|e.h)},o.xor=function(e){let t=Math.max(this.g.length,e.g.length),n=[];for(let r=0;r<t;r++)n[r]=this.i(r)^e.i(r);return new a(n,this.h^e.h)},e.prototype.digest=e.prototype.A,e.prototype.reset=e.prototype.u,e.prototype.update=e.prototype.v,r=P.Md5=e,a.prototype.add=a.prototype.add,a.prototype.multiply=a.prototype.j,a.prototype.modulo=a.prototype.B,a.prototype.compare=a.prototype.l,a.prototype.toNumber=a.prototype.m,a.prototype.toString=a.prototype.toString,a.prototype.getBits=a.prototype.i,a.fromNumber=h,a.fromString=function e(t,n){if(0==t.length)throw Error("number format error: empty string");if((n=n||10)<2||36<n)throw Error("radix out of range: "+n);if("-"==t.charAt(0))return p(e(t.substring(1),n));if(t.indexOf("-")>=0)throw Error('number format error: interior "-" character');let r=h(Math.pow(n,8)),i=c;for(let e=0;e<t.length;e+=8){var s=Math.min(8,t.length-e);let a=parseInt(t.substring(e,e+s),n);s<8?(s=h(Math.pow(n,s)),i=i.j(s).add(h(a))):i=(i=i.j(r)).add(h(a))}return i},n=P.Integer=a}).apply(void 0!==R?R:"u">typeof self?self:"u">typeof window?window:{});var O=e.i(83877),M="u">typeof globalThis?globalThis:"u">typeof window?window:e.g,F={};(function(){var e,t,n=Object.defineProperty,r=function(e){e=["object"==typeof globalThis&&globalThis,e,"object"==typeof window&&window,"object"==typeof self&&self,"object"==typeof M&&M];for(var t=0;t<e.length;++t){var n=e[t];if(n&&n.Math==Math)return n}throw Error("Cannot find global object")}(this);function d(e,t){if(t)e:{var i=r;e=e.split(".");for(var s=0;s<e.length-1;s++){var a=e[s];if(!(a in i))break e;i=i[a]}(t=t(s=i[e=e[e.length-1]]))!=s&&null!=t&&n(i,e,{configurable:!0,writable:!0,value:t})}}d("Symbol.dispose",function(e){return e||Symbol("Symbol.dispose")}),d("Array.prototype.values",function(e){return e||function(){return this[Symbol.iterator]()}}),d("Object.entries",function(e){return e||function(e){var t,n=[];for(t in e)Object.prototype.hasOwnProperty.call(e,t)&&n.push([t,e[t]]);return n}});var f=f||{},m=this||self;function g(e){var t=typeof e;return"object"==t&&null!=e||"function"==t}function p(e,t,n){return e.call.apply(e.bind,arguments)}function y(e,t,n){return(y=p).apply(null,arguments)}function w(e,t){var n=Array.prototype.slice.call(arguments,1);return function(){var t=n.slice();return t.push.apply(t,arguments),e.apply(this,t)}}function v(e,t){function n(){}n.prototype=t.prototype,e.Z=t.prototype,e.prototype=new n,e.prototype.constructor=e,e.Ob=function(e,n,r){for(var i=Array(arguments.length-2),s=2;s<arguments.length;s++)i[s-2]=arguments[s];return t.prototype[n].apply(e,i)}}var b="u">typeof AsyncContext&&"function"==typeof AsyncContext.Snapshot?e=>e&&AsyncContext.Snapshot.wrap(e):e=>e;function x(e){let t=e.length;if(t>0){let n=Array(t);for(let r=0;r<t;r++)n[r]=e[r];return n}return[]}function T(e,t){for(let t=1;t<arguments.length;t++){let r=arguments[t];var n=typeof r;if("array"==(n="object"!=n?n:r?Array.isArray(r)?"array":n:"null")||"object"==n&&"number"==typeof r.length){n=e.length||0;let t=r.length||0;e.length=n+t;for(let i=0;i<t;i++)e[n+i]=r[i]}else e.push(r)}}var I=new class{constructor(e,t){this.i=e,this.j=t,this.h=0,this.g=null}get(){let e;return this.h>0?(this.h--,e=this.g,this.g=e.next,e.next=null):e=this.i(),e}}(()=>new S,e=>e.reset());class S{constructor(){this.next=this.g=this.h=null}set(e,t){this.h=e,this.g=t,this.next=null}reset(){this.next=this.g=this.h=null}}let E,_=!1,C=new class{constructor(){this.h=this.g=null}add(e,t){let n=I.get();n.set(e,t),this.h?this.h.next=n:this.g=n,this.h=n}},A=()=>{let e=Promise.resolve(void 0);E=()=>{e.then(N)}};function N(){let e;for(var t;e=null,C.g&&(e=C.g,C.g=C.g.next,C.g||(C.h=null),e.next=null),t=e;){try{t.h.call(t.g)}catch(e){!function(e){m.setTimeout(()=>{throw e},0)}(e)}I.j(t),I.h<100&&(I.h++,t.next=I.g,I.g=t)}_=!1}function D(){this.u=this.u,this.C=this.C}function k(e,t){this.type=e,this.g=this.target=t,this.defaultPrevented=!1}D.prototype.u=!1,D.prototype.dispose=function(){this.u||(this.u=!0,this.N())},D.prototype[Symbol.dispose]=function(){this.dispose()},D.prototype.N=function(){if(this.C)for(;this.C.length;)this.C.shift()()},k.prototype.h=function(){this.defaultPrevented=!0};var R=function(){if(!m.addEventListener||!Object.defineProperty)return!1;var e=!1,t=Object.defineProperty({},"passive",{get:function(){e=!0}});try{let e=()=>{};m.addEventListener("test",e,t),m.removeEventListener("test",e,t)}catch(e){}return e}();function P(e){return/^[\s\xa0]*$/.test(e)}function O(e,t){k.call(this,e?e.type:""),this.relatedTarget=this.g=this.target=null,this.button=this.screenY=this.screenX=this.clientY=this.clientX=0,this.key="",this.metaKey=this.shiftKey=this.altKey=this.ctrlKey=!1,this.state=null,this.pointerId=0,this.pointerType="",this.i=null,e&&this.init(e,t)}v(O,k),O.prototype.init=function(e,t){let n=this.type=e.type,r=e.changedTouches&&e.changedTouches.length?e.changedTouches[0]:null;this.target=e.target||e.srcElement,this.g=t,(t=e.relatedTarget)||("mouseover"==n?t=e.fromElement:"mouseout"==n&&(t=e.toElement)),this.relatedTarget=t,r?(this.clientX=void 0!==r.clientX?r.clientX:r.pageX,this.clientY=void 0!==r.clientY?r.clientY:r.pageY,this.screenX=r.screenX||0,this.screenY=r.screenY||0):(this.clientX=void 0!==e.clientX?e.clientX:e.pageX,this.clientY=void 0!==e.clientY?e.clientY:e.pageY,this.screenX=e.screenX||0,this.screenY=e.screenY||0),this.button=e.button,this.key=e.key||"",this.ctrlKey=e.ctrlKey,this.altKey=e.altKey,this.shiftKey=e.shiftKey,this.metaKey=e.metaKey,this.pointerId=e.pointerId||0,this.pointerType=e.pointerType,this.state=e.state,this.i=e,e.defaultPrevented&&O.Z.h.call(this)},O.prototype.h=function(){O.Z.h.call(this);let e=this.i;e.preventDefault?e.preventDefault():e.returnValue=!1};var V="closure_listenable_"+(1e6*Math.random()|0),L=0;function j(e,t,n,r,i){this.listener=e,this.proxy=null,this.src=t,this.type=n,this.capture=!!r,this.ha=i,this.key=++L,this.da=this.fa=!1}function U(e){e.da=!0,e.listener=null,e.proxy=null,e.src=null,e.ha=null}function q(e,t,n){for(let r in e)t.call(n,e[r],r,e)}function B(e){let t={};for(let n in e)t[n]=e[n];return t}let z="constructor hasOwnProperty isPrototypeOf propertyIsEnumerable toLocaleString toString valueOf".split(" ");function $(e,t){let n,r;for(let t=1;t<arguments.length;t++){for(n in r=arguments[t])e[n]=r[n];for(let t=0;t<z.length;t++)n=z[t],Object.prototype.hasOwnProperty.call(r,n)&&(e[n]=r[n])}}function G(e){this.src=e,this.g={},this.h=0}function K(e,t){let n=t.type;if(n in e.g){var r,i=e.g[n],s=Array.prototype.indexOf.call(i,t,void 0);(r=s>=0)&&Array.prototype.splice.call(i,s,1),r&&(U(t),0==e.g[n].length&&(delete e.g[n],e.h--))}}function Q(e,t,n,r){for(let i=0;i<e.length;++i){let s=e[i];if(!s.da&&s.listener==t&&!!n==s.capture&&s.ha==r)return i}return -1}G.prototype.add=function(e,t,n,r,i){let s=e.toString();(e=this.g[s])||(e=this.g[s]=[],this.h++);let a=Q(e,t,r,i);return a>-1?(t=e[a],n||(t.fa=!1)):((t=new j(t,this.src,s,!!r,i)).fa=n,e.push(t)),t};var H="closure_lm_"+(1e6*Math.random()|0),W={};function J(e,t,n,r,i,s){if(!t)throw Error("Invalid event type");let a=g(i)?!!i.capture:!!i,o=ee(e);if(o||(e[H]=o=new G(e)),(n=o.add(t,n,r,a,s)).proxy)return n;if(r=function e(t){return Z.call(e.src,e.listener,t)},n.proxy=r,r.src=e,r.listener=n,e.addEventListener)R||(i=a),void 0===i&&(i=!1),e.addEventListener(t.toString(),r,i);else if(e.attachEvent)e.attachEvent(X(t.toString()),r);else if(e.addListener&&e.removeListener)e.addListener(r);else throw Error("addEventListener and attachEvent are unavailable.");return n}function Y(e){if("number"!=typeof e&&e&&!e.da){var t=e.src;if(t&&t[V])K(t.i,e);else{var n=e.type,r=e.proxy;t.removeEventListener?t.removeEventListener(n,r,e.capture):t.detachEvent?t.detachEvent(X(n),r):t.addListener&&t.removeListener&&t.removeListener(r),(n=ee(t))?(K(n,e),0==n.h&&(n.src=null,t[H]=null)):U(e)}}}function X(e){return e in W?W[e]:W[e]="on"+e}function Z(e,t){if(e.da)e=!0;else{t=new O(t,this);let n=e.listener,r=e.ha||e.src;e.fa&&Y(e),e=n.call(r,t)}return e}function ee(e){return(e=e[H])instanceof G?e:null}var et="__closure_events_fn_"+(1e9*Math.random()>>>0);function en(e){return"function"==typeof e?e:(e[et]||(e[et]=function(t){return e.handleEvent(t)}),e[et])}function er(){D.call(this),this.i=new G(this),this.M=this,this.G=null}function ei(e,t){let n,r;var i,s=e.G;if(s)for(i=[];s;s=s.G)i.push(s);if(e=e.M,s=t.type||t,"string"==typeof t)t=new k(t,e);else if(t instanceof k)t.target=t.target||e;else{var a=t;$(t=new k(s,e),a)}if(a=!0,i)for(r=i.length-1;r>=0;r--)a=es(n=t.g=i[r],s,!0,t)&&a;if(a=es(n=t.g=e,s,!0,t)&&a,a=es(n,s,!1,t)&&a,i)for(r=0;r<i.length;r++)a=es(n=t.g=i[r],s,!1,t)&&a}function es(e,t,n,r){if(!(t=e.i.g[String(t)]))return!0;t=t.concat();let i=!0;for(let s=0;s<t.length;++s){let a=t[s];if(a&&!a.da&&a.capture==n){let t=a.listener,n=a.ha||a.src;a.fa&&K(e.i,a),i=!1!==t.call(n,r)&&i}}return i&&!r.defaultPrevented}v(er,D),er.prototype[V]=!0,er.prototype.removeEventListener=function(e,t,n,r){!function e(t,n,r,i,s){if(Array.isArray(n))for(var a=0;a<n.length;a++)e(t,n[a],r,i,s);else(i=g(i)?!!i.capture:!!i,r=en(r),t&&t[V])?(t=t.i,(a=String(n).toString())in t.g&&(r=Q(n=t.g[a],r,i,s))>-1&&(U(n[r]),Array.prototype.splice.call(n,r,1),0==n.length&&(delete t.g[a],t.h--))):t&&(t=ee(t))&&(n=t.g[n.toString()],t=-1,n&&(t=Q(n,r,i,s)),(r=t>-1?n[t]:null)&&Y(r))}(this,e,t,n,r)},er.prototype.N=function(){if(er.Z.N.call(this),this.i){var e=this.i;for(let t in e.g){let n=e.g[t];for(let e=0;e<n.length;e++)U(n[e]);delete e.g[t],e.h--}}this.G=null},er.prototype.J=function(e,t,n,r){return this.i.add(String(e),t,!1,n,r)},er.prototype.K=function(e,t,n,r){return this.i.add(String(e),t,!0,n,r)};class ea extends D{constructor(e,t){super(),this.m=e,this.l=t,this.h=null,this.i=!1,this.g=null}j(e){this.h=arguments,this.g?this.i=!0:function e(t){t.g=function(e,t){if("function"!=typeof e)if(e&&"function"==typeof e.handleEvent)e=y(e.handleEvent,e);else throw Error("Invalid listener argument");return Number(t)>0x7fffffff?-1:m.setTimeout(e,t||0)}(()=>{t.g=null,t.i&&(t.i=!1,e(t))},t.l);let n=t.h;t.h=null,t.m.apply(null,n)}(this)}N(){super.N(),this.g&&(m.clearTimeout(this.g),this.g=null,this.i=!1,this.h=null)}}function eo(e){D.call(this),this.h=e,this.g={}}v(eo,D);var el=[];function eu(e){q(e.g,function(e,t){this.g.hasOwnProperty(t)&&Y(e)},e),e.g={}}eo.prototype.N=function(){eo.Z.N.call(this),eu(this)},eo.prototype.handleEvent=function(){throw Error("EventHandler.handleEvent not implemented")};var eh=m.JSON.stringify,ec=m.JSON.parse,ed=class{stringify(e){return m.JSON.stringify(e,void 0)}parse(e){return m.JSON.parse(e,void 0)}};function ef(){}function em(){}var eg={OPEN:"a",hb:"b",ERROR:"c",tb:"d"};function ep(){k.call(this,"d")}function ey(){k.call(this,"c")}v(ep,k),v(ey,k);var ew={},ev=null;function eb(){return ev=ev||new er}function ex(e){k.call(this,ew.Ia,e)}function eT(e){let t=eb();ei(t,new ex(t))}function eI(e,t){k.call(this,ew.STAT_EVENT,e),this.stat=t}function eS(e){let t=eb();ei(t,new eI(t,e))}function eE(e,t){k.call(this,ew.Ja,e),this.size=t}function e_(e,t){if("function"!=typeof e)throw Error("Fn must not be null and must be a function");return m.setTimeout(function(){e()},t)}function eC(){this.g=!0}function eA(e,t,n,r){e.info(function(){return"XMLHTTP TEXT ("+t+"): "+function(e,t){if(!e.g)return t;if(!t)return null;try{let s=JSON.parse(t);if(s){for(e=0;e<s.length;e++)if(Array.isArray(s[e])){var n=s[e];if(!(n.length<2)){var r=n[1];if(Array.isArray(r)&&!(r.length<1)){var i=r[0];if("noop"!=i&&"stop"!=i&&"close"!=i)for(let e=1;e<r.length;e++)r[e]=""}}}}return eh(s)}catch(e){return t}}(e,n)+(r?" "+r:"")})}ew.Ia="serverreachability",v(ex,k),ew.STAT_EVENT="statevent",v(eI,k),ew.Ja="timingevent",v(eE,k),eC.prototype.ua=function(){this.g=!1},eC.prototype.info=function(){};var eN={NO_ERROR:0,cb:1,qb:2,pb:3,kb:4,ob:5,rb:6,Ga:7,TIMEOUT:8,ub:9},eD={ib:"complete",Fb:"success",ERROR:"error",Ga:"abort",xb:"ready",yb:"readystatechange",TIMEOUT:"timeout",sb:"incrementaldata",wb:"progress",lb:"downloadprogress",Nb:"uploadprogress"};function ek(){}function eR(e){return encodeURIComponent(String(e))}function eP(e,t,n,r){this.j=e,this.i=t,this.l=n,this.S=r||1,this.V=new eo(this),this.H=45e3,this.J=null,this.o=!1,this.u=this.B=this.A=this.M=this.F=this.T=this.D=null,this.G=[],this.g=null,this.C=0,this.m=this.v=null,this.X=-1,this.K=!1,this.P=0,this.O=null,this.W=this.L=this.U=this.R=!1,this.h=new eO}function eO(){this.i=null,this.g="",this.h=!1}v(ek,ef),ek.prototype.g=function(){return new XMLHttpRequest},e=new ek;var eM={},eF={};function eV(e,t,n){e.M=1,e.A=e8(e2(t)),e.u=n,e.R=!0,eL(e,null)}function eL(e,t){e.F=Date.now(),eU(e),e.B=e2(e.A);var n,r,i,s,a,o,l=e.B,u=e.S;Array.isArray(u)||(u=[String(u)]),tc(l.i,"t",u),e.C=0,l=e.j.L,e.h=new eO,e.g=tY(e.j,l?t:null,!e.u),e.P>0&&(e.O=new ea(y(e.Y,e,e.g),e.P)),t=e.V,l=e.g,u=e.ba;var h="readystatechange";Array.isArray(h)||(h&&(el[0]=h.toString()),h=el);for(let e=0;e<h.length;e++){let n=function e(t,n,r,i,s){if(i&&i.once)return function e(t,n,r,i,s){if(Array.isArray(n)){for(let a=0;a<n.length;a++)e(t,n[a],r,i,s);return null}return r=en(r),t&&t[V]?t.K(n,r,g(i)?!!i.capture:!!i,s):J(t,n,r,!0,i,s)}(t,n,r,i,s);if(Array.isArray(n)){for(let a=0;a<n.length;a++)e(t,n[a],r,i,s);return null}return r=en(r),t&&t[V]?t.J(n,r,g(i)?!!i.capture:!!i,s):J(t,n,r,!1,i,s)}(l,h[e],u||t.handleEvent,!1,t.h||t);if(!n)break;t.g[n.key]=n}t=e.J?B(e.J):{},e.u?(e.v||(e.v="POST"),t["Content-Type"]="application/x-www-form-urlencoded",e.g.ea(e.B,e.v,e.u,t)):(e.v="GET",e.g.ea(e.B,e.v,null,t)),eT(),n=e.i,r=e.v,i=e.B,s=e.l,a=e.S,o=e.u,n.info(function(){if(n.g)if(o){var e="",t=o.split("&");for(let n=0;n<t.length;n++){var l=t[n].split("=");if(l.length>1){let t=l[0];l=l[1];let n=t.split("_");e=n.length>=2&&"type"==n[1]?e+(t+"=")+l+"&":e+(t+"=redacted&")}}}else e=null;else e=o;return"XMLHTTP REQ ("+s+") [attempt "+a+"]: "+r+"\n"+i+"\n"+e})}function ej(e){return!!e.g&&"GET"==e.v&&2!=e.M&&e.j.Aa}function eU(e){e.T=Date.now()+e.H,eq(e,e.H)}function eq(e,t){if(null!=e.D)throw Error("WatchDog timer not null");e.D=e_(y(e.aa,e),t)}function eB(e){e.D&&(m.clearTimeout(e.D),e.D=null)}function ez(e){0==e.j.I||e.K||tK(e.j,e)}function e$(e){eB(e);var t=e.O;t&&"function"==typeof t.dispose&&t.dispose(),e.O=null,eu(e.V),e.g&&(t=e.g,e.g=null,t.abort(),t.dispose())}function eG(e,t){try{var n=e.j;if(0!=n.I&&(n.g==e||eJ(n.h,e))){if(!e.L&&eJ(n.h,e)&&3==n.I){try{var r=n.Ba.g.parse(t)}catch(e){r=null}if(Array.isArray(r)&&3==r.length){var i=r;if(0==i[0]){e:if(!n.v){if(n.g)if(n.g.F+3e3<e.F)tG(n),tM(n);else break e;tB(n),eS(18)}}else n.xa=i[1],0<n.xa-n.K&&i[2]<37500&&n.F&&0==n.A&&!n.C&&(n.C=e_(y(n.Va,n),6e3));1>=eW(n.h)&&n.ta&&(n.ta=void 0)}else tH(n,11)}else if((e.L||n.g==e)&&tG(n),!P(t))for(i=n.Ba.g.parse(t),t=0;t<i.length;t++){let o=i[t],l=o[0];if(!(l<=n.K))if(n.K=l,o=o[1],2==n.I)if("c"==o[0]){n.M=o[1],n.ba=o[2];let t=o[3];null!=t&&(n.ka=t,n.j.info("VER="+n.ka));let i=o[4];null!=i&&(n.za=i,n.j.info("SVER="+n.za));let l=o[5];null!=l&&"number"==typeof l&&l>0&&(n.O=r=1.5*l,n.j.info("backChannelRequestTimeoutMs_="+r)),r=n;let u=e.g;if(u){let e=u.g?u.g.getResponseHeader("X-Client-Wire-Protocol"):null;if(e){var s=r.h;s.g||-1==e.indexOf("spdy")&&-1==e.indexOf("quic")&&-1==e.indexOf("h2")||(s.j=s.l,s.g=new Set,s.h&&(eY(s,s.h),s.h=null))}if(r.G){let e=u.g?u.g.getResponseHeader("X-HTTP-Session-Id"):null;e&&(r.wa=e,e6(r.J,r.G,e))}}if(n.I=3,n.l&&n.l.ra(),n.aa&&(n.T=Date.now()-e.F,n.j.info("Handshake RTT: "+n.T+"ms")),(r=n).na=tJ(r,r.L?r.ba:null,r.W),e.L){eX(r.h,e);var a=r.O;a&&(e.H=a),e.D&&(eB(e),eU(e)),r.g=e}else tq(r);n.i.length>0&&tV(n)}else"stop"!=o[0]&&"close"!=o[0]||tH(n,7);else 3==n.I&&("stop"==o[0]||"close"==o[0]?"stop"==o[0]?tH(n,7):tO(n):"noop"!=o[0]&&n.l&&n.l.qa(o),n.A=0)}}eT(4)}catch(e){}}eP.prototype.ba=function(e){e=e.target;let t=this.O;t&&3==tD(e)?t.j():this.Y(e)},eP.prototype.Y=function(e){try{if(e==this.g)e:{let d=tD(this.g),f=this.g.ya(),g=this.g.ca();if(!(d<3)&&(3!=d||this.g&&(this.h.h||this.g.la()||tk(this.g)))){this.K||4!=d||7==f||(8==f||g<=0?eT(3):eT(2)),eB(this);var t=this.g.ca();this.X=t;var n=function(e){if(!ej(e))return e.g.la();let t=tk(e.g);if(""===t)return"";let n="",r=t.length,i=4==tD(e.g);if(!e.h.i){if("u"<typeof TextDecoder)return e$(e),ez(e),"";e.h.i=new m.TextDecoder}for(let s=0;s<r;s++)e.h.h=!0,n+=e.h.i.decode(t[s],{stream:!(i&&s==r-1)});return t.length=0,e.h.g+=n,e.C=0,e.h.g}(this);if(this.o=200==t,r=this.i,i=this.v,s=this.B,a=this.l,o=this.S,r.info(function(){return"XMLHTTP RESP ("+a+") [ attempt "+o+"]: "+i+"\n"+s+"\n"+d+" "+t}),this.o){if(this.U&&!this.L){t:{if(this.g){var r,i,s,a,o,l,u=this.g;if((l=u.g?u.g.getResponseHeader("X-HTTP-Initial-Response"):null)&&!P(l)){var h=l;break t}}h=null}if(e=h)eA(this.i,this.l,e,"Initial handshake response via X-HTTP-Initial-Response"),this.L=!0,eG(this,e);else{this.o=!1,this.m=3,eS(12),e$(this),ez(this);break e}}if(this.R){let t;for(e=!0;!this.K&&this.C<n.length;)if((t=function(e,t){var n=e.C,r=t.indexOf("\n",n);return -1==r?eF:isNaN(n=Number(t.substring(n,r)))?eM:(r+=1)+n>t.length?eF:(t=t.slice(r,r+n),e.C=r+n,t)}(this,n))==eF){4==d&&(this.m=4,eS(14),e=!1),eA(this.i,this.l,null,"[Incomplete Response]");break}else if(t==eM){this.m=4,eS(15),eA(this.i,this.l,n,"[Invalid Chunk]"),e=!1;break}else eA(this.i,this.l,t,null),eG(this,t);if(ej(this)&&0!=this.C&&(this.h.g=this.h.g.slice(this.C),this.C=0),4!=d||0!=n.length||this.h.h||(this.m=1,eS(16),e=!1),this.o=this.o&&e,e){if(n.length>0&&!this.W){this.W=!0;var c=this.j;c.g==this&&c.aa&&!c.P&&(c.j.info("Great, no buffering proxy detected. Bytes received: "+n.length),tz(c),c.P=!0,eS(11))}}else eA(this.i,this.l,n,"[Invalid Chunked Response]"),e$(this),ez(this)}else eA(this.i,this.l,n,null),eG(this,n);4==d&&e$(this),this.o&&!this.K&&(4==d?tK(this.j,this):(this.o=!1,eU(this)))}else(function(e){let t={};e=(e.g&&tD(e)>=2&&e.g.getAllResponseHeaders()||"").split("\r\n");for(let r=0;r<e.length;r++){if(P(e[r]))continue;var n=function(e){var t=1;e=e.split(":");let n=[];for(;t>0&&e.length;)n.push(e.shift()),t--;return e.length&&n.push(e.join(":")),n}(e[r]);let i=n[0];if("string"!=typeof(n=n[1]))continue;n=n.trim();let s=t[i]||[];t[i]=s,s.push(n)}var r=function(e){return e.join(", ")};for(let e in t)r.call(void 0,t[e],e,t)})(this.g),400==t&&n.indexOf("Unknown SID")>0?(this.m=3,eS(12)):(this.m=0,eS(13)),e$(this),ez(this)}}}catch(e){}finally{}},eP.prototype.cancel=function(){this.K=!0,e$(this)},eP.prototype.aa=function(){var e,t;this.D=null;let n=Date.now();n-this.T>=0?(e=this.i,t=this.B,e.info(function(){return"TIMEOUT: "+t}),2!=this.M&&(eT(),eS(17)),e$(this),this.m=2,ez(this)):eq(this,this.T-n)};var eK=class{constructor(e,t){this.g=e,this.map=t}};function eQ(e){this.l=e||10,e=m.PerformanceNavigationTiming?(e=m.performance.getEntriesByType("navigation")).length>0&&("hq"==e[0].nextHopProtocol||"h2"==e[0].nextHopProtocol):!!(m.chrome&&m.chrome.loadTimes&&m.chrome.loadTimes()&&m.chrome.loadTimes().wasFetchedViaSpdy),this.j=e?this.l:1,this.g=null,this.j>1&&(this.g=new Set),this.h=null,this.i=[]}function eH(e){return!!e.h||!!e.g&&e.g.size>=e.j}function eW(e){return e.h?1:e.g?e.g.size:0}function eJ(e,t){return e.h?e.h==t:!!e.g&&e.g.has(t)}function eY(e,t){e.g?e.g.add(t):e.h=t}function eX(e,t){e.h&&e.h==t?e.h=null:e.g&&e.g.has(t)&&e.g.delete(t)}function eZ(e){if(null!=e.h)return e.i.concat(e.h.G);if(null!=e.g&&0!==e.g.size){let t=e.i;for(let n of e.g.values())t=t.concat(n.G);return t}return x(e.i)}eQ.prototype.cancel=function(){if(this.i=eZ(this),this.h)this.h.cancel(),this.h=null;else if(this.g&&0!==this.g.size){for(let e of this.g.values())e.cancel();this.g.clear()}};var e0=RegExp("^(?:([^:/?#.]+):)?(?://(?:([^\\\\/?#]*)@)?([^\\\\/?#]*?)(?::([0-9]+))?(?=[\\\\/?#]|$))?([^?#]+)?(?:\\?([^#]*))?(?:#([\\s\\S]*))?$");function e1(e){let t;this.g=this.o=this.j="",this.u=null,this.m=this.h="",this.l=!1,e instanceof e1?(this.l=e.l,e5(this,e.j),this.o=e.o,this.g=e.g,e4(this,e.u),this.h=e.h,e3(this,td(e.i)),this.m=e.m):e&&(t=String(e).match(e0))?(this.l=!1,e5(this,t[1]||"",!0),this.o=e7(t[2]||""),this.g=e7(t[3]||"",!0),e4(this,t[4]),this.h=e7(t[5]||"",!0),e3(this,t[6]||"",!0),this.m=e7(t[7]||"")):(this.l=!1,this.i=new ta(null,this.l))}function e2(e){return new e1(e)}function e5(e,t,n){e.j=n?e7(t,!0):t,e.j&&(e.j=e.j.replace(/:$/,""))}function e4(e,t){if(t){if(isNaN(t=Number(t))||t<0)throw Error("Bad port number "+t);e.u=t}else e.u=null}function e3(e,t,n){var r,i;t instanceof ta?(e.i=t,r=e.i,(i=e.l)&&!r.j&&(to(r),r.i=null,r.g.forEach(function(e,t){let n=t.toLowerCase();t!=n&&(tl(this,t),tc(this,n,e))},r)),r.j=i):(n||(t=e9(t,ti)),e.i=new ta(t,e.l))}function e6(e,t,n){e.i.set(t,n)}function e8(e){return e6(e,"zx",Math.floor(0x80000000*Math.random()).toString(36)+Math.abs(Math.floor(0x80000000*Math.random())^Date.now()).toString(36)),e}function e7(e,t){return e?t?decodeURI(e.replace(/%25/g,"%2525")):decodeURIComponent(e):""}function e9(e,t,n){return"string"==typeof e?(e=encodeURI(e).replace(t,te),n&&(e=e.replace(/%25([0-9a-fA-F]{2})/g,"%$1")),e):null}function te(e){return"%"+((e=e.charCodeAt(0))>>4&15).toString(16)+(15&e).toString(16)}e1.prototype.toString=function(){let e=[];var t=this.j;t&&e.push(e9(t,tt,!0),":");var n=this.g;return(n||"file"==t)&&(e.push("//"),(t=this.o)&&e.push(e9(t,tt,!0),"@"),e.push(eR(n).replace(/%25([0-9a-fA-F]{2})/g,"%$1")),null!=(n=this.u)&&e.push(":",String(n))),(n=this.h)&&(this.g&&"/"!=n.charAt(0)&&e.push("/"),e.push(e9(n,"/"==n.charAt(0)?tr:tn,!0))),(n=this.i.toString())&&e.push("?",n),(n=this.m)&&e.push("#",e9(n,ts)),e.join("")},e1.prototype.resolve=function(e){let t=e2(this),n=!!e.j;n?e5(t,e.j):n=!!e.o,n?t.o=e.o:n=!!e.g,n?t.g=e.g:n=null!=e.u;var r=e.h;if(n)e4(t,e.u);else if(n=!!e.h){if("/"!=r.charAt(0))if(this.g&&!this.h)r="/"+r;else{var i=t.h.lastIndexOf("/");-1!=i&&(r=t.h.slice(0,i+1)+r)}if(".."==(i=r)||"."==i)r="";else if(-1!=i.indexOf("./")||-1!=i.indexOf("/.")){r=0==i.lastIndexOf("/",0),i=i.split("/");let e=[];for(let t=0;t<i.length;){let n=i[t++];"."==n?r&&t==i.length&&e.push(""):".."==n?((e.length>1||1==e.length&&""!=e[0])&&e.pop(),r&&t==i.length&&e.push("")):(e.push(n),r=!0)}r=e.join("/")}else r=i}return n?t.h=r:n=""!==e.i.toString(),n?e3(t,td(e.i)):n=!!e.m,n&&(t.m=e.m),t};var tt=/[#\/\?@]/g,tn=/[#\?:]/g,tr=/[#\?]/g,ti=/[#\?@]/g,ts=/#/g;function ta(e,t){this.h=this.g=null,this.i=e||null,this.j=!!t}function to(e){e.g||(e.g=new Map,e.h=0,e.i&&function(e,t){if(e){e=e.split("&");for(let n=0;n<e.length;n++){let r=e[n].indexOf("="),i,s=null;r>=0?(i=e[n].substring(0,r),s=e[n].substring(r+1)):i=e[n],t(i,s?decodeURIComponent(s.replace(/\+/g," ")):"")}}}(e.i,function(t,n){e.add(decodeURIComponent(t.replace(/\+/g," ")),n)}))}function tl(e,t){to(e),t=tf(e,t),e.g.has(t)&&(e.i=null,e.h-=e.g.get(t).length,e.g.delete(t))}function tu(e,t){return to(e),t=tf(e,t),e.g.has(t)}function th(e,t){to(e);let n=[];if("string"==typeof t)tu(e,t)&&(n=n.concat(e.g.get(tf(e,t))));else for(e=Array.from(e.g.values()),t=0;t<e.length;t++)n=n.concat(e[t]);return n}function tc(e,t,n){tl(e,t),n.length>0&&(e.i=null,e.g.set(tf(e,t),x(n)),e.h+=n.length)}function td(e){let t=new ta;return t.i=e.i,e.g&&(t.g=new Map(e.g),t.h=e.h),t}function tf(e,t){return t=String(t),e.j&&(t=t.toLowerCase()),t}function tm(e,t,n,r,i){try{i&&(i.onload=null,i.onerror=null,i.onabort=null,i.ontimeout=null),r(n)}catch(e){}}function tg(){this.g=new ed}function tp(e){this.i=e.Sb||null,this.h=e.ab||!1}function ty(e,t){er.call(this),this.H=e,this.o=t,this.m=void 0,this.status=this.readyState=0,this.responseType=this.responseText=this.response=this.statusText="",this.onreadystatechange=null,this.A=new Headers,this.h=null,this.F="GET",this.D="",this.g=!1,this.B=this.j=this.l=null,this.v=new AbortController}function tw(e){e.j.read().then(e.Ma.bind(e)).catch(e.ga.bind(e))}function tv(e){e.readyState=4,e.l=null,e.j=null,e.B=null,tb(e)}function tb(e){e.onreadystatechange&&e.onreadystatechange.call(e)}function tx(e){let t="";return q(e,function(e,n){t+=n,t+=":",t+=e,t+="\r\n"}),t}function tT(e,t,n){e:{for(r in n){var r=!1;break e}r=!0}r||(n=tx(n),"string"==typeof e?null!=n&&eR(n):e6(e,t,n))}function tI(e){er.call(this),this.headers=new Map,this.L=e||null,this.h=!1,this.g=null,this.D="",this.o=0,this.l="",this.j=this.B=this.v=this.A=!1,this.m=null,this.F="",this.H=!1}(t=ta.prototype).add=function(e,t){to(this),this.i=null,e=tf(this,e);let n=this.g.get(e);return n||this.g.set(e,n=[]),n.push(t),this.h+=1,this},t.forEach=function(e,t){to(this),this.g.forEach(function(n,r){n.forEach(function(n){e.call(t,n,r,this)},this)},this)},t.set=function(e,t){return to(this),this.i=null,tu(this,e=tf(this,e))&&(this.h-=this.g.get(e).length),this.g.set(e,[t]),this.h+=1,this},t.get=function(e,t){return e&&(e=th(this,e)).length>0?String(e[0]):t},t.toString=function(){if(this.i)return this.i;if(!this.g)return"";let e=[],t=Array.from(this.g.keys());for(let r=0;r<t.length;r++){var n=t[r];let i=eR(n);n=th(this,n);for(let t=0;t<n.length;t++){let r=i;""!==n[t]&&(r+="="+eR(n[t])),e.push(r)}}return this.i=e.join("&")},v(tp,ef),tp.prototype.g=function(){return new ty(this.i,this.h)},v(ty,er),(t=ty.prototype).open=function(e,t){if(0!=this.readyState)throw this.abort(),Error("Error reopening a connection");this.F=e,this.D=t,this.readyState=1,tb(this)},t.send=function(e){if(1!=this.readyState)throw this.abort(),Error("need to call open() first. ");if(this.v.signal.aborted)throw this.abort(),Error("Request was aborted.");this.g=!0;let t={headers:this.A,method:this.F,credentials:this.m,cache:void 0,signal:this.v.signal};e&&(t.body=e),(this.H||m).fetch(new Request(this.D,t)).then(this.Pa.bind(this),this.ga.bind(this))},t.abort=function(){this.response=this.responseText="",this.A=new Headers,this.status=0,this.v.abort(),this.j&&this.j.cancel("Request was aborted.").catch(()=>{}),this.readyState>=1&&this.g&&4!=this.readyState&&(this.g=!1,tv(this)),this.readyState=0},t.Pa=function(e){if(this.g&&(this.l=e,this.h||(this.status=this.l.status,this.statusText=this.l.statusText,this.h=e.headers,this.readyState=2,tb(this)),this.g&&(this.readyState=3,tb(this),this.g)))if("arraybuffer"===this.responseType)e.arrayBuffer().then(this.Na.bind(this),this.ga.bind(this));else if(void 0!==m.ReadableStream&&"body"in e){if(this.j=e.body.getReader(),this.o){if(this.responseType)throw Error('responseType must be empty for "streamBinaryChunks" mode responses.');this.response=[]}else this.response=this.responseText="",this.B=new TextDecoder;tw(this)}else e.text().then(this.Oa.bind(this),this.ga.bind(this))},t.Ma=function(e){if(this.g){if(this.o&&e.value)this.response.push(e.value);else if(!this.o){var t=e.value?e.value:new Uint8Array(0);(t=this.B.decode(t,{stream:!e.done}))&&(this.response=this.responseText+=t)}e.done?tv(this):tb(this),3==this.readyState&&tw(this)}},t.Oa=function(e){this.g&&(this.response=this.responseText=e,tv(this))},t.Na=function(e){this.g&&(this.response=e,tv(this))},t.ga=function(){this.g&&tv(this)},t.setRequestHeader=function(e,t){this.A.append(e,t)},t.getResponseHeader=function(e){return this.h&&this.h.get(e.toLowerCase())||""},t.getAllResponseHeaders=function(){if(!this.h)return"";let e=[],t=this.h.entries();for(var n=t.next();!n.done;)e.push((n=n.value)[0]+": "+n[1]),n=t.next();return e.join("\r\n")},Object.defineProperty(ty.prototype,"withCredentials",{get:function(){return"include"===this.m},set:function(e){this.m=e?"include":"same-origin"}}),v(tI,er);var tS=/^https?$/i,tE=["POST","PUT"];function t_(e,t){e.h=!1,e.g&&(e.j=!0,e.g.abort(),e.j=!1),e.l=t,e.o=5,tC(e),tN(e)}function tC(e){e.A||(e.A=!0,ei(e,"complete"),ei(e,"error"))}function tA(e){if(e.h&&void 0!==f){if(e.v&&4==tD(e))setTimeout(e.Ca.bind(e),0);else if(ei(e,"readystatechange"),4==tD(e)){e.h=!1;try{let s=e.ca();switch(s){case 200:case 201:case 202:case 204:case 206:case 304:case 1223:var t,n,r=!0;break;default:r=!1}if(!(t=r)){if(n=0===s){let t=String(e.D).match(e0)[1]||null;!t&&m.self&&m.self.location&&(t=m.self.location.protocol.slice(0,-1)),n=!tS.test(t?t.toLowerCase():"")}t=n}if(t)ei(e,"complete"),ei(e,"success");else{e.o=6;try{var i=tD(e)>2?e.g.statusText:""}catch(e){i=""}e.l=i+" ["+e.ca()+"]",tC(e)}}finally{tN(e)}}}}function tN(e,t){if(e.g){e.m&&(clearTimeout(e.m),e.m=null);let n=e.g;e.g=null,t||ei(e,"ready");try{n.onreadystatechange=null}catch(e){}}}function tD(e){return e.g?e.g.readyState:0}function tk(e){try{if(!e.g)return null;if("response"in e.g)return e.g.response;switch(e.F){case"":case"text":return e.g.responseText;case"arraybuffer":if("mozResponseArrayBuffer"in e.g)return e.g.mozResponseArrayBuffer}return null}catch(e){return null}}function tR(e,t,n){return n&&n.internalChannelParams&&n.internalChannelParams[e]||t}function tP(e){this.za=0,this.i=[],this.j=new eC,this.ba=this.na=this.J=this.W=this.g=this.wa=this.G=this.H=this.u=this.U=this.o=null,this.Ya=this.V=0,this.Sa=tR("failFast",!1,e),this.F=this.C=this.v=this.m=this.l=null,this.X=!0,this.xa=this.K=-1,this.Y=this.A=this.D=0,this.Qa=tR("baseRetryDelayMs",5e3,e),this.Za=tR("retryDelaySeedMs",1e4,e),this.Ta=tR("forwardChannelMaxRetries",2,e),this.va=tR("forwardChannelRequestTimeoutMs",2e4,e),this.ma=e&&e.xmlHttpFactory||void 0,this.Ua=e&&e.Rb||void 0,this.Aa=e&&e.useFetchStreams||!1,this.O=void 0,this.L=e&&e.supportsCrossDomainXhr||!1,this.M="",this.h=new eQ(e&&e.concurrentRequestLimit),this.Ba=new tg,this.S=e&&e.fastHandshake||!1,this.R=e&&e.encodeInitMessageHeaders||!1,this.S&&this.R&&(this.R=!1),this.Ra=e&&e.Pb||!1,e&&e.ua&&this.j.ua(),e&&e.forceLongPolling&&(this.X=!1),this.aa=!this.S&&this.X&&e&&e.detectBufferingProxy||!1,this.ia=void 0,e&&e.longPollingTimeout&&e.longPollingTimeout>0&&(this.ia=e.longPollingTimeout),this.ta=void 0,this.T=0,this.P=!1,this.ja=this.B=null}function tO(e){if(tF(e),3==e.I){var t=e.V++,n=e2(e.J);if(e6(n,"SID",e.M),e6(n,"RID",t),e6(n,"TYPE","terminate"),tj(e,n),(t=new eP(e,e.j,t)).M=2,t.A=e8(e2(n)),n=!1,m.navigator&&m.navigator.sendBeacon)try{n=m.navigator.sendBeacon(t.A.toString(),"")}catch(e){}!n&&m.Image&&((new Image).src=t.A,n=!0),n||(t.g=tY(t.j,null),t.g.ea(t.A)),t.F=Date.now(),eU(t)}tW(e)}function tM(e){e.g&&(tz(e),e.g.cancel(),e.g=null)}function tF(e){tM(e),e.v&&(m.clearTimeout(e.v),e.v=null),tG(e),e.h.cancel(),e.m&&("number"==typeof e.m&&m.clearTimeout(e.m),e.m=null)}function tV(e){if(!eH(e.h)&&!e.m){e.m=!0;var t=e.Ea;E||A(),_||(E(),_=!0),C.add(t,e),e.D=0}}function tL(e,t){var n;n=t?t.l:e.V++;let r=e2(e.J);e6(r,"SID",e.M),e6(r,"RID",n),e6(r,"AID",e.K),tj(e,r),e.u&&e.o&&tT(r,e.u,e.o),n=new eP(e,e.j,n,e.D+1),null===e.u&&(n.J=e.o),t&&(e.i=t.G.concat(e.i)),t=tU(e,n,1e3),n.H=Math.round(.5*e.va)+Math.round(.5*e.va*Math.random()),eY(e.h,n),eV(n,r,t)}function tj(e,t){e.H&&q(e.H,function(e,n){e6(t,n,e)}),e.l&&q({},function(e,n){e6(t,n,e)})}function tU(e,t,n){n=Math.min(e.i.length,n);let r=e.l?y(e.l.Ka,e.l,e):null;e:{var i=e.i;let t=-1;for(;;){let e=["count="+n];-1==t?n>0?(t=i[0].g,e.push("ofs="+t)):t=0:e.push("ofs="+t);let o=!0;for(let l=0;l<n;l++){var s=i[l].g;let n=i[l].map;if((s-=t)<0)t=Math.max(0,i[l].g-100),o=!1;else try{s="req"+s+"_";try{var a=n instanceof Map?n:Object.entries(n);for(let[t,n]of a){let r=n;g(n)&&(r=eh(n)),e.push(s+t+"="+encodeURIComponent(r))}}catch(t){throw e.push(s+"type="+encodeURIComponent("_badmap")),t}}catch(e){r&&r(n)}}if(o){a=e.join("&");break e}}a=void 0}return t.G=e=e.i.splice(0,n),a}function tq(e){if(!e.g&&!e.v){e.Y=1;var t=e.Da;E||A(),_||(E(),_=!0),C.add(t,e),e.A=0}}function tB(e){return!e.g&&!e.v&&!(e.A>=3)&&(e.Y++,e.v=e_(y(e.Da,e),tQ(e,e.A)),e.A++,!0)}function tz(e){null!=e.B&&(m.clearTimeout(e.B),e.B=null)}function t$(e){e.g=new eP(e,e.j,"rpc",e.Y),null===e.u&&(e.g.J=e.o),e.g.P=0;var t=e2(e.na);e6(t,"RID","rpc"),e6(t,"SID",e.M),e6(t,"AID",e.K),e6(t,"CI",e.F?"0":"1"),!e.F&&e.ia&&e6(t,"TO",e.ia),e6(t,"TYPE","xmlhttp"),tj(e,t),e.u&&e.o&&tT(t,e.u,e.o),e.O&&(e.g.H=e.O);var n=e.g;e=e.ba,n.M=1,n.A=e8(e2(t)),n.u=null,n.R=!0,eL(n,e)}function tG(e){null!=e.C&&(m.clearTimeout(e.C),e.C=null)}function tK(e,t){var n,r=null;if(e.g==t){tG(e),tz(e),e.g=null;var i=2}else{if(!eJ(e.h,t))return;r=t.G,eX(e.h,t),i=1}if(0!=e.I){if(t.o)if(1==i){r=t.u?t.u.length:0,t=Date.now()-t.F;var s=e.D;ei(i=eb(),new eE(i,r)),tV(e)}else tq(e);else if(3==(s=t.m)||0==s&&t.X>0||!(1==i&&(n=t,!(eW(e.h)>=e.h.j-!!e.m)&&(e.m?(e.i=n.G.concat(e.i),!0):1!=e.I&&2!=e.I&&!(e.D>=(e.Sa?0:e.Ta))&&(e.m=e_(y(e.Ea,e,n),tQ(e,e.D)),e.D++,!0)))||2==i&&tB(e)))switch(r&&r.length>0&&((t=e.h).i=t.i.concat(r)),s){case 1:tH(e,5);break;case 4:tH(e,10);break;case 3:tH(e,6);break;default:tH(e,2)}}}function tQ(e,t){let n=e.Qa+Math.floor(Math.random()*e.Za);return e.isActive()||(n*=2),n*t}function tH(e,t){if(e.j.info("Error code "+t),2==t){let t,s,a;var n,r=y(e.bb,e),i=e.Ua;let o=!i;i=new e1(i||"//www.google.com/images/cleardot.gif"),m.location&&"http"==m.location.protocol||e5(i,"https"),e8(i),o?function(e,t){let n=new eC;if(m.Image){let r=new Image;r.onload=w(tm,n,"TestLoadImage: loaded",!0,t,r),r.onerror=w(tm,n,"TestLoadImage: error",!1,t,r),r.onabort=w(tm,n,"TestLoadImage: abort",!1,t,r),r.ontimeout=w(tm,n,"TestLoadImage: timeout",!1,t,r),m.setTimeout(function(){r.ontimeout&&r.ontimeout()},1e4),r.src=e}else t(!1)}(i.toString(),r):(n=i.toString(),t=new eC,s=new AbortController,a=setTimeout(()=>{s.abort(),tm(t,"TestPingServer: timeout",!1,r)},1e4),fetch(n,{signal:s.signal}).then(e=>{clearTimeout(a),e.ok?tm(t,"TestPingServer: ok",!0,r):tm(t,"TestPingServer: server error",!1,r)}).catch(()=>{clearTimeout(a),tm(t,"TestPingServer: error",!1,r)}))}else eS(2);e.I=0,e.l&&e.l.pa(t),tW(e),tF(e)}function tW(e){if(e.I=0,e.ja=[],e.l){let t=eZ(e.h);(0!=t.length||0!=e.i.length)&&(T(e.ja,t),T(e.ja,e.i),e.h.i.length=0,x(e.i),e.i.length=0),e.l.oa()}}function tJ(e,t,n){var r=n instanceof e1?e2(n):new e1(n);if(""!=r.g)t&&(r.g=t+"."+r.g),e4(r,r.u);else{var i=m.location;r=i.protocol,t=t?t+"."+i.hostname:i.hostname,i=+i.port;let e=new e1(null);r&&e5(e,r),t&&(e.g=t),i&&e4(e,i),n&&(e.h=n),r=e}return n=e.G,t=e.wa,n&&t&&e6(r,n,t),e6(r,"VER",e.ka),tj(e,r),r}function tY(e,t,n){if(t&&!e.L)throw Error("Can't create secondary domain capable XhrIo object.");return(t=new tI(e.Aa&&!e.ma?new tp({ab:n}):e.ma)).Fa(e.L),t}function tX(){}function tZ(){}function t0(e,t){er.call(this),this.g=new tP(t),this.l=e,this.h=t&&t.messageUrlParams||null,e=t&&t.messageHeaders||null,t&&t.clientProtocolHeaderRequired&&(e?e["X-Client-Protocol"]="webchannel":e={"X-Client-Protocol":"webchannel"}),this.g.o=e,e=t&&t.initMessageHeaders||null,t&&t.messageContentType&&(e?e["X-WebChannel-Content-Type"]=t.messageContentType:e={"X-WebChannel-Content-Type":t.messageContentType}),t&&t.sa&&(e?e["X-WebChannel-Client-Profile"]=t.sa:e={"X-WebChannel-Client-Profile":t.sa}),this.g.U=e,(e=t&&t.Qb)&&!P(e)&&(this.g.u=e),this.A=t&&t.supportsCrossDomainXhr||!1,this.v=t&&t.sendRawJson||!1,(t=t&&t.httpSessionIdParam)&&!P(t)&&(this.g.G=t,null!==(e=this.h)&&t in e&&t in(e=this.h)&&delete e[t]),this.j=new t5(this)}function t1(e){ep.call(this),e.__headers__&&(this.headers=e.__headers__,this.statusCode=e.__status__,delete e.__headers__,delete e.__status__);var t=e.__sm__;if(t){e:{for(let n in t){e=n;break e}e=void 0}(this.i=e)&&(e=this.i,t=null!==t&&e in t?t[e]:void 0),this.data=t}else this.data=e}function t2(){ey.call(this),this.status=1}function t5(e){this.g=e}(t=tI.prototype).Fa=function(e){this.H=e},t.ea=function(t,n,r,i){if(this.g)throw Error("[goog.net.XhrIo] Object is active with another request="+this.D+"; newUri="+t);n=n?n.toUpperCase():"GET",this.D=t,this.l="",this.o=0,this.A=!1,this.h=!0,this.g=this.L?this.L.g():e.g(),this.g.onreadystatechange=b(y(this.Ca,this));try{this.B=!0,this.g.open(n,String(t),!0),this.B=!1}catch(e){t_(this,e);return}if(t=r||"",r=new Map(this.headers),i)if(Object.getPrototypeOf(i)===Object.prototype)for(var s in i)r.set(s,i[s]);else if("function"==typeof i.keys&&"function"==typeof i.get)for(let e of i.keys())r.set(e,i.get(e));else throw Error("Unknown input type for opt_headers: "+String(i));for(let[e,a]of(i=Array.from(r.keys()).find(e=>"content-type"==e.toLowerCase()),s=m.FormData&&t instanceof m.FormData,!(Array.prototype.indexOf.call(tE,n,void 0)>=0)||i||s||r.set("Content-Type","application/x-www-form-urlencoded;charset=utf-8"),r))this.g.setRequestHeader(e,a);this.F&&(this.g.responseType=this.F),"withCredentials"in this.g&&this.g.withCredentials!==this.H&&(this.g.withCredentials=this.H);try{this.m&&(clearTimeout(this.m),this.m=null),this.v=!0,this.g.send(t),this.v=!1}catch(e){t_(this,e)}},t.abort=function(e){this.g&&this.h&&(this.h=!1,this.j=!0,this.g.abort(),this.j=!1,this.o=e||7,ei(this,"complete"),ei(this,"abort"),tN(this))},t.N=function(){this.g&&(this.h&&(this.h=!1,this.j=!0,this.g.abort(),this.j=!1),tN(this,!0)),tI.Z.N.call(this)},t.Ca=function(){this.u||(this.B||this.v||this.j?tA(this):this.Xa())},t.Xa=function(){tA(this)},t.isActive=function(){return!!this.g},t.ca=function(){try{return tD(this)>2?this.g.status:-1}catch(e){return -1}},t.la=function(){try{return this.g?this.g.responseText:""}catch(e){return""}},t.La=function(e){if(this.g){var t=this.g.responseText;return e&&0==t.indexOf(e)&&(t=t.substring(e.length)),ec(t)}},t.ya=function(){return this.o},t.Ha=function(){return"string"==typeof this.l?this.l:String(this.l)},(t=tP.prototype).ka=8,t.I=1,t.connect=function(e,t,n,r){eS(0),this.W=e,this.H=t||{},n&&void 0!==r&&(this.H.OSID=n,this.H.OAID=r),this.F=this.X,this.J=tJ(this,null,this.W),tV(this)},t.Ea=function(e){if(this.m)if(this.m=null,1==this.I){if(!e){this.V=Math.floor(1e5*Math.random()),e=this.V++;let i=new eP(this,this.j,e),s=this.o;if(this.U&&(s?$(s=B(s),this.U):s=this.U),null!==this.u||this.R||(i.J=s,s=null),this.S)e:{for(var t=0,n=0;n<this.i.length;n++){t:{var r=this.i[n];if("__data__"in r.map&&"string"==typeof(r=r.map.__data__)){r=r.length;break t}r=void 0}if(void 0===r)break;if((t+=r)>4096){t=n;break e}if(4096===t||n===this.i.length-1){t=n+1;break e}}t=1e3}else t=1e3;t=tU(this,i,t),e6(n=e2(this.J),"RID",e),e6(n,"CVER",22),this.G&&e6(n,"X-HTTP-Session-Id",this.G),tj(this,n),s&&(this.R?t="headers="+eR(tx(s))+"&"+t:this.u&&tT(n,this.u,s)),eY(this.h,i),this.Ra&&e6(n,"TYPE","init"),this.S?(e6(n,"$req",t),e6(n,"SID","null"),i.U=!0,eV(i,n,null)):eV(i,n,t),this.I=2}}else 3==this.I&&(e?tL(this,e):0==this.i.length||eH(this.h)||tL(this))},t.Da=function(){if(this.v=null,t$(this),this.aa&&!(this.P||null==this.g||this.T<=0)){var e=4*this.T;this.j.info("BP detection timer enabled: "+e),this.B=e_(y(this.Wa,this),e)}},t.Wa=function(){this.B&&(this.B=null,this.j.info("BP detection timeout reached."),this.j.info("Buffering proxy detected and switch to long-polling!"),this.F=!1,this.P=!0,eS(10),tM(this),t$(this))},t.Va=function(){null!=this.C&&(this.C=null,tM(this),tB(this),eS(19))},t.bb=function(e){e?(this.j.info("Successfully pinged google.com"),eS(2)):(this.j.info("Failed to ping google.com"),eS(1))},t.isActive=function(){return!!this.l&&this.l.isActive(this)},(t=tX.prototype).ra=function(){},t.qa=function(){},t.pa=function(){},t.oa=function(){},t.isActive=function(){return!0},t.Ka=function(){},tZ.prototype.g=function(e,t){return new t0(e,t)},v(t0,er),t0.prototype.m=function(){this.g.l=this.j,this.A&&(this.g.L=!0),this.g.connect(this.l,this.h||void 0)},t0.prototype.close=function(){tO(this.g)},t0.prototype.o=function(e){var t=this.g;if("string"==typeof e){var n={};n.__data__=e,e=n}else this.v&&((n={}).__data__=eh(e),e=n);t.i.push(new eK(t.Ya++,e)),3==t.I&&tV(t)},t0.prototype.N=function(){this.g.l=null,delete this.j,tO(this.g),delete this.g,t0.Z.N.call(this)},v(t1,ep),v(t2,ey),v(t5,tX),t5.prototype.ra=function(){ei(this.g,"a")},t5.prototype.qa=function(e){ei(this.g,new t1(e))},t5.prototype.pa=function(e){ei(this.g,new t2)},t5.prototype.oa=function(){ei(this.g,"b")},tZ.prototype.createWebChannel=tZ.prototype.g,t0.prototype.send=t0.prototype.o,t0.prototype.open=t0.prototype.m,t0.prototype.close=t0.prototype.close,c=F.createWebChannelTransport=function(){return new tZ},h=F.getStatEventTarget=function(){return eb()},u=F.Event=ew,l=F.Stat={jb:0,mb:1,nb:2,Hb:3,Mb:4,Jb:5,Kb:6,Ib:7,Gb:8,Lb:9,PROXY:10,NOPROXY:11,Eb:12,Ab:13,Bb:14,zb:15,Cb:16,Db:17,fb:18,eb:19,gb:20},eN.NO_ERROR=0,eN.TIMEOUT=8,eN.HTTP_ERROR=6,o=F.ErrorCode=eN,eD.COMPLETE="complete",a=F.EventType=eD,em.EventType=eg,eg.OPEN="a",eg.CLOSE="b",eg.ERROR="c",eg.MESSAGE="d",er.prototype.listen=er.prototype.J,s=F.WebChannel=em,F.FetchXmlHttpFactory=tp,tI.prototype.listenOnce=tI.prototype.K,tI.prototype.getLastError=tI.prototype.Ha,tI.prototype.getLastErrorCode=tI.prototype.ya,tI.prototype.getStatus=tI.prototype.ca,tI.prototype.getResponseJson=tI.prototype.La,tI.prototype.getResponseText=tI.prototype.la,tI.prototype.send=tI.prototype.ea,tI.prototype.setWithCredentials=tI.prototype.Fa,i=F.XhrIo=tI}).apply(void 0!==M?M:"u">typeof self?self:"u">typeof window?window:{});class V{constructor(e){this.uid=e}isAuthenticated(){return null!=this.uid}toKey(){return this.isAuthenticated()?"uid:"+this.uid:"anonymous-user"}isEqual(e){return e.uid===this.uid}}V.UNAUTHENTICATED=new V(null),V.GOOGLE_CREDENTIALS=new V("google-credentials-uid"),V.FIRST_PARTY=new V("first-party-uid"),V.MOCK_USER=new V("mock-user");let L="12.8.0",j=new O.Logger("@firebase/firestore");function U(){return j.logLevel}function q(e,...t){if(j.logLevel<=O.LogLevel.DEBUG){let n=t.map($);j.debug(`Firestore (${L}): ${e}`,...n)}}function B(e,...t){if(j.logLevel<=O.LogLevel.ERROR){let n=t.map($);j.error(`Firestore (${L}): ${e}`,...n)}}function z(e,...t){if(j.logLevel<=O.LogLevel.WARN){let n=t.map($);j.warn(`Firestore (${L}): ${e}`,...n)}}function $(e){if("string"==typeof e)return e;try{return JSON.stringify(e)}catch(t){return e}}function G(e,t,n){let r="Unexpected state";"string"==typeof t?r=t:n=t,K(e,r,n)}function K(e,t,n){let r=`FIRESTORE (${L}) INTERNAL ASSERTION FAILED: ${t} (ID: ${e.toString(16)})`;if(void 0!==n)try{r+=" CONTEXT: "+JSON.stringify(n)}catch(e){r+=" CONTEXT: "+n}throw B(r),Error(r)}function Q(e,t,n,r){let i="Unexpected state";"string"==typeof n?i=n:r=n,e||K(t,i,r)}let H={OK:"ok",CANCELLED:"cancelled",UNKNOWN:"unknown",INVALID_ARGUMENT:"invalid-argument",DEADLINE_EXCEEDED:"deadline-exceeded",NOT_FOUND:"not-found",ALREADY_EXISTS:"already-exists",PERMISSION_DENIED:"permission-denied",UNAUTHENTICATED:"unauthenticated",RESOURCE_EXHAUSTED:"resource-exhausted",FAILED_PRECONDITION:"failed-precondition",ABORTED:"aborted",OUT_OF_RANGE:"out-of-range",UNIMPLEMENTED:"unimplemented",INTERNAL:"internal",UNAVAILABLE:"unavailable",DATA_LOSS:"data-loss"};class W extends k.FirebaseError{constructor(e,t){super(e,t),this.code=e,this.message=t,this.toString=()=>`${this.name}: [code=${this.code}]: ${this.message}`}}class J{constructor(){this.promise=new Promise((e,t)=>{this.resolve=e,this.reject=t})}}class Y{constructor(e,t){this.user=t,this.type="OAuth",this.headers=new Map,this.headers.set("Authorization",`Bearer ${e}`)}}class X{getToken(){return Promise.resolve(null)}invalidateToken(){}start(e,t){e.enqueueRetryable(()=>t(V.UNAUTHENTICATED))}shutdown(){}}class Z{constructor(e){this.token=e,this.changeListener=null}getToken(){return Promise.resolve(this.token)}invalidateToken(){}start(e,t){this.changeListener=t,e.enqueueRetryable(()=>t(this.token.user))}shutdown(){this.changeListener=null}}class ee{constructor(e){this.t=e,this.currentUser=V.UNAUTHENTICATED,this.i=0,this.forceRefresh=!1,this.auth=null}start(e,t){Q(void 0===this.o,42304);let n=this.i,r=e=>this.i!==n?(n=this.i,t(e)):Promise.resolve(),i=new J;this.o=()=>{this.i++,this.currentUser=this.u(),i.resolve(),i=new J,e.enqueueRetryable(()=>r(this.currentUser))};let s=()=>{let t=i;e.enqueueRetryable(async()=>{await t.promise,await r(this.currentUser)})},a=e=>{q("FirebaseAuthCredentialsProvider","Auth detected"),this.auth=e,this.o&&(this.auth.addAuthTokenListener(this.o),s())};this.t.onInit(e=>a(e)),setTimeout(()=>{if(!this.auth){let e=this.t.getImmediate({optional:!0});e?a(e):(q("FirebaseAuthCredentialsProvider","Auth not yet detected"),i.resolve(),i=new J)}},0),s()}getToken(){let e=this.i,t=this.forceRefresh;return this.forceRefresh=!1,this.auth?this.auth.getToken(t).then(t=>this.i!==e?(q("FirebaseAuthCredentialsProvider","getToken aborted due to token change."),this.getToken()):t?(Q("string"==typeof t.accessToken,31837,{l:t}),new Y(t.accessToken,this.currentUser)):null):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.auth&&this.o&&this.auth.removeAuthTokenListener(this.o),this.o=void 0}u(){let e=this.auth&&this.auth.getUid();return Q(null===e||"string"==typeof e,2055,{h:e}),new V(e)}}class et{constructor(e,t,n){this.P=e,this.T=t,this.I=n,this.type="FirstParty",this.user=V.FIRST_PARTY,this.R=new Map}A(){return this.I?this.I():null}get headers(){this.R.set("X-Goog-AuthUser",this.P);let e=this.A();return e&&this.R.set("Authorization",e),this.T&&this.R.set("X-Goog-Iam-Authorization-Token",this.T),this.R}}class en{constructor(e,t,n){this.P=e,this.T=t,this.I=n}getToken(){return Promise.resolve(new et(this.P,this.T,this.I))}start(e,t){e.enqueueRetryable(()=>t(V.FIRST_PARTY))}shutdown(){}invalidateToken(){}}class er{constructor(e){this.value=e,this.type="AppCheck",this.headers=new Map,e&&e.length>0&&this.headers.set("x-firebase-appcheck",this.value)}}class ei{constructor(e,t){this.V=t,this.forceRefresh=!1,this.appCheck=null,this.m=null,this.p=null,(0,C._isFirebaseServerApp)(e)&&e.settings.appCheckToken&&(this.p=e.settings.appCheckToken)}start(e,t){Q(void 0===this.o,3512);let n=e=>{null!=e.error&&q("FirebaseAppCheckTokenProvider",`Error getting App Check token; using placeholder token instead. Error: ${e.error.message}`);let n=e.token!==this.m;return this.m=e.token,q("FirebaseAppCheckTokenProvider",`Received ${n?"new":"existing"} token.`),n?t(e.token):Promise.resolve()};this.o=t=>{e.enqueueRetryable(()=>n(t))};let r=e=>{q("FirebaseAppCheckTokenProvider","AppCheck detected"),this.appCheck=e,this.o&&this.appCheck.addTokenListener(this.o)};this.V.onInit(e=>r(e)),setTimeout(()=>{if(!this.appCheck){let e=this.V.getImmediate({optional:!0});e?r(e):q("FirebaseAppCheckTokenProvider","AppCheck not yet detected")}},0)}getToken(){if(this.p)return Promise.resolve(new er(this.p));let e=this.forceRefresh;return this.forceRefresh=!1,this.appCheck?this.appCheck.getToken(e).then(e=>e?(Q("string"==typeof e.token,44558,{tokenResult:e}),this.m=e.token,new er(e.token)):null):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.appCheck&&this.o&&this.appCheck.removeTokenListener(this.o),this.o=void 0}}class es{static newId(){let e=62*Math.floor(256/62),t="";for(;t.length<20;){let n=function(e){let t="u">typeof self&&(self.crypto||self.msCrypto),n=new Uint8Array(40);if(t&&"function"==typeof t.getRandomValues)t.getRandomValues(n);else for(let e=0;e<40;e++)n[e]=Math.floor(256*Math.random());return n}(0);for(let r=0;r<n.length;++r)t.length<20&&n[r]<e&&(t+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789".charAt(n[r]%62))}return t}}function ea(e,t){return e<t?-1:+(e>t)}function eo(e,t){let n=Math.min(e.length,t.length);for(let r=0;r<n;r++){let n=e.charAt(r),i=t.charAt(r);if(n!==i)return el(n)===el(i)?ea(n,i):el(n)?1:-1}return ea(e.length,t.length)}function el(e){let t=e.charCodeAt(0);return t>=55296&&t<=57343}function eu(e,t,n){return e.length===t.length&&e.every((e,r)=>n(e,t[r]))}let eh="__name__";class ec{constructor(e,t,n){void 0===t?t=0:t>e.length&&G(637,{offset:t,range:e.length}),void 0===n?n=e.length-t:n>e.length-t&&G(1746,{length:n,range:e.length-t}),this.segments=e,this.offset=t,this.len=n}get length(){return this.len}isEqual(e){return 0===ec.comparator(this,e)}child(e){let t=this.segments.slice(this.offset,this.limit());return e instanceof ec?e.forEach(e=>{t.push(e)}):t.push(e),this.construct(t)}limit(){return this.offset+this.length}popFirst(e){return e=void 0===e?1:e,this.construct(this.segments,this.offset+e,this.length-e)}popLast(){return this.construct(this.segments,this.offset,this.length-1)}firstSegment(){return this.segments[this.offset]}lastSegment(){return this.get(this.length-1)}get(e){return this.segments[this.offset+e]}isEmpty(){return 0===this.length}isPrefixOf(e){if(e.length<this.length)return!1;for(let t=0;t<this.length;t++)if(this.get(t)!==e.get(t))return!1;return!0}isImmediateParentOf(e){if(this.length+1!==e.length)return!1;for(let t=0;t<this.length;t++)if(this.get(t)!==e.get(t))return!1;return!0}forEach(e){for(let t=this.offset,n=this.limit();t<n;t++)e(this.segments[t])}toArray(){return this.segments.slice(this.offset,this.limit())}static comparator(e,t){let n=Math.min(e.length,t.length);for(let r=0;r<n;r++){let n=ec.compareSegments(e.get(r),t.get(r));if(0!==n)return n}return ea(e.length,t.length)}static compareSegments(e,t){let n=ec.isNumericId(e),r=ec.isNumericId(t);return n&&!r?-1:!n&&r?1:n&&r?ec.extractNumericId(e).compare(ec.extractNumericId(t)):eo(e,t)}static isNumericId(e){return e.startsWith("__id")&&e.endsWith("__")}static extractNumericId(e){return n.fromString(e.substring(4,e.length-2))}}class ed extends ec{construct(e,t,n){return new ed(e,t,n)}canonicalString(){return this.toArray().join("/")}toString(){return this.canonicalString()}toUriEncodedString(){return this.toArray().map(encodeURIComponent).join("/")}static fromString(...e){let t=[];for(let n of e){if(n.indexOf("//")>=0)throw new W(H.INVALID_ARGUMENT,`Invalid segment (${n}). Paths must not contain // in them.`);t.push(...n.split("/").filter(e=>e.length>0))}return new ed(t)}static emptyPath(){return new ed([])}}let ef=/^[_a-zA-Z][_a-zA-Z0-9]*$/;class em extends ec{construct(e,t,n){return new em(e,t,n)}static isValidIdentifier(e){return ef.test(e)}canonicalString(){return this.toArray().map(e=>(e=e.replace(/\\/g,"\\\\").replace(/`/g,"\\`"),em.isValidIdentifier(e)||(e="`"+e+"`"),e)).join(".")}toString(){return this.canonicalString()}isKeyField(){return 1===this.length&&this.get(0)===eh}static keyField(){return new em([eh])}static fromServerFormat(e){let t=[],n="",r=0,i=()=>{if(0===n.length)throw new W(H.INVALID_ARGUMENT,`Invalid field path (${e}). Paths must not be empty, begin with '.', end with '.', or contain '..'`);t.push(n),n=""},s=!1;for(;r<e.length;){let t=e[r];if("\\"===t){if(r+1===e.length)throw new W(H.INVALID_ARGUMENT,"Path has trailing escape character: "+e);let t=e[r+1];if("\\"!==t&&"."!==t&&"`"!==t)throw new W(H.INVALID_ARGUMENT,"Path has invalid escape sequence: "+e);n+=t,r+=2}else"`"===t?s=!s:"."!==t||s?n+=t:i(),r++}if(i(),s)throw new W(H.INVALID_ARGUMENT,"Unterminated ` in path: "+e);return new em(t)}static emptyPath(){return new em([])}}class eg{constructor(e){this.path=e}static fromPath(e){return new eg(ed.fromString(e))}static fromName(e){return new eg(ed.fromString(e).popFirst(5))}static empty(){return new eg(ed.emptyPath())}get collectionGroup(){return this.path.popLast().lastSegment()}hasCollectionId(e){return this.path.length>=2&&this.path.get(this.path.length-2)===e}getCollectionGroup(){return this.path.get(this.path.length-2)}getCollectionPath(){return this.path.popLast()}isEqual(e){return null!==e&&0===ed.comparator(this.path,e.path)}toString(){return this.path.toString()}static comparator(e,t){return ed.comparator(e.path,t.path)}static isDocumentKey(e){return e.length%2==0}static fromSegments(e){return new eg(new ed(e.slice()))}}function ep(e,t,n){if(!n)throw new W(H.INVALID_ARGUMENT,`Function ${e}() cannot be called with an empty ${t}.`)}function ey(e){if(!eg.isDocumentKey(e))throw new W(H.INVALID_ARGUMENT,`Invalid document reference. Document references must have an even number of segments, but ${e} has ${e.length}.`)}function ew(e){if(eg.isDocumentKey(e))throw new W(H.INVALID_ARGUMENT,`Invalid collection reference. Collection references must have an odd number of segments, but ${e} has ${e.length}.`)}function ev(e){return"object"==typeof e&&null!==e&&(Object.getPrototypeOf(e)===Object.prototype||null===Object.getPrototypeOf(e))}function eb(e){if(void 0===e)return"undefined";if(null===e)return"null";if("string"==typeof e)return e.length>20&&(e=`${e.substring(0,20)}...`),JSON.stringify(e);if("number"==typeof e||"boolean"==typeof e)return""+e;if("object"==typeof e){if(e instanceof Array)return"an array";{var t;let n=(t=e).constructor?t.constructor.name:null;return n?`a custom ${n} object`:"an object"}}return"function"==typeof e?"a function":G(12329,{type:typeof e})}function ex(e,t){if("_delegate"in e&&(e=e._delegate),!(e instanceof t)){if(t.name===e.constructor.name)throw new W(H.INVALID_ARGUMENT,"Type does not match the expected instance. Did you pass a reference from a different Firestore SDK?");{let n=eb(e);throw new W(H.INVALID_ARGUMENT,`Expected type '${t.name}', but it was: ${n}`)}}return e}function eT(e,t){if(t<=0)throw new W(H.INVALID_ARGUMENT,`Function ${e}() requires a positive number, but it was: ${t}.`)}function eI(e,t){let n={typeString:e};return t&&(n.value=t),n}function eS(e,t){let n;if(!ev(e))throw new W(H.INVALID_ARGUMENT,"JSON must be an object");for(let r in t)if(t[r]){let i=t[r].typeString,s="value"in t[r]?{value:t[r].value}:void 0;if(!(r in e)){n=`JSON missing required field: '${r}'`;break}let a=e[r];if(i&&typeof a!==i){n=`JSON field '${r}' must be a ${i}.`;break}if(void 0!==s&&a!==s.value){n=`Expected '${r}' field to equal '${s.value}'`;break}}if(n)throw new W(H.INVALID_ARGUMENT,n);return!0}class eE{static now(){return eE.fromMillis(Date.now())}static fromDate(e){return eE.fromMillis(e.getTime())}static fromMillis(e){let t=Math.floor(e/1e3),n=Math.floor((e-1e3*t)*1e6);return new eE(t,n)}constructor(e,t){if(this.seconds=e,this.nanoseconds=t,t<0||t>=1e9)throw new W(H.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+t);if(e<-0xe7791f700||e>=0x3afff44180)throw new W(H.INVALID_ARGUMENT,"Timestamp seconds out of range: "+e)}toDate(){return new Date(this.toMillis())}toMillis(){return 1e3*this.seconds+this.nanoseconds/1e6}_compareTo(e){return this.seconds===e.seconds?ea(this.nanoseconds,e.nanoseconds):ea(this.seconds,e.seconds)}isEqual(e){return e.seconds===this.seconds&&e.nanoseconds===this.nanoseconds}toString(){return"Timestamp(seconds="+this.seconds+", nanoseconds="+this.nanoseconds+")"}toJSON(){return{type:eE._jsonSchemaVersion,seconds:this.seconds,nanoseconds:this.nanoseconds}}static fromJSON(e){if(eS(e,eE._jsonSchema))return new eE(e.seconds,e.nanoseconds)}valueOf(){return String(this.seconds- -0xe7791f700).padStart(12,"0")+"."+String(this.nanoseconds).padStart(9,"0")}}eE._jsonSchemaVersion="firestore/timestamp/1.0",eE._jsonSchema={type:eI("string",eE._jsonSchemaVersion),seconds:eI("number"),nanoseconds:eI("number")};class e_{static fromTimestamp(e){return new e_(e)}static min(){return new e_(new eE(0,0))}static max(){return new e_(new eE(0x3afff4417f,0x3b9ac9ff))}constructor(e){this.timestamp=e}compareTo(e){return this.timestamp._compareTo(e.timestamp)}isEqual(e){return this.timestamp.isEqual(e.timestamp)}toMicroseconds(){return 1e6*this.timestamp.seconds+this.timestamp.nanoseconds/1e3}toString(){return"SnapshotVersion("+this.timestamp.toString()+")"}toTimestamp(){return this.timestamp}}class eC{constructor(e,t,n,r){this.indexId=e,this.collectionGroup=t,this.fields=n,this.indexState=r}}function eA(e){return e.fields.find(e=>2===e.kind)}function eN(e){return e.fields.filter(e=>2!==e.kind)}function eD(e,t){let n=ea(e.collectionGroup,t.collectionGroup);if(0!==n)return n;for(let r=0;r<Math.min(e.fields.length,t.fields.length);++r)if(0!==(n=function(e,t){let n=em.comparator(e.fieldPath,t.fieldPath);return 0!==n?n:ea(e.kind,t.kind)}(e.fields[r],t.fields[r])))return n;return ea(e.fields.length,t.fields.length)}eC.UNKNOWN_ID=-1;class ek{constructor(e,t){this.fieldPath=e,this.kind=t}}class eR{constructor(e,t){this.sequenceNumber=e,this.offset=t}static empty(){return new eR(0,eM.min())}}function eP(e,t){let n=e.toTimestamp().seconds,r=e.toTimestamp().nanoseconds+1;return new eM(e_.fromTimestamp(1e9===r?new eE(n+1,0):new eE(n,r)),eg.empty(),t)}function eO(e){return new eM(e.readTime,e.key,-1)}class eM{constructor(e,t,n){this.readTime=e,this.documentKey=t,this.largestBatchId=n}static min(){return new eM(e_.min(),eg.empty(),-1)}static max(){return new eM(e_.max(),eg.empty(),-1)}}function eF(e,t){let n=e.readTime.compareTo(t.readTime);return 0!==n||0!==(n=eg.comparator(e.documentKey,t.documentKey))?n:ea(e.largestBatchId,t.largestBatchId)}let eV="The current tab is not in the required state to perform this operation. It might be necessary to refresh the browser tab.";class eL{constructor(){this.onCommittedListeners=[]}addOnCommittedListener(e){this.onCommittedListeners.push(e)}raiseOnCommittedEvent(){this.onCommittedListeners.forEach(e=>e())}}async function ej(e){if(e.code!==H.FAILED_PRECONDITION||e.message!==eV)throw e;q("LocalStore","Unexpectedly lost primary lease")}class eU{constructor(e){this.nextCallback=null,this.catchCallback=null,this.result=void 0,this.error=void 0,this.isDone=!1,this.callbackAttached=!1,e(e=>{this.isDone=!0,this.result=e,this.nextCallback&&this.nextCallback(e)},e=>{this.isDone=!0,this.error=e,this.catchCallback&&this.catchCallback(e)})}catch(e){return this.next(void 0,e)}next(e,t){return this.callbackAttached&&G(59440),this.callbackAttached=!0,this.isDone?this.error?this.wrapFailure(t,this.error):this.wrapSuccess(e,this.result):new eU((n,r)=>{this.nextCallback=t=>{this.wrapSuccess(e,t).next(n,r)},this.catchCallback=e=>{this.wrapFailure(t,e).next(n,r)}})}toPromise(){return new Promise((e,t)=>{this.next(e,t)})}wrapUserFunction(e){try{let t=e();return t instanceof eU?t:eU.resolve(t)}catch(e){return eU.reject(e)}}wrapSuccess(e,t){return e?this.wrapUserFunction(()=>e(t)):eU.resolve(t)}wrapFailure(e,t){return e?this.wrapUserFunction(()=>e(t)):eU.reject(t)}static resolve(e){return new eU((t,n)=>{t(e)})}static reject(e){return new eU((t,n)=>{n(e)})}static waitFor(e){return new eU((t,n)=>{let r=0,i=0,s=!1;e.forEach(e=>{++r,e.next(()=>{++i,s&&i===r&&t()},e=>n(e))}),s=!0,i===r&&t()})}static or(e){let t=eU.resolve(!1);for(let n of e)t=t.next(e=>e?eU.resolve(e):n());return t}static forEach(e,t){let n=[];return e.forEach((e,r)=>{n.push(t.call(this,e,r))}),this.waitFor(n)}static mapArray(e,t){return new eU((n,r)=>{let i=e.length,s=Array(i),a=0;for(let o=0;o<i;o++){let l=o;t(e[l]).next(e=>{s[l]=e,++a===i&&n(s)},e=>r(e))}})}static doWhile(e,t){return new eU((n,r)=>{let i=()=>{!0===e()?t().next(()=>{i()},r):n()};i()})}}let eq="SimpleDb";class eB{static open(e,t,n,r){try{return new eB(t,e.transaction(r,n))}catch(e){throw new eK(t,e)}}constructor(e,t){this.action=e,this.transaction=t,this.aborted=!1,this.S=new J,this.transaction.oncomplete=()=>{this.S.resolve()},this.transaction.onabort=()=>{t.error?this.S.reject(new eK(e,t.error)):this.S.resolve()},this.transaction.onerror=t=>{let n=eY(t.target.error);this.S.reject(new eK(e,n))}}get D(){return this.S.promise}abort(e){e&&this.S.reject(e),this.aborted||(q(eq,"Aborting transaction:",e?e.message:"Client-initiated abort"),this.aborted=!0,this.transaction.abort())}C(){let e=this.transaction;this.aborted||"function"!=typeof e.commit||e.commit()}store(e){return new eH(this.transaction.objectStore(e))}}class ez{static delete(e){return q(eq,"Removing database:",e),eW((0,k.getGlobal)().indexedDB.deleteDatabase(e)).toPromise()}static v(){if(!(0,k.isIndexedDBAvailable)())return!1;if(ez.F())return!0;let e=(0,k.getUA)(),t=ez.M(e),n=e$(e);return!(e.indexOf("MSIE ")>0||e.indexOf("Trident/")>0||e.indexOf("Edge/")>0||0<t&&t<10||0<n&&n<4.5)}static F(){return void 0!==N.default&&"YES"===N.default.__PRIVATE_env?.__PRIVATE_USE_MOCK_PERSISTENCE}static O(e,t){return e.store(t)}static M(e){let t=e.match(/i(?:phone|pad|pod) os ([\d_]+)/i);return Number(t?t[1].split("_").slice(0,2).join("."):"-1")}constructor(e,t,n){this.name=e,this.version=t,this.N=n,this.B=null,12.2===ez.M((0,k.getUA)())&&B("Firestore persistence suffers from a bug in iOS 12.2 Safari that may cause your app to stop working. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.")}async L(e){return this.db||(q(eq,"Opening database:",this.name),this.db=await new Promise((t,n)=>{let r=indexedDB.open(this.name,this.version);r.onsuccess=e=>{t(e.target.result)},r.onblocked=()=>{n(new eK(e,"Cannot upgrade IndexedDB schema while another tab is open. Close all tabs that access Firestore and reload this page to proceed."))},r.onerror=t=>{let r=t.target.error;"VersionError"===r.name?n(new W(H.FAILED_PRECONDITION,"A newer version of the Firestore SDK was previously used and so the persisted data is not compatible with the version of the SDK you are now using. The SDK will operate with persistence disabled. If you need persistence, please re-upgrade to a newer version of the SDK or else clear the persisted IndexedDB data for your app to start fresh.")):"InvalidStateError"===r.name?n(new W(H.FAILED_PRECONDITION,"Unable to open an IndexedDB connection. This could be due to running in a private browsing session on a browser whose private browsing sessions do not support IndexedDB: "+r)):n(new eK(e,r))},r.onupgradeneeded=e=>{q(eq,'Database "'+this.name+'" requires upgrade from version:',e.oldVersion);let t=e.target.result;this.N.k(t,r.transaction,e.oldVersion,this.version).next(()=>{q(eq,"Database upgrade to version "+this.version+" complete")})}})),this.K&&(this.db.onversionchange=e=>this.K(e)),this.db}q(e){this.K=e,this.db&&(this.db.onversionchange=t=>e(t))}async runTransaction(e,t,n,r){let i="readonly"===t,s=0;for(;;){++s;try{this.db=await this.L(e);let t=eB.open(this.db,e,i?"readonly":"readwrite",n),s=r(t).next(e=>(t.C(),e)).catch(e=>(t.abort(e),eU.reject(e))).toPromise();return s.catch(()=>{}),await t.D,s}catch(t){let e="FirebaseError"!==t.name&&s<3;if(q(eq,"Transaction failed with error:",t.message,"Retrying:",e),this.close(),!e)return Promise.reject(t)}}}close(){this.db&&this.db.close(),this.db=void 0}}function e$(e){let t=e.match(/Android ([\d.]+)/i);return Number(t?t[1].split(".").slice(0,2).join("."):"-1")}class eG{constructor(e){this.U=e,this.$=!1,this.W=null}get isDone(){return this.$}get G(){return this.W}set cursor(e){this.U=e}done(){this.$=!0}j(e){this.W=e}delete(){return eW(this.U.delete())}}class eK extends W{constructor(e,t){super(H.UNAVAILABLE,`IndexedDB transaction '${e}' failed: ${t}`),this.name="IndexedDbTransactionError"}}function eQ(e){return"IndexedDbTransactionError"===e.name}class eH{constructor(e){this.store=e}put(e,t){let n;return void 0!==t?(q(eq,"PUT",this.store.name,e,t),n=this.store.put(t,e)):(q(eq,"PUT",this.store.name,"<auto-key>",e),n=this.store.put(e)),eW(n)}add(e){return q(eq,"ADD",this.store.name,e,e),eW(this.store.add(e))}get(e){return eW(this.store.get(e)).next(t=>(void 0===t&&(t=null),q(eq,"GET",this.store.name,e,t),t))}delete(e){return q(eq,"DELETE",this.store.name,e),eW(this.store.delete(e))}count(){return q(eq,"COUNT",this.store.name),eW(this.store.count())}H(e,t){let n=this.options(e,t),r=n.index?this.store.index(n.index):this.store;if("function"==typeof r.getAll){let e=r.getAll(n.range);return new eU((t,n)=>{e.onerror=e=>{n(e.target.error)},e.onsuccess=e=>{t(e.target.result)}})}{let e=this.cursor(n),t=[];return this.J(e,(e,n)=>{t.push(n)}).next(()=>t)}}Z(e,t){let n=this.store.getAll(e,null===t?void 0:t);return new eU((e,t)=>{n.onerror=e=>{t(e.target.error)},n.onsuccess=t=>{e(t.target.result)}})}X(e,t){q(eq,"DELETE ALL",this.store.name);let n=this.options(e,t);n.Y=!1;let r=this.cursor(n);return this.J(r,(e,t,n)=>n.delete())}ee(e,t){let n;t?n=e:(n={},t=e);let r=this.cursor(n);return this.J(r,t)}te(e){let t=this.cursor({});return new eU((n,r)=>{t.onerror=e=>{r(eY(e.target.error))},t.onsuccess=t=>{let r=t.target.result;r?e(r.primaryKey,r.value).next(e=>{e?r.continue():n()}):n()}})}J(e,t){let n=[];return new eU((r,i)=>{e.onerror=e=>{i(e.target.error)},e.onsuccess=e=>{let i=e.target.result;if(!i)return void r();let s=new eG(i),a=t(i.primaryKey,i.value,s);if(a instanceof eU){let e=a.catch(e=>(s.done(),eU.reject(e)));n.push(e)}s.isDone?r():null===s.G?i.continue():i.continue(s.G)}}).next(()=>eU.waitFor(n))}options(e,t){let n;return void 0!==e&&("string"==typeof e?n=e:t=e),{index:n,range:t}}cursor(e){let t="next";if(e.reverse&&(t="prev"),e.index){let n=this.store.index(e.index);return e.Y?n.openKeyCursor(e.range,t):n.openCursor(e.range,t)}return this.store.openCursor(e.range,t)}}function eW(e){return new eU((t,n)=>{e.onsuccess=e=>{t(e.target.result)},e.onerror=e=>{n(eY(e.target.error))}})}let eJ=!1;function eY(e){let t=ez.M((0,k.getUA)());if(t>=12.2&&t<13){let t="An internal error was encountered in the Indexed Database server";if(e.message.indexOf(t)>=0){let e=new W("internal",`IOS_INDEXEDDB_BUG1: IndexedDb has thrown '${t}'. This is likely due to an unavoidable bug in iOS. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.`);return eJ||(eJ=!0,setTimeout(()=>{throw e},0)),e}}return e}let eX="IndexBackfiller";class eZ{constructor(e,t){this.asyncQueue=e,this.ne=t,this.task=null}start(){this.re(15e3)}stop(){this.task&&(this.task.cancel(),this.task=null)}get started(){return null!==this.task}re(e){q(eX,`Scheduled in ${e}ms`),this.task=this.asyncQueue.enqueueAfterDelay("index_backfill",e,async()=>{this.task=null;try{let e=await this.ne.ie();q(eX,`Documents written: ${e}`)}catch(e){eQ(e)?q(eX,"Ignoring IndexedDB error during index backfill: ",e):await ej(e)}await this.re(6e4)})}}class e0{constructor(e,t){this.localStore=e,this.persistence=t}async ie(e=50){return this.persistence.runTransaction("Backfill Indexes","readwrite-primary",t=>this.se(t,e))}se(e,t){let n=new Set,r=t,i=!0;return eU.doWhile(()=>!0===i&&r>0,()=>this.localStore.indexManager.getNextCollectionGroupToUpdate(e).next(t=>{if(null!==t&&!n.has(t))return q(eX,`Processing collection: ${t}`),this.oe(e,t,r).next(e=>{r-=e,n.add(t)});i=!1})).next(()=>t-r)}oe(e,t,n){return this.localStore.indexManager.getMinOffsetFromCollectionGroup(e,t).next(r=>this.localStore.localDocuments.getNextDocuments(e,t,r,n).next(n=>{let i=n.changes;return this.localStore.indexManager.updateIndexEntries(e,i).next(()=>this._e(r,n)).next(n=>(q(eX,`Updating offset: ${n}`),this.localStore.indexManager.updateCollectionGroup(e,t,n))).next(()=>i.size)}))}_e(e,t){let n=e;return t.changes.forEach((e,t)=>{let r=eO(t);eF(r,n)>0&&(n=r)}),new eM(n.readTime,n.documentKey,Math.max(t.batchId,e.largestBatchId))}}class e1{constructor(e,t){this.previousValue=e,t&&(t.sequenceNumberHandler=e=>this.ae(e),this.ue=e=>t.writeSequenceNumber(e))}ae(e){return this.previousValue=Math.max(e,this.previousValue),this.previousValue}next(){let e=++this.previousValue;return this.ue&&this.ue(e),e}}function e2(e){return null==e}function e5(e){return 0===e&&1/e==-1/0}function e4(e){return"number"==typeof e&&Number.isInteger(e)&&!e5(e)&&e<=Number.MAX_SAFE_INTEGER&&e>=Number.MIN_SAFE_INTEGER}function e3(e){let t="";for(let n=0;n<e.length;n++)t.length>0&&(t+="\x01\x01"),t=function(e,t){let n=t,r=e.length;for(let t=0;t<r;t++){let r=e.charAt(t);switch(r){case"\0":n+="\x01\x10";break;case"\x01":n+="\x01\x11";break;default:n+=r}}return n}(e.get(n),t);return t+"\x01\x01"}e1.ce=-1;function e6(e){let t=e.length;if(Q(t>=2,64408,{path:e}),2===t)return Q("\x01"===e.charAt(0)&&"\x01"===e.charAt(1),56145,{path:e}),ed.emptyPath();let n=t-2,r=[],i="";for(let s=0;s<t;){let t=e.indexOf("\x01",s);switch((t<0||t>n)&&G(50515,{path:e}),e.charAt(t+1)){case"\x01":let a,o=e.substring(s,t);0===i.length?a=o:(i+=o,a=i,i=""),r.push(a);break;case"\x10":i+=e.substring(s,t),i+="\0";break;case"\x11":i+=e.substring(s,t+1);break;default:G(61167,{path:e})}s=t+2}return new ed(r)}let e8="remoteDocuments",e7="owner",e9="owner",te="mutationQueues",tt="mutations",tn="batchId",tr="userMutationsIndex",ti=["userId","batchId"],ts={},ta="documentMutations",to="remoteDocumentsV14",tl=["prefixPath","collectionGroup","readTime","documentId"],tu="documentKeyIndex",th=["prefixPath","collectionGroup","documentId"],tc="collectionGroupIndex",td=["collectionGroup","readTime","prefixPath","documentId"],tf="remoteDocumentGlobal",tm="remoteDocumentGlobalKey",tg="targets",tp="queryTargetsIndex",ty=["canonicalId","targetId"],tw="targetDocuments",tv=["targetId","path"],tb="documentTargetsIndex",tx=["path","targetId"],tT="targetGlobalKey",tI="targetGlobal",tS="collectionParents",tE=["collectionId","parent"],t_="clientMetadata",tC="bundles",tA="namedQueries",tN="indexConfiguration",tD="collectionGroupIndex",tk="indexState",tR=["indexId","uid"],tP="sequenceNumberIndex",tO=["uid","sequenceNumber"],tM="indexEntries",tF=["indexId","uid","arrayValue","directionalValue","orderedDocumentKey","documentKey"],tV="documentKeyIndex",tL=["indexId","uid","orderedDocumentKey"],tj="documentOverlays",tU=["userId","collectionPath","documentId"],tq="collectionPathOverlayIndex",tB=["userId","collectionPath","largestBatchId"],tz="collectionGroupOverlayIndex",t$=["userId","collectionGroup","largestBatchId"],tG="globals",tK=[te,tt,ta,e8,tg,e7,tI,tw,t_,tf,tS,tC,tA],tQ=[...tK,tj],tH=[te,tt,ta,to,tg,e7,tI,tw,t_,tf,tS,tC,tA,tj],tW=[...tH,tN,tk,tM],tJ=[...tW,tG];class tY extends eL{constructor(e,t){super(),this.le=e,this.currentSequenceNumber=t}}function tX(e,t){return ez.O(e.le,t)}function tZ(e){let t=0;for(let n in e)Object.prototype.hasOwnProperty.call(e,n)&&t++;return t}function t0(e,t){for(let n in e)Object.prototype.hasOwnProperty.call(e,n)&&t(n,e[n])}function t1(e){for(let t in e)if(Object.prototype.hasOwnProperty.call(e,t))return!1;return!0}class t2{constructor(e,t){this.comparator=e,this.root=t||t4.EMPTY}insert(e,t){return new t2(this.comparator,this.root.insert(e,t,this.comparator).copy(null,null,t4.BLACK,null,null))}remove(e){return new t2(this.comparator,this.root.remove(e,this.comparator).copy(null,null,t4.BLACK,null,null))}get(e){let t=this.root;for(;!t.isEmpty();){let n=this.comparator(e,t.key);if(0===n)return t.value;n<0?t=t.left:n>0&&(t=t.right)}return null}indexOf(e){let t=0,n=this.root;for(;!n.isEmpty();){let r=this.comparator(e,n.key);if(0===r)return t+n.left.size;r<0?n=n.left:(t+=n.left.size+1,n=n.right)}return -1}isEmpty(){return this.root.isEmpty()}get size(){return this.root.size}minKey(){return this.root.minKey()}maxKey(){return this.root.maxKey()}inorderTraversal(e){return this.root.inorderTraversal(e)}forEach(e){this.inorderTraversal((t,n)=>(e(t,n),!1))}toString(){let e=[];return this.inorderTraversal((t,n)=>(e.push(`${t}:${n}`),!1)),`{${e.join(", ")}}`}reverseTraversal(e){return this.root.reverseTraversal(e)}getIterator(){return new t5(this.root,null,this.comparator,!1)}getIteratorFrom(e){return new t5(this.root,e,this.comparator,!1)}getReverseIterator(){return new t5(this.root,null,this.comparator,!0)}getReverseIteratorFrom(e){return new t5(this.root,e,this.comparator,!0)}}class t5{constructor(e,t,n,r){this.isReverse=r,this.nodeStack=[];let i=1;for(;!e.isEmpty();)if(i=t?n(e.key,t):1,t&&r&&(i*=-1),i<0)e=this.isReverse?e.left:e.right;else{if(0===i){this.nodeStack.push(e);break}this.nodeStack.push(e),e=this.isReverse?e.right:e.left}}getNext(){let e=this.nodeStack.pop(),t={key:e.key,value:e.value};if(this.isReverse)for(e=e.left;!e.isEmpty();)this.nodeStack.push(e),e=e.right;else for(e=e.right;!e.isEmpty();)this.nodeStack.push(e),e=e.left;return t}hasNext(){return this.nodeStack.length>0}peek(){if(0===this.nodeStack.length)return null;let e=this.nodeStack[this.nodeStack.length-1];return{key:e.key,value:e.value}}}class t4{constructor(e,t,n,r,i){this.key=e,this.value=t,this.color=null!=n?n:t4.RED,this.left=null!=r?r:t4.EMPTY,this.right=null!=i?i:t4.EMPTY,this.size=this.left.size+1+this.right.size}copy(e,t,n,r,i){return new t4(null!=e?e:this.key,null!=t?t:this.value,null!=n?n:this.color,null!=r?r:this.left,null!=i?i:this.right)}isEmpty(){return!1}inorderTraversal(e){return this.left.inorderTraversal(e)||e(this.key,this.value)||this.right.inorderTraversal(e)}reverseTraversal(e){return this.right.reverseTraversal(e)||e(this.key,this.value)||this.left.reverseTraversal(e)}min(){return this.left.isEmpty()?this:this.left.min()}minKey(){return this.min().key}maxKey(){return this.right.isEmpty()?this.key:this.right.maxKey()}insert(e,t,n){let r=this,i=n(e,r.key);return(r=i<0?r.copy(null,null,null,r.left.insert(e,t,n),null):0===i?r.copy(null,t,null,null,null):r.copy(null,null,null,null,r.right.insert(e,t,n))).fixUp()}removeMin(){if(this.left.isEmpty())return t4.EMPTY;let e=this;return e.left.isRed()||e.left.left.isRed()||(e=e.moveRedLeft()),(e=e.copy(null,null,null,e.left.removeMin(),null)).fixUp()}remove(e,t){let n,r=this;if(0>t(e,r.key))r.left.isEmpty()||r.left.isRed()||r.left.left.isRed()||(r=r.moveRedLeft()),r=r.copy(null,null,null,r.left.remove(e,t),null);else{if(r.left.isRed()&&(r=r.rotateRight()),r.right.isEmpty()||r.right.isRed()||r.right.left.isRed()||(r=r.moveRedRight()),0===t(e,r.key)){if(r.right.isEmpty())return t4.EMPTY;n=r.right.min(),r=r.copy(n.key,n.value,null,null,r.right.removeMin())}r=r.copy(null,null,null,null,r.right.remove(e,t))}return r.fixUp()}isRed(){return this.color}fixUp(){let e=this;return e.right.isRed()&&!e.left.isRed()&&(e=e.rotateLeft()),e.left.isRed()&&e.left.left.isRed()&&(e=e.rotateRight()),e.left.isRed()&&e.right.isRed()&&(e=e.colorFlip()),e}moveRedLeft(){let e=this.colorFlip();return e.right.left.isRed()&&(e=(e=(e=e.copy(null,null,null,null,e.right.rotateRight())).rotateLeft()).colorFlip()),e}moveRedRight(){let e=this.colorFlip();return e.left.left.isRed()&&(e=(e=e.rotateRight()).colorFlip()),e}rotateLeft(){let e=this.copy(null,null,t4.RED,null,this.right.left);return this.right.copy(null,null,this.color,e,null)}rotateRight(){let e=this.copy(null,null,t4.RED,this.left.right,null);return this.left.copy(null,null,this.color,null,e)}colorFlip(){let e=this.left.copy(null,null,!this.left.color,null,null),t=this.right.copy(null,null,!this.right.color,null,null);return this.copy(null,null,!this.color,e,t)}checkMaxDepth(){return Math.pow(2,this.check())<=this.size+1}check(){if(this.isRed()&&this.left.isRed())throw G(43730,{key:this.key,value:this.value});if(this.right.isRed())throw G(14113,{key:this.key,value:this.value});let e=this.left.check();if(e!==this.right.check())throw G(27949);return e+ +!this.isRed()}}t4.EMPTY=null,t4.RED=!0,t4.BLACK=!1,t4.EMPTY=new class{constructor(){this.size=0}get key(){throw G(57766)}get value(){throw G(16141)}get color(){throw G(16727)}get left(){throw G(29726)}get right(){throw G(36894)}copy(e,t,n,r,i){return this}insert(e,t,n){return new t4(e,t)}remove(e,t){return this}isEmpty(){return!0}inorderTraversal(e){return!1}reverseTraversal(e){return!1}minKey(){return null}maxKey(){return null}isRed(){return!1}checkMaxDepth(){return!0}check(){return 0}};class t3{constructor(e){this.comparator=e,this.data=new t2(this.comparator)}has(e){return null!==this.data.get(e)}first(){return this.data.minKey()}last(){return this.data.maxKey()}get size(){return this.data.size}indexOf(e){return this.data.indexOf(e)}forEach(e){this.data.inorderTraversal((t,n)=>(e(t),!1))}forEachInRange(e,t){let n=this.data.getIteratorFrom(e[0]);for(;n.hasNext();){let r=n.getNext();if(this.comparator(r.key,e[1])>=0)return;t(r.key)}}forEachWhile(e,t){let n;for(n=void 0!==t?this.data.getIteratorFrom(t):this.data.getIterator();n.hasNext();)if(!e(n.getNext().key))return}firstAfterOrEqual(e){let t=this.data.getIteratorFrom(e);return t.hasNext()?t.getNext().key:null}getIterator(){return new t6(this.data.getIterator())}getIteratorFrom(e){return new t6(this.data.getIteratorFrom(e))}add(e){return this.copy(this.data.remove(e).insert(e,!0))}delete(e){return this.has(e)?this.copy(this.data.remove(e)):this}isEmpty(){return this.data.isEmpty()}unionWith(e){let t=this;return t.size<e.size&&(t=e,e=this),e.forEach(e=>{t=t.add(e)}),t}isEqual(e){if(!(e instanceof t3)||this.size!==e.size)return!1;let t=this.data.getIterator(),n=e.data.getIterator();for(;t.hasNext();){let e=t.getNext().key,r=n.getNext().key;if(0!==this.comparator(e,r))return!1}return!0}toArray(){let e=[];return this.forEach(t=>{e.push(t)}),e}toString(){let e=[];return this.forEach(t=>e.push(t)),"SortedSet("+e.toString()+")"}copy(e){let t=new t3(this.comparator);return t.data=e,t}}class t6{constructor(e){this.iter=e}getNext(){return this.iter.getNext().key}hasNext(){return this.iter.hasNext()}}function t8(e){return e.hasNext()?e.getNext():void 0}class t7{constructor(e){this.fields=e,e.sort(em.comparator)}static empty(){return new t7([])}unionWith(e){let t=new t3(em.comparator);for(let e of this.fields)t=t.add(e);for(let n of e)t=t.add(n);return new t7(t.toArray())}covers(e){for(let t of this.fields)if(t.isPrefixOf(e))return!0;return!1}isEqual(e){return eu(this.fields,e.fields,(e,t)=>e.isEqual(t))}}class t9 extends Error{constructor(){super(...arguments),this.name="Base64DecodeError"}}class ne{constructor(e){this.binaryString=e}static fromBase64String(e){return new ne(function(e){try{return atob(e)}catch(e){throw"u">typeof DOMException&&e instanceof DOMException?new t9("Invalid base64 string: "+e):e}}(e))}static fromUint8Array(e){return new ne(function(e){let t="";for(let n=0;n<e.length;++n)t+=String.fromCharCode(e[n]);return t}(e))}[Symbol.iterator](){let e=0;return{next:()=>e<this.binaryString.length?{value:this.binaryString.charCodeAt(e++),done:!1}:{value:void 0,done:!0}}}toBase64(){return btoa(this.binaryString)}toUint8Array(){var e=this.binaryString;let t=new Uint8Array(e.length);for(let n=0;n<e.length;n++)t[n]=e.charCodeAt(n);return t}approximateByteSize(){return 2*this.binaryString.length}compareTo(e){return ea(this.binaryString,e.binaryString)}isEqual(e){return this.binaryString===e.binaryString}}ne.EMPTY_BYTE_STRING=new ne("");let nt=new RegExp(/^\d{4}-\d\d-\d\dT\d\d:\d\d:\d\d(?:\.(\d+))?Z$/);function nn(e){if(Q(!!e,39018),"string"==typeof e){let t=0,n=nt.exec(e);if(Q(!!n,46558,{timestamp:e}),n[1]){let e=n[1];t=Number(e=(e+"000000000").substr(0,9))}return{seconds:Math.floor(new Date(e).getTime()/1e3),nanos:t}}return{seconds:nr(e.seconds),nanos:nr(e.nanos)}}function nr(e){return"number"==typeof e?e:"string"==typeof e?Number(e):0}function ni(e){return"string"==typeof e?ne.fromBase64String(e):ne.fromUint8Array(e)}let ns="server_timestamp",na="__type__",no="__previous_value__",nl="__local_write_time__";function nu(e){return(e?.mapValue?.fields||{})[na]?.stringValue===ns}function nh(e){let t=e.mapValue.fields[no];return nu(t)?nh(t):t}function nc(e){let t=nn(e.mapValue.fields[nl].timestampValue);return new eE(t.seconds,t.nanos)}class nd{constructor(e,t,n,r,i,s,a,o,l,u,h){this.databaseId=e,this.appId=t,this.persistenceKey=n,this.host=r,this.ssl=i,this.forceLongPolling=s,this.autoDetectLongPolling=a,this.longPollingOptions=o,this.useFetchStreams=l,this.isUsingEmulator=u,this.apiKey=h}}let nf="(default)";class nm{constructor(e,t){this.projectId=e,this.database=t||nf}static empty(){return new nm("","")}get isDefaultDatabase(){return this.database===nf}isEqual(e){return e instanceof nm&&e.projectId===this.projectId&&e.database===this.database}}let ng="__type__",np="__max__",ny={mapValue:{fields:{__type__:{stringValue:np}}}},nw="__vector__",nv="value",nb={nullValue:"NULL_VALUE"};function nx(e){return"nullValue"in e?0:"booleanValue"in e?1:"integerValue"in e||"doubleValue"in e?2:"timestampValue"in e?3:"stringValue"in e?5:"bytesValue"in e?6:"referenceValue"in e?7:"geoPointValue"in e?8:"arrayValue"in e?9:"mapValue"in e?nu(e)?4:nF(e)?0x1fffffffffffff:nO(e)?10:11:G(28295,{value:e})}function nT(e,t){if(e===t)return!0;let n=nx(e);if(n!==nx(t))return!1;switch(n){case 0:case 0x1fffffffffffff:return!0;case 1:return e.booleanValue===t.booleanValue;case 4:return nc(e).isEqual(nc(t));case 3:if("string"==typeof e.timestampValue&&"string"==typeof t.timestampValue&&e.timestampValue.length===t.timestampValue.length)return e.timestampValue===t.timestampValue;let r=nn(e.timestampValue),i=nn(t.timestampValue);return r.seconds===i.seconds&&r.nanos===i.nanos;case 5:return e.stringValue===t.stringValue;case 6:return ni(e.bytesValue).isEqual(ni(t.bytesValue));case 7:return e.referenceValue===t.referenceValue;case 8:return nr(e.geoPointValue.latitude)===nr(t.geoPointValue.latitude)&&nr(e.geoPointValue.longitude)===nr(t.geoPointValue.longitude);case 2:if("integerValue"in e&&"integerValue"in t)return nr(e.integerValue)===nr(t.integerValue);if("doubleValue"in e&&"doubleValue"in t){let n=nr(e.doubleValue),r=nr(t.doubleValue);return n===r?e5(n)===e5(r):isNaN(n)&&isNaN(r)}return!1;case 9:return eu(e.arrayValue.values||[],t.arrayValue.values||[],nT);case 10:case 11:let s=e.mapValue.fields||{},a=t.mapValue.fields||{};if(tZ(s)!==tZ(a))return!1;for(let e in s)if(s.hasOwnProperty(e)&&(void 0===a[e]||!nT(s[e],a[e])))return!1;return!0;default:return G(52216,{left:e})}}function nI(e,t){return void 0!==(e.values||[]).find(e=>nT(e,t))}function nS(e,t){var n,r,i,s,a,o;if(e===t)return 0;let l=nx(e),u=nx(t);if(l!==u)return ea(l,u);switch(l){case 0:case 0x1fffffffffffff:return 0;case 1:return ea(e.booleanValue,t.booleanValue);case 2:let h,c;return h=nr(e.integerValue||e.doubleValue),h<(c=nr(t.integerValue||t.doubleValue))?-1:h>c?1:h===c?0:isNaN(h)?isNaN(c)?0:-1:1;case 3:return nE(e.timestampValue,t.timestampValue);case 4:return nE(nc(e),nc(t));case 5:return eo(e.stringValue,t.stringValue);case 6:let d,f;return n=e.bytesValue,r=t.bytesValue,d=ni(n),f=ni(r),d.compareTo(f);case 7:return function(e,t){let n=e.split("/"),r=t.split("/");for(let e=0;e<n.length&&e<r.length;e++){let t=ea(n[e],r[e]);if(0!==t)return t}return ea(n.length,r.length)}(e.referenceValue,t.referenceValue);case 8:let m;return i=e.geoPointValue,s=t.geoPointValue,0!==(m=ea(nr(i.latitude),nr(s.latitude)))?m:ea(nr(i.longitude),nr(s.longitude));case 9:return n_(e.arrayValue,t.arrayValue);case 10:let g,p,y,w,v;return a=e.mapValue,o=t.mapValue,g=a.fields||{},p=o.fields||{},y=g[nv]?.arrayValue,w=p[nv]?.arrayValue,0!==(v=ea(y?.values?.length||0,w?.values?.length||0))?v:n_(y,w);case 11:return function(e,t){if(e===ny.mapValue&&t===ny.mapValue)return 0;if(e===ny.mapValue)return 1;if(t===ny.mapValue)return -1;let n=e.fields||{},r=Object.keys(n),i=t.fields||{},s=Object.keys(i);r.sort(),s.sort();for(let e=0;e<r.length&&e<s.length;++e){let t=eo(r[e],s[e]);if(0!==t)return t;let a=nS(n[r[e]],i[s[e]]);if(0!==a)return a}return ea(r.length,s.length)}(e.mapValue,t.mapValue);default:throw G(23264,{he:l})}}function nE(e,t){if("string"==typeof e&&"string"==typeof t&&e.length===t.length)return ea(e,t);let n=nn(e),r=nn(t),i=ea(n.seconds,r.seconds);return 0!==i?i:ea(n.nanos,r.nanos)}function n_(e,t){let n=e.values||[],r=t.values||[];for(let e=0;e<n.length&&e<r.length;++e){let t=nS(n[e],r[e]);if(t)return t}return ea(n.length,r.length)}function nC(e){var t,n;let r;return"nullValue"in e?"null":"booleanValue"in e?""+e.booleanValue:"integerValue"in e?""+e.integerValue:"doubleValue"in e?""+e.doubleValue:"timestampValue"in e?(r=nn(e.timestampValue),`time(${r.seconds},${r.nanos})`):"stringValue"in e?e.stringValue:"bytesValue"in e?ni(e.bytesValue).toBase64():"referenceValue"in e?(t=e.referenceValue,eg.fromName(t).toString()):"geoPointValue"in e?(n=e.geoPointValue,`geo(${n.latitude},${n.longitude})`):"arrayValue"in e?function(e){let t="[",n=!0;for(let r of e.values||[])n?n=!1:t+=",",t+=nC(r);return t+"]"}(e.arrayValue):"mapValue"in e?function(e){let t=Object.keys(e.fields||{}).sort(),n="{",r=!0;for(let i of t)r?r=!1:n+=",",n+=`${i}:${nC(e.fields[i])}`;return n+"}"}(e.mapValue):G(61005,{value:e})}function nA(e,t){return{referenceValue:`projects/${e.projectId}/databases/${e.database}/documents/${t.path.canonicalString()}`}}function nN(e){return!!e&&"integerValue"in e}function nD(e){return!!e&&"arrayValue"in e}function nk(e){return!!e&&"nullValue"in e}function nR(e){return!!e&&"doubleValue"in e&&isNaN(Number(e.doubleValue))}function nP(e){return!!e&&"mapValue"in e}function nO(e){return(e?.mapValue?.fields||{})[ng]?.stringValue===nw}function nM(e){if(e.geoPointValue)return{geoPointValue:{...e.geoPointValue}};if(e.timestampValue&&"object"==typeof e.timestampValue)return{timestampValue:{...e.timestampValue}};if(e.mapValue){let t={mapValue:{fields:{}}};return t0(e.mapValue.fields,(e,n)=>t.mapValue.fields[e]=nM(n)),t}if(e.arrayValue){let t={arrayValue:{values:[]}};for(let n=0;n<(e.arrayValue.values||[]).length;++n)t.arrayValue.values[n]=nM(e.arrayValue.values[n]);return t}return{...e}}function nF(e){return(((e.mapValue||{}).fields||{}).__type__||{}).stringValue===np}let nV={mapValue:{fields:{[ng]:{stringValue:nw},[nv]:{arrayValue:{}}}}};function nL(e,t){let n=nS(e.value,t.value);return 0!==n?n:e.inclusive&&!t.inclusive?-1:!e.inclusive&&t.inclusive?1:0}function nj(e,t){let n=nS(e.value,t.value);return 0!==n?n:e.inclusive&&!t.inclusive?1:!e.inclusive&&t.inclusive?-1:0}class nU{constructor(e){this.value=e}static empty(){return new nU({mapValue:{}})}field(e){if(e.isEmpty())return this.value;{let t=this.value;for(let n=0;n<e.length-1;++n)if(!nP(t=(t.mapValue.fields||{})[e.get(n)]))return null;return(t=(t.mapValue.fields||{})[e.lastSegment()])||null}}set(e,t){this.getFieldsMap(e.popLast())[e.lastSegment()]=nM(t)}setAll(e){let t=em.emptyPath(),n={},r=[];e.forEach((e,i)=>{if(!t.isImmediateParentOf(i)){let e=this.getFieldsMap(t);this.applyChanges(e,n,r),n={},r=[],t=i.popLast()}e?n[i.lastSegment()]=nM(e):r.push(i.lastSegment())});let i=this.getFieldsMap(t);this.applyChanges(i,n,r)}delete(e){let t=this.field(e.popLast());nP(t)&&t.mapValue.fields&&delete t.mapValue.fields[e.lastSegment()]}isEqual(e){return nT(this.value,e.value)}getFieldsMap(e){let t=this.value;t.mapValue.fields||(t.mapValue={fields:{}});for(let n=0;n<e.length;++n){let r=t.mapValue.fields[e.get(n)];nP(r)&&r.mapValue.fields||(r={mapValue:{fields:{}}},t.mapValue.fields[e.get(n)]=r),t=r}return t.mapValue.fields}applyChanges(e,t,n){for(let r of(t0(t,(t,n)=>e[t]=n),n))delete e[r]}clone(){return new nU(nM(this.value))}}class nq{constructor(e,t,n,r,i,s,a){this.key=e,this.documentType=t,this.version=n,this.readTime=r,this.createTime=i,this.data=s,this.documentState=a}static newInvalidDocument(e){return new nq(e,0,e_.min(),e_.min(),e_.min(),nU.empty(),0)}static newFoundDocument(e,t,n,r){return new nq(e,1,t,e_.min(),n,r,0)}static newNoDocument(e,t){return new nq(e,2,t,e_.min(),e_.min(),nU.empty(),0)}static newUnknownDocument(e,t){return new nq(e,3,t,e_.min(),e_.min(),nU.empty(),2)}convertToFoundDocument(e,t){return this.createTime.isEqual(e_.min())&&(2===this.documentType||0===this.documentType)&&(this.createTime=e),this.version=e,this.documentType=1,this.data=t,this.documentState=0,this}convertToNoDocument(e){return this.version=e,this.documentType=2,this.data=nU.empty(),this.documentState=0,this}convertToUnknownDocument(e){return this.version=e,this.documentType=3,this.data=nU.empty(),this.documentState=2,this}setHasCommittedMutations(){return this.documentState=2,this}setHasLocalMutations(){return this.documentState=1,this.version=e_.min(),this}setReadTime(e){return this.readTime=e,this}get hasLocalMutations(){return 1===this.documentState}get hasCommittedMutations(){return 2===this.documentState}get hasPendingWrites(){return this.hasLocalMutations||this.hasCommittedMutations}isValidDocument(){return 0!==this.documentType}isFoundDocument(){return 1===this.documentType}isNoDocument(){return 2===this.documentType}isUnknownDocument(){return 3===this.documentType}isEqual(e){return e instanceof nq&&this.key.isEqual(e.key)&&this.version.isEqual(e.version)&&this.documentType===e.documentType&&this.documentState===e.documentState&&this.data.isEqual(e.data)}mutableCopy(){return new nq(this.key,this.documentType,this.version,this.readTime,this.createTime,this.data.clone(),this.documentState)}toString(){return`Document(${this.key}, ${this.version}, ${JSON.stringify(this.data.value)}, {createTime: ${this.createTime}}), {documentType: ${this.documentType}}), {documentState: ${this.documentState}})`}}class nB{constructor(e,t){this.position=e,this.inclusive=t}}function nz(e,t,n){let r=0;for(let i=0;i<e.position.length;i++){let s=t[i],a=e.position[i];if(r=s.field.isKeyField()?eg.comparator(eg.fromName(a.referenceValue),n.key):nS(a,n.data.field(s.field)),"desc"===s.dir&&(r*=-1),0!==r)break}return r}function n$(e,t){if(null===e)return null===t;if(null===t||e.inclusive!==t.inclusive||e.position.length!==t.position.length)return!1;for(let n=0;n<e.position.length;n++)if(!nT(e.position[n],t.position[n]))return!1;return!0}class nG{constructor(e,t="asc"){this.field=e,this.dir=t}}class nK{}class nQ extends nK{constructor(e,t,n){super(),this.field=e,this.op=t,this.value=n}static create(e,t,n){return e.isKeyField()?"in"===t||"not-in"===t?this.createKeyFieldInFilter(e,t,n):new n0(e,t,n):"array-contains"===t?new n4(e,n):"in"===t?new n3(e,n):"not-in"===t?new n6(e,n):"array-contains-any"===t?new n8(e,n):new nQ(e,t,n)}static createKeyFieldInFilter(e,t,n){return"in"===t?new n1(e,n):new n2(e,n)}matches(e){let t=e.data.field(this.field);return"!="===this.op?null!==t&&void 0===t.nullValue&&this.matchesComparison(nS(t,this.value)):null!==t&&nx(this.value)===nx(t)&&this.matchesComparison(nS(t,this.value))}matchesComparison(e){switch(this.op){case"<":return e<0;case"<=":return e<=0;case"==":return 0===e;case"!=":return 0!==e;case">":return e>0;case">=":return e>=0;default:return G(47266,{operator:this.op})}}isInequality(){return["<","<=",">",">=","!=","not-in"].indexOf(this.op)>=0}getFlattenedFilters(){return[this]}getFilters(){return[this]}}class nH extends nK{constructor(e,t){super(),this.filters=e,this.op=t,this.Pe=null}static create(e,t){return new nH(e,t)}matches(e){return nW(this)?void 0===this.filters.find(t=>!t.matches(e)):void 0!==this.filters.find(t=>t.matches(e))}getFlattenedFilters(){return null!==this.Pe||(this.Pe=this.filters.reduce((e,t)=>e.concat(t.getFlattenedFilters()),[])),this.Pe}getFilters(){return Object.assign([],this.filters)}}function nW(e){return"and"===e.op}function nJ(e){return"or"===e.op}function nY(e){return nX(e)&&nW(e)}function nX(e){for(let t of e.filters)if(t instanceof nH)return!1;return!0}function nZ(e,t){let n=e.filters.concat(t);return nH.create(n,e.op)}class n0 extends nQ{constructor(e,t,n){super(e,t,n),this.key=eg.fromName(n.referenceValue)}matches(e){let t=eg.comparator(e.key,this.key);return this.matchesComparison(t)}}class n1 extends nQ{constructor(e,t){super(e,"in",t),this.keys=n5("in",t)}matches(e){return this.keys.some(t=>t.isEqual(e.key))}}class n2 extends nQ{constructor(e,t){super(e,"not-in",t),this.keys=n5("not-in",t)}matches(e){return!this.keys.some(t=>t.isEqual(e.key))}}function n5(e,t){return(t.arrayValue?.values||[]).map(e=>eg.fromName(e.referenceValue))}class n4 extends nQ{constructor(e,t){super(e,"array-contains",t)}matches(e){let t=e.data.field(this.field);return nD(t)&&nI(t.arrayValue,this.value)}}class n3 extends nQ{constructor(e,t){super(e,"in",t)}matches(e){let t=e.data.field(this.field);return null!==t&&nI(this.value.arrayValue,t)}}class n6 extends nQ{constructor(e,t){super(e,"not-in",t)}matches(e){if(nI(this.value.arrayValue,{nullValue:"NULL_VALUE"}))return!1;let t=e.data.field(this.field);return null!==t&&void 0===t.nullValue&&!nI(this.value.arrayValue,t)}}class n8 extends nQ{constructor(e,t){super(e,"array-contains-any",t)}matches(e){let t=e.data.field(this.field);return!(!nD(t)||!t.arrayValue.values)&&t.arrayValue.values.some(e=>nI(this.value.arrayValue,e))}}class n7{constructor(e,t=null,n=[],r=[],i=null,s=null,a=null){this.path=e,this.collectionGroup=t,this.orderBy=n,this.filters=r,this.limit=i,this.startAt=s,this.endAt=a,this.Te=null}}function n9(e,t=null,n=[],r=[],i=null,s=null,a=null){return new n7(e,t,n,r,i,s,a)}function re(e){if(null===e.Te){let t=e.path.canonicalString();null!==e.collectionGroup&&(t+="|cg:"+e.collectionGroup),t+="|f:",t+=e.filters.map(e=>(function e(t){if(t instanceof nQ)return t.field.canonicalString()+t.op.toString()+nC(t.value);if(nY(t))return t.filters.map(t=>e(t)).join(",");{let n=t.filters.map(t=>e(t)).join(",");return`${t.op}(${n})`}})(e)).join(","),t+="|ob:",t+=e.orderBy.map(e=>e.field.canonicalString()+e.dir).join(","),e2(e.limit)||(t+="|l:",t+=e.limit),e.startAt&&(t+="|lb:",t+=e.startAt.inclusive?"b:":"a:",t+=e.startAt.position.map(e=>nC(e)).join(",")),e.endAt&&(t+="|ub:",t+=e.endAt.inclusive?"a:":"b:",t+=e.endAt.position.map(e=>nC(e)).join(",")),e.Te=t}return e.Te}function rt(e,t){if(e.limit!==t.limit||e.orderBy.length!==t.orderBy.length)return!1;for(let i=0;i<e.orderBy.length;i++){var n,r;if(n=e.orderBy[i],r=t.orderBy[i],!(n.dir===r.dir&&n.field.isEqual(r.field)))return!1}if(e.filters.length!==t.filters.length)return!1;for(let n=0;n<e.filters.length;n++)if(!function e(t,n){return t instanceof nQ?n instanceof nQ&&t.op===n.op&&t.field.isEqual(n.field)&&nT(t.value,n.value):t instanceof nH?n instanceof nH&&t.op===n.op&&t.filters.length===n.filters.length&&t.filters.reduce((t,r,i)=>t&&e(r,n.filters[i]),!0):void G(19439)}(e.filters[n],t.filters[n]))return!1;return e.collectionGroup===t.collectionGroup&&!!e.path.isEqual(t.path)&&!!n$(e.startAt,t.startAt)&&n$(e.endAt,t.endAt)}function rn(e){return eg.isDocumentKey(e.path)&&null===e.collectionGroup&&0===e.filters.length}function rr(e,t){return e.filters.filter(e=>e instanceof nQ&&e.field.isEqual(t))}function ri(e,t,n){let r=nb,i=!0;for(let n of rr(e,t)){let e=nb,t=!0;switch(n.op){case"<":case"<=":var s;e="nullValue"in(s=n.value)?nb:"booleanValue"in s?{booleanValue:!1}:"integerValue"in s||"doubleValue"in s?{doubleValue:NaN}:"timestampValue"in s?{timestampValue:{seconds:Number.MIN_SAFE_INTEGER}}:"stringValue"in s?{stringValue:""}:"bytesValue"in s?{bytesValue:""}:"referenceValue"in s?nA(nm.empty(),eg.empty()):"geoPointValue"in s?{geoPointValue:{latitude:-90,longitude:-180}}:"arrayValue"in s?{arrayValue:{}}:"mapValue"in s?nO(s)?nV:{mapValue:{}}:G(35942,{value:s});break;case"==":case"in":case">=":e=n.value;break;case">":e=n.value,t=!1;break;case"!=":case"not-in":e=nb}0>nL({value:r,inclusive:i},{value:e,inclusive:t})&&(r=e,i=t)}if(null!==n){for(let s=0;s<e.orderBy.length;++s)if(e.orderBy[s].field.isEqual(t)){let e=n.position[s];0>nL({value:r,inclusive:i},{value:e,inclusive:n.inclusive})&&(r=e,i=n.inclusive);break}}return{value:r,inclusive:i}}function rs(e,t,n){let r=ny,i=!0;for(let n of rr(e,t)){let e=ny,t=!0;switch(n.op){case">=":case">":var s;e="nullValue"in(s=n.value)?{booleanValue:!1}:"booleanValue"in s?{doubleValue:NaN}:"integerValue"in s||"doubleValue"in s?{timestampValue:{seconds:Number.MIN_SAFE_INTEGER}}:"timestampValue"in s?{stringValue:""}:"stringValue"in s?{bytesValue:""}:"bytesValue"in s?nA(nm.empty(),eg.empty()):"referenceValue"in s?{geoPointValue:{latitude:-90,longitude:-180}}:"geoPointValue"in s?{arrayValue:{}}:"arrayValue"in s?nV:"mapValue"in s?nO(s)?{mapValue:{}}:ny:G(61959,{value:s}),t=!1;break;case"==":case"in":case"<=":e=n.value;break;case"<":e=n.value,t=!1;break;case"!=":case"not-in":e=ny}nj({value:r,inclusive:i},{value:e,inclusive:t})>0&&(r=e,i=t)}if(null!==n){for(let s=0;s<e.orderBy.length;++s)if(e.orderBy[s].field.isEqual(t)){let e=n.position[s];nj({value:r,inclusive:i},{value:e,inclusive:n.inclusive})>0&&(r=e,i=n.inclusive);break}}return{value:r,inclusive:i}}class ra{constructor(e,t=null,n=[],r=[],i=null,s="F",a=null,o=null){this.path=e,this.collectionGroup=t,this.explicitOrderBy=n,this.filters=r,this.limit=i,this.limitType=s,this.startAt=a,this.endAt=o,this.Ie=null,this.Ee=null,this.Re=null,this.startAt,this.endAt}}function ro(e){return new ra(e)}function rl(e){return 0===e.filters.length&&null===e.limit&&null==e.startAt&&null==e.endAt&&(0===e.explicitOrderBy.length||1===e.explicitOrderBy.length&&e.explicitOrderBy[0].field.isKeyField())}function ru(e){return null!==e.collectionGroup}function rh(e){if(null===e.Ie){let t;e.Ie=[];let n=new Set;for(let t of e.explicitOrderBy)e.Ie.push(t),n.add(t.field.canonicalString());let r=e.explicitOrderBy.length>0?e.explicitOrderBy[e.explicitOrderBy.length-1].dir:"asc";(t=new t3(em.comparator),e.filters.forEach(e=>{e.getFlattenedFilters().forEach(e=>{e.isInequality()&&(t=t.add(e.field))})}),t).forEach(t=>{n.has(t.canonicalString())||t.isKeyField()||e.Ie.push(new nG(t,r))}),n.has(em.keyField().canonicalString())||e.Ie.push(new nG(em.keyField(),r))}return e.Ie}function rc(e){return e.Ee||(e.Ee=rd(e,rh(e))),e.Ee}function rd(e,t){if("F"===e.limitType)return n9(e.path,e.collectionGroup,t,e.filters,e.limit,e.startAt,e.endAt);{t=t.map(e=>{let t="desc"===e.dir?"asc":"desc";return new nG(e.field,t)});let n=e.endAt?new nB(e.endAt.position,e.endAt.inclusive):null,r=e.startAt?new nB(e.startAt.position,e.startAt.inclusive):null;return n9(e.path,e.collectionGroup,t,e.filters,e.limit,n,r)}}function rf(e,t){let n=e.filters.concat([t]);return new ra(e.path,e.collectionGroup,e.explicitOrderBy.slice(),n,e.limit,e.limitType,e.startAt,e.endAt)}function rm(e,t,n){return new ra(e.path,e.collectionGroup,e.explicitOrderBy.slice(),e.filters.slice(),t,n,e.startAt,e.endAt)}function rg(e,t){return rt(rc(e),rc(t))&&e.limitType===t.limitType}function rp(e){return`${re(rc(e))}|lt:${e.limitType}`}function ry(e){var t;let n;return`Query(target=${n=(t=rc(e)).path.canonicalString(),null!==t.collectionGroup&&(n+=" collectionGroup="+t.collectionGroup),t.filters.length>0&&(n+=`, filters: [${t.filters.map(e=>(function e(t){return t instanceof nQ?`${t.field.canonicalString()} ${t.op} ${nC(t.value)}`:t instanceof nH?t.op.toString()+" {"+t.getFilters().map(e).join(" ,")+"}":"Filter"})(e)).join(", ")}]`),e2(t.limit)||(n+=", limit: "+t.limit),t.orderBy.length>0&&(n+=`, orderBy: [${t.orderBy.map(e=>`${e.field.canonicalString()} (${e.dir})`).join(", ")}]`),t.startAt&&(n+=", startAt: ",n+=t.startAt.inclusive?"b:":"a:",n+=t.startAt.position.map(e=>nC(e)).join(",")),t.endAt&&(n+=", endAt: ",n+=t.endAt.inclusive?"a:":"b:",n+=t.endAt.position.map(e=>nC(e)).join(",")),`Target(${n})`}; limitType=${e.limitType})`}function rw(e,t){var n,r,i,s;let a,o,l;return t.isFoundDocument()&&(a=t.key.path,null!==e.collectionGroup?t.key.hasCollectionId(e.collectionGroup)&&e.path.isPrefixOf(a):eg.isDocumentKey(e.path)?e.path.isEqual(a):e.path.isImmediateParentOf(a))&&function(e,t){for(let n of rh(e))if(!n.field.isKeyField()&&null===t.data.field(n.field))return!1;return!0}(e,t)&&function(e,t){for(let n of e.filters)if(!n.matches(t))return!1;return!0}(e,t)&&(n=e,r=t,(!n.startAt||(i=n.startAt,o=nz(i,rh(n),r),i.inclusive?!!(o<=0):!!(o<0)))&&(!n.endAt||(s=n.endAt,l=nz(s,rh(n),r),s.inclusive?!!(l>=0):!!(l>0))))}function rv(e){return e.collectionGroup||(e.path.length%2==1?e.path.lastSegment():e.path.get(e.path.length-2))}function rb(e){return(t,n)=>{let r=!1;for(let i of rh(e)){let e=function(e,t,n){var r;let i,s,a=e.field.isKeyField()?eg.comparator(t.key,n.key):(r=e.field,i=t.data.field(r),s=n.data.field(r),null!==i&&null!==s?nS(i,s):G(42886));switch(e.dir){case"asc":return a;case"desc":return -1*a;default:return G(19790,{direction:e.dir})}}(i,t,n);if(0!==e)return e;r=r||i.field.isKeyField()}return 0}}class rx{constructor(e,t){this.mapKeyFn=e,this.equalsFn=t,this.inner={},this.innerSize=0}get(e){let t=this.mapKeyFn(e),n=this.inner[t];if(void 0!==n){for(let[t,r]of n)if(this.equalsFn(t,e))return r}}has(e){return void 0!==this.get(e)}set(e,t){let n=this.mapKeyFn(e),r=this.inner[n];if(void 0===r)return this.inner[n]=[[e,t]],void this.innerSize++;for(let n=0;n<r.length;n++)if(this.equalsFn(r[n][0],e))return void(r[n]=[e,t]);r.push([e,t]),this.innerSize++}delete(e){let t=this.mapKeyFn(e),n=this.inner[t];if(void 0===n)return!1;for(let r=0;r<n.length;r++)if(this.equalsFn(n[r][0],e))return 1===n.length?delete this.inner[t]:n.splice(r,1),this.innerSize--,!0;return!1}forEach(e){t0(this.inner,(t,n)=>{for(let[t,r]of n)e(t,r)})}isEmpty(){return t1(this.inner)}size(){return this.innerSize}}let rT=new t2(eg.comparator),rI=new t2(eg.comparator);function rS(...e){let t=rI;for(let n of e)t=t.insert(n.key,n);return t}function rE(e){let t=rI;return e.forEach((e,n)=>t=t.insert(e,n.overlayedDocument)),t}function r_(){return new rx(e=>e.toString(),(e,t)=>e.isEqual(t))}let rC=new t2(eg.comparator),rA=new t3(eg.comparator);function rN(...e){let t=rA;for(let n of e)t=t.add(n);return t}let rD=new t3(ea);function rk(e,t){if(e.useProto3Json){if(isNaN(t))return{doubleValue:"NaN"};if(t===1/0)return{doubleValue:"Infinity"};if(t===-1/0)return{doubleValue:"-Infinity"}}return{doubleValue:e5(t)?"-0":t}}function rR(e){return{integerValue:""+e}}class rP{constructor(){this._=void 0}}function rO(e,t){return e instanceof rU?nN(t)||t&&"doubleValue"in t?t:{integerValue:0}:null}class rM extends rP{}class rF extends rP{constructor(e){super(),this.elements=e}}function rV(e,t){let n=rB(t);for(let t of e.elements)n.some(e=>nT(e,t))||n.push(t);return{arrayValue:{values:n}}}class rL extends rP{constructor(e){super(),this.elements=e}}function rj(e,t){let n=rB(t);for(let t of e.elements)n=n.filter(e=>!nT(e,t));return{arrayValue:{values:n}}}class rU extends rP{constructor(e,t){super(),this.serializer=e,this.Ae=t}}function rq(e){return nr(e.integerValue||e.doubleValue)}function rB(e){return nD(e)&&e.arrayValue.values?e.arrayValue.values.slice():[]}class rz{constructor(e,t){this.field=e,this.transform=t}}class r${constructor(e,t){this.version=e,this.transformResults=t}}class rG{constructor(e,t){this.updateTime=e,this.exists=t}static none(){return new rG}static exists(e){return new rG(void 0,e)}static updateTime(e){return new rG(e)}get isNone(){return void 0===this.updateTime&&void 0===this.exists}isEqual(e){return this.exists===e.exists&&(this.updateTime?!!e.updateTime&&this.updateTime.isEqual(e.updateTime):!e.updateTime)}}function rK(e,t){return void 0!==e.updateTime?t.isFoundDocument()&&t.version.isEqual(e.updateTime):void 0===e.exists||e.exists===t.isFoundDocument()}class rQ{}function rH(e,t){if(!e.hasLocalMutations||t&&0===t.fields.length)return null;if(null===t)return e.isNoDocument()?new r2(e.key,rG.none()):new rY(e.key,e.data,rG.none());{let n=e.data,r=nU.empty(),i=new t3(em.comparator);for(let e of t.fields)if(!i.has(e)){let t=n.field(e);null===t&&e.length>1&&(e=e.popLast(),t=n.field(e)),null===t?r.delete(e):r.set(e,t),i=i.add(e)}return new rX(e.key,r,new t7(i.toArray()),rG.none())}}function rW(e,t,n,r){return e instanceof rY?function(e,t,n,r){if(!rK(e.precondition,t))return n;let i=e.value.clone(),s=r1(e.fieldTransforms,r,t);return i.setAll(s),t.convertToFoundDocument(t.version,i).setHasLocalMutations(),null}(e,t,n,r):e instanceof rX?function(e,t,n,r){if(!rK(e.precondition,t))return n;let i=r1(e.fieldTransforms,r,t),s=t.data;return(s.setAll(rZ(e)),s.setAll(i),t.convertToFoundDocument(t.version,s).setHasLocalMutations(),null===n)?null:n.unionWith(e.fieldMask.fields).unionWith(e.fieldTransforms.map(e=>e.field))}(e,t,n,r):rK(e.precondition,t)?(t.convertToNoDocument(t.version).setHasLocalMutations(),null):n}function rJ(e,t){var n,r;return e.type===t.type&&!!e.key.isEqual(t.key)&&!!e.precondition.isEqual(t.precondition)&&(n=e.fieldTransforms,r=t.fieldTransforms,!!(void 0===n&&void 0===r||!(!n||!r)&&eu(n,r,(e,t)=>{var n,r;return e.field.isEqual(t.field)&&(n=e.transform,r=t.transform,n instanceof rF&&r instanceof rF||n instanceof rL&&r instanceof rL?eu(n.elements,r.elements,nT):n instanceof rU&&r instanceof rU?nT(n.Ae,r.Ae):n instanceof rM&&r instanceof rM)})))&&(0===e.type?e.value.isEqual(t.value):1!==e.type||e.data.isEqual(t.data)&&e.fieldMask.isEqual(t.fieldMask))}class rY extends rQ{constructor(e,t,n,r=[]){super(),this.key=e,this.value=t,this.precondition=n,this.fieldTransforms=r,this.type=0}getFieldMask(){return null}}class rX extends rQ{constructor(e,t,n,r,i=[]){super(),this.key=e,this.data=t,this.fieldMask=n,this.precondition=r,this.fieldTransforms=i,this.type=1}getFieldMask(){return this.fieldMask}}function rZ(e){let t=new Map;return e.fieldMask.fields.forEach(n=>{if(!n.isEmpty()){let r=e.data.field(n);t.set(n,r)}}),t}function r0(e,t,n){let r=new Map;Q(e.length===n.length,32656,{Ve:n.length,de:e.length});for(let s=0;s<n.length;s++){var i;let a=e[s],o=a.transform,l=t.data.field(a.field);r.set(a.field,(i=n[s],o instanceof rF?rV(o,l):o instanceof rL?rj(o,l):i))}return r}function r1(e,t,n){let r=new Map;for(let i of e){let e=i.transform,s=n.data.field(i.field);r.set(i.field,function(e,t,n){var r;let i,s,a;return e instanceof rM?(r=t,i={fields:{[na]:{stringValue:ns},[nl]:{timestampValue:{seconds:n.seconds,nanos:n.nanoseconds}}}},r&&nu(r)&&(r=nh(r)),r&&(i.fields[no]=r),{mapValue:i}):e instanceof rF?rV(e,t):e instanceof rL?rj(e,t):(a=rq(s=rO(e,t))+rq(e.Ae),nN(s)&&nN(e.Ae)?rR(a):rk(e.serializer,a))}(e,s,t))}return r}class r2 extends rQ{constructor(e,t){super(),this.key=e,this.precondition=t,this.type=2,this.fieldTransforms=[]}getFieldMask(){return null}}class r5 extends rQ{constructor(e,t){super(),this.key=e,this.precondition=t,this.type=3,this.fieldTransforms=[]}getFieldMask(){return null}}class r4{constructor(e,t,n,r){this.batchId=e,this.localWriteTime=t,this.baseMutations=n,this.mutations=r}applyToRemoteDocument(e,t){let n=t.mutationResults;for(let t=0;t<this.mutations.length;t++){let r=this.mutations[t];r.key.isEqual(e.key)&&function(e,t,n){let r,i;e instanceof rY?(r=e.value.clone(),i=r0(e.fieldTransforms,t,n.transformResults),r.setAll(i),t.convertToFoundDocument(n.version,r).setHasCommittedMutations()):e instanceof rX?function(e,t,n){if(!rK(e.precondition,t))return t.convertToUnknownDocument(n.version);let r=r0(e.fieldTransforms,t,n.transformResults),i=t.data;i.setAll(rZ(e)),i.setAll(r),t.convertToFoundDocument(n.version,i).setHasCommittedMutations()}(e,t,n):t.convertToNoDocument(n.version).setHasCommittedMutations()}(r,e,n[t])}}applyToLocalView(e,t){for(let n of this.baseMutations)n.key.isEqual(e.key)&&(t=rW(n,e,t,this.localWriteTime));for(let n of this.mutations)n.key.isEqual(e.key)&&(t=rW(n,e,t,this.localWriteTime));return t}applyToLocalDocumentSet(e,t){let n=r_();return this.mutations.forEach(r=>{let i=e.get(r.key),s=i.overlayedDocument,a=this.applyToLocalView(s,i.mutatedFields),o=rH(s,a=t.has(r.key)?null:a);null!==o&&n.set(r.key,o),s.isValidDocument()||s.convertToNoDocument(e_.min())}),n}keys(){return this.mutations.reduce((e,t)=>e.add(t.key),rN())}isEqual(e){return this.batchId===e.batchId&&eu(this.mutations,e.mutations,(e,t)=>rJ(e,t))&&eu(this.baseMutations,e.baseMutations,(e,t)=>rJ(e,t))}}class r3{constructor(e,t,n,r){this.batch=e,this.commitVersion=t,this.mutationResults=n,this.docVersions=r}static from(e,t,n){Q(e.mutations.length===n.length,58842,{me:e.mutations.length,fe:n.length});let r=rC,i=e.mutations;for(let e=0;e<i.length;e++)r=r.insert(i[e].key,n[e].version);return new r3(e,t,n,r)}}class r6{constructor(e,t){this.largestBatchId=e,this.mutation=t}getKey(){return this.mutation.key}isEqual(e){return null!==e&&this.mutation===e.mutation}toString(){return`Overlay{
      largestBatchId: ${this.largestBatchId},
      mutation: ${this.mutation.toString()}
    }`}}class r8{constructor(e,t,n){this.alias=e,this.aggregateType=t,this.fieldPath=n}}class r7{constructor(e,t){this.count=e,this.unchangedNames=t}}function r9(e){switch(e){case H.OK:return G(64938);case H.CANCELLED:case H.UNKNOWN:case H.DEADLINE_EXCEEDED:case H.RESOURCE_EXHAUSTED:case H.INTERNAL:case H.UNAVAILABLE:case H.UNAUTHENTICATED:return!1;case H.INVALID_ARGUMENT:case H.NOT_FOUND:case H.ALREADY_EXISTS:case H.PERMISSION_DENIED:case H.FAILED_PRECONDITION:case H.ABORTED:case H.OUT_OF_RANGE:case H.UNIMPLEMENTED:case H.DATA_LOSS:return!0;default:return G(15467,{code:e})}}function ie(e){if(void 0===e)return B("GRPC error has no .code"),H.UNKNOWN;switch(e){case d.OK:return H.OK;case d.CANCELLED:return H.CANCELLED;case d.UNKNOWN:return H.UNKNOWN;case d.DEADLINE_EXCEEDED:return H.DEADLINE_EXCEEDED;case d.RESOURCE_EXHAUSTED:return H.RESOURCE_EXHAUSTED;case d.INTERNAL:return H.INTERNAL;case d.UNAVAILABLE:return H.UNAVAILABLE;case d.UNAUTHENTICATED:return H.UNAUTHENTICATED;case d.INVALID_ARGUMENT:return H.INVALID_ARGUMENT;case d.NOT_FOUND:return H.NOT_FOUND;case d.ALREADY_EXISTS:return H.ALREADY_EXISTS;case d.PERMISSION_DENIED:return H.PERMISSION_DENIED;case d.FAILED_PRECONDITION:return H.FAILED_PRECONDITION;case d.ABORTED:return H.ABORTED;case d.OUT_OF_RANGE:return H.OUT_OF_RANGE;case d.UNIMPLEMENTED:return H.UNIMPLEMENTED;case d.DATA_LOSS:return H.DATA_LOSS;default:return G(39323,{code:e})}}(f=d||(d={}))[f.OK=0]="OK",f[f.CANCELLED=1]="CANCELLED",f[f.UNKNOWN=2]="UNKNOWN",f[f.INVALID_ARGUMENT=3]="INVALID_ARGUMENT",f[f.DEADLINE_EXCEEDED=4]="DEADLINE_EXCEEDED",f[f.NOT_FOUND=5]="NOT_FOUND",f[f.ALREADY_EXISTS=6]="ALREADY_EXISTS",f[f.PERMISSION_DENIED=7]="PERMISSION_DENIED",f[f.UNAUTHENTICATED=16]="UNAUTHENTICATED",f[f.RESOURCE_EXHAUSTED=8]="RESOURCE_EXHAUSTED",f[f.FAILED_PRECONDITION=9]="FAILED_PRECONDITION",f[f.ABORTED=10]="ABORTED",f[f.OUT_OF_RANGE=11]="OUT_OF_RANGE",f[f.UNIMPLEMENTED=12]="UNIMPLEMENTED",f[f.INTERNAL=13]="INTERNAL",f[f.UNAVAILABLE=14]="UNAVAILABLE",f[f.DATA_LOSS=15]="DATA_LOSS";let it=null;function ir(){return new TextEncoder}let ii=new n([0xffffffff,0xffffffff],0);function is(e){let t=ir().encode(e),n=new r;return n.update(t),new Uint8Array(n.digest())}function ia(e){let t=new DataView(e.buffer),r=t.getUint32(0,!0),i=t.getUint32(4,!0),s=t.getUint32(8,!0),a=t.getUint32(12,!0);return[new n([r,i],0),new n([s,a],0)]}class io{constructor(e,t,r){if(this.bitmap=e,this.padding=t,this.hashCount=r,t<0||t>=8)throw new il(`Invalid padding: ${t}`);if(r<0||e.length>0&&0===this.hashCount)throw new il(`Invalid hash count: ${r}`);if(0===e.length&&0!==t)throw new il(`Invalid padding when bitmap length is 0: ${t}`);this.ge=8*e.length-t,this.pe=n.fromNumber(this.ge)}ye(e,t,r){let i=e.add(t.multiply(n.fromNumber(r)));return 1===i.compare(ii)&&(i=new n([i.getBits(0),i.getBits(1)],0)),i.modulo(this.pe).toNumber()}we(e){return!!(this.bitmap[Math.floor(e/8)]&1<<e%8)}mightContain(e){if(0===this.ge)return!1;let[t,n]=ia(is(e));for(let e=0;e<this.hashCount;e++){let r=this.ye(t,n,e);if(!this.we(r))return!1}return!0}static create(e,t,n){let r=new io(new Uint8Array(Math.ceil(e/8)),e%8==0?0:8-e%8,t);return n.forEach(e=>r.insert(e)),r}insert(e){if(0===this.ge)return;let[t,n]=ia(is(e));for(let e=0;e<this.hashCount;e++){let r=this.ye(t,n,e);this.be(r)}}be(e){let t=Math.floor(e/8);this.bitmap[t]|=1<<e%8}}class il extends Error{constructor(){super(...arguments),this.name="BloomFilterError"}}class iu{constructor(e,t,n,r,i){this.snapshotVersion=e,this.targetChanges=t,this.targetMismatches=n,this.documentUpdates=r,this.resolvedLimboDocuments=i}static createSynthesizedRemoteEventForCurrentChange(e,t,n){let r=new Map;return r.set(e,ih.createSynthesizedTargetChangeForCurrentChange(e,t,n)),new iu(e_.min(),r,new t2(ea),rT,rN())}}class ih{constructor(e,t,n,r,i){this.resumeToken=e,this.current=t,this.addedDocuments=n,this.modifiedDocuments=r,this.removedDocuments=i}static createSynthesizedTargetChangeForCurrentChange(e,t,n){return new ih(n,t,rN(),rN(),rN())}}class ic{constructor(e,t,n,r){this.Se=e,this.removedTargetIds=t,this.key=n,this.De=r}}class id{constructor(e,t){this.targetId=e,this.Ce=t}}class im{constructor(e,t,n=ne.EMPTY_BYTE_STRING,r=null){this.state=e,this.targetIds=t,this.resumeToken=n,this.cause=r}}class ig{constructor(){this.ve=0,this.Fe=iw(),this.Me=ne.EMPTY_BYTE_STRING,this.xe=!1,this.Oe=!0}get current(){return this.xe}get resumeToken(){return this.Me}get Ne(){return 0!==this.ve}get Be(){return this.Oe}Le(e){e.approximateByteSize()>0&&(this.Oe=!0,this.Me=e)}ke(){let e=rN(),t=rN(),n=rN();return this.Fe.forEach((r,i)=>{switch(i){case 0:e=e.add(r);break;case 2:t=t.add(r);break;case 1:n=n.add(r);break;default:G(38017,{changeType:i})}}),new ih(this.Me,this.xe,e,t,n)}Ke(){this.Oe=!1,this.Fe=iw()}qe(e,t){this.Oe=!0,this.Fe=this.Fe.insert(e,t)}Ue(e){this.Oe=!0,this.Fe=this.Fe.remove(e)}$e(){this.ve+=1}We(){this.ve-=1,Q(this.ve>=0,3241,{ve:this.ve})}Qe(){this.Oe=!0,this.xe=!0}}class ip{constructor(e){this.Ge=e,this.ze=new Map,this.je=rT,this.He=iy(),this.Je=iy(),this.Ze=new t2(ea)}Xe(e){for(let t of e.Se)e.De&&e.De.isFoundDocument()?this.Ye(t,e.De):this.et(t,e.key,e.De);for(let t of e.removedTargetIds)this.et(t,e.key,e.De)}tt(e){this.forEachTarget(e,t=>{let n=this.nt(t);switch(e.state){case 0:this.rt(t)&&n.Le(e.resumeToken);break;case 1:n.We(),n.Ne||n.Ke(),n.Le(e.resumeToken);break;case 2:n.We(),n.Ne||this.removeTarget(t);break;case 3:this.rt(t)&&(n.Qe(),n.Le(e.resumeToken));break;case 4:this.rt(t)&&(this.it(t),n.Le(e.resumeToken));break;default:G(56790,{state:e.state})}})}forEachTarget(e,t){e.targetIds.length>0?e.targetIds.forEach(t):this.ze.forEach((e,n)=>{this.rt(n)&&t(n)})}st(e){let t=e.targetId,n=e.Ce.count,r=this.ot(t);if(r){let a=r.target;if(rn(a))if(0===n){let e=new eg(a.path);this.et(t,e,nq.newNoDocument(e,e_.min()))}else Q(1===n,20013,{expectedCount:n});else{let r=this._t(t);if(r!==n){var i,s;let n,a,o=this.ut(e),l=o?this.ct(o,e,r):1;0!==l&&(this.it(t),this.Ze=this.Ze.insert(t,2===l?"TargetPurposeExistenceFilterMismatchBloom":"TargetPurposeExistenceFilterMismatch")),it?.lt((i=e.Ce,s=this.Ge.ht(),n={localCacheCount:r,existenceFilterCount:i.count,databaseId:s.database,projectId:s.projectId},(a=i.unchangedNames)&&(n.bloomFilter={applied:0===l,hashCount:a?.hashCount??0,bitmapLength:a?.bits?.bitmap?.length??0,padding:a?.bits?.padding??0,mightContain:e=>o?.mightContain(e)??!1}),n))}}}}ut(e){let t,n,r=e.Ce.unchangedNames;if(!r||!r.bits)return null;let{bits:{bitmap:i="",padding:s=0},hashCount:a=0}=r;try{t=ni(i).toUint8Array()}catch(e){if(e instanceof t9)return z("Decoding the base64 bloom filter in existence filter failed ("+e.message+"); ignoring the bloom filter and falling back to full re-query."),null;throw e}try{n=new io(t,s,a)}catch(e){return z(e instanceof il?"BloomFilter error: ":"Applying bloom filter failed: ",e),null}return 0===n.ge?null:n}ct(e,t,n){return 2*(t.Ce.count!==n-this.Pt(e,t.targetId))}Pt(e,t){let n=this.Ge.getRemoteKeysForTarget(t),r=0;return n.forEach(n=>{let i=this.Ge.ht(),s=`projects/${i.projectId}/databases/${i.database}/documents/${n.path.canonicalString()}`;e.mightContain(s)||(this.et(t,n,null),r++)}),r}Tt(e){let t=new Map;this.ze.forEach((n,r)=>{let i=this.ot(r);if(i){if(n.current&&rn(i.target)){let t=new eg(i.target.path);this.It(t).has(r)||this.Et(r,t)||this.et(r,t,nq.newNoDocument(t,e))}n.Be&&(t.set(r,n.ke()),n.Ke())}});let n=rN();this.Je.forEach((e,t)=>{let r=!0;t.forEachWhile(e=>{let t=this.ot(e);return!t||"TargetPurposeLimboResolution"===t.purpose||(r=!1,!1)}),r&&(n=n.add(e))}),this.je.forEach((t,n)=>n.setReadTime(e));let r=new iu(e,t,this.Ze,this.je,n);return this.je=rT,this.He=iy(),this.Je=iy(),this.Ze=new t2(ea),r}Ye(e,t){if(!this.rt(e))return;let n=2*!!this.Et(e,t.key);this.nt(e).qe(t.key,n),this.je=this.je.insert(t.key,t),this.He=this.He.insert(t.key,this.It(t.key).add(e)),this.Je=this.Je.insert(t.key,this.Rt(t.key).add(e))}et(e,t,n){if(!this.rt(e))return;let r=this.nt(e);this.Et(e,t)?r.qe(t,1):r.Ue(t),this.Je=this.Je.insert(t,this.Rt(t).delete(e)),this.Je=this.Je.insert(t,this.Rt(t).add(e)),n&&(this.je=this.je.insert(t,n))}removeTarget(e){this.ze.delete(e)}_t(e){let t=this.nt(e).ke();return this.Ge.getRemoteKeysForTarget(e).size+t.addedDocuments.size-t.removedDocuments.size}$e(e){this.nt(e).$e()}nt(e){let t=this.ze.get(e);return t||(t=new ig,this.ze.set(e,t)),t}Rt(e){let t=this.Je.get(e);return t||(t=new t3(ea),this.Je=this.Je.insert(e,t)),t}It(e){let t=this.He.get(e);return t||(t=new t3(ea),this.He=this.He.insert(e,t)),t}rt(e){let t=null!==this.ot(e);return t||q("WatchChangeAggregator","Detected inactive target",e),t}ot(e){let t=this.ze.get(e);return t&&t.Ne?null:this.Ge.At(e)}it(e){this.ze.set(e,new ig),this.Ge.getRemoteKeysForTarget(e).forEach(t=>{this.et(e,t,null)})}Et(e,t){return this.Ge.getRemoteKeysForTarget(e).has(t)}}function iy(){return new t2(eg.comparator)}function iw(){return new t2(eg.comparator)}let iv={asc:"ASCENDING",desc:"DESCENDING"},ib={"<":"LESS_THAN","<=":"LESS_THAN_OR_EQUAL",">":"GREATER_THAN",">=":"GREATER_THAN_OR_EQUAL","==":"EQUAL","!=":"NOT_EQUAL","array-contains":"ARRAY_CONTAINS",in:"IN","not-in":"NOT_IN","array-contains-any":"ARRAY_CONTAINS_ANY"},ix={and:"AND",or:"OR"};class iT{constructor(e,t){this.databaseId=e,this.useProto3Json=t}}function iI(e,t){return e.useProto3Json||e2(t)?t:{value:t}}function iS(e,t){return e.useProto3Json?`${new Date(1e3*t.seconds).toISOString().replace(/\.\d*/,"").replace("Z","")}.${("000000000"+t.nanoseconds).slice(-9)}Z`:{seconds:""+t.seconds,nanos:t.nanoseconds}}function iE(e,t){return e.useProto3Json?t.toBase64():t.toUint8Array()}function i_(e){let t;return Q(!!e,49232),e_.fromTimestamp(new eE((t=nn(e)).seconds,t.nanos))}function iC(e,t){return iA(e,t).canonicalString()}function iA(e,t){let n=new ed(["projects",e.projectId,"databases",e.database]).child("documents");return void 0===t?n:n.child(t)}function iN(e){let t=ed.fromString(e);return Q(iG(t),10190,{key:t.toString()}),t}function iD(e,t){return iC(e.databaseId,t.path)}function ik(e,t){let n=iN(t);if(n.get(1)!==e.databaseId.projectId)throw new W(H.INVALID_ARGUMENT,"Tried to deserialize key from different project: "+n.get(1)+" vs "+e.databaseId.projectId);if(n.get(3)!==e.databaseId.database)throw new W(H.INVALID_ARGUMENT,"Tried to deserialize key from different database: "+n.get(3)+" vs "+e.databaseId.database);return new eg(iM(n))}function iR(e,t){return iC(e.databaseId,t)}function iP(e){let t=iN(e);return 4===t.length?ed.emptyPath():iM(t)}function iO(e){return new ed(["projects",e.databaseId.projectId,"databases",e.databaseId.database]).canonicalString()}function iM(e){return Q(e.length>4&&"documents"===e.get(4),29091,{key:e.toString()}),e.popFirst(5)}function iF(e,t,n){return{name:iD(e,t),fields:n.value.mapValue.fields}}function iV(e,t,n){let r=ik(e,t.name),i=i_(t.updateTime),s=t.createTime?i_(t.createTime):e_.min(),a=new nU({mapValue:{fields:t.fields}}),o=nq.newFoundDocument(r,i,s,a);return n&&o.setHasCommittedMutations(),n?o.setHasCommittedMutations():o}function iL(e,t){var n,r;let i;if(t instanceof rY)i={update:iF(e,t.key,t.value)};else if(t instanceof r2)i={delete:iD(e,t.key)};else if(t instanceof rX){let n;i={update:iF(e,t.key,t.data),updateMask:(r=t.fieldMask,n=[],r.fields.forEach(e=>n.push(e.canonicalString())),{fieldPaths:n})}}else{if(!(t instanceof r5))return G(16599,{dt:t.type});i={verify:iD(e,t.key)}}return t.fieldTransforms.length>0&&(i.updateTransforms=t.fieldTransforms.map(e=>(function(e,t){let n=t.transform;if(n instanceof rM)return{fieldPath:t.field.canonicalString(),setToServerValue:"REQUEST_TIME"};if(n instanceof rF)return{fieldPath:t.field.canonicalString(),appendMissingElements:{values:n.elements}};if(n instanceof rL)return{fieldPath:t.field.canonicalString(),removeAllFromArray:{values:n.elements}};if(n instanceof rU)return{fieldPath:t.field.canonicalString(),increment:n.Ae};throw G(20930,{transform:t.transform})})(0,e))),t.precondition.isNone||(i.currentDocument=void 0!==(n=t.precondition).updateTime?{updateTime:iS(e,n.updateTime.toTimestamp())}:void 0!==n.exists?{exists:n.exists}:G(27497)),i}function ij(e,t){var n;let r=t.currentDocument?void 0!==(n=t.currentDocument).updateTime?rG.updateTime(i_(n.updateTime)):void 0!==n.exists?rG.exists(n.exists):rG.none():rG.none(),i=t.updateTransforms?t.updateTransforms.map(t=>{let n;return n=null,"setToServerValue"in t?(Q("REQUEST_TIME"===t.setToServerValue,16630,{proto:t}),n=new rM):"appendMissingElements"in t?n=new rF(t.appendMissingElements.values||[]):"removeAllFromArray"in t?n=new rL(t.removeAllFromArray.values||[]):"increment"in t?n=new rU(e,t.increment):G(16584,{proto:t}),new rz(em.fromServerFormat(t.fieldPath),n)}):[];if(t.update){t.update.name;let n=ik(e,t.update.name),s=new nU({mapValue:{fields:t.update.fields}});return t.updateMask?new rX(n,s,new t7((t.updateMask.fieldPaths||[]).map(e=>em.fromServerFormat(e))),r,i):new rY(n,s,r,i)}return t.delete?new r2(ik(e,t.delete),r):t.verify?new r5(ik(e,t.verify),r):G(1463,{proto:t})}function iU(e,t){return{documents:[iR(e,t.path)]}}function iq(e,t){var n,r;let i,s={structuredQuery:{}},a=t.path;null!==t.collectionGroup?(i=a,s.structuredQuery.from=[{collectionId:t.collectionGroup,allDescendants:!0}]):(i=a.popLast(),s.structuredQuery.from=[{collectionId:a.lastSegment()}]),s.parent=iR(e,i);let o=function(e){if(0!==e.length)return function e(t){var n;let r;return t instanceof nQ?function(e){if("=="===e.op){if(nR(e.value))return{unaryFilter:{field:iz(e.field),op:"IS_NAN"}};if(nk(e.value))return{unaryFilter:{field:iz(e.field),op:"IS_NULL"}}}else if("!="===e.op){if(nR(e.value))return{unaryFilter:{field:iz(e.field),op:"IS_NOT_NAN"}};if(nk(e.value))return{unaryFilter:{field:iz(e.field),op:"IS_NOT_NULL"}}}return{fieldFilter:{field:iz(e.field),op:ib[e.op],value:e.value}}}(t):t instanceof nH?1===(r=(n=t).getFilters().map(t=>e(t))).length?r[0]:{compositeFilter:{op:ix[n.op],filters:r}}:G(54877,{filter:t})}(nH.create(e,"and"))}(t.filters);o&&(s.structuredQuery.where=o);let l=function(e){if(0!==e.length)return e.map(e=>({field:iz(e.field),direction:iv[e.dir]}))}(t.orderBy);l&&(s.structuredQuery.orderBy=l);let u=iI(e,t.limit);return null!==u&&(s.structuredQuery.limit=u),t.startAt&&(s.structuredQuery.startAt={before:(n=t.startAt).inclusive,values:n.position}),t.endAt&&(s.structuredQuery.endAt={before:!(r=t.endAt).inclusive,values:r.position}),{ft:s,parent:i}}function iB(e){var t,n,r;let i,s,a,o,l=iP(e.parent),u=e.structuredQuery,h=u.from?u.from.length:0,c=null;if(h>0){Q(1===h,65062);let e=u.from[0];e.allDescendants?c=e.collectionId:l=l.child(e.collectionId)}let d=[];u.where&&(d=(i=function e(t){return void 0!==t.unaryFilter?function(e){switch(e.unaryFilter.op){case"IS_NAN":let t=i$(e.unaryFilter.field);return nQ.create(t,"==",{doubleValue:NaN});case"IS_NULL":let n=i$(e.unaryFilter.field);return nQ.create(n,"==",{nullValue:"NULL_VALUE"});case"IS_NOT_NAN":let r=i$(e.unaryFilter.field);return nQ.create(r,"!=",{doubleValue:NaN});case"IS_NOT_NULL":let i=i$(e.unaryFilter.field);return nQ.create(i,"!=",{nullValue:"NULL_VALUE"});case"OPERATOR_UNSPECIFIED":return G(61313);default:return G(60726)}}(t):void 0!==t.fieldFilter?nQ.create(i$(t.fieldFilter.field),function(e){switch(e){case"EQUAL":return"==";case"NOT_EQUAL":return"!=";case"GREATER_THAN":return">";case"GREATER_THAN_OR_EQUAL":return">=";case"LESS_THAN":return"<";case"LESS_THAN_OR_EQUAL":return"<=";case"ARRAY_CONTAINS":return"array-contains";case"IN":return"in";case"NOT_IN":return"not-in";case"ARRAY_CONTAINS_ANY":return"array-contains-any";case"OPERATOR_UNSPECIFIED":return G(58110);default:return G(50506)}}(t.fieldFilter.op),t.fieldFilter.value):void 0!==t.compositeFilter?nH.create(t.compositeFilter.filters.map(t=>e(t)),function(e){switch(e){case"AND":return"and";case"OR":return"or";default:return G(1026)}}(t.compositeFilter.op)):G(30097,{filter:t})}(u.where))instanceof nH&&nY(i)?i.getFilters():[i]);let f=[];u.orderBy&&(f=u.orderBy.map(e=>new nG(i$(e.field),function(e){switch(e){case"ASCENDING":return"asc";case"DESCENDING":return"desc";default:return}}(e.direction))));let m=null;u.limit&&(m=e2(s="object"==typeof(t=u.limit)?t.value:t)?null:s);let g=null;u.startAt&&(a=!!(n=u.startAt).before,g=new nB(n.values||[],a));let p=null;return u.endAt&&(o=!(r=u.endAt).before,p=new nB(r.values||[],o)),new ra(l,c,f,d,m,"F",g,p)}function iz(e){return{fieldPath:e.canonicalString()}}function i$(e){return em.fromServerFormat(e.fieldPath)}function iG(e){return e.length>=4&&"projects"===e.get(0)&&"databases"===e.get(2)}function iK(e){return!!e&&"function"==typeof e._toProto&&"ProtoValue"===e._protoValueType}class iQ{constructor(e,t,n,r,i=e_.min(),s=e_.min(),a=ne.EMPTY_BYTE_STRING,o=null){this.target=e,this.targetId=t,this.purpose=n,this.sequenceNumber=r,this.snapshotVersion=i,this.lastLimboFreeSnapshotVersion=s,this.resumeToken=a,this.expectedCount=o}withSequenceNumber(e){return new iQ(this.target,this.targetId,this.purpose,e,this.snapshotVersion,this.lastLimboFreeSnapshotVersion,this.resumeToken,this.expectedCount)}withResumeToken(e,t){return new iQ(this.target,this.targetId,this.purpose,this.sequenceNumber,t,this.lastLimboFreeSnapshotVersion,e,null)}withExpectedCount(e){return new iQ(this.target,this.targetId,this.purpose,this.sequenceNumber,this.snapshotVersion,this.lastLimboFreeSnapshotVersion,this.resumeToken,e)}withLastLimboFreeSnapshotVersion(e){return new iQ(this.target,this.targetId,this.purpose,this.sequenceNumber,this.snapshotVersion,e,this.resumeToken,this.expectedCount)}}class iH{constructor(e){this.yt=e}}function iW(e,t){let n=t.key,r={prefixPath:n.getCollectionPath().popLast().toArray(),collectionGroup:n.collectionGroup,documentId:n.path.lastSegment(),readTime:iJ(t.readTime),hasCommittedMutations:t.hasCommittedMutations};if(t.isFoundDocument()){var i;r.document={name:iD(i=e.yt,t.key),fields:t.data.value.mapValue.fields,updateTime:iS(i,t.version.toTimestamp()),createTime:iS(i,t.createTime.toTimestamp())}}else if(t.isNoDocument())r.noDocument={path:n.path.toArray(),readTime:iY(t.version)};else{if(!t.isUnknownDocument())return G(57904,{document:t});r.unknownDocument={path:n.path.toArray(),version:iY(t.version)}}return r}function iJ(e){let t=e.toTimestamp();return[t.seconds,t.nanoseconds]}function iY(e){let t=e.toTimestamp();return{seconds:t.seconds,nanoseconds:t.nanoseconds}}function iX(e){let t=new eE(e.seconds,e.nanoseconds);return e_.fromTimestamp(t)}function iZ(e,t){let n=(t.baseMutations||[]).map(t=>ij(e.yt,t));for(let e=0;e<t.mutations.length-1;++e){let n=t.mutations[e];e+1<t.mutations.length&&void 0!==t.mutations[e+1].transform&&(n.updateTransforms=t.mutations[e+1].transform.fieldTransforms,t.mutations.splice(e+1,1),++e)}let r=t.mutations.map(t=>ij(e.yt,t)),i=eE.fromMillis(t.localWriteTimeMs);return new r4(t.batchId,i,n,r)}function i0(e){var t;let n,r=iX(e.readTime),i=void 0!==e.lastLimboFreeSnapshotVersion?iX(e.lastLimboFreeSnapshotVersion):e_.min();return new iQ(void 0!==e.query.documents?(Q(1===(n=(t=e.query).documents.length),1966,{count:n}),rc(ro(iP(t.documents[0])))):rc(iB(e.query)),e.targetId,"TargetPurposeListen",e.lastListenSequenceNumber,r,i,ne.fromBase64String(e.resumeToken))}function i1(e,t){let n,r=iY(t.snapshotVersion),i=iY(t.lastLimboFreeSnapshotVersion);n=rn(t.target)?iU(e.yt,t.target):iq(e.yt,t.target).ft;let s=t.resumeToken.toBase64();return{targetId:t.targetId,canonicalId:re(t.target),readTime:r,resumeToken:s,lastListenSequenceNumber:t.sequenceNumber,lastLimboFreeSnapshotVersion:i,query:n}}function i2(e){let t=iB({parent:e.parent,structuredQuery:e.structuredQuery});return"LAST"===e.limitType?rm(t,t.limit,"L"):t}function i5(e,t){return new r6(t.largestBatchId,ij(e.yt,t.overlayMutation))}function i4(e,t){let n=t.path.lastSegment();return[e,e3(t.path.popLast()),n]}function i3(e,t,n,r){return{indexId:e,uid:t,sequenceNumber:n,readTime:iY(r.readTime),documentKey:e3(r.documentKey.path),largestBatchId:r.largestBatchId}}class i6{getBundleMetadata(e,t){return tX(e,tC).get(t).next(e=>{if(e)return{id:e.bundleId,createTime:iX(e.createTime),version:e.version}})}saveBundleMetadata(e,t){return tX(e,tC).put({bundleId:t.id,createTime:iY(i_(t.createTime)),version:t.version})}getNamedQuery(e,t){return tX(e,tA).get(t).next(e=>{if(e)return{name:e.name,query:i2(e.bundledQuery),readTime:iX(e.readTime)}})}saveNamedQuery(e,t){return tX(e,tA).put({name:t.name,readTime:iY(i_(t.readTime)),bundledQuery:t.bundledQuery})}}class i8{constructor(e,t){this.serializer=e,this.userId=t}static wt(e,t){return new i8(e,t.uid||"")}getOverlay(e,t){return tX(e,tj).get(i4(this.userId,t)).next(e=>e?i5(this.serializer,e):null)}getOverlays(e,t){let n=r_();return eU.forEach(t,t=>this.getOverlay(e,t).next(e=>{null!==e&&n.set(t,e)})).next(()=>n)}saveOverlays(e,t,n){let r=[];return n.forEach((n,i)=>{let s=new r6(t,i);r.push(this.bt(e,s))}),eU.waitFor(r)}removeOverlaysForBatchId(e,t,n){let r=new Set;t.forEach(e=>r.add(e3(e.getCollectionPath())));let i=[];return r.forEach(t=>{let r=IDBKeyRange.bound([this.userId,t,n],[this.userId,t,n+1],!1,!0);i.push(tX(e,tj).X(tq,r))}),eU.waitFor(i)}getOverlaysForCollection(e,t,n){let r=r_(),i=e3(t),s=IDBKeyRange.bound([this.userId,i,n],[this.userId,i,1/0],!0);return tX(e,tj).H(tq,s).next(e=>{for(let t of e){let e=i5(this.serializer,t);r.set(e.getKey(),e)}return r})}getOverlaysForCollectionGroup(e,t,n,r){let i,s=r_(),a=IDBKeyRange.bound([this.userId,t,n],[this.userId,t,1/0],!0);return tX(e,tj).ee({index:tz,range:a},(e,t,n)=>{let a=i5(this.serializer,t);s.size()<r||a.largestBatchId===i?(s.set(a.getKey(),a),i=a.largestBatchId):n.done()}).next(()=>s)}bt(e,t){return tX(e,tj).put(function(e,t,n){let[r,i,s]=i4(t,n.mutation.key);return{userId:t,collectionPath:i,documentId:s,collectionGroup:n.mutation.key.getCollectionGroup(),largestBatchId:n.largestBatchId,overlayMutation:iL(e.yt,n.mutation)}}(this.serializer,this.userId,t))}}class i7{St(e){return tX(e,tG)}getSessionToken(e){return this.St(e).get("sessionToken").next(e=>{let t=e?.value;return t?ne.fromUint8Array(t):ne.EMPTY_BYTE_STRING})}setSessionToken(e,t){return this.St(e).put({name:"sessionToken",value:t.toUint8Array()})}}class i9{Dt(e,t){this.Ct(e,t),t.vt()}Ct(e,t){if("nullValue"in e)this.Ft(t,5);else if("booleanValue"in e)this.Ft(t,10),t.Mt(+!!e.booleanValue);else if("integerValue"in e)this.Ft(t,15),t.Mt(nr(e.integerValue));else if("doubleValue"in e){let n=nr(e.doubleValue);isNaN(n)?this.Ft(t,13):(this.Ft(t,15),e5(n)?t.Mt(0):t.Mt(n))}else if("timestampValue"in e){let n=e.timestampValue;this.Ft(t,20),"string"==typeof n&&(n=nn(n)),t.xt(`${n.seconds||""}`),t.Mt(n.nanos||0)}else if("stringValue"in e)this.Ot(e.stringValue,t),this.Nt(t);else if("bytesValue"in e)this.Ft(t,30),t.Bt(ni(e.bytesValue)),this.Nt(t);else if("referenceValue"in e)this.Lt(e.referenceValue,t);else if("geoPointValue"in e){let n=e.geoPointValue;this.Ft(t,45),t.Mt(n.latitude||0),t.Mt(n.longitude||0)}else"mapValue"in e?nF(e)?this.Ft(t,Number.MAX_SAFE_INTEGER):nO(e)?this.kt(e.mapValue,t):(this.Kt(e.mapValue,t),this.Nt(t)):"arrayValue"in e?(this.qt(e.arrayValue,t),this.Nt(t)):G(19022,{Ut:e})}Ot(e,t){this.Ft(t,25),this.$t(e,t)}$t(e,t){t.xt(e)}Kt(e,t){let n=e.fields||{};for(let e of(this.Ft(t,55),Object.keys(n)))this.Ot(e,t),this.Ct(n[e],t)}kt(e,t){let n=e.fields||{};this.Ft(t,53);let r=n[nv].arrayValue?.values?.length||0;this.Ft(t,15),t.Mt(nr(r)),this.Ot(nv,t),this.Ct(n[nv],t)}qt(e,t){let n=e.values||[];for(let e of(this.Ft(t,50),n))this.Ct(e,t)}Lt(e,t){this.Ft(t,37),eg.fromName(e).path.forEach(e=>{this.Ft(t,60),this.$t(e,t)})}Ft(e,t){e.Mt(t)}Nt(e){e.Mt(2)}}function se(e){return Math.ceil((64-function(e){let t=0;for(let n=0;n<8;++n){let r=function(e){if(0===e)return 8;let t=0;return e>>4||(t+=4,e<<=4),e>>6||(t+=2,e<<=2),e>>7||(t+=1),t}(255&e[n]);if(t+=r,8!==r)break}return t}(e))/8)}i9.Wt=new i9;class st{constructor(){this.buffer=new Uint8Array(1024),this.position=0}Qt(e){let t=e[Symbol.iterator](),n=t.next();for(;!n.done;)this.Gt(n.value),n=t.next();this.zt()}jt(e){let t=e[Symbol.iterator](),n=t.next();for(;!n.done;)this.Ht(n.value),n=t.next();this.Jt()}Zt(e){for(let t of e){let e=t.charCodeAt(0);if(e<128)this.Gt(e);else if(e<2048)this.Gt(960|e>>>6),this.Gt(128|63&e);else if(t<"\uD800"||"\uDBFF"<t)this.Gt(480|e>>>12),this.Gt(128|63&e>>>6),this.Gt(128|63&e);else{let e=t.codePointAt(0);this.Gt(240|e>>>18),this.Gt(128|63&e>>>12),this.Gt(128|63&e>>>6),this.Gt(128|63&e)}}this.zt()}Xt(e){for(let t of e){let e=t.charCodeAt(0);if(e<128)this.Ht(e);else if(e<2048)this.Ht(960|e>>>6),this.Ht(128|63&e);else if(t<"\uD800"||"\uDBFF"<t)this.Ht(480|e>>>12),this.Ht(128|63&e>>>6),this.Ht(128|63&e);else{let e=t.codePointAt(0);this.Ht(240|e>>>18),this.Ht(128|63&e>>>12),this.Ht(128|63&e>>>6),this.Ht(128|63&e)}}this.Jt()}Yt(e){let t=this.en(e),n=se(t);this.tn(1+n),this.buffer[this.position++]=255&n;for(let e=t.length-n;e<t.length;++e)this.buffer[this.position++]=255&t[e]}nn(e){let t=this.en(e),n=se(t);this.tn(1+n),this.buffer[this.position++]=~(255&n);for(let e=t.length-n;e<t.length;++e)this.buffer[this.position++]=~(255&t[e])}rn(){this.sn(255),this.sn(255)}_n(){this.an(255),this.an(255)}reset(){this.position=0}seed(e){this.tn(e.length),this.buffer.set(e,this.position),this.position+=e.length}un(){return this.buffer.slice(0,this.position)}en(e){let t,n=((t=new DataView(new ArrayBuffer(8))).setFloat64(0,e,!1),new Uint8Array(t.buffer)),r=!!(128&n[0]);n[0]^=r?255:128;for(let e=1;e<n.length;++e)n[e]^=255*!!r;return n}Gt(e){let t=255&e;0===t?(this.sn(0),this.sn(255)):255===t?(this.sn(255),this.sn(0)):this.sn(t)}Ht(e){let t=255&e;0===t?(this.an(0),this.an(255)):255===t?(this.an(255),this.an(0)):this.an(e)}zt(){this.sn(0),this.sn(1)}Jt(){this.an(0),this.an(1)}sn(e){this.tn(1),this.buffer[this.position++]=e}an(e){this.tn(1),this.buffer[this.position++]=~e}tn(e){let t=e+this.position;if(t<=this.buffer.length)return;let n=2*this.buffer.length;n<t&&(n=t);let r=new Uint8Array(n);r.set(this.buffer),this.buffer=r}}class sn{constructor(e){this.cn=e}Bt(e){this.cn.Qt(e)}xt(e){this.cn.Zt(e)}Mt(e){this.cn.Yt(e)}vt(){this.cn.rn()}}class sr{constructor(e){this.cn=e}Bt(e){this.cn.jt(e)}xt(e){this.cn.Xt(e)}Mt(e){this.cn.nn(e)}vt(){this.cn._n()}}class si{constructor(){this.cn=new st,this.ascending=new sn(this.cn),this.descending=new sr(this.cn)}seed(e){this.cn.seed(e)}ln(e){return 0===e?this.ascending:this.descending}un(){return this.cn.un()}reset(){this.cn.reset()}}class ss{constructor(e,t,n,r){this.hn=e,this.Pn=t,this.Tn=n,this.In=r}En(){let e=this.In.length,t=0===e||255===this.In[e-1]?e+1:e,n=new Uint8Array(t);return n.set(this.In,0),t!==e?n.set([0],this.In.length):++n[n.length-1],new ss(this.hn,this.Pn,this.Tn,n)}Rn(e,t,n){return{indexId:this.hn,uid:e,arrayValue:sl(this.Tn),directionalValue:sl(this.In),orderedDocumentKey:sl(t),documentKey:n.path.toArray()}}An(e,t,n){let r=this.Rn(e,t,n);return[r.indexId,r.uid,r.arrayValue,r.directionalValue,r.orderedDocumentKey,r.documentKey]}}function sa(e,t){let n=e.hn-t.hn;return 0!==n||0!==(n=so(e.Tn,t.Tn))||0!==(n=so(e.In,t.In))?n:eg.comparator(e.Pn,t.Pn)}function so(e,t){for(let n=0;n<e.length&&n<t.length;++n){let r=e[n]-t[n];if(0!==r)return r}return e.length-t.length}function sl(e){return(0,k.isSafariOrWebkit)()?function(e){let t="";for(let n=0;n<e.length;n++)t+=String.fromCharCode(e[n]);return t}(e):e}function su(e){return"string"!=typeof e?e:function(e){let t=new Uint8Array(e.length);for(let n=0;n<e.length;n++)t[n]=e.charCodeAt(n);return t}(e)}class sh{constructor(e){for(const t of(this.Vn=new t3((e,t)=>em.comparator(e.field,t.field)),this.collectionId=null!=e.collectionGroup?e.collectionGroup:e.path.lastSegment(),this.dn=e.orderBy,this.mn=[],e.filters))t.isInequality()?this.Vn=this.Vn.add(t):this.mn.push(t)}get fn(){return this.Vn.size>1}gn(e){if(Q(e.collectionGroup===this.collectionId,49279),this.fn)return!1;let t=eA(e);if(void 0!==t&&!this.pn(t))return!1;let n=eN(e),r=new Set,i=0,s=0;for(;i<n.length&&this.pn(n[i]);++i)r=r.add(n[i].fieldPath.canonicalString());if(i===n.length)return!0;if(this.Vn.size>0){let e=this.Vn.getIterator().getNext();if(!r.has(e.field.canonicalString())){let t=n[i];if(!this.yn(e,t)||!this.wn(this.dn[s++],t))return!1}++i}for(;i<n.length;++i){let e=n[i];if(s>=this.dn.length||!this.wn(this.dn[s++],e))return!1}return!0}bn(){if(this.fn)return null;let e=new t3(em.comparator),t=[];for(let n of this.mn)if(!n.field.isKeyField())if("array-contains"===n.op||"array-contains-any"===n.op)t.push(new ek(n.field,2));else{if(e.has(n.field))continue;e=e.add(n.field),t.push(new ek(n.field,0))}for(let n of this.dn)n.field.isKeyField()||e.has(n.field)||(e=e.add(n.field),t.push(new ek(n.field,+("asc"!==n.dir))));return new eC(eC.UNKNOWN_ID,this.collectionId,t,eR.empty())}pn(e){for(let t of this.mn)if(this.yn(t,e))return!0;return!1}yn(e,t){if(void 0===e||!e.field.isEqual(t.fieldPath))return!1;let n="array-contains"===e.op||"array-contains-any"===e.op;return 2===t.kind===n}wn(e,t){return!!e.field.isEqual(t.fieldPath)&&(0===t.kind&&"asc"===e.dir||1===t.kind&&"desc"===e.dir)}}function sc(e){return e instanceof nQ}function sd(e){return e instanceof nH&&nY(e)}function sf(e){return sc(e)||sd(e)||function(e){if(e instanceof nH&&nJ(e)){for(let t of e.getFilters())if(!sc(t)&&!sd(t))return!1;return!0}return!1}(e)}function sm(e,t){return Q(e instanceof nQ||e instanceof nH,38388),Q(t instanceof nQ||t instanceof nH,25473),sp(e instanceof nQ?t instanceof nQ?nH.create([e,t],"and"):sg(e,t):t instanceof nQ?sg(t,e):function(e,t){if(Q(e.filters.length>0&&t.filters.length>0,48005),nW(e)&&nW(t))return nZ(e,t.getFilters());let n=nJ(e)?e:t,r=nJ(e)?t:e,i=n.filters.map(e=>sm(e,r));return nH.create(i,"or")}(e,t))}function sg(e,t){if(nW(t))return nZ(t,e.getFilters());{let n=t.filters.map(t=>sm(e,t));return nH.create(n,"or")}}function sp(e){if(Q(e instanceof nQ||e instanceof nH,11850),e instanceof nQ)return e;let t=e.getFilters();if(1===t.length)return sp(t[0]);if(nX(e))return e;let n=t.map(e=>sp(e)),r=[];return n.forEach(t=>{t instanceof nQ?r.push(t):t instanceof nH&&(t.op===e.op?r.push(...t.filters):r.push(t))}),1===r.length?r[0]:nH.create(r,e.op)}class sy{constructor(){this.Sn=new sw}addToCollectionParentIndex(e,t){return this.Sn.add(t),eU.resolve()}getCollectionParents(e,t){return eU.resolve(this.Sn.getEntries(t))}addFieldIndex(e,t){return eU.resolve()}deleteFieldIndex(e,t){return eU.resolve()}deleteAllFieldIndexes(e){return eU.resolve()}createTargetIndexes(e,t){return eU.resolve()}getDocumentsMatchingTarget(e,t){return eU.resolve(null)}getIndexType(e,t){return eU.resolve(0)}getFieldIndexes(e,t){return eU.resolve([])}getNextCollectionGroupToUpdate(e){return eU.resolve(null)}getMinOffset(e,t){return eU.resolve(eM.min())}getMinOffsetFromCollectionGroup(e,t){return eU.resolve(eM.min())}updateCollectionGroup(e,t,n){return eU.resolve()}updateIndexEntries(e,t){return eU.resolve()}}class sw{constructor(){this.index={}}add(e){let t=e.lastSegment(),n=e.popLast(),r=this.index[t]||new t3(ed.comparator),i=!r.has(n);return this.index[t]=r.add(n),i}has(e){let t=e.lastSegment(),n=e.popLast(),r=this.index[t];return r&&r.has(n)}getEntries(e){return(this.index[e]||new t3(ed.comparator)).toArray()}}let sv="IndexedDbIndexManager",sb=new Uint8Array(0);class sx{constructor(e,t){this.databaseId=t,this.Dn=new sw,this.Cn=new rx(e=>re(e),(e,t)=>rt(e,t)),this.uid=e.uid||""}addToCollectionParentIndex(e,t){if(!this.Dn.has(t)){let n=t.lastSegment(),r=t.popLast();e.addOnCommittedListener(()=>{this.Dn.add(t)});let i={collectionId:n,parent:e3(r)};return tX(e,tS).put(i)}return eU.resolve()}getCollectionParents(e,t){let n=[],r=IDBKeyRange.bound([t,""],[t+"\0",""],!1,!0);return tX(e,tS).H(r).next(e=>{for(let r of e){if(r.collectionId!==t)break;n.push(e6(r.parent))}return n})}addFieldIndex(e,t){let n=tX(e,tN),r={indexId:t.indexId,collectionGroup:t.collectionGroup,fields:t.fields.map(e=>[e.fieldPath.canonicalString(),e.kind])};delete r.indexId;let i=n.add(r);if(t.indexState){let n=tX(e,tk);return i.next(e=>{n.put(i3(e,this.uid,t.indexState.sequenceNumber,t.indexState.offset))})}return i.next()}deleteFieldIndex(e,t){let n=tX(e,tN),r=tX(e,tk),i=tX(e,tM);return n.delete(t.indexId).next(()=>r.delete(IDBKeyRange.bound([t.indexId],[t.indexId+1],!1,!0))).next(()=>i.delete(IDBKeyRange.bound([t.indexId],[t.indexId+1],!1,!0)))}deleteAllFieldIndexes(e){let t=tX(e,tN),n=tX(e,tM),r=tX(e,tk);return t.X().next(()=>n.X()).next(()=>r.X())}createTargetIndexes(e,t){return eU.forEach(this.vn(t),t=>this.getIndexType(e,t).next(n=>{if(0===n||1===n){let n=new sh(t).bn();if(null!=n)return this.addFieldIndex(e,n)}}))}getDocumentsMatchingTarget(e,t){let n=tX(e,tM),r=!0,i=new Map;return eU.forEach(this.vn(t),t=>this.Fn(e,t).next(e=>{r&&(r=!!e),i.set(t,e)})).next(()=>{if(r){let e=rN(),r=[];return eU.forEach(i,(i,s)=>{q(sv,`Using index id=${i.indexId}|cg=${i.collectionGroup}|f=${i.fields.map(e=>`${e.fieldPath}:${e.kind}`).join(",")} to execute ${re(t)}`);let a=function(e,t){let n=eA(t);if(void 0===n)return null;for(let t of rr(e,n.fieldPath))switch(t.op){case"array-contains-any":return t.value.arrayValue.values||[];case"array-contains":return[t.value]}return null}(s,i),o=function(e,t){let n=new Map;for(let r of eN(t))for(let t of rr(e,r.fieldPath))switch(t.op){case"==":case"in":n.set(r.fieldPath.canonicalString(),t.value);break;case"not-in":case"!=":return n.set(r.fieldPath.canonicalString(),t.value),Array.from(n.values())}return null}(s,i),l=function(e,t){let n=[],r=!0;for(let i of eN(t)){let t=0===i.kind?ri(e,i.fieldPath,e.startAt):rs(e,i.fieldPath,e.startAt);n.push(t.value),r&&(r=t.inclusive)}return new nB(n,r)}(s,i),u=function(e,t){let n=[],r=!0;for(let i of eN(t)){let t=0===i.kind?rs(e,i.fieldPath,e.endAt):ri(e,i.fieldPath,e.endAt);n.push(t.value),r&&(r=t.inclusive)}return new nB(n,r)}(s,i),h=this.Mn(i,s,l),c=this.Mn(i,s,u),d=this.xn(i,s,o),f=this.On(i.indexId,a,h,l.inclusive,c,u.inclusive,d);return eU.forEach(f,i=>n.Z(i,t.limit).next(t=>{t.forEach(t=>{let n=eg.fromSegments(t.documentKey);e.has(n)||(e=e.add(n),r.push(n))})}))}).next(()=>r)}return eU.resolve(null)})}vn(e){let t=this.Cn.get(e);return t||(t=0===e.filters.length?[e]:(function(e){if(0===e.getFilters().length)return[];let t=function e(t){if(Q(t instanceof nQ||t instanceof nH,34018),t instanceof nQ)return t;if(1===t.filters.length)return e(t.filters[0]);let n=t.filters.map(t=>e(t)),r=nH.create(n,t.op);return sf(r=sp(r))?r:(Q(r instanceof nH,64498),Q(nW(r),40251),Q(r.filters.length>1,57927),r.filters.reduce((e,t)=>sm(e,t)))}(function e(t){if(Q(t instanceof nQ||t instanceof nH,20012),t instanceof nQ){if(t instanceof n3){let e=t.value.arrayValue?.values?.map(e=>nQ.create(t.field,"==",e))||[];return nH.create(e,"or")}return t}let n=t.filters.map(t=>e(t));return nH.create(n,t.op)}(e));return Q(sf(t),7391),sc(t)||sd(t)?[t]:t.getFilters()})(nH.create(e.filters,"and")).map(t=>n9(e.path,e.collectionGroup,e.orderBy,t.getFilters(),e.limit,e.startAt,e.endAt)),this.Cn.set(e,t)),t}On(e,t,n,r,i,s,a){let o=(null!=t?t.length:1)*Math.max(n.length,i.length),l=o/(null!=t?t.length:1),u=[];for(let h=0;h<o;++h){let o=t?this.Nn(t[h/l]):sb,c=this.Bn(e,o,n[h%l],r),d=this.Ln(e,o,i[h%l],s),f=a.map(t=>this.Bn(e,o,t,!0));u.push(...this.createRange(c,d,f))}return u}Bn(e,t,n,r){let i=new ss(e,eg.empty(),t,n);return r?i:i.En()}Ln(e,t,n,r){let i=new ss(e,eg.empty(),t,n);return r?i.En():i}Fn(e,t){let n=new sh(t),r=null!=t.collectionGroup?t.collectionGroup:t.path.lastSegment();return this.getFieldIndexes(e,r).next(e=>{let t=null;for(let r of e)n.gn(r)&&(!t||r.fields.length>t.fields.length)&&(t=r);return t})}getIndexType(e,t){let n=2,r=this.vn(t);return eU.forEach(r,t=>this.Fn(e,t).next(e=>{e?0!==n&&e.fields.length<function(e){let t=new t3(em.comparator),n=!1;for(let r of e.filters)for(let e of r.getFlattenedFilters())e.field.isKeyField()||("array-contains"===e.op||"array-contains-any"===e.op?n=!0:t=t.add(e.field));for(let n of e.orderBy)n.field.isKeyField()||(t=t.add(n.field));return t.size+ +!!n}(t)&&(n=1):n=0})).next(()=>null!==t.limit&&r.length>1&&2===n?1:n)}kn(e,t){let n=new si;for(let r of eN(e)){let e=t.data.field(r.fieldPath);if(null==e)return null;let i=n.ln(r.kind);i9.Wt.Dt(e,i)}return n.un()}Nn(e){let t=new si;return i9.Wt.Dt(e,t.ln(0)),t.un()}Kn(e,t){let n,r=new si;return i9.Wt.Dt(nA(this.databaseId,t),r.ln(0===(n=eN(e)).length?0:n[n.length-1].kind)),r.un()}xn(e,t,n){if(null===n)return[];let r=[];r.push(new si);let i=0;for(let s of eN(e)){let e=n[i++];for(let n of r)if(this.qn(t,s.fieldPath)&&nD(e))r=this.Un(r,s,e);else{let t=n.ln(s.kind);i9.Wt.Dt(e,t)}}return this.$n(r)}Mn(e,t,n){return this.xn(e,t,n.position)}$n(e){let t=[];for(let n=0;n<e.length;++n)t[n]=e[n].un();return t}Un(e,t,n){let r=[...e],i=[];for(let e of n.arrayValue.values||[])for(let n of r){let r=new si;r.seed(n.un()),i9.Wt.Dt(e,r.ln(t.kind)),i.push(r)}return i}qn(e,t){return!!e.filters.find(e=>e instanceof nQ&&e.field.isEqual(t)&&("in"===e.op||"not-in"===e.op))}getFieldIndexes(e,t){let n=tX(e,tN),r=tX(e,tk);return(t?n.H(tD,IDBKeyRange.bound(t,t)):n.H()).next(e=>{let t=[];return eU.forEach(e,e=>r.get([e.indexId,this.uid]).next(n=>{let r,i;t.push((r=n?new eR(n.sequenceNumber,new eM(iX(n.readTime),new eg(e6(n.documentKey)),n.largestBatchId)):eR.empty(),i=e.fields.map(([e,t])=>new ek(em.fromServerFormat(e),t)),new eC(e.indexId,e.collectionGroup,i,r)))})).next(()=>t)})}getNextCollectionGroupToUpdate(e){return this.getFieldIndexes(e).next(e=>0===e.length?null:(e.sort((e,t)=>{let n=e.indexState.sequenceNumber-t.indexState.sequenceNumber;return 0!==n?n:ea(e.collectionGroup,t.collectionGroup)}),e[0].collectionGroup))}updateCollectionGroup(e,t,n){let r=tX(e,tN),i=tX(e,tk);return this.Wn(e).next(e=>r.H(tD,IDBKeyRange.bound(t,t)).next(t=>eU.forEach(t,t=>i.put(i3(t.indexId,this.uid,e,n)))))}updateIndexEntries(e,t){let n=new Map;return eU.forEach(t,(t,r)=>{let i=n.get(t.collectionGroup);return(i?eU.resolve(i):this.getFieldIndexes(e,t.collectionGroup)).next(i=>(n.set(t.collectionGroup,i),eU.forEach(i,n=>this.Qn(e,t,n).next(t=>{let i=this.Gn(r,n);return t.isEqual(i)?eU.resolve():this.zn(e,r,n,t,i)}))))})}jn(e,t,n,r){return tX(e,tM).put(r.Rn(this.uid,this.Kn(n,t.key),t.key))}Hn(e,t,n,r){return tX(e,tM).delete(r.An(this.uid,this.Kn(n,t.key),t.key))}Qn(e,t,n){let r=tX(e,tM),i=new t3(sa);return r.ee({index:tV,range:IDBKeyRange.only([n.indexId,this.uid,sl(this.Kn(n,t))])},(e,r)=>{i=i.add(new ss(n.indexId,t,su(r.arrayValue),su(r.directionalValue)))}).next(()=>i)}Gn(e,t){let n=new t3(sa),r=this.kn(t,e);if(null==r)return n;let i=eA(t);if(null!=i){let s=e.data.field(i.fieldPath);if(nD(s))for(let i of s.arrayValue.values||[])n=n.add(new ss(t.indexId,e.key,this.Nn(i),r))}else n=n.add(new ss(t.indexId,e.key,sb,r));return n}zn(e,t,n,r,i){q(sv,"Updating index entries for document '%s'",t.key);let s=[];return function(e,t,n,r,i){let s=e.getIterator(),a=t.getIterator(),o=t8(s),l=t8(a);for(;o||l;){let e=!1,t=!1;if(o&&l){let r=n(o,l);r<0?t=!0:r>0&&(e=!0)}else null!=o?t=!0:e=!0;e?(r(l),l=t8(a)):t?(i(o),o=t8(s)):(o=t8(s),l=t8(a))}}(r,i,sa,r=>{s.push(this.jn(e,t,n,r))},r=>{s.push(this.Hn(e,t,n,r))}),eU.waitFor(s)}Wn(e){let t=1;return tX(e,tk).ee({index:tP,reverse:!0,range:IDBKeyRange.upperBound([this.uid,Number.MAX_SAFE_INTEGER])},(e,n,r)=>{r.done(),t=n.sequenceNumber+1}).next(()=>t)}createRange(e,t,n){n=n.sort((e,t)=>sa(e,t)).filter((e,t,n)=>!t||0!==sa(e,n[t-1]));let r=[];for(let i of(r.push(e),n)){let n=sa(i,e),s=sa(i,t);if(0===n)r[0]=e.En();else if(n>0&&s<0)r.push(i),r.push(i.En());else if(s>0)break}r.push(t);let i=[];for(let e=0;e<r.length;e+=2){if(this.Jn(r[e],r[e+1]))return[];let t=r[e].An(this.uid,sb,eg.empty()),n=r[e+1].An(this.uid,sb,eg.empty());i.push(IDBKeyRange.bound(t,n))}return i}Jn(e,t){return sa(e,t)>0}getMinOffsetFromCollectionGroup(e,t){return this.getFieldIndexes(e,t).next(sT)}getMinOffset(e,t){return eU.mapArray(this.vn(t),t=>this.Fn(e,t).next(e=>e||G(44426))).next(sT)}}function sT(e){Q(0!==e.length,28825);let t=e[0].indexState.offset,n=t.largestBatchId;for(let r=1;r<e.length;r++){let i=e[r].indexState.offset;0>eF(i,t)&&(t=i),n<i.largestBatchId&&(n=i.largestBatchId)}return new eM(t.readTime,t.documentKey,n)}let sI={didRun:!1,sequenceNumbersCollected:0,targetsRemoved:0,documentsRemoved:0};class sS{static withCacheSize(e){return new sS(e,sS.DEFAULT_COLLECTION_PERCENTILE,sS.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT)}constructor(e,t,n){this.cacheSizeCollectionThreshold=e,this.percentileToCollect=t,this.maximumSequenceNumbersToCollect=n}}function sE(e,t,n){let r=e.store(tt),i=e.store(ta),s=[],a=IDBKeyRange.only(n.batchId),o=0,l=r.ee({range:a},(e,t,n)=>(o++,n.delete()));s.push(l.next(()=>{Q(1===o,47070,{batchId:n.batchId})}));let u=[];for(let e of n.mutations){var h,c;let r=(h=e.key.path,c=n.batchId,[t,e3(h),c]);s.push(i.delete(r)),u.push(e.key)}return eU.waitFor(s).next(()=>u)}function s_(e){let t;if(!e)return 0;if(e.document)t=e.document;else if(e.unknownDocument)t=e.unknownDocument;else{if(!e.noDocument)throw G(14731);t=e.noDocument}return JSON.stringify(t).length}sS.DEFAULT_COLLECTION_PERCENTILE=10,sS.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT=1e3,sS.DEFAULT=new sS(0x2800000,sS.DEFAULT_COLLECTION_PERCENTILE,sS.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT),sS.DISABLED=new sS(-1,0,0);class sC{constructor(e,t,n,r){this.userId=e,this.serializer=t,this.indexManager=n,this.referenceDelegate=r,this.Zn={}}static wt(e,t,n,r){return Q(""!==e.uid,64387),new sC(e.isAuthenticated()?e.uid:"",t,n,r)}checkEmpty(e){let t=!0,n=IDBKeyRange.bound([this.userId,-1/0],[this.userId,1/0]);return sN(e).ee({index:tr,range:n},(e,n,r)=>{t=!1,r.done()}).next(()=>t)}addMutationBatch(e,t,n,r){let i=tX(e,ta),s=sN(e);return s.add({}).next(a=>{var o,l,u,h;let c,d;Q("number"==typeof a,49019);let f=new r4(a,t,n,r),m=(o=this.serializer,l=this.userId,c=f.baseMutations.map(e=>iL(o.yt,e)),d=f.mutations.map(e=>iL(o.yt,e)),{userId:l,batchId:f.batchId,localWriteTimeMs:f.localWriteTime.toMillis(),baseMutations:c,mutations:d}),g=[],p=new t3((e,t)=>ea(e.canonicalString(),t.canonicalString()));for(let e of r){let t=(u=this.userId,h=e.key.path,[u,e3(h),a]);p=p.add(e.key.path.popLast()),g.push(s.put(m)),g.push(i.put(t,ts))}return p.forEach(t=>{g.push(this.indexManager.addToCollectionParentIndex(e,t))}),e.addOnCommittedListener(()=>{this.Zn[a]=f.keys()}),eU.waitFor(g).next(()=>f)})}lookupMutationBatch(e,t){return sN(e).get(t).next(e=>e?(Q(e.userId===this.userId,48,"Unexpected user for mutation batch",{userId:e.userId,batchId:t}),iZ(this.serializer,e)):null)}Xn(e,t){return this.Zn[t]?eU.resolve(this.Zn[t]):this.lookupMutationBatch(e,t).next(e=>{if(e){let n=e.keys();return this.Zn[t]=n,n}return null})}getNextMutationBatchAfterBatchId(e,t){let n=t+1,r=IDBKeyRange.lowerBound([this.userId,n]),i=null;return sN(e).ee({index:tr,range:r},(e,t,r)=>{t.userId===this.userId&&(Q(t.batchId>=n,47524,{Yn:n}),i=iZ(this.serializer,t)),r.done()}).next(()=>i)}getHighestUnacknowledgedBatchId(e){let t=IDBKeyRange.upperBound([this.userId,1/0]),n=-1;return sN(e).ee({index:tr,range:t,reverse:!0},(e,t,r)=>{n=t.batchId,r.done()}).next(()=>n)}getAllMutationBatches(e){let t=IDBKeyRange.bound([this.userId,-1],[this.userId,1/0]);return sN(e).H(tr,t).next(e=>e.map(e=>iZ(this.serializer,e)))}getAllMutationBatchesAffectingDocumentKey(e,t){let n=[this.userId,e3(t.path)],r=IDBKeyRange.lowerBound(n),i=[];return tX(e,ta).ee({range:r},(n,r,s)=>{let[a,o,l]=n,u=e6(o);if(a===this.userId&&t.path.isEqual(u))return sN(e).get(l).next(e=>{if(!e)throw G(61480,{er:n,batchId:l});Q(e.userId===this.userId,10503,"Unexpected user for mutation batch",{userId:e.userId,batchId:l}),i.push(iZ(this.serializer,e))});s.done()}).next(()=>i)}getAllMutationBatchesAffectingDocumentKeys(e,t){let n=new t3(ea),r=[];return t.forEach(t=>{let i=[this.userId,e3(t.path)],s=IDBKeyRange.lowerBound(i),a=tX(e,ta).ee({range:s},(e,r,i)=>{let[s,a,o]=e,l=e6(a);s===this.userId&&t.path.isEqual(l)?n=n.add(o):i.done()});r.push(a)}),eU.waitFor(r).next(()=>this.tr(e,n))}getAllMutationBatchesAffectingQuery(e,t){let n=t.path,r=n.length+1,i=[this.userId,e3(n)],s=IDBKeyRange.lowerBound(i),a=new t3(ea);return tX(e,ta).ee({range:s},(e,t,i)=>{let[s,o,l]=e,u=e6(o);s===this.userId&&n.isPrefixOf(u)?u.length===r&&(a=a.add(l)):i.done()}).next(()=>this.tr(e,a))}tr(e,t){let n=[],r=[];return t.forEach(t=>{r.push(sN(e).get(t).next(e=>{if(null===e)throw G(35274,{batchId:t});Q(e.userId===this.userId,9748,"Unexpected user for mutation batch",{userId:e.userId,batchId:t}),n.push(iZ(this.serializer,e))}))}),eU.waitFor(r).next(()=>n)}removeMutationBatch(e,t){return sE(e.le,this.userId,t).next(n=>(e.addOnCommittedListener(()=>{this.nr(t.batchId)}),eU.forEach(n,t=>this.referenceDelegate.markPotentiallyOrphaned(e,t))))}nr(e){delete this.Zn[e]}performConsistencyCheck(e){return this.checkEmpty(e).next(t=>{if(!t)return eU.resolve();let n=IDBKeyRange.lowerBound([this.userId]),r=[];return tX(e,ta).ee({range:n},(e,t,n)=>{if(e[0]===this.userId){let t=e6(e[1]);r.push(t)}else n.done()}).next(()=>{Q(0===r.length,56720,{rr:r.map(e=>e.canonicalString())})})})}containsKey(e,t){return sA(e,this.userId,t)}ir(e){return tX(e,te).get(this.userId).next(e=>e||{userId:this.userId,lastAcknowledgedBatchId:-1,lastStreamToken:""})}}function sA(e,t,n){let r=[t,e3(n.path)],i=r[1],s=IDBKeyRange.lowerBound(r),a=!1;return tX(e,ta).ee({range:s,Y:!0},(e,n,r)=>{let[s,o,l]=e;s===t&&o===i&&(a=!0),r.done()}).next(()=>a)}function sN(e){return tX(e,tt)}class sD{constructor(e){this.sr=e}next(){return this.sr+=2,this.sr}static _r(){return new sD(0)}static ar(){return new sD(-1)}}class sk{constructor(e,t){this.referenceDelegate=e,this.serializer=t}allocateTargetId(e){return this.ur(e).next(t=>{let n=new sD(t.highestTargetId);return t.highestTargetId=n.next(),this.cr(e,t).next(()=>t.highestTargetId)})}getLastRemoteSnapshotVersion(e){return this.ur(e).next(e=>e_.fromTimestamp(new eE(e.lastRemoteSnapshotVersion.seconds,e.lastRemoteSnapshotVersion.nanoseconds)))}getHighestSequenceNumber(e){return this.ur(e).next(e=>e.highestListenSequenceNumber)}setTargetsMetadata(e,t,n){return this.ur(e).next(r=>(r.highestListenSequenceNumber=t,n&&(r.lastRemoteSnapshotVersion=n.toTimestamp()),t>r.highestListenSequenceNumber&&(r.highestListenSequenceNumber=t),this.cr(e,r)))}addTargetData(e,t){return this.lr(e,t).next(()=>this.ur(e).next(n=>(n.targetCount+=1,this.hr(t,n),this.cr(e,n))))}updateTargetData(e,t){return this.lr(e,t)}removeTargetData(e,t){return this.removeMatchingKeysForTargetId(e,t.targetId).next(()=>tX(e,tg).delete(t.targetId)).next(()=>this.ur(e)).next(t=>(Q(t.targetCount>0,8065),t.targetCount-=1,this.cr(e,t)))}removeTargets(e,t,n){let r=0,i=[];return tX(e,tg).ee((s,a)=>{let o=i0(a);o.sequenceNumber<=t&&null===n.get(o.targetId)&&(r++,i.push(this.removeTargetData(e,o)))}).next(()=>eU.waitFor(i)).next(()=>r)}forEachTarget(e,t){return tX(e,tg).ee((e,n)=>{t(i0(n))})}ur(e){return tX(e,tI).get(tT).next(e=>(Q(null!==e,2888),e))}cr(e,t){return tX(e,tI).put(tT,t)}lr(e,t){return tX(e,tg).put(i1(this.serializer,t))}hr(e,t){let n=!1;return e.targetId>t.highestTargetId&&(t.highestTargetId=e.targetId,n=!0),e.sequenceNumber>t.highestListenSequenceNumber&&(t.highestListenSequenceNumber=e.sequenceNumber,n=!0),n}getTargetCount(e){return this.ur(e).next(e=>e.targetCount)}getTargetData(e,t){let n=re(t),r=IDBKeyRange.bound([n,-1/0],[n,1/0]),i=null;return tX(e,tg).ee({range:r,index:tp},(e,n,r)=>{let s=i0(n);rt(t,s.target)&&(i=s,r.done())}).next(()=>i)}addMatchingKeys(e,t,n){let r=[],i=sR(e);return t.forEach(t=>{let s=e3(t.path);r.push(i.put({targetId:n,path:s})),r.push(this.referenceDelegate.addReference(e,n,t))}),eU.waitFor(r)}removeMatchingKeys(e,t,n){let r=sR(e);return eU.forEach(t,t=>{let i=e3(t.path);return eU.waitFor([r.delete([n,i]),this.referenceDelegate.removeReference(e,n,t)])})}removeMatchingKeysForTargetId(e,t){let n=sR(e),r=IDBKeyRange.bound([t],[t+1],!1,!0);return n.delete(r)}getMatchingKeysForTargetId(e,t){let n=IDBKeyRange.bound([t],[t+1],!1,!0),r=sR(e),i=rN();return r.ee({range:n,Y:!0},(e,t,n)=>{let r=new eg(e6(e[1]));i=i.add(r)}).next(()=>i)}containsKey(e,t){let n=e3(t.path),r=IDBKeyRange.bound([n],[n+"\0"],!1,!0),i=0;return sR(e).ee({index:tb,Y:!0,range:r},([e,t],n,r)=>{0!==e&&(i++,r.done())}).next(()=>i>0)}At(e,t){return tX(e,tg).get(t).next(e=>e?i0(e):null)}}function sR(e){return tX(e,tw)}let sP="LruGarbageCollector";function sO([e,t],[n,r]){let i=ea(e,n);return 0===i?ea(t,r):i}class sM{constructor(e){this.Pr=e,this.buffer=new t3(sO),this.Tr=0}Ir(){return++this.Tr}Er(e){let t=[e,this.Ir()];if(this.buffer.size<this.Pr)this.buffer=this.buffer.add(t);else{let e=this.buffer.last();0>sO(t,e)&&(this.buffer=this.buffer.delete(e).add(t))}}get maxValue(){return this.buffer.last()[0]}}class sF{constructor(e,t,n){this.garbageCollector=e,this.asyncQueue=t,this.localStore=n,this.Rr=null}start(){-1!==this.garbageCollector.params.cacheSizeCollectionThreshold&&this.Ar(6e4)}stop(){this.Rr&&(this.Rr.cancel(),this.Rr=null)}get started(){return null!==this.Rr}Ar(e){q(sP,`Garbage collection scheduled in ${e}ms`),this.Rr=this.asyncQueue.enqueueAfterDelay("lru_garbage_collection",e,async()=>{this.Rr=null;try{await this.localStore.collectGarbage(this.garbageCollector)}catch(e){eQ(e)?q(sP,"Ignoring IndexedDB error during garbage collection: ",e):await ej(e)}await this.Ar(3e5)})}}class sV{constructor(e,t){this.Vr=e,this.params=t}calculateTargetCount(e,t){return this.Vr.dr(e).next(e=>Math.floor(t/100*e))}nthSequenceNumber(e,t){if(0===t)return eU.resolve(e1.ce);let n=new sM(t);return this.Vr.forEachTarget(e,e=>n.Er(e.sequenceNumber)).next(()=>this.Vr.mr(e,e=>n.Er(e))).next(()=>n.maxValue)}removeTargets(e,t,n){return this.Vr.removeTargets(e,t,n)}removeOrphanedDocuments(e,t){return this.Vr.removeOrphanedDocuments(e,t)}collect(e,t){return -1===this.params.cacheSizeCollectionThreshold?(q("LruGarbageCollector","Garbage collection skipped; disabled"),eU.resolve(sI)):this.getCacheSize(e).next(n=>n<this.params.cacheSizeCollectionThreshold?(q("LruGarbageCollector",`Garbage collection skipped; Cache size ${n} is lower than threshold ${this.params.cacheSizeCollectionThreshold}`),sI):this.gr(e,t))}getCacheSize(e){return this.Vr.getCacheSize(e)}gr(e,t){let n,r,i,s,a,o,l,u=Date.now();return this.calculateTargetCount(e,this.params.percentileToCollect).next(t=>(t>this.params.maximumSequenceNumbersToCollect?(q("LruGarbageCollector",`Capping sequence numbers to collect down to the maximum of ${this.params.maximumSequenceNumbersToCollect} from ${t}`),r=this.params.maximumSequenceNumbersToCollect):r=t,s=Date.now(),this.nthSequenceNumber(e,r))).next(r=>(n=r,a=Date.now(),this.removeTargets(e,n,t))).next(t=>(i=t,o=Date.now(),this.removeOrphanedDocuments(e,n))).next(e=>(l=Date.now(),U()<=O.LogLevel.DEBUG&&q("LruGarbageCollector",`LRU Garbage Collection
	Counted targets in ${s-u}ms
	Determined least recently used ${r} in `+(a-s)+"ms\n"+`	Removed ${i} targets in `+(o-a)+"ms\n"+`	Removed ${e} documents in `+(l-o)+"ms\n"+`Total Duration: ${l-u}ms`),eU.resolve({didRun:!0,sequenceNumbersCollected:r,targetsRemoved:i,documentsRemoved:e})))}}class sL{constructor(e,t){this.db=e,this.garbageCollector=new sV(this,t)}dr(e){let t=this.pr(e);return this.db.getTargetCache().getTargetCount(e).next(e=>t.next(t=>e+t))}pr(e){let t=0;return this.mr(e,e=>{t++}).next(()=>t)}forEachTarget(e,t){return this.db.getTargetCache().forEachTarget(e,t)}mr(e,t){return this.yr(e,(e,n)=>t(n))}addReference(e,t,n){return sj(e,n)}removeReference(e,t,n){return sj(e,n)}removeTargets(e,t,n){return this.db.getTargetCache().removeTargets(e,t,n)}markPotentiallyOrphaned(e,t){return sj(e,t)}wr(e,t){let n;return n=!1,tX(e,te).te(r=>sA(e,r,t).next(e=>(e&&(n=!0),eU.resolve(!e)))).next(()=>n)}removeOrphanedDocuments(e,t){let n=this.db.getRemoteDocumentCache().newChangeBuffer(),r=[],i=0;return this.yr(e,(s,a)=>{if(a<=t){let t=this.wr(e,s).next(t=>{if(!t)return i++,n.getEntry(e,s).next(()=>(n.removeEntry(s,e_.min()),sR(e).delete([0,e3(s.path)])))});r.push(t)}}).next(()=>eU.waitFor(r)).next(()=>n.apply(e)).next(()=>i)}removeTarget(e,t){let n=t.withSequenceNumber(e.currentSequenceNumber);return this.db.getTargetCache().updateTargetData(e,n)}updateLimboDocument(e,t){return sj(e,t)}yr(e,t){let n=sR(e),r,i=e1.ce;return n.ee({index:tb},([e,n],{path:s,sequenceNumber:a})=>{0===e?(i!==e1.ce&&t(new eg(e6(r)),i),i=a,r=s):i=e1.ce}).next(()=>{i!==e1.ce&&t(new eg(e6(r)),i)})}getCacheSize(e){return this.db.getRemoteDocumentCache().getSize(e)}}function sj(e,t){var n;return sR(e).put((n=e.currentSequenceNumber,{targetId:0,path:e3(t.path),sequenceNumber:n}))}class sU{constructor(){this.changes=new rx(e=>e.toString(),(e,t)=>e.isEqual(t)),this.changesApplied=!1}addEntry(e){this.assertNotApplied(),this.changes.set(e.key,e)}removeEntry(e,t){this.assertNotApplied(),this.changes.set(e,nq.newInvalidDocument(e).setReadTime(t))}getEntry(e,t){this.assertNotApplied();let n=this.changes.get(t);return void 0!==n?eU.resolve(n):this.getFromCache(e,t)}getEntries(e,t){return this.getAllFromCache(e,t)}apply(e){return this.assertNotApplied(),this.changesApplied=!0,this.applyChanges(e)}assertNotApplied(){}}class sq{constructor(e){this.serializer=e}setIndexManager(e){this.indexManager=e}addEntry(e,t,n){return tX(e,to).put(n)}removeEntry(e,t,n){let r;return tX(e,to).delete([(r=t.path.toArray()).slice(0,r.length-2),r[r.length-2],iJ(n),r[r.length-1]])}updateMetadata(e,t){return this.getMetadata(e).next(n=>(n.byteSize+=t,this.br(e,n)))}getEntry(e,t){let n=nq.newInvalidDocument(t);return tX(e,to).ee({index:tu,range:IDBKeyRange.only(sz(t))},(e,r)=>{n=this.Sr(t,r)}).next(()=>n)}Dr(e,t){let n={size:0,document:nq.newInvalidDocument(t)};return tX(e,to).ee({index:tu,range:IDBKeyRange.only(sz(t))},(e,r)=>{n={document:this.Sr(t,r),size:s_(r)}}).next(()=>n)}getEntries(e,t){let n=rT;return this.Cr(e,t,(e,t)=>{let r=this.Sr(e,t);n=n.insert(e,r)}).next(()=>n)}vr(e,t){let n=rT,r=new t2(eg.comparator);return this.Cr(e,t,(e,t)=>{let i=this.Sr(e,t);n=n.insert(e,i),r=r.insert(e,s_(t))}).next(()=>({documents:n,Fr:r}))}Cr(e,t,n){if(t.isEmpty())return eU.resolve();let r=new t3(sG);t.forEach(e=>r=r.add(e));let i=IDBKeyRange.bound(sz(r.first()),sz(r.last())),s=r.getIterator(),a=s.getNext();return tX(e,to).ee({index:tu,range:i},(e,t,r)=>{let i=eg.fromSegments([...t.prefixPath,t.collectionGroup,t.documentId]);for(;a&&0>sG(a,i);)n(a,null),a=s.getNext();a&&a.isEqual(i)&&(n(a,t),a=s.hasNext()?s.getNext():null),a?r.j(sz(a)):r.done()}).next(()=>{for(;a;)n(a,null),a=s.hasNext()?s.getNext():null})}getDocumentsMatchingQuery(e,t,n,r,i){let s=t.path,a=[s.popLast().toArray(),s.lastSegment(),iJ(n.readTime),n.documentKey.path.isEmpty()?"":n.documentKey.path.lastSegment()],o=[s.popLast().toArray(),s.lastSegment(),[Number.MAX_SAFE_INTEGER,Number.MAX_SAFE_INTEGER],""];return tX(e,to).H(IDBKeyRange.bound(a,o,!0)).next(e=>{i?.incrementDocumentReadCount(e.length);let n=rT;for(let i of e){let e=this.Sr(eg.fromSegments(i.prefixPath.concat(i.collectionGroup,i.documentId)),i);e.isFoundDocument()&&(rw(t,e)||r.has(e.key))&&(n=n.insert(e.key,e))}return n})}getAllFromCollectionGroup(e,t,n,r){let i=rT,s=s$(t,n),a=s$(t,eM.max());return tX(e,to).ee({index:tc,range:IDBKeyRange.bound(s,a,!0)},(e,t,n)=>{let s=this.Sr(eg.fromSegments(t.prefixPath.concat(t.collectionGroup,t.documentId)),t);(i=i.insert(s.key,s)).size===r&&n.done()}).next(()=>i)}newChangeBuffer(e){return new sB(this,!!e&&e.trackRemovals)}getSize(e){return this.getMetadata(e).next(e=>e.byteSize)}getMetadata(e){return tX(e,tf).get(tm).next(e=>(Q(!!e,20021),e))}br(e,t){return tX(e,tf).put(tm,t)}Sr(e,t){if(t){let e=function(e,t){var n;let r,i;if(t.document)r=iV(e.yt,t.document,!!t.hasCommittedMutations);else if(t.noDocument){let e=eg.fromSegments(t.noDocument.path),n=iX(t.noDocument.readTime);r=nq.newNoDocument(e,n),t.hasCommittedMutations&&r.setHasCommittedMutations()}else{if(!t.unknownDocument)return G(56709);{let e=eg.fromSegments(t.unknownDocument.path),n=iX(t.unknownDocument.version);r=nq.newUnknownDocument(e,n)}}return t.readTime&&r.setReadTime((i=new eE((n=t.readTime)[0],n[1]),e_.fromTimestamp(i))),r}(this.serializer,t);if(!(e.isNoDocument()&&e.version.isEqual(e_.min())))return e}return nq.newInvalidDocument(e)}}class sB extends sU{constructor(e,t){super(),this.Mr=e,this.trackRemovals=t,this.Or=new rx(e=>e.toString(),(e,t)=>e.isEqual(t))}applyChanges(e){let t=[],n=0,r=new t3((e,t)=>ea(e.canonicalString(),t.canonicalString()));return this.changes.forEach((i,s)=>{let a=this.Or.get(i);if(t.push(this.Mr.removeEntry(e,i,a.readTime)),s.isValidDocument()){let o=iW(this.Mr.serializer,s);r=r.add(i.path.popLast());let l=s_(o);n+=l-a.size,t.push(this.Mr.addEntry(e,i,o))}else if(n-=a.size,this.trackRemovals){let n=iW(this.Mr.serializer,s.convertToNoDocument(e_.min()));t.push(this.Mr.addEntry(e,i,n))}}),r.forEach(n=>{t.push(this.Mr.indexManager.addToCollectionParentIndex(e,n))}),t.push(this.Mr.updateMetadata(e,n)),eU.waitFor(t)}getFromCache(e,t){return this.Mr.Dr(e,t).next(e=>(this.Or.set(t,{size:e.size,readTime:e.document.readTime}),e.document))}getAllFromCache(e,t){return this.Mr.vr(e,t).next(({documents:e,Fr:t})=>(t.forEach((t,n)=>{this.Or.set(t,{size:n,readTime:e.get(t).readTime})}),e))}}function sz(e){let t=e.path.toArray();return[t.slice(0,t.length-2),t[t.length-2],t[t.length-1]]}function s$(e,t){let n=t.documentKey.path.toArray();return[e,iJ(t.readTime),n.slice(0,n.length-2),n.length>0?n[n.length-1]:""]}function sG(e,t){let n=e.path.toArray(),r=t.path.toArray(),i=0;for(let e=0;e<n.length-2&&e<r.length-2;++e)if(i=ea(n[e],r[e]))return i;return(i=ea(n.length,r.length))||(i=ea(n[n.length-2],r[r.length-2]))||ea(n[n.length-1],r[r.length-1])}class sK{constructor(e,t){this.overlayedDocument=e,this.mutatedFields=t}}class sQ{constructor(e,t,n,r){this.remoteDocumentCache=e,this.mutationQueue=t,this.documentOverlayCache=n,this.indexManager=r}getDocument(e,t){let n=null;return this.documentOverlayCache.getOverlay(e,t).next(r=>(n=r,this.remoteDocumentCache.getEntry(e,t))).next(e=>(null!==n&&rW(n.mutation,e,t7.empty(),eE.now()),e))}getDocuments(e,t){return this.remoteDocumentCache.getEntries(e,t).next(t=>this.getLocalViewOfDocuments(e,t,rN()).next(()=>t))}getLocalViewOfDocuments(e,t,n=rN()){let r=r_();return this.populateOverlays(e,r,t).next(()=>this.computeViews(e,t,r,n).next(e=>{let t=rS();return e.forEach((e,n)=>{t=t.insert(e,n.overlayedDocument)}),t}))}getOverlayedDocuments(e,t){let n=r_();return this.populateOverlays(e,n,t).next(()=>this.computeViews(e,t,n,rN()))}populateOverlays(e,t,n){let r=[];return n.forEach(e=>{t.has(e)||r.push(e)}),this.documentOverlayCache.getOverlays(e,r).next(e=>{e.forEach((e,n)=>{t.set(e,n)})})}computeViews(e,t,n,r){let i=rT,s=r_(),a=r_();return t.forEach((e,t)=>{let a=n.get(t.key);r.has(t.key)&&(void 0===a||a.mutation instanceof rX)?i=i.insert(t.key,t):void 0!==a?(s.set(t.key,a.mutation.getFieldMask()),rW(a.mutation,t,a.mutation.getFieldMask(),eE.now())):s.set(t.key,t7.empty())}),this.recalculateAndSaveOverlays(e,i).next(e=>(e.forEach((e,t)=>s.set(e,t)),t.forEach((e,t)=>a.set(e,new sK(t,s.get(e)??null))),a))}recalculateAndSaveOverlays(e,t){let n=r_(),r=new t2((e,t)=>e-t),i=rN();return this.mutationQueue.getAllMutationBatchesAffectingDocumentKeys(e,t).next(e=>{for(let i of e)i.keys().forEach(e=>{let s=t.get(e);if(null===s)return;let a=n.get(e)||t7.empty();a=i.applyToLocalView(s,a),n.set(e,a);let o=(r.get(i.batchId)||rN()).add(e);r=r.insert(i.batchId,o)})}).next(()=>{let s=[],a=r.getReverseIterator();for(;a.hasNext();){let r=a.getNext(),o=r.key,l=r.value,u=r_();l.forEach(e=>{if(!i.has(e)){let r=rH(t.get(e),n.get(e));null!==r&&u.set(e,r),i=i.add(e)}}),s.push(this.documentOverlayCache.saveOverlays(e,o,u))}return eU.waitFor(s)}).next(()=>n)}recalculateAndSaveOverlaysForDocumentKeys(e,t){return this.remoteDocumentCache.getEntries(e,t).next(t=>this.recalculateAndSaveOverlays(e,t))}getDocumentsMatchingQuery(e,t,n,r){return eg.isDocumentKey(t.path)&&null===t.collectionGroup&&0===t.filters.length?this.getDocumentsMatchingDocumentQuery(e,t.path):ru(t)?this.getDocumentsMatchingCollectionGroupQuery(e,t,n,r):this.getDocumentsMatchingCollectionQuery(e,t,n,r)}getNextDocuments(e,t,n,r){return this.remoteDocumentCache.getAllFromCollectionGroup(e,t,n,r).next(i=>{let s=r-i.size>0?this.documentOverlayCache.getOverlaysForCollectionGroup(e,t,n.largestBatchId,r-i.size):eU.resolve(r_()),a=-1,o=i;return s.next(t=>eU.forEach(t,(t,n)=>(a<n.largestBatchId&&(a=n.largestBatchId),i.get(t)?eU.resolve():this.remoteDocumentCache.getEntry(e,t).next(e=>{o=o.insert(t,e)}))).next(()=>this.populateOverlays(e,t,i)).next(()=>this.computeViews(e,o,t,rN())).next(e=>({batchId:a,changes:rE(e)})))})}getDocumentsMatchingDocumentQuery(e,t){return this.getDocument(e,new eg(t)).next(e=>{let t=rS();return e.isFoundDocument()&&(t=t.insert(e.key,e)),t})}getDocumentsMatchingCollectionGroupQuery(e,t,n,r){let i=t.collectionGroup,s=rS();return this.indexManager.getCollectionParents(e,i).next(a=>eU.forEach(a,a=>{let o=new ra(a.child(i),null,t.explicitOrderBy.slice(),t.filters.slice(),t.limit,t.limitType,t.startAt,t.endAt);return this.getDocumentsMatchingCollectionQuery(e,o,n,r).next(e=>{e.forEach((e,t)=>{s=s.insert(e,t)})})}).next(()=>s))}getDocumentsMatchingCollectionQuery(e,t,n,r){let i;return this.documentOverlayCache.getOverlaysForCollection(e,t.path,n.largestBatchId).next(s=>(i=s,this.remoteDocumentCache.getDocumentsMatchingQuery(e,t,n,i,r))).next(e=>{i.forEach((t,n)=>{let r=n.getKey();null===e.get(r)&&(e=e.insert(r,nq.newInvalidDocument(r)))});let n=rS();return e.forEach((e,r)=>{let s=i.get(e);void 0!==s&&rW(s.mutation,r,t7.empty(),eE.now()),rw(t,r)&&(n=n.insert(e,r))}),n})}}class sH{constructor(e){this.serializer=e,this.Nr=new Map,this.Br=new Map}getBundleMetadata(e,t){return eU.resolve(this.Nr.get(t))}saveBundleMetadata(e,t){return this.Nr.set(t.id,{id:t.id,version:t.version,createTime:i_(t.createTime)}),eU.resolve()}getNamedQuery(e,t){return eU.resolve(this.Br.get(t))}saveNamedQuery(e,t){return this.Br.set(t.name,{name:t.name,query:i2(t.bundledQuery),readTime:i_(t.readTime)}),eU.resolve()}}class sW{constructor(){this.overlays=new t2(eg.comparator),this.Lr=new Map}getOverlay(e,t){return eU.resolve(this.overlays.get(t))}getOverlays(e,t){let n=r_();return eU.forEach(t,t=>this.getOverlay(e,t).next(e=>{null!==e&&n.set(t,e)})).next(()=>n)}saveOverlays(e,t,n){return n.forEach((n,r)=>{this.bt(e,t,r)}),eU.resolve()}removeOverlaysForBatchId(e,t,n){let r=this.Lr.get(n);return void 0!==r&&(r.forEach(e=>this.overlays=this.overlays.remove(e)),this.Lr.delete(n)),eU.resolve()}getOverlaysForCollection(e,t,n){let r=r_(),i=t.length+1,s=new eg(t.child("")),a=this.overlays.getIteratorFrom(s);for(;a.hasNext();){let e=a.getNext().value,s=e.getKey();if(!t.isPrefixOf(s.path))break;s.path.length===i&&e.largestBatchId>n&&r.set(e.getKey(),e)}return eU.resolve(r)}getOverlaysForCollectionGroup(e,t,n,r){let i=new t2((e,t)=>e-t),s=this.overlays.getIterator();for(;s.hasNext();){let e=s.getNext().value;if(e.getKey().getCollectionGroup()===t&&e.largestBatchId>n){let t=i.get(e.largestBatchId);null===t&&(t=r_(),i=i.insert(e.largestBatchId,t)),t.set(e.getKey(),e)}}let a=r_(),o=i.getIterator();for(;o.hasNext()&&(o.getNext().value.forEach((e,t)=>a.set(e,t)),!(a.size()>=r)););return eU.resolve(a)}bt(e,t,n){let r=this.overlays.get(n.key);if(null!==r){let e=this.Lr.get(r.largestBatchId).delete(n.key);this.Lr.set(r.largestBatchId,e)}this.overlays=this.overlays.insert(n.key,new r6(t,n));let i=this.Lr.get(t);void 0===i&&(i=rN(),this.Lr.set(t,i)),this.Lr.set(t,i.add(n.key))}}class sJ{constructor(){this.sessionToken=ne.EMPTY_BYTE_STRING}getSessionToken(e){return eU.resolve(this.sessionToken)}setSessionToken(e,t){return this.sessionToken=t,eU.resolve()}}class sY{constructor(){this.kr=new t3(sX.Kr),this.qr=new t3(sX.Ur)}isEmpty(){return this.kr.isEmpty()}addReference(e,t){let n=new sX(e,t);this.kr=this.kr.add(n),this.qr=this.qr.add(n)}$r(e,t){e.forEach(e=>this.addReference(e,t))}removeReference(e,t){this.Wr(new sX(e,t))}Qr(e,t){e.forEach(e=>this.removeReference(e,t))}Gr(e){let t=new eg(new ed([])),n=new sX(t,e),r=new sX(t,e+1),i=[];return this.qr.forEachInRange([n,r],e=>{this.Wr(e),i.push(e.key)}),i}zr(){this.kr.forEach(e=>this.Wr(e))}Wr(e){this.kr=this.kr.delete(e),this.qr=this.qr.delete(e)}jr(e){let t=new eg(new ed([])),n=new sX(t,e),r=new sX(t,e+1),i=rN();return this.qr.forEachInRange([n,r],e=>{i=i.add(e.key)}),i}containsKey(e){let t=new sX(e,0),n=this.kr.firstAfterOrEqual(t);return null!==n&&e.isEqual(n.key)}}class sX{constructor(e,t){this.key=e,this.Hr=t}static Kr(e,t){return eg.comparator(e.key,t.key)||ea(e.Hr,t.Hr)}static Ur(e,t){return ea(e.Hr,t.Hr)||eg.comparator(e.key,t.key)}}class sZ{constructor(e,t){this.indexManager=e,this.referenceDelegate=t,this.mutationQueue=[],this.Yn=1,this.Jr=new t3(sX.Kr)}checkEmpty(e){return eU.resolve(0===this.mutationQueue.length)}addMutationBatch(e,t,n,r){let i=this.Yn;this.Yn++,this.mutationQueue.length>0&&this.mutationQueue[this.mutationQueue.length-1];let s=new r4(i,t,n,r);for(let t of(this.mutationQueue.push(s),r))this.Jr=this.Jr.add(new sX(t.key,i)),this.indexManager.addToCollectionParentIndex(e,t.key.path.popLast());return eU.resolve(s)}lookupMutationBatch(e,t){return eU.resolve(this.Zr(t))}getNextMutationBatchAfterBatchId(e,t){let n=this.Xr(t+1),r=n<0?0:n;return eU.resolve(this.mutationQueue.length>r?this.mutationQueue[r]:null)}getHighestUnacknowledgedBatchId(){return eU.resolve(0===this.mutationQueue.length?-1:this.Yn-1)}getAllMutationBatches(e){return eU.resolve(this.mutationQueue.slice())}getAllMutationBatchesAffectingDocumentKey(e,t){let n=new sX(t,0),r=new sX(t,1/0),i=[];return this.Jr.forEachInRange([n,r],e=>{let t=this.Zr(e.Hr);i.push(t)}),eU.resolve(i)}getAllMutationBatchesAffectingDocumentKeys(e,t){let n=new t3(ea);return t.forEach(e=>{let t=new sX(e,0),r=new sX(e,1/0);this.Jr.forEachInRange([t,r],e=>{n=n.add(e.Hr)})}),eU.resolve(this.Yr(n))}getAllMutationBatchesAffectingQuery(e,t){let n=t.path,r=n.length+1,i=n;eg.isDocumentKey(i)||(i=i.child(""));let s=new sX(new eg(i),0),a=new t3(ea);return this.Jr.forEachWhile(e=>{let t=e.key.path;return!!n.isPrefixOf(t)&&(t.length===r&&(a=a.add(e.Hr)),!0)},s),eU.resolve(this.Yr(a))}Yr(e){let t=[];return e.forEach(e=>{let n=this.Zr(e);null!==n&&t.push(n)}),t}removeMutationBatch(e,t){Q(0===this.ei(t.batchId,"removed"),55003),this.mutationQueue.shift();let n=this.Jr;return eU.forEach(t.mutations,r=>{let i=new sX(r.key,t.batchId);return n=n.delete(i),this.referenceDelegate.markPotentiallyOrphaned(e,r.key)}).next(()=>{this.Jr=n})}nr(e){}containsKey(e,t){let n=new sX(t,0),r=this.Jr.firstAfterOrEqual(n);return eU.resolve(t.isEqual(r&&r.key))}performConsistencyCheck(e){return this.mutationQueue.length,eU.resolve()}ei(e,t){return this.Xr(e)}Xr(e){return 0===this.mutationQueue.length?0:e-this.mutationQueue[0].batchId}Zr(e){let t=this.Xr(e);return t<0||t>=this.mutationQueue.length?null:this.mutationQueue[t]}}class s0{constructor(e){this.ti=e,this.docs=new t2(eg.comparator),this.size=0}setIndexManager(e){this.indexManager=e}addEntry(e,t){let n=t.key,r=this.docs.get(n),i=r?r.size:0,s=this.ti(t);return this.docs=this.docs.insert(n,{document:t.mutableCopy(),size:s}),this.size+=s-i,this.indexManager.addToCollectionParentIndex(e,n.path.popLast())}removeEntry(e){let t=this.docs.get(e);t&&(this.docs=this.docs.remove(e),this.size-=t.size)}getEntry(e,t){let n=this.docs.get(t);return eU.resolve(n?n.document.mutableCopy():nq.newInvalidDocument(t))}getEntries(e,t){let n=rT;return t.forEach(e=>{let t=this.docs.get(e);n=n.insert(e,t?t.document.mutableCopy():nq.newInvalidDocument(e))}),eU.resolve(n)}getDocumentsMatchingQuery(e,t,n,r){let i=rT,s=t.path,a=new eg(s.child("__id-9223372036854775808__")),o=this.docs.getIteratorFrom(a);for(;o.hasNext();){let{key:e,value:{document:a}}=o.getNext();if(!s.isPrefixOf(e.path))break;e.path.length>s.length+1||0>=eF(eO(a),n)||(r.has(a.key)||rw(t,a))&&(i=i.insert(a.key,a.mutableCopy()))}return eU.resolve(i)}getAllFromCollectionGroup(e,t,n,r){G(9500)}ni(e,t){return eU.forEach(this.docs,e=>t(e))}newChangeBuffer(e){return new s1(this)}getSize(e){return eU.resolve(this.size)}}class s1 extends sU{constructor(e){super(),this.Mr=e}applyChanges(e){let t=[];return this.changes.forEach((n,r)=>{r.isValidDocument()?t.push(this.Mr.addEntry(e,r)):this.Mr.removeEntry(n)}),eU.waitFor(t)}getFromCache(e,t){return this.Mr.getEntry(e,t)}getAllFromCache(e,t){return this.Mr.getEntries(e,t)}}class s2{constructor(e){this.persistence=e,this.ri=new rx(e=>re(e),rt),this.lastRemoteSnapshotVersion=e_.min(),this.highestTargetId=0,this.ii=0,this.si=new sY,this.targetCount=0,this.oi=sD._r()}forEachTarget(e,t){return this.ri.forEach((e,n)=>t(n)),eU.resolve()}getLastRemoteSnapshotVersion(e){return eU.resolve(this.lastRemoteSnapshotVersion)}getHighestSequenceNumber(e){return eU.resolve(this.ii)}allocateTargetId(e){return this.highestTargetId=this.oi.next(),eU.resolve(this.highestTargetId)}setTargetsMetadata(e,t,n){return n&&(this.lastRemoteSnapshotVersion=n),t>this.ii&&(this.ii=t),eU.resolve()}lr(e){this.ri.set(e.target,e);let t=e.targetId;t>this.highestTargetId&&(this.oi=new sD(t),this.highestTargetId=t),e.sequenceNumber>this.ii&&(this.ii=e.sequenceNumber)}addTargetData(e,t){return this.lr(t),this.targetCount+=1,eU.resolve()}updateTargetData(e,t){return this.lr(t),eU.resolve()}removeTargetData(e,t){return this.ri.delete(t.target),this.si.Gr(t.targetId),this.targetCount-=1,eU.resolve()}removeTargets(e,t,n){let r=0,i=[];return this.ri.forEach((s,a)=>{a.sequenceNumber<=t&&null===n.get(a.targetId)&&(this.ri.delete(s),i.push(this.removeMatchingKeysForTargetId(e,a.targetId)),r++)}),eU.waitFor(i).next(()=>r)}getTargetCount(e){return eU.resolve(this.targetCount)}getTargetData(e,t){let n=this.ri.get(t)||null;return eU.resolve(n)}addMatchingKeys(e,t,n){return this.si.$r(t,n),eU.resolve()}removeMatchingKeys(e,t,n){this.si.Qr(t,n);let r=this.persistence.referenceDelegate,i=[];return r&&t.forEach(t=>{i.push(r.markPotentiallyOrphaned(e,t))}),eU.waitFor(i)}removeMatchingKeysForTargetId(e,t){return this.si.Gr(t),eU.resolve()}getMatchingKeysForTargetId(e,t){let n=this.si.jr(t);return eU.resolve(n)}containsKey(e,t){return eU.resolve(this.si.containsKey(t))}}class s5{constructor(e,t){this._i={},this.overlays={},this.ai=new e1(0),this.ui=!1,this.ui=!0,this.ci=new sJ,this.referenceDelegate=e(this),this.li=new s2(this),this.indexManager=new sy,this.remoteDocumentCache=new s0(e=>this.referenceDelegate.hi(e)),this.serializer=new iH(t),this.Pi=new sH(this.serializer)}start(){return Promise.resolve()}shutdown(){return this.ui=!1,Promise.resolve()}get started(){return this.ui}setDatabaseDeletedListener(){}setNetworkEnabled(){}getIndexManager(e){return this.indexManager}getDocumentOverlayCache(e){let t=this.overlays[e.toKey()];return t||(t=new sW,this.overlays[e.toKey()]=t),t}getMutationQueue(e,t){let n=this._i[e.toKey()];return n||(n=new sZ(t,this.referenceDelegate),this._i[e.toKey()]=n),n}getGlobalsCache(){return this.ci}getTargetCache(){return this.li}getRemoteDocumentCache(){return this.remoteDocumentCache}getBundleCache(){return this.Pi}runTransaction(e,t,n){q("MemoryPersistence","Starting transaction:",e);let r=new s4(this.ai.next());return this.referenceDelegate.Ti(),n(r).next(e=>this.referenceDelegate.Ii(r).next(()=>e)).toPromise().then(e=>(r.raiseOnCommittedEvent(),e))}Ei(e,t){return eU.or(Object.values(this._i).map(n=>()=>n.containsKey(e,t)))}}class s4 extends eL{constructor(e){super(),this.currentSequenceNumber=e}}class s3{constructor(e){this.persistence=e,this.Ri=new sY,this.Ai=null}static Vi(e){return new s3(e)}get di(){if(this.Ai)return this.Ai;throw G(60996)}addReference(e,t,n){return this.Ri.addReference(n,t),this.di.delete(n.toString()),eU.resolve()}removeReference(e,t,n){return this.Ri.removeReference(n,t),this.di.add(n.toString()),eU.resolve()}markPotentiallyOrphaned(e,t){return this.di.add(t.toString()),eU.resolve()}removeTarget(e,t){this.Ri.Gr(t.targetId).forEach(e=>this.di.add(e.toString()));let n=this.persistence.getTargetCache();return n.getMatchingKeysForTargetId(e,t.targetId).next(e=>{e.forEach(e=>this.di.add(e.toString()))}).next(()=>n.removeTargetData(e,t))}Ti(){this.Ai=new Set}Ii(e){let t=this.persistence.getRemoteDocumentCache().newChangeBuffer();return eU.forEach(this.di,n=>{let r=eg.fromPath(n);return this.mi(e,r).next(e=>{e||t.removeEntry(r,e_.min())})}).next(()=>(this.Ai=null,t.apply(e)))}updateLimboDocument(e,t){return this.mi(e,t).next(e=>{e?this.di.delete(t.toString()):this.di.add(t.toString())})}hi(e){return 0}mi(e,t){return eU.or([()=>eU.resolve(this.Ri.containsKey(t)),()=>this.persistence.getTargetCache().containsKey(e,t),()=>this.persistence.Ei(e,t)])}}class s6{constructor(e,t){this.persistence=e,this.fi=new rx(e=>e3(e.path),(e,t)=>e.isEqual(t)),this.garbageCollector=new sV(this,t)}static Vi(e,t){return new s6(e,t)}Ti(){}Ii(e){return eU.resolve()}forEachTarget(e,t){return this.persistence.getTargetCache().forEachTarget(e,t)}dr(e){let t=this.pr(e);return this.persistence.getTargetCache().getTargetCount(e).next(e=>t.next(t=>e+t))}pr(e){let t=0;return this.mr(e,e=>{t++}).next(()=>t)}mr(e,t){return eU.forEach(this.fi,(n,r)=>this.wr(e,n,r).next(e=>e?eU.resolve():t(r)))}removeTargets(e,t,n){return this.persistence.getTargetCache().removeTargets(e,t,n)}removeOrphanedDocuments(e,t){let n=0,r=this.persistence.getRemoteDocumentCache(),i=r.newChangeBuffer();return r.ni(e,r=>this.wr(e,r,t).next(e=>{e||(n++,i.removeEntry(r,e_.min()))})).next(()=>i.apply(e)).next(()=>n)}markPotentiallyOrphaned(e,t){return this.fi.set(t,e.currentSequenceNumber),eU.resolve()}removeTarget(e,t){let n=t.withSequenceNumber(e.currentSequenceNumber);return this.persistence.getTargetCache().updateTargetData(e,n)}addReference(e,t,n){return this.fi.set(n,e.currentSequenceNumber),eU.resolve()}removeReference(e,t,n){return this.fi.set(n,e.currentSequenceNumber),eU.resolve()}updateLimboDocument(e,t){return this.fi.set(t,e.currentSequenceNumber),eU.resolve()}hi(e){let t=e.key.toString().length;return e.isFoundDocument()&&(t+=function e(t){switch(nx(t)){case 0:case 1:return 4;case 2:return 8;case 3:case 8:return 16;case 4:let n=nh(t);return n?16+e(n):16;case 5:return 2*t.stringValue.length;case 6:return ni(t.bytesValue).approximateByteSize();case 7:return t.referenceValue.length;case 9:return(t.arrayValue.values||[]).reduce((t,n)=>t+e(n),0);case 10:case 11:var r;let i;return r=t.mapValue,i=0,t0(r.fields,(t,n)=>{i+=t.length+e(n)}),i;default:throw G(13486,{value:t})}}(e.data.value)),t}wr(e,t,n){return eU.or([()=>this.persistence.Ei(e,t),()=>this.persistence.getTargetCache().containsKey(e,t),()=>{let e=this.fi.get(t);return eU.resolve(void 0!==e&&e>n)}])}getCacheSize(e){return this.persistence.getRemoteDocumentCache().getSize(e)}}class s8{constructor(e){this.serializer=e}k(e,t,n,r){let i=new eB("createOrUpgrade",t);n<1&&r>=1&&(e.createObjectStore(e7),e.createObjectStore(te,{keyPath:"userId"}),e.createObjectStore(tt,{keyPath:tn,autoIncrement:!0}).createIndex(tr,ti,{unique:!0}),e.createObjectStore(ta),s7(e),e.createObjectStore(e8));let s=eU.resolve();return n<3&&r>=3&&(0!==n&&(e.deleteObjectStore(tw),e.deleteObjectStore(tg),e.deleteObjectStore(tI),s7(e)),s=s.next(()=>{let e,t;return e=i.store(tI),t={highestTargetId:0,highestListenSequenceNumber:0,lastRemoteSnapshotVersion:e_.min().toTimestamp(),targetCount:0},e.put(tT,t)})),n<4&&r>=4&&(0!==n&&(s=s.next(()=>i.store(tt).H().next(t=>{e.deleteObjectStore(tt),e.createObjectStore(tt,{keyPath:tn,autoIncrement:!0}).createIndex(tr,ti,{unique:!0});let n=i.store(tt),r=t.map(e=>n.put(e));return eU.waitFor(r)}))),s=s.next(()=>{e.createObjectStore(t_,{keyPath:"clientId"})})),n<5&&r>=5&&(s=s.next(()=>this.gi(i))),n<6&&r>=6&&(s=s.next(()=>(e.createObjectStore(tf),this.pi(i)))),n<7&&r>=7&&(s=s.next(()=>this.yi(i))),n<8&&r>=8&&(s=s.next(()=>this.wi(e,i))),n<9&&r>=9&&(s=s.next(()=>{e.objectStoreNames.contains("remoteDocumentChanges")&&e.deleteObjectStore("remoteDocumentChanges")})),n<10&&r>=10&&(s=s.next(()=>this.bi(i))),n<11&&r>=11&&(s=s.next(()=>{e.createObjectStore(tC,{keyPath:"bundleId"}),e.createObjectStore(tA,{keyPath:"name"})})),n<12&&r>=12&&(s=s.next(()=>{let t;(t=e.createObjectStore(tj,{keyPath:tU})).createIndex(tq,tB,{unique:!1}),t.createIndex(tz,t$,{unique:!1})})),n<13&&r>=13&&(s=s.next(()=>{let t;(t=e.createObjectStore(to,{keyPath:tl})).createIndex(tu,th),t.createIndex(tc,td)}).next(()=>this.Si(e,i)).next(()=>e.deleteObjectStore(e8))),n<14&&r>=14&&(s=s.next(()=>this.Di(e,i))),n<15&&r>=15&&(s=s.next(()=>{e.createObjectStore(tN,{keyPath:"indexId",autoIncrement:!0}).createIndex(tD,"collectionGroup",{unique:!1}),e.createObjectStore(tk,{keyPath:tR}).createIndex(tP,tO,{unique:!1}),e.createObjectStore(tM,{keyPath:tF}).createIndex(tV,tL,{unique:!1})})),n<16&&r>=16&&(s=s.next(()=>{t.objectStore(tk).clear()}).next(()=>{t.objectStore(tM).clear()})),n<17&&r>=17&&(s=s.next(()=>{e.createObjectStore(tG,{keyPath:"name"})})),n<18&&r>=18&&(0,k.isSafariOrWebkit)()&&(s=s.next(()=>{t.objectStore(tk).clear()}).next(()=>{t.objectStore(tM).clear()})),s}pi(e){let t=0;return e.store(e8).ee((e,n)=>{t+=s_(n)}).next(()=>{let n={byteSize:t};return e.store(tf).put(tm,n)})}gi(e){let t=e.store(te),n=e.store(tt);return t.H().next(t=>eU.forEach(t,t=>{let r=IDBKeyRange.bound([t.userId,-1],[t.userId,t.lastAcknowledgedBatchId]);return n.H(tr,r).next(n=>eU.forEach(n,n=>{Q(n.userId===t.userId,18650,"Cannot process batch from unexpected user",{batchId:n.batchId});let r=iZ(this.serializer,n);return sE(e,t.userId,r).next(()=>{})}))}))}yi(e){let t=e.store(tw),n=e.store(e8);return e.store(tI).get(tT).next(e=>{let r=[];return n.ee((n,i)=>{let s=new ed(n),a=[0,e3(s)];r.push(t.get(a).next(n=>n?eU.resolve():t.put({targetId:0,path:e3(s),sequenceNumber:e.highestListenSequenceNumber})))}).next(()=>eU.waitFor(r))})}wi(e,t){e.createObjectStore(tS,{keyPath:tE});let n=t.store(tS),r=new sw,i=e=>{if(r.add(e)){let t=e.lastSegment(),r=e.popLast();return n.put({collectionId:t,parent:e3(r)})}};return t.store(e8).ee({Y:!0},(e,t)=>i(new ed(e).popLast())).next(()=>t.store(ta).ee({Y:!0},([e,t,n],r)=>i(e6(t).popLast())))}bi(e){let t=e.store(tg);return t.ee((e,n)=>{let r=i0(n),i=i1(this.serializer,r);return t.put(i)})}Si(e,t){let n=t.store(e8),r=[];return n.ee((e,n)=>{let i=t.store(to),s=(n.document?new eg(ed.fromString(n.document.name).popFirst(5)):n.noDocument?eg.fromSegments(n.noDocument.path):n.unknownDocument?eg.fromSegments(n.unknownDocument.path):G(36783)).path.toArray(),a={prefixPath:s.slice(0,s.length-2),collectionGroup:s[s.length-2],documentId:s[s.length-1],readTime:n.readTime||[0,0],unknownDocument:n.unknownDocument,noDocument:n.noDocument,document:n.document,hasCommittedMutations:!!n.hasCommittedMutations};r.push(i.put(a))}).next(()=>eU.waitFor(r))}Di(e,t){let n=t.store(tt),r=new sq(this.serializer),i=new s5(s3.Vi,this.serializer.yt);return n.H().next(e=>{let n=new Map;return e.forEach(e=>{let t=n.get(e.userId)??rN();iZ(this.serializer,e).keys().forEach(e=>t=t.add(e)),n.set(e.userId,t)}),eU.forEach(n,(e,n)=>{let s=new V(n),a=i8.wt(this.serializer,s),o=i.getIndexManager(s);return new sQ(r,sC.wt(s,this.serializer,o,i.referenceDelegate),a,o).recalculateAndSaveOverlaysForDocumentKeys(new tY(t,e1.ce),e).next()})})}}function s7(e){e.createObjectStore(tw,{keyPath:tv}).createIndex(tb,tx,{unique:!0}),e.createObjectStore(tg,{keyPath:"targetId"}).createIndex(tp,ty,{unique:!0}),e.createObjectStore(tI)}let s9="IndexedDbPersistence",ae="Failed to obtain exclusive access to the persistence layer. To allow shared access, multi-tab synchronization has to be enabled in all tabs. If you are using `experimentalForceOwningTab:true`, make sure that only one tab has persistence enabled at any given time.";class at{constructor(e,t,n,r,i,s,a,o,l,u,h=18){if(this.allowTabSynchronization=e,this.persistenceKey=t,this.clientId=n,this.Ci=i,this.window=s,this.document=a,this.Fi=l,this.Mi=u,this.xi=h,this.ai=null,this.ui=!1,this.isPrimary=!1,this.networkEnabled=!0,this.Oi=null,this.inForeground=!1,this.Ni=null,this.Bi=null,this.Li=-1/0,this.ki=e=>Promise.resolve(),!at.v())throw new W(H.UNIMPLEMENTED,"This platform is either missing IndexedDB or is known to have an incomplete implementation. Offline persistence has been disabled.");this.referenceDelegate=new sL(this,r),this.Ki=t+"main",this.serializer=new iH(o),this.qi=new ez(this.Ki,this.xi,new s8(this.serializer)),this.ci=new i7,this.li=new sk(this.referenceDelegate,this.serializer),this.remoteDocumentCache=new sq(this.serializer),this.Pi=new i6,this.window&&this.window.localStorage?this.Ui=this.window.localStorage:(this.Ui=null,!1===u&&B(s9,"LocalStorage is unavailable. As a result, persistence may not work reliably. In particular enablePersistence() could fail immediately after refreshing the page."))}start(){return this.$i().then(()=>{if(!this.isPrimary&&!this.allowTabSynchronization)throw new W(H.FAILED_PRECONDITION,ae);return this.Wi(),this.Qi(),this.Gi(),this.runTransaction("getHighestListenSequenceNumber","readonly",e=>this.li.getHighestSequenceNumber(e))}).then(e=>{this.ai=new e1(e,this.Fi)}).then(()=>{this.ui=!0}).catch(e=>(this.qi&&this.qi.close(),Promise.reject(e)))}zi(e){return this.ki=async t=>{if(this.started)return e(t)},e(this.isPrimary)}setDatabaseDeletedListener(e){this.qi.q(async t=>{null===t.newVersion&&await e()})}setNetworkEnabled(e){this.networkEnabled!==e&&(this.networkEnabled=e,this.Ci.enqueueAndForget(async()=>{this.started&&await this.$i()}))}$i(){return this.runTransaction("updateClientMetadataAndTryBecomePrimary","readwrite",e=>tX(e,t_).put({clientId:this.clientId,updateTimeMs:Date.now(),networkEnabled:this.networkEnabled,inForeground:this.inForeground}).next(()=>{if(this.isPrimary)return this.ji(e).next(e=>{e||(this.isPrimary=!1,this.Ci.enqueueRetryable(()=>this.ki(!1)))})}).next(()=>this.Hi(e)).next(t=>this.isPrimary&&!t?this.Ji(e).next(()=>!1):!!t&&this.Zi(e).next(()=>!0))).catch(e=>{if(eQ(e))return q(s9,"Failed to extend owner lease: ",e),this.isPrimary;if(!this.allowTabSynchronization)throw e;return q(s9,"Releasing owner lease after error during lease refresh",e),!1}).then(e=>{this.isPrimary!==e&&this.Ci.enqueueRetryable(()=>this.ki(e)),this.isPrimary=e})}ji(e){return tX(e,e7).get(e9).next(e=>eU.resolve(this.Xi(e)))}Yi(e){return tX(e,t_).delete(this.clientId)}async es(){if(this.isPrimary&&!this.ts(this.Li,18e5)){this.Li=Date.now();let e=await this.runTransaction("maybeGarbageCollectMultiClientState","readwrite-primary",e=>{let t=tX(e,t_);return t.H().next(e=>{let n=this.ns(e,18e5),r=e.filter(e=>-1===n.indexOf(e));return eU.forEach(r,e=>t.delete(e.clientId)).next(()=>r)})}).catch(()=>[]);if(this.Ui)for(let t of e)this.Ui.removeItem(this.rs(t.clientId))}}Gi(){this.Bi=this.Ci.enqueueAfterDelay("client_metadata_refresh",4e3,()=>this.$i().then(()=>this.es()).then(()=>this.Gi()))}Xi(e){return!!e&&e.ownerId===this.clientId}Hi(e){return this.Mi?eU.resolve(!0):tX(e,e7).get(e9).next(t=>{if(null!==t&&this.ts(t.leaseTimestampMs,5e3)&&!this.ss(t.ownerId)){if(this.Xi(t)&&this.networkEnabled)return!0;if(!this.Xi(t)){if(!t.allowTabSynchronization)throw new W(H.FAILED_PRECONDITION,ae);return!1}}return!(!this.networkEnabled||!this.inForeground)||tX(e,t_).H().next(e=>void 0===this.ns(e,5e3).find(e=>{if(this.clientId!==e.clientId){let t=!this.networkEnabled&&e.networkEnabled,n=!this.inForeground&&e.inForeground,r=this.networkEnabled===e.networkEnabled;if(t||n&&r)return!0}return!1}))}).next(e=>(this.isPrimary!==e&&q(s9,`Client ${e?"is":"is not"} eligible for a primary lease.`),e))}async shutdown(){this.ui=!1,this._s(),this.Bi&&(this.Bi.cancel(),this.Bi=null),this.us(),this.cs(),await this.qi.runTransaction("shutdown","readwrite",[e7,t_],e=>{let t=new tY(e,e1.ce);return this.Ji(t).next(()=>this.Yi(t))}),this.qi.close(),this.ls()}ns(e,t){return e.filter(e=>this.ts(e.updateTimeMs,t)&&!this.ss(e.clientId))}hs(){return this.runTransaction("getActiveClients","readonly",e=>tX(e,t_).H().next(e=>this.ns(e,18e5).map(e=>e.clientId)))}get started(){return this.ui}getGlobalsCache(){return this.ci}getMutationQueue(e,t){return sC.wt(e,this.serializer,t,this.referenceDelegate)}getTargetCache(){return this.li}getRemoteDocumentCache(){return this.remoteDocumentCache}getIndexManager(e){return new sx(e,this.serializer.yt.databaseId)}getDocumentOverlayCache(e){return i8.wt(this.serializer,e)}getBundleCache(){return this.Pi}runTransaction(e,t,n){var r;let i;q(s9,"Starting transaction:",e);let s=18===(r=this.xi)||17===r?tJ:16===r||15===r?tW:14===r||13===r?tH:12===r?tQ:11===r?tK:void G(60245);return this.qi.runTransaction(e,"readonly"===t?"readonly":"readwrite",s,r=>(i=new tY(r,this.ai?this.ai.next():e1.ce),"readwrite-primary"===t?this.ji(i).next(e=>!!e||this.Hi(i)).next(t=>{if(!t)throw B(`Failed to obtain primary lease for action '${e}'.`),this.isPrimary=!1,this.Ci.enqueueRetryable(()=>this.ki(!1)),new W(H.FAILED_PRECONDITION,eV);return n(i)}).next(e=>this.Zi(i).next(()=>e)):this.Ps(i).next(()=>n(i)))).then(e=>(i.raiseOnCommittedEvent(),e))}Ps(e){return tX(e,e7).get(e9).next(e=>{if(null!==e&&this.ts(e.leaseTimestampMs,5e3)&&!this.ss(e.ownerId)&&!this.Xi(e)&&!(this.Mi||this.allowTabSynchronization&&e.allowTabSynchronization))throw new W(H.FAILED_PRECONDITION,ae)})}Zi(e){let t={ownerId:this.clientId,allowTabSynchronization:this.allowTabSynchronization,leaseTimestampMs:Date.now()};return tX(e,e7).put(e9,t)}static v(){return ez.v()}Ji(e){let t=tX(e,e7);return t.get(e9).next(e=>this.Xi(e)?(q(s9,"Releasing primary lease."),t.delete(e9)):eU.resolve())}ts(e,t){let n=Date.now();return!(e<n-t)&&(!(e>n)||(B(`Detected an update time that is in the future: ${e} > ${n}`),!1))}Wi(){null!==this.document&&"function"==typeof this.document.addEventListener&&(this.Ni=()=>{this.Ci.enqueueAndForget(()=>(this.inForeground="visible"===this.document.visibilityState,this.$i()))},this.document.addEventListener("visibilitychange",this.Ni),this.inForeground="visible"===this.document.visibilityState)}us(){this.Ni&&(this.document.removeEventListener("visibilitychange",this.Ni),this.Ni=null)}Qi(){"function"==typeof this.window?.addEventListener&&(this.Oi=()=>{this._s();let e=/(?:Version|Mobile)\/1[456]/;(0,k.isSafari)()&&(navigator.appVersion.match(e)||navigator.userAgent.match(e))&&this.Ci.enterRestrictedMode(!0),this.Ci.enqueueAndForget(()=>this.shutdown())},this.window.addEventListener("pagehide",this.Oi))}cs(){this.Oi&&(this.window.removeEventListener("pagehide",this.Oi),this.Oi=null)}ss(e){try{let t=null!==this.Ui?.getItem(this.rs(e));return q(s9,`Client '${e}' ${t?"is":"is not"} zombied in LocalStorage`),t}catch(e){return B(s9,"Failed to get zombied client id.",e),!1}}_s(){if(this.Ui)try{this.Ui.setItem(this.rs(this.clientId),String(Date.now()))}catch(e){B("Failed to set zombie client id.",e)}}ls(){if(this.Ui)try{this.Ui.removeItem(this.rs(this.clientId))}catch(e){}}rs(e){return`firestore_zombie_${this.persistenceKey}_${e}`}}function an(e,t){let n=e.projectId;return e.isDefaultDatabase||(n+="."+e.database),"firestore/"+t+"/"+n+"/"}class ar{constructor(e,t,n,r){this.targetId=e,this.fromCache=t,this.Ts=n,this.Is=r}static Es(e,t){let n=rN(),r=rN();for(let e of t.docChanges)switch(e.type){case 0:n=n.add(e.doc.key);break;case 1:r=r.add(e.doc.key)}return new ar(e,t.fromCache,n,r)}}class ai{constructor(){this._documentReadCount=0}get documentReadCount(){return this._documentReadCount}incrementDocumentReadCount(e){this._documentReadCount+=e}}class as{constructor(){this.Rs=!1,this.As=!1,this.Vs=100,this.ds=(0,k.isSafari)()?8:e$((0,k.getUA)())>0?6:4}initialize(e,t){this.fs=e,this.indexManager=t,this.Rs=!0}getDocumentsMatchingQuery(e,t,n,r){let i={result:null};return this.gs(e,t).next(e=>{i.result=e}).next(()=>{if(!i.result)return this.ps(e,t,r,n).next(e=>{i.result=e})}).next(()=>{if(i.result)return;let n=new ai;return this.ys(e,t,n).next(r=>{if(i.result=r,this.As)return this.ws(e,t,n,r.size)})}).next(()=>i.result)}ws(e,t,n,r){return n.documentReadCount<this.Vs?(U()<=O.LogLevel.DEBUG&&q("QueryEngine","SDK will not create cache indexes for query:",ry(t),"since it only creates cache indexes for collection contains","more than or equal to",this.Vs,"documents"),eU.resolve()):(U()<=O.LogLevel.DEBUG&&q("QueryEngine","Query:",ry(t),"scans",n.documentReadCount,"local documents and returns",r,"documents as results."),n.documentReadCount>this.ds*r?(U()<=O.LogLevel.DEBUG&&q("QueryEngine","The SDK decides to create cache indexes for query:",ry(t),"as using cache indexes may help improve performance."),this.indexManager.createTargetIndexes(e,rc(t))):eU.resolve())}gs(e,t){if(rl(t))return eU.resolve(null);let n=rc(t);return this.indexManager.getIndexType(e,n).next(r=>0===r?null:(null!==t.limit&&1===r&&(n=rc(t=rm(t,null,"F"))),this.indexManager.getDocumentsMatchingTarget(e,n).next(r=>{let i=rN(...r);return this.fs.getDocuments(e,i).next(r=>this.indexManager.getMinOffset(e,n).next(n=>{let s=this.bs(t,r);return this.Ss(t,s,i,n.readTime)?this.gs(e,rm(t,null,"F")):this.Ds(e,s,t,n)}))})))}ps(e,t,n,r){return rl(t)||r.isEqual(e_.min())?eU.resolve(null):this.fs.getDocuments(e,n).next(i=>{let s=this.bs(t,i);return this.Ss(t,s,n,r)?eU.resolve(null):(U()<=O.LogLevel.DEBUG&&q("QueryEngine","Re-using previous result from %s to execute query: %s",r.toString(),ry(t)),this.Ds(e,s,t,eP(r,-1)).next(e=>e))})}bs(e,t){let n=new t3(rb(e));return t.forEach((t,r)=>{rw(e,r)&&(n=n.add(r))}),n}Ss(e,t,n,r){if(null===e.limit)return!1;if(n.size!==t.size)return!0;let i="F"===e.limitType?t.last():t.first();return!!i&&(i.hasPendingWrites||i.version.compareTo(r)>0)}ys(e,t,n){return U()<=O.LogLevel.DEBUG&&q("QueryEngine","Using full collection scan to execute query:",ry(t)),this.fs.getDocumentsMatchingQuery(e,t,eM.min(),n)}Ds(e,t,n,r){return this.fs.getDocumentsMatchingQuery(e,n,r).next(e=>(t.forEach(t=>{e=e.insert(t.key,t)}),e))}}let aa="LocalStore";class ao{constructor(e,t,n,r){this.persistence=e,this.Cs=t,this.serializer=r,this.vs=new t2(ea),this.Fs=new rx(e=>re(e),rt),this.Ms=new Map,this.xs=e.getRemoteDocumentCache(),this.li=e.getTargetCache(),this.Pi=e.getBundleCache(),this.Os(n)}Os(e){this.documentOverlayCache=this.persistence.getDocumentOverlayCache(e),this.indexManager=this.persistence.getIndexManager(e),this.mutationQueue=this.persistence.getMutationQueue(e,this.indexManager),this.localDocuments=new sQ(this.xs,this.mutationQueue,this.documentOverlayCache,this.indexManager),this.xs.setIndexManager(this.indexManager),this.Cs.initialize(this.localDocuments,this.indexManager)}collectGarbage(e){return this.persistence.runTransaction("Collect garbage","readwrite-primary",t=>e.collect(t,this.vs))}}async function al(e,t){return await e.persistence.runTransaction("Handle user change","readonly",n=>{let r;return e.mutationQueue.getAllMutationBatches(n).next(i=>(r=i,e.Os(t),e.mutationQueue.getAllMutationBatches(n))).next(t=>{let i=[],s=[],a=rN();for(let e of r)for(let t of(i.push(e.batchId),e.mutations))a=a.add(t.key);for(let e of t)for(let t of(s.push(e.batchId),e.mutations))a=a.add(t.key);return e.localDocuments.getDocuments(n,a).next(e=>({Ns:e,removedBatchIds:i,addedBatchIds:s}))})})}function au(e){return e.persistence.runTransaction("Get last remote snapshot version","readonly",t=>e.li.getLastRemoteSnapshotVersion(t))}function ah(e,t,n){let r=rN(),i=rN();return n.forEach(e=>r=r.add(e)),t.getEntries(e,r).next(e=>{let r=rT;return n.forEach((n,s)=>{let a=e.get(n);s.isFoundDocument()!==a.isFoundDocument()&&(i=i.add(n)),s.isNoDocument()&&s.version.isEqual(e_.min())?(t.removeEntry(n,s.readTime),r=r.insert(n,s)):!a.isValidDocument()||s.version.compareTo(a.version)>0||0===s.version.compareTo(a.version)&&a.hasPendingWrites?(t.addEntry(s),r=r.insert(n,s)):q(aa,"Ignoring outdated watch update for ",n,". Current version:",a.version," Watch version:",s.version)}),{Bs:r,Ls:i}})}function ac(e,t){return e.persistence.runTransaction("Allocate target","readwrite",n=>{let r;return e.li.getTargetData(n,t).next(i=>i?(r=i,eU.resolve(r)):e.li.allocateTargetId(n).next(i=>(r=new iQ(t,i,"TargetPurposeListen",n.currentSequenceNumber),e.li.addTargetData(n,r).next(()=>r))))}).then(n=>{let r=e.vs.get(n.targetId);return(null===r||n.snapshotVersion.compareTo(r.snapshotVersion)>0)&&(e.vs=e.vs.insert(n.targetId,n),e.Fs.set(t,n.targetId)),n})}async function ad(e,t,n){let r=e.vs.get(t);try{n||await e.persistence.runTransaction("Release target",n?"readwrite":"readwrite-primary",t=>e.persistence.referenceDelegate.removeTarget(t,r))}catch(e){if(!eQ(e))throw e;q(aa,`Failed to update sequence numbers for target ${t}: ${e}`)}e.vs=e.vs.remove(t),e.Fs.delete(r.target)}function af(e,t,n){let r=e_.min(),i=rN();return e.persistence.runTransaction("Execute query","readwrite",s=>{var a;let o;return(a=rc(t),void 0!==(o=e.Fs.get(a))?eU.resolve(e.vs.get(o)):e.li.getTargetData(s,a)).next(t=>{if(t)return r=t.lastLimboFreeSnapshotVersion,e.li.getMatchingKeysForTargetId(s,t.targetId).next(e=>{i=e})}).next(()=>e.Cs.getDocumentsMatchingQuery(s,t,n?r:e_.min(),n?i:rN())).next(n=>(ap(e,rv(t),n),{documents:n,ks:i}))})}function am(e,t){let n=e.li,r=e.vs.get(t);return r?Promise.resolve(r.target):e.persistence.runTransaction("Get target data","readonly",e=>n.At(e,t).next(e=>e?e.target:null))}function ag(e,t){let n=e.Ms.get(t)||e_.min();return e.persistence.runTransaction("Get new document changes","readonly",r=>e.xs.getAllFromCollectionGroup(r,t,eP(n,-1),Number.MAX_SAFE_INTEGER)).then(n=>(ap(e,t,n),n))}function ap(e,t,n){let r=e.Ms.get(t)||e_.min();n.forEach((e,t)=>{t.readTime.compareTo(r)>0&&(r=t.readTime)}),e.Ms.set(t,r)}async function ay(e,t,n,r){let i=rN(),s=rT;for(let e of n){let n=t.Ks(e.metadata.name);e.document&&(i=i.add(n));let r=t.qs(e);r.setReadTime(t.Us(e.metadata.readTime)),s=s.insert(n,r)}let a=e.xs.newChangeBuffer({trackRemovals:!0}),o=await ac(e,rc(ro(ed.fromString(`__bundle__/docs/${r}`))));return e.persistence.runTransaction("Apply bundle documents","readwrite",t=>ah(t,a,s).next(e=>(a.apply(t),e)).next(n=>e.li.removeMatchingKeysForTargetId(t,o.targetId).next(()=>e.li.addMatchingKeys(t,i,o.targetId)).next(()=>e.localDocuments.getLocalViewOfDocuments(t,n.Bs,n.Ls)).next(()=>n.Bs)))}async function aw(e,t,n=rN()){let r=await ac(e,rc(i2(t.bundledQuery)));return e.persistence.runTransaction("Save named query","readwrite",i=>{let s=i_(t.readTime);if(r.snapshotVersion.compareTo(s)>=0)return e.Pi.saveNamedQuery(i,t);let a=r.withResumeToken(ne.EMPTY_BYTE_STRING,s);return e.vs=e.vs.insert(a.targetId,a),e.li.updateTargetData(i,a).next(()=>e.li.removeMatchingKeysForTargetId(i,r.targetId)).next(()=>e.li.addMatchingKeys(i,n,r.targetId)).next(()=>e.Pi.saveNamedQuery(i,t))})}let av="firestore_clients";function ab(e,t){return`${av}_${e}_${t}`}let ax="firestore_mutations";function aT(e,t,n){let r=`${ax}_${e}_${n}`;return t.isAuthenticated()&&(r+=`_${t.uid}`),r}let aI="firestore_targets";function aS(e,t){return`${aI}_${e}_${t}`}let aE="SharedClientState";class a_{constructor(e,t,n,r){this.user=e,this.batchId=t,this.state=n,this.error=r}static $s(e,t,n){let r=JSON.parse(n),i,s="object"==typeof r&&-1!==["pending","acknowledged","rejected"].indexOf(r.state)&&(void 0===r.error||"object"==typeof r.error);return s&&r.error&&(s="string"==typeof r.error.message&&"string"==typeof r.error.code)&&(i=new W(r.error.code,r.error.message)),s?new a_(e,t,r.state,i):(B(aE,`Failed to parse mutation state for ID '${t}': ${n}`),null)}Ws(){let e={state:this.state,updateTimeMs:Date.now()};return this.error&&(e.error={code:this.error.code,message:this.error.message}),JSON.stringify(e)}}class aC{constructor(e,t,n){this.targetId=e,this.state=t,this.error=n}static $s(e,t){let n=JSON.parse(t),r,i="object"==typeof n&&-1!==["not-current","current","rejected"].indexOf(n.state)&&(void 0===n.error||"object"==typeof n.error);return i&&n.error&&(i="string"==typeof n.error.message&&"string"==typeof n.error.code)&&(r=new W(n.error.code,n.error.message)),i?new aC(e,n.state,r):(B(aE,`Failed to parse target state for ID '${e}': ${t}`),null)}Ws(){let e={state:this.state,updateTimeMs:Date.now()};return this.error&&(e.error={code:this.error.code,message:this.error.message}),JSON.stringify(e)}}class aA{constructor(e,t){this.clientId=e,this.activeTargetIds=t}static $s(e,t){let n=JSON.parse(t),r="object"==typeof n&&n.activeTargetIds instanceof Array,i=rD;for(let e=0;r&&e<n.activeTargetIds.length;++e)r=e4(n.activeTargetIds[e]),i=i.add(n.activeTargetIds[e]);return r?new aA(e,i):(B(aE,`Failed to parse client data for instance '${e}': ${t}`),null)}}class aN{constructor(e,t){this.clientId=e,this.onlineState=t}static $s(e){let t=JSON.parse(e);return"object"==typeof t&&-1!==["Unknown","Online","Offline"].indexOf(t.onlineState)&&"string"==typeof t.clientId?new aN(t.clientId,t.onlineState):(B(aE,`Failed to parse online state: ${e}`),null)}}class aD{constructor(){this.activeTargetIds=rD}Qs(e){this.activeTargetIds=this.activeTargetIds.add(e)}Gs(e){this.activeTargetIds=this.activeTargetIds.delete(e)}Ws(){return JSON.stringify({activeTargetIds:this.activeTargetIds.toArray(),updateTimeMs:Date.now()})}}class ak{constructor(e,t,n,r,i){var s,a,o;this.window=e,this.Ci=t,this.persistenceKey=n,this.zs=r,this.syncEngine=null,this.onlineStateHandler=null,this.sequenceNumberHandler=null,this.js=this.Hs.bind(this),this.Js=new t2(ea),this.started=!1,this.Zs=[];const l=n.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");this.storage=this.window.localStorage,this.currentUser=i,this.Xs=ab(this.persistenceKey,this.zs),this.Ys=(s=this.persistenceKey,`firestore_sequence_number_${s}`),this.Js=this.Js.insert(this.zs,new aD),this.eo=RegExp(`^${av}_${l}_([^_]*)$`),this.no=RegExp(`^${ax}_${l}_(\\d+)(?:_(.*))?$`),this.ro=RegExp(`^${aI}_${l}_(\\d+)$`),this.io=(a=this.persistenceKey,`firestore_online_state_${a}`),this.so=(o=this.persistenceKey,`firestore_bundle_loaded_v2_${o}`),this.window.addEventListener("storage",this.js)}static v(e){return!(!e||!e.localStorage)}async start(){for(let e of(await this.syncEngine.hs())){if(e===this.zs)continue;let t=this.getItem(ab(this.persistenceKey,e));if(t){let n=aA.$s(e,t);n&&(this.Js=this.Js.insert(n.clientId,n))}}this.oo();let e=this.storage.getItem(this.io);if(e){let t=this._o(e);t&&this.ao(t)}for(let e of this.Zs)this.Hs(e);this.Zs=[],this.window.addEventListener("pagehide",()=>this.shutdown()),this.started=!0}writeSequenceNumber(e){this.setItem(this.Ys,JSON.stringify(e))}getAllActiveQueryTargets(){return this.uo(this.Js)}isActiveQueryTarget(e){let t=!1;return this.Js.forEach((n,r)=>{r.activeTargetIds.has(e)&&(t=!0)}),t}addPendingMutation(e){this.co(e,"pending")}updateMutationState(e,t,n){this.co(e,t,n),this.lo(e)}addLocalQueryTarget(e,t=!0){let n="not-current";if(this.isActiveQueryTarget(e)){let t=this.storage.getItem(aS(this.persistenceKey,e));if(t){let r=aC.$s(e,t);r&&(n=r.state)}}return t&&this.ho.Qs(e),this.oo(),n}removeLocalQueryTarget(e){this.ho.Gs(e),this.oo()}isLocalQueryTarget(e){return this.ho.activeTargetIds.has(e)}clearQueryState(e){this.removeItem(aS(this.persistenceKey,e))}updateQueryState(e,t,n){this.Po(e,t,n)}handleUserChange(e,t,n){t.forEach(e=>{this.lo(e)}),this.currentUser=e,n.forEach(e=>{this.addPendingMutation(e)})}setOnlineState(e){this.To(e)}notifyBundleLoaded(e){this.Io(e)}shutdown(){this.started&&(this.window.removeEventListener("storage",this.js),this.removeItem(this.Xs),this.started=!1)}getItem(e){let t=this.storage.getItem(e);return q(aE,"READ",e,t),t}setItem(e,t){q(aE,"SET",e,t),this.storage.setItem(e,t)}removeItem(e){q(aE,"REMOVE",e),this.storage.removeItem(e)}Hs(e){if(e.storageArea===this.storage){if(q(aE,"EVENT",e.key,e.newValue),e.key===this.Xs)return void B("Received WebStorage notification for local change. Another client might have garbage-collected our state");this.Ci.enqueueRetryable(async()=>{if(this.started){if(null!==e.key){if(this.eo.test(e.key)){if(null==e.newValue){let t=this.Eo(e.key);return this.Ro(t,null)}{let t=this.Ao(e.key,e.newValue);if(t)return this.Ro(t.clientId,t)}}else if(this.no.test(e.key)){if(null!==e.newValue){let t=this.Vo(e.key,e.newValue);if(t)return this.mo(t)}}else if(this.ro.test(e.key)){if(null!==e.newValue){let t=this.fo(e.key,e.newValue);if(t)return this.po(t)}}else if(e.key===this.io){if(null!==e.newValue){let t=this._o(e.newValue);if(t)return this.ao(t)}}else if(e.key===this.Ys){let t=function(e){let t=e1.ce;if(null!=e)try{let n=JSON.parse(e);Q("number"==typeof n,30636,{yo:e}),t=n}catch(e){B(aE,"Failed to read sequence number from WebStorage",e)}return t}(e.newValue);t!==e1.ce&&this.sequenceNumberHandler(t)}else if(e.key===this.so){let t=this.wo(e.newValue);await Promise.all(t.map(e=>this.syncEngine.bo(e)))}}}else this.Zs.push(e)})}}get ho(){return this.Js.get(this.zs)}oo(){this.setItem(this.Xs,this.ho.Ws())}co(e,t,n){let r=new a_(this.currentUser,e,t,n),i=aT(this.persistenceKey,this.currentUser,e);this.setItem(i,r.Ws())}lo(e){let t=aT(this.persistenceKey,this.currentUser,e);this.removeItem(t)}To(e){let t={clientId:this.zs,onlineState:e};this.storage.setItem(this.io,JSON.stringify(t))}Po(e,t,n){let r=aS(this.persistenceKey,e),i=new aC(e,t,n);this.setItem(r,i.Ws())}Io(e){let t=JSON.stringify(Array.from(e));this.setItem(this.so,t)}Eo(e){let t=this.eo.exec(e);return t?t[1]:null}Ao(e,t){let n=this.Eo(e);return aA.$s(n,t)}Vo(e,t){let n=this.no.exec(e),r=Number(n[1]),i=void 0!==n[2]?n[2]:null;return a_.$s(new V(i),r,t)}fo(e,t){let n=Number(this.ro.exec(e)[1]);return aC.$s(n,t)}_o(e){return aN.$s(e)}wo(e){return JSON.parse(e)}async mo(e){if(e.user.uid===this.currentUser.uid)return this.syncEngine.So(e.batchId,e.state,e.error);q(aE,`Ignoring mutation for non-active user ${e.user.uid}`)}po(e){return this.syncEngine.Do(e.targetId,e.state,e.error)}Ro(e,t){let n=t?this.Js.insert(e,t):this.Js.remove(e),r=this.uo(this.Js),i=this.uo(n),s=[],a=[];return i.forEach(e=>{r.has(e)||s.push(e)}),r.forEach(e=>{i.has(e)||a.push(e)}),this.syncEngine.Co(s,a).then(()=>{this.Js=n})}ao(e){this.Js.get(e.clientId)&&this.onlineStateHandler(e.onlineState)}uo(e){let t=rD;return e.forEach((e,n)=>{t=t.unionWith(n.activeTargetIds)}),t}}class aR{constructor(){this.vo=new aD,this.Fo={},this.onlineStateHandler=null,this.sequenceNumberHandler=null}addPendingMutation(e){}updateMutationState(e,t,n){}addLocalQueryTarget(e,t=!0){return t&&this.vo.Qs(e),this.Fo[e]||"not-current"}updateQueryState(e,t,n){this.Fo[e]=t}removeLocalQueryTarget(e){this.vo.Gs(e)}isLocalQueryTarget(e){return this.vo.activeTargetIds.has(e)}clearQueryState(e){delete this.Fo[e]}getAllActiveQueryTargets(){return this.vo.activeTargetIds}isActiveQueryTarget(e){return this.vo.activeTargetIds.has(e)}start(){return this.vo=new aD,Promise.resolve()}handleUserChange(e,t,n){}setOnlineState(e){}shutdown(){}writeSequenceNumber(e){}notifyBundleLoaded(e){}}class aP{Mo(e){}shutdown(){}}let aO="ConnectivityMonitor";class aM{constructor(){this.xo=()=>this.Oo(),this.No=()=>this.Bo(),this.Lo=[],this.ko()}Mo(e){this.Lo.push(e)}shutdown(){window.removeEventListener("online",this.xo),window.removeEventListener("offline",this.No)}ko(){window.addEventListener("online",this.xo),window.addEventListener("offline",this.No)}Oo(){for(let e of(q(aO,"Network connectivity changed: AVAILABLE"),this.Lo))e(0)}Bo(){for(let e of(q(aO,"Network connectivity changed: UNAVAILABLE"),this.Lo))e(1)}static v(){return"u">typeof window&&void 0!==window.addEventListener&&void 0!==window.removeEventListener}}let aF=null;function aV(){return null===aF?aF=0x10000000+Math.round(0x80000000*Math.random()):aF++,"0x"+aF.toString(16)}let aL="RestConnection",aj={BatchGetDocuments:"batchGet",Commit:"commit",RunQuery:"runQuery",RunAggregationQuery:"runAggregationQuery",ExecutePipeline:"executePipeline"};class aU{get Ko(){return!1}constructor(e){this.databaseInfo=e,this.databaseId=e.databaseId;const t=e.ssl?"https":"http",n=encodeURIComponent(this.databaseId.projectId),r=encodeURIComponent(this.databaseId.database);this.qo=t+"://"+e.host,this.Uo=`projects/${n}/databases/${r}`,this.$o=this.databaseId.database===nf?`project_id=${n}`:`project_id=${n}&database_id=${r}`}Wo(e,t,n,r,i){let s=aV(),a=this.Qo(e,t.toUriEncodedString());q(aL,`Sending RPC '${e}' ${s}:`,a,n);let o={"google-cloud-resource-prefix":this.Uo,"x-goog-request-params":this.$o};this.Go(o,r,i);let{host:l}=new URL(a),u=(0,k.isCloudWorkstation)(l);return this.zo(e,a,o,n,u).then(t=>(q(aL,`Received RPC '${e}' ${s}: `,t),t),t=>{throw z(aL,`RPC '${e}' ${s} failed with error: `,t,"url: ",a,"request:",n),t})}jo(e,t,n,r,i,s){return this.Wo(e,t,n,r,i)}Go(e,t,n){e["X-Goog-Api-Client"]="gl-js/ fire/"+L,e["Content-Type"]="text/plain",this.databaseInfo.appId&&(e["X-Firebase-GMPID"]=this.databaseInfo.appId),t&&t.headers.forEach((t,n)=>e[n]=t),n&&n.headers.forEach((t,n)=>e[n]=t)}Qo(e,t){let n=aj[e],r=`${this.qo}/v1/${t}:${n}`;return this.databaseInfo.apiKey&&(r=`${r}?key=${encodeURIComponent(this.databaseInfo.apiKey)}`),r}terminate(){}}class aq{constructor(e){this.Ho=e.Ho,this.Jo=e.Jo}Zo(e){this.Xo=e}Yo(e){this.e_=e}t_(e){this.n_=e}onMessage(e){this.r_=e}close(){this.Jo()}send(e){this.Ho(e)}i_(){this.Xo()}s_(){this.e_()}o_(e){this.n_(e)}__(e){this.r_(e)}}let aB="WebChannelConnection",az=(e,t,n)=>{e.listen(t,e=>{try{n(e)}catch(e){setTimeout(()=>{throw e},0)}})};class a$ extends aU{constructor(e){super(e),this.a_=[],this.forceLongPolling=e.forceLongPolling,this.autoDetectLongPolling=e.autoDetectLongPolling,this.useFetchStreams=e.useFetchStreams,this.longPollingOptions=e.longPollingOptions}static u_(){a$.c_||(az(h(),u.STAT_EVENT,e=>{e.stat===l.PROXY?q(aB,"STAT_EVENT: detected buffering proxy"):e.stat===l.NOPROXY&&q(aB,"STAT_EVENT: detected no buffering proxy")}),a$.c_=!0)}zo(e,t,n,r,s){let l=aV();return new Promise((s,u)=>{let h=new i;h.setWithCredentials(!0),h.listenOnce(a.COMPLETE,()=>{try{switch(h.getLastErrorCode()){case o.NO_ERROR:let t=h.getResponseJson();q(aB,`XHR for RPC '${e}' ${l} received:`,JSON.stringify(t)),s(t);break;case o.TIMEOUT:q(aB,`RPC '${e}' ${l} timed out`),u(new W(H.DEADLINE_EXCEEDED,"Request time out"));break;case o.HTTP_ERROR:let n=h.getStatus();if(q(aB,`RPC '${e}' ${l} failed with status:`,n,"response text:",h.getResponseText()),n>0){let e=h.getResponseJson();Array.isArray(e)&&(e=e[0]);let t=e?.error;if(t&&t.status&&t.message){let e,n=(e=t.status.toLowerCase().replace(/_/g,"-"),Object.values(H).indexOf(e)>=0?e:H.UNKNOWN);u(new W(n,t.message))}else u(new W(H.UNKNOWN,"Server responded with status "+h.getStatus()))}else u(new W(H.UNAVAILABLE,"Connection failed."));break;default:G(9055,{l_:e,streamId:l,h_:h.getLastErrorCode(),P_:h.getLastError()})}}finally{q(aB,`RPC '${e}' ${l} completed.`)}});let c=JSON.stringify(r);q(aB,`RPC '${e}' ${l} sending request:`,r),h.send(t,"POST",c,n,15)})}T_(e,t,n){let r=aV(),i=[this.qo,"/","google.firestore.v1.Firestore","/",e,"/channel"],a=this.createWebChannelTransport(),o={httpSessionIdParam:"gsessionid",initMessageHeaders:{},messageUrlParams:{database:`projects/${this.databaseId.projectId}/databases/${this.databaseId.database}`},sendRawJson:!0,supportsCrossDomainXhr:!0,internalChannelParams:{forwardChannelRequestTimeoutMs:6e5},forceLongPolling:this.forceLongPolling,detectBufferingProxy:this.autoDetectLongPolling},l=this.longPollingOptions.timeoutSeconds;void 0!==l&&(o.longPollingTimeout=Math.round(1e3*l)),this.useFetchStreams&&(o.useFetchStreams=!0),this.Go(o.initMessageHeaders,t,n),o.encodeInitMessageHeaders=!0;let u=i.join("");q(aB,`Creating RPC '${e}' stream ${r}: ${u}`,o);let h=a.createWebChannel(u,o);this.I_(h);let c=!1,f=!1,m=new aq({Ho:t=>{f?q(aB,`Not sending because RPC '${e}' stream ${r} is closed:`,t):(c||(q(aB,`Opening RPC '${e}' stream ${r} transport.`),h.open(),c=!0),q(aB,`RPC '${e}' stream ${r} sending:`,t),h.send(t))},Jo:()=>h.close()});return az(h,s.EventType.OPEN,()=>{f||(q(aB,`RPC '${e}' stream ${r} transport opened.`),m.i_())}),az(h,s.EventType.CLOSE,()=>{f||(f=!0,q(aB,`RPC '${e}' stream ${r} transport closed`),m.o_(),this.E_(h))}),az(h,s.EventType.ERROR,t=>{f||(f=!0,z(aB,`RPC '${e}' stream ${r} transport errored. Name:`,t.name,"Message:",t.message),m.o_(new W(H.UNAVAILABLE,"The operation could not be completed")))}),az(h,s.EventType.MESSAGE,t=>{if(!f){let n=t.data[0];Q(!!n,16349);let i=n?.error||n[0]?.error;if(i){q(aB,`RPC '${e}' stream ${r} received error:`,i);let t=i.status,n=function(e){let t=d[e];if(void 0!==t)return ie(t)}(t),s=i.message;void 0===n&&(n=H.INTERNAL,s="Unknown error status: "+t+" with message "+i.message),f=!0,m.o_(new W(n,s)),h.close()}else q(aB,`RPC '${e}' stream ${r} received:`,n),m.__(n)}}),a$.u_(),setTimeout(()=>{m.s_()},0),m}terminate(){this.a_.forEach(e=>e.close()),this.a_=[]}I_(e){this.a_.push(e)}E_(e){this.a_=this.a_.filter(t=>t===e)}Go(e,t,n){super.Go(e,t,n),this.databaseInfo.apiKey&&(e["x-goog-api-key"]=this.databaseInfo.apiKey)}createWebChannelTransport(){return c()}}function aG(){return"u">typeof window?window:null}function aK(){return"u">typeof document?document:null}function aQ(e){return new iT(e,!0)}a$.c_=!1;class aH{constructor(e,t,n=1e3,r=1.5,i=6e4){this.Ci=e,this.timerId=t,this.R_=n,this.A_=r,this.V_=i,this.d_=0,this.m_=null,this.f_=Date.now(),this.reset()}reset(){this.d_=0}g_(){this.d_=this.V_}p_(e){this.cancel();let t=Math.floor(this.d_+this.y_()),n=Math.max(0,Date.now()-this.f_),r=Math.max(0,t-n);r>0&&q("ExponentialBackoff",`Backing off for ${r} ms (base delay: ${this.d_} ms, delay with jitter: ${t} ms, last attempt: ${n} ms ago)`),this.m_=this.Ci.enqueueAfterDelay(this.timerId,r,()=>(this.f_=Date.now(),e())),this.d_*=this.A_,this.d_<this.R_&&(this.d_=this.R_),this.d_>this.V_&&(this.d_=this.V_)}w_(){null!==this.m_&&(this.m_.skipDelay(),this.m_=null)}cancel(){null!==this.m_&&(this.m_.cancel(),this.m_=null)}y_(){return(Math.random()-.5)*this.d_}}let aW="PersistentStream";class aJ{constructor(e,t,n,r,i,s,a,o){this.Ci=e,this.b_=n,this.S_=r,this.connection=i,this.authCredentialsProvider=s,this.appCheckCredentialsProvider=a,this.listener=o,this.state=0,this.D_=0,this.C_=null,this.v_=null,this.stream=null,this.F_=0,this.M_=new aH(e,t)}x_(){return 1===this.state||5===this.state||this.O_()}O_(){return 2===this.state||3===this.state}start(){this.F_=0,4!==this.state?this.auth():this.N_()}async stop(){this.x_()&&await this.close(0)}B_(){this.state=0,this.M_.reset()}L_(){this.O_()&&null===this.C_&&(this.C_=this.Ci.enqueueAfterDelay(this.b_,6e4,()=>this.k_()))}K_(e){this.q_(),this.stream.send(e)}async k_(){if(this.O_())return this.close(0)}q_(){this.C_&&(this.C_.cancel(),this.C_=null)}U_(){this.v_&&(this.v_.cancel(),this.v_=null)}async close(e,t){this.q_(),this.U_(),this.M_.cancel(),this.D_++,4!==e?this.M_.reset():t&&t.code===H.RESOURCE_EXHAUSTED?(B(t.toString()),B("Using maximum backoff delay to prevent overloading the backend."),this.M_.g_()):t&&t.code===H.UNAUTHENTICATED&&3!==this.state&&(this.authCredentialsProvider.invalidateToken(),this.appCheckCredentialsProvider.invalidateToken()),null!==this.stream&&(this.W_(),this.stream.close(),this.stream=null),this.state=e,await this.listener.t_(t)}W_(){}auth(){this.state=1;let e=this.Q_(this.D_),t=this.D_;Promise.all([this.authCredentialsProvider.getToken(),this.appCheckCredentialsProvider.getToken()]).then(([e,n])=>{this.D_===t&&this.G_(e,n)},t=>{e(()=>{let e=new W(H.UNKNOWN,"Fetching auth token failed: "+t.message);return this.z_(e)})})}G_(e,t){let n=this.Q_(this.D_);this.stream=this.j_(e,t),this.stream.Zo(()=>{n(()=>this.listener.Zo())}),this.stream.Yo(()=>{n(()=>(this.state=2,this.v_=this.Ci.enqueueAfterDelay(this.S_,1e4,()=>(this.O_()&&(this.state=3),Promise.resolve())),this.listener.Yo()))}),this.stream.t_(e=>{n(()=>this.z_(e))}),this.stream.onMessage(e=>{n(()=>1==++this.F_?this.H_(e):this.onNext(e))})}N_(){this.state=5,this.M_.p_(async()=>{this.state=0,this.start()})}z_(e){return q(aW,`close with error: ${e}`),this.stream=null,this.close(4,e)}Q_(e){return t=>{this.Ci.enqueueAndForget(()=>this.D_===e?t():(q(aW,"stream callback skipped by getCloseGuardedDispatcher."),Promise.resolve()))}}}class aY extends aJ{constructor(e,t,n,r,i,s){super(e,"listen_stream_connection_backoff","listen_stream_idle","health_check_timeout",t,n,r,s),this.serializer=i}j_(e,t){return this.connection.T_("Listen",e,t)}H_(e){return this.onNext(e)}onNext(e){this.M_.reset();let t=function(e,t){let n;if("targetChange"in t){var r,i;t.targetChange;let s="NO_CHANGE"===(r=t.targetChange.targetChangeType||"NO_CHANGE")?0:"ADD"===r?1:"REMOVE"===r?2:"CURRENT"===r?3:"RESET"===r?4:G(39313,{state:r}),a=t.targetChange.targetIds||[],o=(i=t.targetChange.resumeToken,e.useProto3Json?(Q(void 0===i||"string"==typeof i,58123),ne.fromBase64String(i||"")):(Q(void 0===i||i instanceof D.Buffer||i instanceof Uint8Array,16193),ne.fromUint8Array(i||new Uint8Array))),l=t.targetChange.cause;n=new im(s,a,o,l&&new W(void 0===l.code?H.UNKNOWN:ie(l.code),l.message||"")||null)}else if("documentChange"in t){t.documentChange;let r=t.documentChange;r.document,r.document.name,r.document.updateTime;let i=ik(e,r.document.name),s=i_(r.document.updateTime),a=r.document.createTime?i_(r.document.createTime):e_.min(),o=new nU({mapValue:{fields:r.document.fields}}),l=nq.newFoundDocument(i,s,a,o);n=new ic(r.targetIds||[],r.removedTargetIds||[],l.key,l)}else if("documentDelete"in t){t.documentDelete;let r=t.documentDelete;r.document;let i=ik(e,r.document),s=r.readTime?i_(r.readTime):e_.min(),a=nq.newNoDocument(i,s);n=new ic([],r.removedTargetIds||[],a.key,a)}else if("documentRemove"in t){t.documentRemove;let r=t.documentRemove;r.document;let i=ik(e,r.document);n=new ic([],r.removedTargetIds||[],i,null)}else{if(!("filter"in t))return G(11601,{Vt:t});{t.filter;let e=t.filter;e.targetId;let{count:r=0,unchangedNames:i}=e,s=new r7(r,i);n=new id(e.targetId,s)}}return n}(this.serializer,e),n=function(e){if(!("targetChange"in e))return e_.min();let t=e.targetChange;return t.targetIds&&t.targetIds.length?e_.min():t.readTime?i_(t.readTime):e_.min()}(e);return this.listener.J_(t,n)}Z_(e){let t,n={};n.database=iO(this.serializer),n.addTarget=function(e,t){let n,r=t.target;if((n=rn(r)?{documents:iU(e,r)}:{query:iq(e,r).ft}).targetId=t.targetId,t.resumeToken.approximateByteSize()>0){n.resumeToken=iE(e,t.resumeToken);let r=iI(e,t.expectedCount);null!==r&&(n.expectedCount=r)}else if(t.snapshotVersion.compareTo(e_.min())>0){n.readTime=iS(e,t.snapshotVersion.toTimestamp());let r=iI(e,t.expectedCount);null!==r&&(n.expectedCount=r)}return n}(this.serializer,e);let r=(this.serializer,null==(t=function(e){switch(e){case"TargetPurposeListen":return null;case"TargetPurposeExistenceFilterMismatch":return"existence-filter-mismatch";case"TargetPurposeExistenceFilterMismatchBloom":return"existence-filter-mismatch-bloom";case"TargetPurposeLimboResolution":return"limbo-document";default:return G(28987,{purpose:e})}}(e.purpose))?null:{"goog-listen-tags":t});r&&(n.labels=r),this.K_(n)}X_(e){let t={};t.database=iO(this.serializer),t.removeTarget=e,this.K_(t)}}class aX extends aJ{constructor(e,t,n,r,i,s){super(e,"write_stream_connection_backoff","write_stream_idle","health_check_timeout",t,n,r,s),this.serializer=i}get Y_(){return this.F_>0}start(){this.lastStreamToken=void 0,super.start()}W_(){this.Y_&&this.ea([])}j_(e,t){return this.connection.T_("Write",e,t)}H_(e){return Q(!!e.streamToken,31322),this.lastStreamToken=e.streamToken,Q(!e.writeResults||0===e.writeResults.length,55816),this.listener.ta()}onNext(e){var t,n;Q(!!e.streamToken,12678),this.lastStreamToken=e.streamToken,this.M_.reset();let r=(t=e.writeResults,n=e.commitTime,t&&t.length>0?(Q(void 0!==n,14353),t.map(e=>{let t;return(t=e.updateTime?i_(e.updateTime):i_(n)).isEqual(e_.min())&&(t=i_(n)),new r$(t,e.transformResults||[])})):[]),i=i_(e.commitTime);return this.listener.na(i,r)}ra(){let e={};e.database=iO(this.serializer),this.K_(e)}ea(e){let t={streamToken:this.lastStreamToken,writes:e.map(e=>iL(this.serializer,e))};this.K_(t)}}class aZ{}class a0 extends aZ{constructor(e,t,n,r){super(),this.authCredentials=e,this.appCheckCredentials=t,this.connection=n,this.serializer=r,this.ia=!1}sa(){if(this.ia)throw new W(H.FAILED_PRECONDITION,"The client has already been terminated.")}Wo(e,t,n,r){return this.sa(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then(([i,s])=>this.connection.Wo(e,iA(t,n),r,i,s)).catch(e=>{throw"FirebaseError"===e.name?(e.code===H.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),e):new W(H.UNKNOWN,e.toString())})}jo(e,t,n,r,i){return this.sa(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then(([s,a])=>this.connection.jo(e,iA(t,n),r,s,a,i)).catch(e=>{throw"FirebaseError"===e.name?(e.code===H.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),e):new W(H.UNKNOWN,e.toString())})}terminate(){this.ia=!0,this.connection.terminate()}}class a1{constructor(e,t){this.asyncQueue=e,this.onlineStateHandler=t,this.state="Unknown",this.oa=0,this._a=null,this.aa=!0}ua(){0===this.oa&&(this.ca("Unknown"),this._a=this.asyncQueue.enqueueAfterDelay("online_state_timeout",1e4,()=>(this._a=null,this.la("Backend didn't respond within 10 seconds."),this.ca("Offline"),Promise.resolve())))}ha(e){"Online"===this.state?this.ca("Unknown"):(this.oa++,this.oa>=1&&(this.Pa(),this.la(`Connection failed 1 times. Most recent error: ${e.toString()}`),this.ca("Offline")))}set(e){this.Pa(),this.oa=0,"Online"===e&&(this.aa=!1),this.ca(e)}ca(e){e!==this.state&&(this.state=e,this.onlineStateHandler(e))}la(e){let t=`Could not reach Cloud Firestore backend. ${e}
This typically indicates that your device does not have a healthy Internet connection at the moment. The client will operate in offline mode until it is able to successfully connect to the backend.`;this.aa?(B(t),this.aa=!1):q("OnlineStateTracker",t)}Pa(){null!==this._a&&(this._a.cancel(),this._a=null)}}let a2="RemoteStore";class a5{constructor(e,t,n,r,i){this.localStore=e,this.datastore=t,this.asyncQueue=n,this.remoteSyncer={},this.Ta=[],this.Ia=new Map,this.Ea=new Set,this.Ra=[],this.Aa=i,this.Aa.Mo(e=>{n.enqueueAndForget(async()=>{on(this)&&(q(a2,"Restarting streams for network reachability change."),await async function(e){e.Ea.add(4),await a3(e),e.Va.set("Unknown"),e.Ea.delete(4),await a4(e)}(this))})}),this.Va=new a1(n,r)}}async function a4(e){if(on(e))for(let t of e.Ra)await t(!0)}async function a3(e){for(let t of e.Ra)await t(!1)}function a6(e,t){e.Ia.has(t.targetId)||(e.Ia.set(t.targetId,t),ot(e)?oe(e):ow(e).O_()&&a7(e,t))}function a8(e,t){let n=ow(e);e.Ia.delete(t),n.O_()&&a9(e,t),0===e.Ia.size&&(n.O_()?n.L_():on(e)&&e.Va.set("Unknown"))}function a7(e,t){if(e.da.$e(t.targetId),t.resumeToken.approximateByteSize()>0||t.snapshotVersion.compareTo(e_.min())>0){let n=e.remoteSyncer.getRemoteKeysForTarget(t.targetId).size;t=t.withExpectedCount(n)}ow(e).Z_(t)}function a9(e,t){e.da.$e(t),ow(e).X_(t)}function oe(e){e.da=new ip({getRemoteKeysForTarget:t=>e.remoteSyncer.getRemoteKeysForTarget(t),At:t=>e.Ia.get(t)||null,ht:()=>e.datastore.serializer.databaseId}),ow(e).start(),e.Va.ua()}function ot(e){return on(e)&&!ow(e).x_()&&e.Ia.size>0}function on(e){return 0===e.Ea.size}async function or(e){e.Va.set("Online")}async function oi(e){e.Ia.forEach((t,n)=>{a7(e,t)})}async function os(e,t){e.da=void 0,ot(e)?(e.Va.ha(t),oe(e)):e.Va.set("Unknown")}async function oa(e,t,n){if(e.Va.set("Online"),t instanceof im&&2===t.state&&t.cause)try{await async function(e,t){let n=t.cause;for(let r of t.targetIds)e.Ia.has(r)&&(await e.remoteSyncer.rejectListen(r,n),e.Ia.delete(r),e.da.removeTarget(r))}(e,t)}catch(n){q(a2,"Failed to remove targets %s: %s ",t.targetIds.join(","),n),await oo(e,n)}else if(t instanceof ic?e.da.Xe(t):t instanceof id?e.da.st(t):e.da.tt(t),!n.isEqual(e_.min()))try{let t,r=await au(e.localStore);n.compareTo(r)>=0&&await ((t=e.da.Tt(n)).targetChanges.forEach((t,r)=>{if(t.resumeToken.approximateByteSize()>0){let i=e.Ia.get(r);i&&e.Ia.set(r,i.withResumeToken(t.resumeToken,n))}}),t.targetMismatches.forEach((t,n)=>{let r=e.Ia.get(t);if(!r)return;e.Ia.set(t,r.withResumeToken(ne.EMPTY_BYTE_STRING,r.snapshotVersion)),a9(e,t);let i=new iQ(r.target,t,n,r.sequenceNumber);a7(e,i)}),e.remoteSyncer.applyRemoteEvent(t))}catch(t){q(a2,"Failed to raise snapshot:",t),await oo(e,t)}}async function oo(e,t,n){if(!eQ(t))throw t;e.Ea.add(1),await a3(e),e.Va.set("Offline"),n||(n=()=>au(e.localStore)),e.asyncQueue.enqueueRetryable(async()=>{q(a2,"Retrying IndexedDB access"),await n(),e.Ea.delete(1),await a4(e)})}function ol(e,t){return t().catch(n=>oo(e,n,t))}async function ou(e){var t;let n=ov(e),r=e.Ta.length>0?e.Ta[e.Ta.length-1].batchId:-1;for(;on(t=e)&&t.Ta.length<10;)try{let t=await function(e,t){return e.persistence.runTransaction("Get next mutation batch","readonly",n=>(void 0===t&&(t=-1),e.mutationQueue.getNextMutationBatchAfterBatchId(n,t)))}(e.localStore,r);if(null===t){0===e.Ta.length&&n.L_();break}r=t.batchId,function(e,t){e.Ta.push(t);let n=ov(e);n.O_()&&n.Y_&&n.ea(t.mutations)}(e,t)}catch(t){await oo(e,t)}oh(e)&&oc(e)}function oh(e){return on(e)&&!ov(e).x_()&&e.Ta.length>0}function oc(e){ov(e).start()}async function od(e){ov(e).ra()}async function of(e){let t=ov(e);for(let n of e.Ta)t.ea(n.mutations)}async function om(e,t,n){let r=e.Ta.shift(),i=r3.from(r,t,n);await ol(e,()=>e.remoteSyncer.applySuccessfulWrite(i)),await ou(e)}async function og(e,t){t&&ov(e).Y_&&await async function(e,t){var n;if(r9(n=t.code)&&n!==H.ABORTED){let n=e.Ta.shift();ov(e).B_(),await ol(e,()=>e.remoteSyncer.rejectFailedWrite(n.batchId,t)),await ou(e)}}(e,t),oh(e)&&oc(e)}async function op(e,t){e.asyncQueue.verifyOperationInProgress(),q(a2,"RemoteStore received new credentials");let n=on(e);e.Ea.add(3),await a3(e),n&&e.Va.set("Unknown"),await e.remoteSyncer.handleCredentialChange(t),e.Ea.delete(3),await a4(e)}async function oy(e,t){t?(e.Ea.delete(2),await a4(e)):t||(e.Ea.add(2),await a3(e),e.Va.set("Unknown"))}function ow(e){var t,n,r;return e.ma||(t=e.datastore,n=e.asyncQueue,r={Zo:or.bind(null,e),Yo:oi.bind(null,e),t_:os.bind(null,e),J_:oa.bind(null,e)},t.sa(),e.ma=new aY(n,t.connection,t.authCredentials,t.appCheckCredentials,t.serializer,r),e.Ra.push(async t=>{t?(e.ma.B_(),ot(e)?oe(e):e.Va.set("Unknown")):(await e.ma.stop(),e.da=void 0)})),e.ma}function ov(e){var t,n,r;return e.fa||(t=e.datastore,n=e.asyncQueue,r={Zo:()=>Promise.resolve(),Yo:od.bind(null,e),t_:og.bind(null,e),ta:of.bind(null,e),na:om.bind(null,e)},t.sa(),e.fa=new aX(n,t.connection,t.authCredentials,t.appCheckCredentials,t.serializer,r),e.Ra.push(async t=>{t?(e.fa.B_(),await ou(e)):(await e.fa.stop(),e.Ta.length>0&&(q(a2,`Stopping write stream with ${e.Ta.length} pending writes`),e.Ta=[]))})),e.fa}class ob{constructor(e,t,n,r,i){this.asyncQueue=e,this.timerId=t,this.targetTimeMs=n,this.op=r,this.removalCallback=i,this.deferred=new J,this.then=this.deferred.promise.then.bind(this.deferred.promise),this.deferred.promise.catch(e=>{})}get promise(){return this.deferred.promise}static createAndSchedule(e,t,n,r,i){let s=new ob(e,t,Date.now()+n,r,i);return s.start(n),s}start(e){this.timerHandle=setTimeout(()=>this.handleDelayElapsed(),e)}skipDelay(){return this.handleDelayElapsed()}cancel(e){null!==this.timerHandle&&(this.clearTimeout(),this.deferred.reject(new W(H.CANCELLED,"Operation cancelled"+(e?": "+e:""))))}handleDelayElapsed(){this.asyncQueue.enqueueAndForget(()=>null!==this.timerHandle?(this.clearTimeout(),this.op().then(e=>this.deferred.resolve(e))):Promise.resolve())}clearTimeout(){null!==this.timerHandle&&(this.removalCallback(this),clearTimeout(this.timerHandle),this.timerHandle=null)}}function ox(e,t){if(B("AsyncQueue",`${t}: ${e}`),eQ(e))return new W(H.UNAVAILABLE,`${t}: ${e}`);throw e}class oT{static emptySet(e){return new oT(e.comparator)}constructor(e){this.comparator=e?(t,n)=>e(t,n)||eg.comparator(t.key,n.key):(e,t)=>eg.comparator(e.key,t.key),this.keyedMap=rS(),this.sortedSet=new t2(this.comparator)}has(e){return null!=this.keyedMap.get(e)}get(e){return this.keyedMap.get(e)}first(){return this.sortedSet.minKey()}last(){return this.sortedSet.maxKey()}isEmpty(){return this.sortedSet.isEmpty()}indexOf(e){let t=this.keyedMap.get(e);return t?this.sortedSet.indexOf(t):-1}get size(){return this.sortedSet.size}forEach(e){this.sortedSet.inorderTraversal((t,n)=>(e(t),!1))}add(e){let t=this.delete(e.key);return t.copy(t.keyedMap.insert(e.key,e),t.sortedSet.insert(e,null))}delete(e){let t=this.get(e);return t?this.copy(this.keyedMap.remove(e),this.sortedSet.remove(t)):this}isEqual(e){if(!(e instanceof oT)||this.size!==e.size)return!1;let t=this.sortedSet.getIterator(),n=e.sortedSet.getIterator();for(;t.hasNext();){let e=t.getNext().key,r=n.getNext().key;if(!e.isEqual(r))return!1}return!0}toString(){let e=[];return this.forEach(t=>{e.push(t.toString())}),0===e.length?"DocumentSet ()":"DocumentSet (\n  "+e.join("  \n")+"\n)"}copy(e,t){let n=new oT;return n.comparator=this.comparator,n.keyedMap=e,n.sortedSet=t,n}}class oI{constructor(){this.ga=new t2(eg.comparator)}track(e){let t=e.doc.key,n=this.ga.get(t);n?0!==e.type&&3===n.type?this.ga=this.ga.insert(t,e):3===e.type&&1!==n.type?this.ga=this.ga.insert(t,{type:n.type,doc:e.doc}):2===e.type&&2===n.type?this.ga=this.ga.insert(t,{type:2,doc:e.doc}):2===e.type&&0===n.type?this.ga=this.ga.insert(t,{type:0,doc:e.doc}):1===e.type&&0===n.type?this.ga=this.ga.remove(t):1===e.type&&2===n.type?this.ga=this.ga.insert(t,{type:1,doc:n.doc}):0===e.type&&1===n.type?this.ga=this.ga.insert(t,{type:2,doc:e.doc}):G(63341,{Vt:e,pa:n}):this.ga=this.ga.insert(t,e)}ya(){let e=[];return this.ga.inorderTraversal((t,n)=>{e.push(n)}),e}}class oS{constructor(e,t,n,r,i,s,a,o,l){this.query=e,this.docs=t,this.oldDocs=n,this.docChanges=r,this.mutatedKeys=i,this.fromCache=s,this.syncStateChanged=a,this.excludesMetadataChanges=o,this.hasCachedResults=l}static fromInitialDocuments(e,t,n,r,i){let s=[];return t.forEach(e=>{s.push({type:0,doc:e})}),new oS(e,t,oT.emptySet(t),s,n,r,!0,!1,i)}get hasPendingWrites(){return!this.mutatedKeys.isEmpty()}isEqual(e){if(!(this.fromCache===e.fromCache&&this.hasCachedResults===e.hasCachedResults&&this.syncStateChanged===e.syncStateChanged&&this.mutatedKeys.isEqual(e.mutatedKeys)&&rg(this.query,e.query)&&this.docs.isEqual(e.docs)&&this.oldDocs.isEqual(e.oldDocs)))return!1;let t=this.docChanges,n=e.docChanges;if(t.length!==n.length)return!1;for(let e=0;e<t.length;e++)if(t[e].type!==n[e].type||!t[e].doc.isEqual(n[e].doc))return!1;return!0}}class oE{constructor(){this.wa=void 0,this.ba=[]}Sa(){return this.ba.some(e=>e.Da())}}class o_{constructor(){this.queries=oC(),this.onlineState="Unknown",this.Ca=new Set}terminate(){var e;let t;e=new W(H.ABORTED,"Firestore shutting down"),t=this.queries,this.queries=oC(),t.forEach((t,n)=>{for(let t of n.ba)t.onError(e)})}}function oC(){return new rx(e=>rp(e),rg)}async function oA(e,t){let n=3,r=t.query,i=e.queries.get(r);i?!i.Sa()&&t.Da()&&(n=2):(i=new oE,n=+!t.Da());try{switch(n){case 0:i.wa=await e.onListen(r,!0);break;case 1:i.wa=await e.onListen(r,!1);break;case 2:await e.onFirstRemoteStoreListen(r)}}catch(n){let e=ox(n,`Initialization of query '${ry(t.query)}' failed`);return void t.onError(e)}e.queries.set(r,i),i.ba.push(t),t.va(e.onlineState),i.wa&&t.Fa(i.wa)&&oR(e)}async function oN(e,t){let n=t.query,r=3,i=e.queries.get(n);if(i){let e=i.ba.indexOf(t);e>=0&&(i.ba.splice(e,1),0===i.ba.length?r=+!t.Da():!i.Sa()&&t.Da()&&(r=2))}switch(r){case 0:return e.queries.delete(n),e.onUnlisten(n,!0);case 1:return e.queries.delete(n),e.onUnlisten(n,!1);case 2:return e.onLastRemoteStoreUnlisten(n);default:return}}function oD(e,t){let n=!1;for(let r of t){let t=r.query,i=e.queries.get(t);if(i){for(let e of i.ba)e.Fa(r)&&(n=!0);i.wa=r}}n&&oR(e)}function ok(e,t,n){let r=e.queries.get(t);if(r)for(let e of r.ba)e.onError(n);e.queries.delete(t)}function oR(e){e.Ca.forEach(e=>{e.next()})}(g=m||(m={})).Ma="default",g.Cache="cache";class oP{constructor(e,t,n){this.query=e,this.xa=t,this.Oa=!1,this.Na=null,this.onlineState="Unknown",this.options=n||{}}Fa(e){if(!this.options.includeMetadataChanges){let t=[];for(let n of e.docChanges)3!==n.type&&t.push(n);e=new oS(e.query,e.docs,e.oldDocs,t,e.mutatedKeys,e.fromCache,e.syncStateChanged,!0,e.hasCachedResults)}let t=!1;return this.Oa?this.Ba(e)&&(this.xa.next(e),t=!0):this.La(e,this.onlineState)&&(this.ka(e),t=!0),this.Na=e,t}onError(e){this.xa.error(e)}va(e){this.onlineState=e;let t=!1;return this.Na&&!this.Oa&&this.La(this.Na,e)&&(this.ka(this.Na),t=!0),t}La(e,t){return!(e.fromCache&&this.Da())||(!this.options.Ka||"Offline"===t)&&(!e.docs.isEmpty()||e.hasCachedResults||"Offline"===t)}Ba(e){if(e.docChanges.length>0)return!0;let t=this.Na&&this.Na.hasPendingWrites!==e.hasPendingWrites;return!(!e.syncStateChanged&&!t)&&!0===this.options.includeMetadataChanges}ka(e){e=oS.fromInitialDocuments(e.query,e.docs,e.mutatedKeys,e.fromCache,e.hasCachedResults),this.Oa=!0,this.xa.next(e)}Da(){return this.options.source!==m.Cache}}class oO{constructor(e,t){this.qa=e,this.byteLength=t}Ua(){return"metadata"in this.qa}}class oM{constructor(e){this.serializer=e}Ks(e){return ik(this.serializer,e)}qs(e){return e.metadata.exists?iV(this.serializer,e.document,!1):nq.newNoDocument(this.Ks(e.metadata.name),this.Us(e.metadata.readTime))}Us(e){return i_(e)}}class oF{constructor(e,t){this.$a=e,this.serializer=t,this.Wa=[],this.Qa=[],this.collectionGroups=new Set,this.progress=oV(e)}get queries(){return this.Wa}get documents(){return this.Qa}Ga(e){this.progress.bytesLoaded+=e.byteLength;let t=this.progress.documentsLoaded;if(e.qa.namedQuery)this.Wa.push(e.qa.namedQuery);else if(e.qa.documentMetadata){this.Qa.push({metadata:e.qa.documentMetadata}),e.qa.documentMetadata.exists||++t;let n=ed.fromString(e.qa.documentMetadata.name);this.collectionGroups.add(n.get(n.length-2))}else e.qa.document&&(this.Qa[this.Qa.length-1].document=e.qa.document,++t);return t!==this.progress.documentsLoaded?(this.progress.documentsLoaded=t,{...this.progress}):null}za(e){let t=new Map,n=new oM(this.serializer);for(let r of e)if(r.metadata.queries){let e=n.Ks(r.metadata.name);for(let n of r.metadata.queries){let r=(t.get(n)||rN()).add(e);t.set(n,r)}}return t}async ja(e){let t=await ay(e,new oM(this.serializer),this.Qa,this.$a.id),n=this.za(this.documents);for(let t of this.Wa)await aw(e,t,n.get(t.name));return this.progress.taskState="Success",{progress:this.progress,Ha:this.collectionGroups,Ja:t}}}function oV(e){return{taskState:"Running",documentsLoaded:0,bytesLoaded:0,totalDocuments:e.totalDocuments,totalBytes:e.totalBytes}}class oL{constructor(e){this.key=e}}class oj{constructor(e){this.key=e}}class oU{constructor(e,t){this.query=e,this.Za=t,this.Xa=null,this.hasCachedResults=!1,this.current=!1,this.Ya=rN(),this.mutatedKeys=rN(),this.eu=rb(e),this.tu=new oT(this.eu)}get nu(){return this.Za}ru(e,t){let n=t?t.iu:new oI,r=t?t.tu:this.tu,i=t?t.mutatedKeys:this.mutatedKeys,s=r,a=!1,o="F"===this.query.limitType&&r.size===this.query.limit?r.last():null,l="L"===this.query.limitType&&r.size===this.query.limit?r.first():null;if(e.inorderTraversal((e,t)=>{let u=r.get(e),h=rw(this.query,t)?t:null,c=!!u&&this.mutatedKeys.has(u.key),d=!!h&&(h.hasLocalMutations||this.mutatedKeys.has(h.key)&&h.hasCommittedMutations),f=!1;u&&h?u.data.isEqual(h.data)?c!==d&&(n.track({type:3,doc:h}),f=!0):this.su(u,h)||(n.track({type:2,doc:h}),f=!0,(o&&this.eu(h,o)>0||l&&0>this.eu(h,l))&&(a=!0)):!u&&h?(n.track({type:0,doc:h}),f=!0):u&&!h&&(n.track({type:1,doc:u}),f=!0,(o||l)&&(a=!0)),f&&(h?(s=s.add(h),i=d?i.add(e):i.delete(e)):(s=s.delete(e),i=i.delete(e)))}),null!==this.query.limit)for(;s.size>this.query.limit;){let e="F"===this.query.limitType?s.last():s.first();s=s.delete(e.key),i=i.delete(e.key),n.track({type:1,doc:e})}return{tu:s,iu:n,Ss:a,mutatedKeys:i}}su(e,t){return e.hasLocalMutations&&t.hasCommittedMutations&&!t.hasLocalMutations}applyChanges(e,t,n,r){let i=this.tu;this.tu=e.tu,this.mutatedKeys=e.mutatedKeys;let s=e.iu.ya();s.sort((e,t)=>{var n,r;let i;return n=e.type,r=t.type,(i=e=>{switch(e){case 0:return 1;case 2:case 3:return 2;case 1:return 0;default:return G(20277,{Vt:e})}})(n)-i(r)||this.eu(e.doc,t.doc)}),this.ou(n),r=r??!1;let a=t&&!r?this._u():[],o=0===this.Ya.size&&this.current&&!r?1:0,l=o!==this.Xa;return(this.Xa=o,0!==s.length||l)?{snapshot:new oS(this.query,e.tu,i,s,e.mutatedKeys,0===o,l,!1,!!n&&n.resumeToken.approximateByteSize()>0),au:a}:{au:a}}va(e){return this.current&&"Offline"===e?(this.current=!1,this.applyChanges({tu:this.tu,iu:new oI,mutatedKeys:this.mutatedKeys,Ss:!1},!1)):{au:[]}}uu(e){return!this.Za.has(e)&&!!this.tu.has(e)&&!this.tu.get(e).hasLocalMutations}ou(e){e&&(e.addedDocuments.forEach(e=>this.Za=this.Za.add(e)),e.modifiedDocuments.forEach(e=>{}),e.removedDocuments.forEach(e=>this.Za=this.Za.delete(e)),this.current=e.current)}_u(){if(!this.current)return[];let e=this.Ya;this.Ya=rN(),this.tu.forEach(e=>{this.uu(e.key)&&(this.Ya=this.Ya.add(e.key))});let t=[];return e.forEach(e=>{this.Ya.has(e)||t.push(new oj(e))}),this.Ya.forEach(n=>{e.has(n)||t.push(new oL(n))}),t}cu(e){this.Za=e.ks,this.Ya=rN();let t=this.ru(e.documents);return this.applyChanges(t,!0)}lu(){return oS.fromInitialDocuments(this.query,this.tu,this.mutatedKeys,0===this.Xa,this.hasCachedResults)}}let oq="SyncEngine";class oB{constructor(e,t,n){this.query=e,this.targetId=t,this.view=n}}class oz{constructor(e){this.key=e,this.hu=!1}}class o${constructor(e,t,n,r,i,s){this.localStore=e,this.remoteStore=t,this.eventManager=n,this.sharedClientState=r,this.currentUser=i,this.maxConcurrentLimboResolutions=s,this.Pu={},this.Tu=new rx(e=>rp(e),rg),this.Iu=new Map,this.Eu=new Set,this.Ru=new t2(eg.comparator),this.Au=new Map,this.Vu=new sY,this.du={},this.mu=new Map,this.fu=sD.ar(),this.onlineState="Unknown",this.gu=void 0}get isPrimaryClient(){return!0===this.gu}}async function oG(e,t,n=!0){let r,i=lc(e),s=i.Tu.get(t);return s?(i.sharedClientState.addLocalQueryTarget(s.targetId),r=s.view.lu()):r=await oQ(i,t,n,!0),r}async function oK(e,t){let n=lc(e);await oQ(n,t,!0,!1)}async function oQ(e,t,n,r){let i,s=await ac(e.localStore,rc(t)),a=s.targetId,o=e.sharedClientState.addLocalQueryTarget(a,n);return r&&(i=await oH(e,t,a,"current"===o,s.resumeToken)),e.isPrimaryClient&&n&&a6(e.remoteStore,s),i}async function oH(e,t,n,r,i){e.pu=(t,n,r)=>(async function(e,t,n,r){let i=t.view.ru(n);i.Ss&&(i=await af(e.localStore,t.query,!1).then(({documents:e})=>t.view.ru(e,i)));let s=r&&r.targetChanges.get(t.targetId),a=r&&null!=r.targetMismatches.get(t.targetId),o=t.view.applyChanges(i,e.isPrimaryClient,s,a);return o8(e,t.targetId,o.au),o.snapshot})(e,t,n,r);let s=await af(e.localStore,t,!0),a=new oU(t,s.ks),o=a.ru(s.documents),l=ih.createSynthesizedTargetChangeForCurrentChange(n,r&&"Offline"!==e.onlineState,i),u=a.applyChanges(o,e.isPrimaryClient,l);o8(e,n,u.au);let h=new oB(t,n,a);return e.Tu.set(t,h),e.Iu.has(n)?e.Iu.get(n).push(t):e.Iu.set(n,[t]),u.snapshot}async function oW(e,t,n){let r=e.Tu.get(t),i=e.Iu.get(r.targetId);i.length>1?(e.Iu.set(r.targetId,i.filter(e=>!rg(e,t))),e.Tu.delete(t)):e.isPrimaryClient?(e.sharedClientState.removeLocalQueryTarget(r.targetId),e.sharedClientState.isActiveQueryTarget(r.targetId)||await ad(e.localStore,r.targetId,!1).then(()=>{e.sharedClientState.clearQueryState(r.targetId),n&&a8(e.remoteStore,r.targetId),o3(e,r.targetId)}).catch(ej)):(o3(e,r.targetId),await ad(e.localStore,r.targetId,!0))}async function oJ(e,t){let n=e.Tu.get(t),r=e.Iu.get(n.targetId);e.isPrimaryClient&&1===r.length&&(e.sharedClientState.removeLocalQueryTarget(n.targetId),a8(e.remoteStore,n.targetId))}async function oY(e,t,n){let r=ld(e);try{var i,s;let e,a,o,l,u,h=await (i=r.localStore,o=eE.now(),l=t.reduce((e,t)=>e.add(t.key),rN()),i.persistence.runTransaction("Locally write mutations","readwrite",n=>{let r=rT,s=rN();return i.xs.getEntries(n,l).next(e=>{(r=e).forEach((e,t)=>{t.isValidDocument()||(s=s.add(e))})}).next(()=>i.localDocuments.getOverlayedDocuments(n,r)).next(r=>{e=r;let s=[];for(let n of t){let t=function(e,t){let n=null;for(let r of e.fieldTransforms){let e=t.data.field(r.field),i=rO(r.transform,e||null);null!=i&&(null===n&&(n=nU.empty()),n.set(r.field,i))}return n||null}(n,e.get(n.key).overlayedDocument);null!=t&&s.push(new rX(n.key,t,function e(t){let n=[];return t0(t.fields,(t,r)=>{let i=new em([t]);if(nP(r)){let t=e(r.mapValue).fields;if(0===t.length)n.push(i);else for(let e of t)n.push(i.child(e))}else n.push(i)}),new t7(n)}(t.value.mapValue),rG.exists(!0)))}return i.mutationQueue.addMutationBatch(n,o,s,t)}).next(t=>{a=t;let r=t.applyToLocalDocumentSet(e,s);return i.documentOverlayCache.saveOverlays(n,t.batchId,r)})}).then(()=>({batchId:a.batchId,changes:rE(e)})));r.sharedClientState.addPendingMutation(h.batchId),s=h.batchId,(u=r.du[r.currentUser.toKey()])||(u=new t2(ea)),u=u.insert(s,n),r.du[r.currentUser.toKey()]=u,await o9(r,h.changes),await ou(r.remoteStore)}catch(t){let e=ox(t,"Failed to persist write");n.reject(e)}}async function oX(e,t){var n;try{let r,i,s=await (n=e.localStore,r=t.snapshotVersion,i=n.vs,n.persistence.runTransaction("Apply remote event","readwrite-primary",e=>{let s=n.xs.newChangeBuffer({trackRemovals:!0});i=n.vs;let a=[];t.targetChanges.forEach((s,o)=>{var l;let u=i.get(o);if(!u)return;a.push(n.li.removeMatchingKeys(e,s.removedDocuments,o).next(()=>n.li.addMatchingKeys(e,s.addedDocuments,o)));let h=u.withSequenceNumber(e.currentSequenceNumber);null!==t.targetMismatches.get(o)?h=h.withResumeToken(ne.EMPTY_BYTE_STRING,e_.min()).withLastLimboFreeSnapshotVersion(e_.min()):s.resumeToken.approximateByteSize()>0&&(h=h.withResumeToken(s.resumeToken,r)),i=i.insert(o,h),l=h,(0===u.resumeToken.approximateByteSize()||l.snapshotVersion.toMicroseconds()-u.snapshotVersion.toMicroseconds()>=3e8||s.addedDocuments.size+s.modifiedDocuments.size+s.removedDocuments.size>0)&&a.push(n.li.updateTargetData(e,h))});let o=rT,l=rN();if(t.documentUpdates.forEach(r=>{t.resolvedLimboDocuments.has(r)&&a.push(n.persistence.referenceDelegate.updateLimboDocument(e,r))}),a.push(ah(e,s,t.documentUpdates).next(e=>{o=e.Bs,l=e.Ls})),!r.isEqual(e_.min())){let t=n.li.getLastRemoteSnapshotVersion(e).next(t=>n.li.setTargetsMetadata(e,e.currentSequenceNumber,r));a.push(t)}return eU.waitFor(a).next(()=>s.apply(e)).next(()=>n.localDocuments.getLocalViewOfDocuments(e,o,l)).next(()=>o)}).then(e=>(n.vs=i,e)));t.targetChanges.forEach((t,n)=>{let r=e.Au.get(n);r&&(Q(t.addedDocuments.size+t.modifiedDocuments.size+t.removedDocuments.size<=1,22616),t.addedDocuments.size>0?r.hu=!0:t.modifiedDocuments.size>0?Q(r.hu,14607):t.removedDocuments.size>0&&(Q(r.hu,42227),r.hu=!1))}),await o9(e,s,t)}catch(e){await ej(e)}}function oZ(e,t,n){var r;if(e.isPrimaryClient&&0===n||!e.isPrimaryClient&&1===n){let n,i=[];e.Tu.forEach((e,n)=>{let r=n.view.va(t);r.snapshot&&i.push(r.snapshot)}),(r=e.eventManager).onlineState=t,n=!1,r.queries.forEach((e,r)=>{for(let e of r.ba)e.va(t)&&(n=!0)}),n&&oR(r),i.length&&e.Pu.J_(i),e.onlineState=t,e.isPrimaryClient&&e.sharedClientState.setOnlineState(t)}}async function o0(e,t,n){e.sharedClientState.updateQueryState(t,"rejected",n);let r=e.Au.get(t),i=r&&r.key;if(i){let n=new t2(eg.comparator);n=n.insert(i,nq.newNoDocument(i,e_.min()));let r=rN().add(i),s=new iu(e_.min(),new Map,new t2(ea),n,r);await oX(e,s),e.Ru=e.Ru.remove(i),e.Au.delete(t),o7(e)}else await ad(e.localStore,t,!1).then(()=>o3(e,t,n)).catch(ej)}async function o1(e,t){var n;let r=t.batch.batchId;try{let i=await (n=e.localStore,n.persistence.runTransaction("Acknowledge batch","readwrite-primary",e=>{let r,i,s,a=t.batch.keys(),o=n.xs.newChangeBuffer({trackRemovals:!0});return(i=(r=t.batch).keys(),s=eU.resolve(),i.forEach(n=>{s=s.next(()=>o.getEntry(e,n)).next(e=>{let i=t.docVersions.get(n);Q(null!==i,48541),0>e.version.compareTo(i)&&(r.applyToRemoteDocument(e,t),e.isValidDocument()&&(e.setReadTime(t.commitVersion),o.addEntry(e)))})}),s.next(()=>n.mutationQueue.removeMutationBatch(e,r))).next(()=>o.apply(e)).next(()=>n.mutationQueue.performConsistencyCheck(e)).next(()=>n.documentOverlayCache.removeOverlaysForBatchId(e,a,t.batch.batchId)).next(()=>n.localDocuments.recalculateAndSaveOverlaysForDocumentKeys(e,function(e){let t=rN();for(let n=0;n<e.mutationResults.length;++n)e.mutationResults[n].transformResults.length>0&&(t=t.add(e.batch.mutations[n].key));return t}(t))).next(()=>n.localDocuments.getDocuments(e,a))}));o4(e,r,null),o5(e,r),e.sharedClientState.updateMutationState(r,"acknowledged"),await o9(e,i)}catch(e){await ej(e)}}async function o2(e,t,n){var r;try{let i=await (r=e.localStore,r.persistence.runTransaction("Reject batch","readwrite-primary",e=>{let n;return r.mutationQueue.lookupMutationBatch(e,t).next(t=>(Q(null!==t,37113),n=t.keys(),r.mutationQueue.removeMutationBatch(e,t))).next(()=>r.mutationQueue.performConsistencyCheck(e)).next(()=>r.documentOverlayCache.removeOverlaysForBatchId(e,n,t)).next(()=>r.localDocuments.recalculateAndSaveOverlaysForDocumentKeys(e,n)).next(()=>r.localDocuments.getDocuments(e,n))}));o4(e,t,n),o5(e,t),e.sharedClientState.updateMutationState(t,"rejected",n),await o9(e,i)}catch(e){await ej(e)}}function o5(e,t){(e.mu.get(t)||[]).forEach(e=>{e.resolve()}),e.mu.delete(t)}function o4(e,t,n){let r=e.du[e.currentUser.toKey()];if(r){let i=r.get(t);i&&(n?i.reject(n):i.resolve(),r=r.remove(t)),e.du[e.currentUser.toKey()]=r}}function o3(e,t,n=null){for(let r of(e.sharedClientState.removeLocalQueryTarget(t),e.Iu.get(t)))e.Tu.delete(r),n&&e.Pu.yu(r,n);e.Iu.delete(t),e.isPrimaryClient&&e.Vu.Gr(t).forEach(t=>{e.Vu.containsKey(t)||o6(e,t)})}function o6(e,t){e.Eu.delete(t.path.canonicalString());let n=e.Ru.get(t);null!==n&&(a8(e.remoteStore,n),e.Ru=e.Ru.remove(t),e.Au.delete(n),o7(e))}function o8(e,t,n){for(let r of n)r instanceof oL?(e.Vu.addReference(r.key,t),function(e,t){let n=t.key,r=n.path.canonicalString();e.Ru.get(n)||e.Eu.has(r)||(q(oq,"New document in limbo: "+n),e.Eu.add(r),o7(e))}(e,r)):r instanceof oj?(q(oq,"Document no longer in limbo: "+r.key),e.Vu.removeReference(r.key,t),e.Vu.containsKey(r.key)||o6(e,r.key)):G(19791,{wu:r})}function o7(e){for(;e.Eu.size>0&&e.Ru.size<e.maxConcurrentLimboResolutions;){let t=e.Eu.values().next().value;e.Eu.delete(t);let n=new eg(ed.fromString(t)),r=e.fu.next();e.Au.set(r,new oz(n)),e.Ru=e.Ru.insert(n,r),a6(e.remoteStore,new iQ(rc(ro(n.path)),r,"TargetPurposeLimboResolution",e1.ce))}}async function o9(e,t,n){let r=[],i=[],s=[];e.Tu.isEmpty()||(e.Tu.forEach((a,o)=>{s.push(e.pu(o,t,n).then(t=>{if((t||n)&&e.isPrimaryClient){let r=t?!t.fromCache:n?.targetChanges.get(o.targetId)?.current;e.sharedClientState.updateQueryState(o.targetId,r?"current":"not-current")}if(t){r.push(t);let e=ar.Es(o.targetId,t);i.push(e)}}))}),await Promise.all(s),e.Pu.J_(r),await async function(e,t){try{await e.persistence.runTransaction("notifyLocalViewChanges","readwrite",n=>eU.forEach(t,t=>eU.forEach(t.Ts,r=>e.persistence.referenceDelegate.addReference(n,t.targetId,r)).next(()=>eU.forEach(t.Is,r=>e.persistence.referenceDelegate.removeReference(n,t.targetId,r)))))}catch(e){if(!eQ(e))throw e;q(aa,"Failed to update sequence numbers: "+e)}for(let n of t){let t=n.targetId;if(!n.fromCache){let n=e.vs.get(t),r=n.snapshotVersion,i=n.withLastLimboFreeSnapshotVersion(r);e.vs=e.vs.insert(t,i)}}}(e.localStore,i))}async function le(e,t){if(!e.currentUser.isEqual(t)){q(oq,"User change. New user:",t.toKey());let n=await al(e.localStore,t);e.currentUser=t,e.mu.forEach(e=>{e.forEach(e=>{e.reject(new W(H.CANCELLED,"'waitForPendingWrites' promise is rejected due to a user change."))})}),e.mu.clear(),e.sharedClientState.handleUserChange(t,n.removedBatchIds,n.addedBatchIds),await o9(e,n.Ns)}}function lt(e,t){let n=e.Au.get(t);if(n&&n.hu)return rN().add(n.key);{let n=rN(),r=e.Iu.get(t);if(!r)return n;for(let t of r){let r=e.Tu.get(t);n=n.unionWith(r.view.nu)}return n}}async function ln(e,t){let n=await af(e.localStore,t.query,!0),r=t.view.cu(n);return e.isPrimaryClient&&o8(e,t.targetId,r.au),r}async function lr(e,t){return ag(e.localStore,t).then(t=>o9(e,t))}async function li(e,t,n,r){var i,s;let a,o=await (i=e.localStore,a=i.mutationQueue,i.persistence.runTransaction("Lookup mutation documents","readonly",e=>a.Xn(e,t).next(t=>t?i.localDocuments.getDocuments(e,t):eU.resolve(null))));null!==o?("pending"===n?await ou(e.remoteStore):"acknowledged"===n||"rejected"===n?(o4(e,t,r||null),o5(e,t),s=e.localStore,s.mutationQueue.nr(t)):G(6720,"Unknown batchState",{bu:n}),await o9(e,o)):q(oq,"Cannot apply mutation batch with id: "+t)}async function ls(e,t){if(lc(e),ld(e),!0===t&&!0!==e.gu){let t=e.sharedClientState.getAllActiveQueryTargets(),n=await la(e,t.toArray());for(let t of(e.gu=!0,await oy(e.remoteStore,!0),n))a6(e.remoteStore,t)}else if(!1===t&&!1!==e.gu){let t=[],n=Promise.resolve();e.Iu.forEach((r,i)=>{e.sharedClientState.isLocalQueryTarget(i)?t.push(i):n=n.then(()=>(o3(e,i),ad(e.localStore,i,!0))),a8(e.remoteStore,i)}),await n,await la(e,t),e.Au.forEach((t,n)=>{a8(e.remoteStore,n)}),e.Vu.zr(),e.Au=new Map,e.Ru=new t2(eg.comparator),e.gu=!1,await oy(e.remoteStore,!1)}}async function la(e,t,n){let r=[],i=[];for(let n of t){let t,s=e.Iu.get(n);if(s&&0!==s.length)for(let n of(t=await ac(e.localStore,rc(s[0])),s)){let t=e.Tu.get(n),r=await ln(e,t);r.snapshot&&i.push(r.snapshot)}else{let r=await am(e.localStore,n);t=await ac(e.localStore,r),await oH(e,lo(r),n,!1,t.resumeToken)}r.push(t)}return e.Pu.J_(i),r}function lo(e){var t,n,r,i,s;return t=e.path,n=e.collectionGroup,r=e.orderBy,i=e.filters,s=e.limit,new ra(t,n,r,i,s,"F",e.startAt,e.endAt)}function ll(e){return e.localStore.persistence.hs()}async function lu(e,t,n,r){if(e.gu)return void q(oq,"Ignoring unexpected query state notification.");let i=e.Iu.get(t);if(i&&i.length>0)switch(n){case"current":case"not-current":{let r=await ag(e.localStore,rv(i[0])),s=iu.createSynthesizedRemoteEventForCurrentChange(t,"current"===n,ne.EMPTY_BYTE_STRING);await o9(e,r,s);break}case"rejected":await ad(e.localStore,t,!0),o3(e,t,r);break;default:G(64155,n)}}async function lh(e,t,n){let r=lc(e);if(r.gu){for(let e of t){if(r.Iu.has(e)&&r.sharedClientState.isActiveQueryTarget(e)){q(oq,"Adding an already active target "+e);continue}let t=await am(r.localStore,e),n=await ac(r.localStore,t);await oH(r,lo(t),n.targetId,!1,n.resumeToken),a6(r.remoteStore,n)}for(let e of n)r.Iu.has(e)&&await ad(r.localStore,e,!1).then(()=>{a8(r.remoteStore,e),o3(r,e)}).catch(ej)}}function lc(e){return e.remoteStore.remoteSyncer.applyRemoteEvent=oX.bind(null,e),e.remoteStore.remoteSyncer.getRemoteKeysForTarget=lt.bind(null,e),e.remoteStore.remoteSyncer.rejectListen=o0.bind(null,e),e.Pu.J_=oD.bind(null,e.eventManager),e.Pu.yu=ok.bind(null,e.eventManager),e}function ld(e){return e.remoteStore.remoteSyncer.applySuccessfulWrite=o1.bind(null,e),e.remoteStore.remoteSyncer.rejectFailedWrite=o2.bind(null,e),e}class lf{constructor(){this.kind="memory",this.synchronizeTabs=!1}async initialize(e){this.serializer=aQ(e.databaseInfo.databaseId),this.sharedClientState=this.Du(e),this.persistence=this.Cu(e),await this.persistence.start(),this.localStore=this.vu(e),this.gcScheduler=this.Fu(e,this.localStore),this.indexBackfillerScheduler=this.Mu(e,this.localStore)}Fu(e,t){return null}Mu(e,t){return null}vu(e){var t,n;return t=this.persistence,n=new as,new ao(t,n,e.initialUser,this.serializer)}Cu(e){return new s5(s3.Vi,this.serializer)}Du(e){return new aR}async terminate(){this.gcScheduler?.stop(),this.indexBackfillerScheduler?.stop(),this.sharedClientState.shutdown(),await this.persistence.shutdown()}}lf.provider={build:()=>new lf};class lm extends lf{constructor(e){super(),this.cacheSizeBytes=e}Fu(e,t){return Q(this.persistence.referenceDelegate instanceof s6,46915),new sF(this.persistence.referenceDelegate.garbageCollector,e.asyncQueue,t)}Cu(e){let t=void 0!==this.cacheSizeBytes?sS.withCacheSize(this.cacheSizeBytes):sS.DEFAULT;return new s5(e=>s6.Vi(e,t),this.serializer)}}class lg extends lf{constructor(e,t,n){super(),this.xu=e,this.cacheSizeBytes=t,this.forceOwnership=n,this.kind="persistent",this.synchronizeTabs=!1}async initialize(e){await super.initialize(e),await this.xu.initialize(this,e),await ld(this.xu.syncEngine),await ou(this.xu.remoteStore),await this.persistence.zi(()=>(this.gcScheduler&&!this.gcScheduler.started&&this.gcScheduler.start(),this.indexBackfillerScheduler&&!this.indexBackfillerScheduler.started&&this.indexBackfillerScheduler.start(),Promise.resolve()))}vu(e){var t,n;return t=this.persistence,n=new as,new ao(t,n,e.initialUser,this.serializer)}Fu(e,t){return new sF(this.persistence.referenceDelegate.garbageCollector,e.asyncQueue,t)}Mu(e,t){let n=new e0(t,this.persistence);return new eZ(e.asyncQueue,n)}Cu(e){let t=an(e.databaseInfo.databaseId,e.databaseInfo.persistenceKey),n=void 0!==this.cacheSizeBytes?sS.withCacheSize(this.cacheSizeBytes):sS.DEFAULT;return new at(this.synchronizeTabs,t,e.clientId,n,e.asyncQueue,aG(),aK(),this.serializer,this.sharedClientState,!!this.forceOwnership)}Du(e){return new aR}}class lp extends lg{constructor(e,t){super(e,t,!1),this.xu=e,this.cacheSizeBytes=t,this.synchronizeTabs=!0}async initialize(e){await super.initialize(e);let t=this.xu.syncEngine;this.sharedClientState instanceof ak&&(this.sharedClientState.syncEngine={So:li.bind(null,t),Do:lu.bind(null,t),Co:lh.bind(null,t),hs:ll.bind(null,t),bo:lr.bind(null,t)},await this.sharedClientState.start()),await this.persistence.zi(async e=>{await ls(this.xu.syncEngine,e),this.gcScheduler&&(e&&!this.gcScheduler.started?this.gcScheduler.start():e||this.gcScheduler.stop()),this.indexBackfillerScheduler&&(e&&!this.indexBackfillerScheduler.started?this.indexBackfillerScheduler.start():e||this.indexBackfillerScheduler.stop())})}Du(e){let t=aG();if(!ak.v(t))throw new W(H.UNIMPLEMENTED,"IndexedDB persistence is only available on platforms that support LocalStorage.");let n=an(e.databaseInfo.databaseId,e.databaseInfo.persistenceKey);return new ak(t,e.asyncQueue,n,e.clientId,e.initialUser)}}class ly{async initialize(e,t){this.localStore||(this.localStore=e.localStore,this.sharedClientState=e.sharedClientState,this.datastore=this.createDatastore(t),this.remoteStore=this.createRemoteStore(t),this.eventManager=this.createEventManager(t),this.syncEngine=this.createSyncEngine(t,!e.synchronizeTabs),this.sharedClientState.onlineStateHandler=e=>oZ(this.syncEngine,e,1),this.remoteStore.remoteSyncer.handleCredentialChange=le.bind(null,this.syncEngine),await oy(this.remoteStore,this.syncEngine.isPrimaryClient))}createEventManager(e){return new o_}createDatastore(e){var t;let n=aQ(e.databaseInfo.databaseId),r=new a$(e.databaseInfo);return t=e.authCredentials,new a0(t,e.appCheckCredentials,r,n)}createRemoteStore(e){var t,n;return t=this.localStore,n=this.datastore,new a5(t,n,e.asyncQueue,e=>oZ(this.syncEngine,e,0),aM.v()?new aM:new aP)}createSyncEngine(e,t){var n,r,i,s,a,o;let l;return n=this.localStore,r=this.remoteStore,i=this.eventManager,s=this.sharedClientState,a=e.initialUser,o=e.maxConcurrentLimboResolutions,l=new o$(n,r,i,s,a,o),t&&(l.gu=!0),l}async terminate(){await async function(e){q(a2,"RemoteStore shutting down."),e.Ea.add(5),await a3(e),e.Aa.shutdown(),e.Va.set("Unknown")}(this.remoteStore),this.datastore?.terminate(),this.eventManager?.terminate()}}function lw(e,t=10240){let n=0;return{async read(){if(n<e.byteLength){let r={value:e.slice(n,n+t),done:!1};return n+=t,r}return{done:!0}},async cancel(){},releaseLock(){},closed:Promise.resolve()}}ly.provider={build:()=>new ly};class lv{constructor(e){this.observer=e,this.muted=!1}next(e){this.muted||this.observer.next&&this.Ou(this.observer.next,e)}error(e){this.muted||(this.observer.error?this.Ou(this.observer.error,e):B("Uncaught Error in snapshot listener:",e.toString()))}Nu(){this.muted=!0}Ou(e,t){setTimeout(()=>{this.muted||e(t)},0)}}class lb{constructor(e,t){this.Bu=e,this.serializer=t,this.metadata=new J,this.buffer=new Uint8Array,this.Lu=new TextDecoder("utf-8"),this.ku().then(e=>{e&&e.Ua()?this.metadata.resolve(e.qa.metadata):this.metadata.reject(Error(`The first element of the bundle is not a metadata, it is
             ${JSON.stringify(e?.qa)}`))},e=>this.metadata.reject(e))}close(){return this.Bu.cancel()}async getMetadata(){return this.metadata.promise}async Su(){return await this.getMetadata(),this.ku()}async ku(){let e=await this.Ku();if(null===e)return null;let t=this.Lu.decode(e),n=Number(t);return isNaN(n)&&this.qu(`length string (${t}) is not valid number`),new oO(JSON.parse(await this.Uu(n)),e.length+n)}$u(){return this.buffer.findIndex(e=>123===e)}async Ku(){for(;0>this.$u()&&!await this.Wu(););if(0===this.buffer.length)return null;let e=this.$u();e<0&&this.qu("Reached the end of bundle when a length string is expected.");let t=this.buffer.slice(0,e);return this.buffer=this.buffer.slice(e),t}async Uu(e){for(;this.buffer.length<e;)await this.Wu()&&this.qu("Reached the end of bundle when more is expected.");let t=this.Lu.decode(this.buffer.slice(0,e));return this.buffer=this.buffer.slice(e),t}qu(e){throw this.Bu.cancel(),Error(`Invalid bundle format: ${e}`)}async Wu(){let e=await this.Bu.read();if(!e.done){let t=new Uint8Array(this.buffer.length+e.value.length);t.set(this.buffer),t.set(e.value,this.buffer.length),this.buffer=t}return e.done}}class lx{constructor(e,t){this.bundleData=e,this.serializer=t,this.cursor=0,this.elements=[];let n=this.Su();if(!n||!n.Ua())throw Error(`The first element of the bundle is not a metadata object, it is
         ${JSON.stringify(n?.qa)}`);this.metadata=n;do null!==(n=this.Su())&&this.elements.push(n);while(null!==n)}getMetadata(){return this.metadata}Qu(){return this.elements}Su(){if(this.cursor===this.bundleData.length)return null;let e=this.Ku();return new oO(JSON.parse(this.Uu(e)),e)}Uu(e){if(this.cursor+e>this.bundleData.length)throw new W(H.INTERNAL,"Reached the end of bundle when more is expected.");return this.bundleData.slice(this.cursor,this.cursor+=e)}Ku(){let e=this.cursor,t=this.cursor;for(;t<this.bundleData.length;){if("{"===this.bundleData[t]){if(t===e)throw Error("First character is a bracket and not a number");return this.cursor=t,Number(this.bundleData.slice(e,t))}t++}throw Error("Reached the end of bundle when more is expected.")}}class lT{constructor(e){this.datastore=e,this.readVersions=new Map,this.mutations=[],this.committed=!1,this.lastTransactionError=null,this.writtenDocs=new Set}async lookup(e){if(this.ensureCommitNotCalled(),this.mutations.length>0)throw this.lastTransactionError=new W(H.INVALID_ARGUMENT,"Firestore transactions require all reads to be executed before all writes."),this.lastTransactionError;let t=await async function(e,t){let n={documents:t.map(t=>iD(e.serializer,t))},r=await e.jo("BatchGetDocuments",e.serializer.databaseId,ed.emptyPath(),n,t.length),i=new Map;r.forEach(t=>{var n;let r,s,a,o,l,u,h=(n=e.serializer,"found"in t?(Q(!!t.found,43571),t.found.name,t.found.updateTime,r=ik(n,t.found.name),s=i_(t.found.updateTime),a=t.found.createTime?i_(t.found.createTime):e_.min(),o=new nU({mapValue:{fields:t.found.fields}}),nq.newFoundDocument(r,s,a,o)):"missing"in t?(Q(!!t.missing,3894),Q(!!t.readTime,22933),l=ik(n,t.missing),u=i_(t.readTime),nq.newNoDocument(l,u)):G(7234,{result:t}));i.set(h.key.toString(),h)});let s=[];return t.forEach(e=>{let t=i.get(e.toString());Q(!!t,55234,{key:e}),s.push(t)}),s}(this.datastore,e);return t.forEach(e=>this.recordVersion(e)),t}set(e,t){this.write(t.toMutation(e,this.precondition(e))),this.writtenDocs.add(e.toString())}update(e,t){try{this.write(t.toMutation(e,this.preconditionForUpdate(e)))}catch(e){this.lastTransactionError=e}this.writtenDocs.add(e.toString())}delete(e){this.write(new r2(e,this.precondition(e))),this.writtenDocs.add(e.toString())}async commit(){if(this.ensureCommitNotCalled(),this.lastTransactionError)throw this.lastTransactionError;let e=this.readVersions;this.mutations.forEach(t=>{e.delete(t.key.toString())}),e.forEach((e,t)=>{let n=eg.fromPath(t);this.mutations.push(new r5(n,this.precondition(n)))}),await async function(e,t){let n={writes:t.map(t=>iL(e.serializer,t))};await e.Wo("Commit",e.serializer.databaseId,ed.emptyPath(),n)}(this.datastore,this.mutations),this.committed=!0}recordVersion(e){let t;if(e.isFoundDocument())t=e.version;else{if(!e.isNoDocument())throw G(50498,{Gu:e.constructor.name});t=e_.min()}let n=this.readVersions.get(e.key.toString());if(n){if(!t.isEqual(n))throw new W(H.ABORTED,"Document version changed between two reads.")}else this.readVersions.set(e.key.toString(),t)}precondition(e){let t=this.readVersions.get(e.toString());return!this.writtenDocs.has(e.toString())&&t?t.isEqual(e_.min())?rG.exists(!1):rG.updateTime(t):rG.none()}preconditionForUpdate(e){let t=this.readVersions.get(e.toString());if(!this.writtenDocs.has(e.toString())&&t){if(t.isEqual(e_.min()))throw new W(H.INVALID_ARGUMENT,"Can't update a document that doesn't exist.");return rG.updateTime(t)}return rG.exists(!0)}write(e){this.ensureCommitNotCalled(),this.mutations.push(e)}ensureCommitNotCalled(){}}class lI{constructor(e,t,n,r,i){this.asyncQueue=e,this.datastore=t,this.options=n,this.updateFunction=r,this.deferred=i,this.zu=n.maxAttempts,this.M_=new aH(this.asyncQueue,"transaction_retry")}ju(){this.zu-=1,this.Hu()}Hu(){this.M_.p_(async()=>{let e=new lT(this.datastore),t=this.Ju(e);t&&t.then(t=>{this.asyncQueue.enqueueAndForget(()=>e.commit().then(()=>{this.deferred.resolve(t)}).catch(e=>{this.Zu(e)}))}).catch(e=>{this.Zu(e)})})}Ju(e){try{let t=this.updateFunction(e);return!e2(t)&&t.catch&&t.then?t:(this.deferred.reject(Error("Transaction callback must return a Promise")),null)}catch(e){return this.deferred.reject(e),null}}Zu(e){this.zu>0&&this.Xu(e)?(this.zu-=1,this.asyncQueue.enqueueAndForget(()=>(this.Hu(),Promise.resolve()))):this.deferred.reject(e)}Xu(e){if("FirebaseError"===e?.name){let t=e.code;return"aborted"===t||"failed-precondition"===t||"already-exists"===t||!r9(t)}return!1}}let lS="FirestoreClient";class lE{constructor(e,t,n,r,i){this.authCredentials=e,this.appCheckCredentials=t,this.asyncQueue=n,this._databaseInfo=r,this.user=V.UNAUTHENTICATED,this.clientId=es.newId(),this.authCredentialListener=()=>Promise.resolve(),this.appCheckCredentialListener=()=>Promise.resolve(),this._uninitializedComponentsProvider=i,this.authCredentials.start(n,async e=>{q(lS,"Received user=",e.uid),await this.authCredentialListener(e),this.user=e}),this.appCheckCredentials.start(n,e=>(q(lS,"Received new app check token=",e),this.appCheckCredentialListener(e,this.user)))}get configuration(){return{asyncQueue:this.asyncQueue,databaseInfo:this._databaseInfo,clientId:this.clientId,authCredentials:this.authCredentials,appCheckCredentials:this.appCheckCredentials,initialUser:this.user,maxConcurrentLimboResolutions:100}}setCredentialChangeListener(e){this.authCredentialListener=e}setAppCheckTokenChangeListener(e){this.appCheckCredentialListener=e}terminate(){this.asyncQueue.enterRestrictedMode();let e=new J;return this.asyncQueue.enqueueAndForgetEvenWhileRestricted(async()=>{try{this._onlineComponents&&await this._onlineComponents.terminate(),this._offlineComponents&&await this._offlineComponents.terminate(),this.authCredentials.shutdown(),this.appCheckCredentials.shutdown(),e.resolve()}catch(n){let t=ox(n,"Failed to shutdown persistence");e.reject(t)}}),e.promise}}async function l_(e,t){e.asyncQueue.verifyOperationInProgress(),q(lS,"Initializing OfflineComponentProvider");let n=e.configuration;await t.initialize(n);let r=n.initialUser;e.setCredentialChangeListener(async e=>{r.isEqual(e)||(await al(t.localStore,e),r=e)}),t.persistence.setDatabaseDeletedListener(()=>e.terminate()),e._offlineComponents=t}async function lC(e,t){e.asyncQueue.verifyOperationInProgress();let n=await lA(e);q(lS,"Initializing OnlineComponentProvider"),await t.initialize(n,e.configuration),e.setCredentialChangeListener(e=>op(t.remoteStore,e)),e.setAppCheckTokenChangeListener((e,n)=>op(t.remoteStore,n)),e._onlineComponents=t}async function lA(e){if(!e._offlineComponents)if(e._uninitializedComponentsProvider){q(lS,"Using user provided OfflineComponentProvider");try{await l_(e,e._uninitializedComponentsProvider._offline)}catch(t){if(!("FirebaseError"===t.name?t.code===H.FAILED_PRECONDITION||t.code===H.UNIMPLEMENTED:!("u">typeof DOMException&&t instanceof DOMException)||22===t.code||20===t.code||11===t.code))throw t;z("Error using user provided cache. Falling back to memory cache: "+t),await l_(e,new lf)}}else q(lS,"Using default OfflineComponentProvider"),await l_(e,new lm(void 0));return e._offlineComponents}async function lN(e){return e._onlineComponents||(e._uninitializedComponentsProvider?(q(lS,"Using user provided OnlineComponentProvider"),await lC(e,e._uninitializedComponentsProvider._online)):(q(lS,"Using default OnlineComponentProvider"),await lC(e,new ly))),e._onlineComponents}function lD(e){return lA(e).then(e=>e.localStore)}function lk(e){return lN(e).then(e=>e.syncEngine)}function lR(e){return lN(e).then(e=>e.datastore)}async function lP(e){let t=await lN(e),n=t.eventManager;return n.onListen=oG.bind(null,t.syncEngine),n.onUnlisten=oW.bind(null,t.syncEngine),n.onFirstRemoteStoreListen=oK.bind(null,t.syncEngine),n.onLastRemoteStoreUnlisten=oJ.bind(null,t.syncEngine),n}function lO(e,t,n={}){let r=new J;return e.asyncQueue.enqueueAndForget(async()=>{var i,s;let a,o;return i=await lP(e),s=e.asyncQueue,a=new lv({next:e=>{a.Nu(),s.enqueueAndForget(()=>oN(i,o));let l=e.docs.has(t);!l&&e.fromCache?r.reject(new W(H.UNAVAILABLE,"Failed to get document because the client is offline.")):l&&e.fromCache&&n&&"server"===n.source?r.reject(new W(H.UNAVAILABLE,'Failed to get document from server. (However, this document does exist in the local cache. Run again without setting source to "server" to retrieve the cached document.)')):r.resolve(e)},error:e=>r.reject(e)}),oA(i,o=new oP(ro(t.path),a,{includeMetadataChanges:!0,Ka:!0}))}),r.promise}function lM(e,t,n={}){let r=new J;return e.asyncQueue.enqueueAndForget(async()=>{var i,s;let a,o;return i=await lP(e),s=e.asyncQueue,o=new oP(t,a=new lv({next:e=>{a.Nu(),s.enqueueAndForget(()=>oN(i,o)),e.fromCache&&"server"===n.source?r.reject(new W(H.UNAVAILABLE,'Failed to get documents from server. (However, these documents may exist in the local cache. Run again without setting source to "server" to retrieve the cached documents.)')):r.resolve(e)},error:e=>r.reject(e)}),{includeMetadataChanges:!0,Ka:!0}),oA(i,o)}),r.promise}function lF(e){let t={};return void 0!==e.timeoutSeconds&&(t.timeoutSeconds=e.timeoutSeconds),t}let lV=new Map,lL="firestore.googleapis.com";class lj{constructor(e){if(void 0===e.host){if(void 0!==e.ssl)throw new W(H.INVALID_ARGUMENT,"Can't provide ssl option if host option is not set");this.host=lL,this.ssl=!0}else this.host=e.host,this.ssl=e.ssl??!0;if(this.isUsingEmulator=void 0!==e.emulatorOptions,this.credentials=e.credentials,this.ignoreUndefinedProperties=!!e.ignoreUndefinedProperties,this.localCache=e.localCache,void 0===e.cacheSizeBytes)this.cacheSizeBytes=0x2800000;else{if(-1!==e.cacheSizeBytes&&e.cacheSizeBytes<1048576)throw new W(H.INVALID_ARGUMENT,"cacheSizeBytes must be at least 1048576");this.cacheSizeBytes=e.cacheSizeBytes}(function(e,t,n,r){if(!0===t&&!0===r)throw new W(H.INVALID_ARGUMENT,`${e} and ${n} cannot be used together.`)})("experimentalForceLongPolling",e.experimentalForceLongPolling,"experimentalAutoDetectLongPolling",e.experimentalAutoDetectLongPolling),this.experimentalForceLongPolling=!!e.experimentalForceLongPolling,this.experimentalForceLongPolling?this.experimentalAutoDetectLongPolling=!1:void 0===e.experimentalAutoDetectLongPolling?this.experimentalAutoDetectLongPolling=!0:this.experimentalAutoDetectLongPolling=!!e.experimentalAutoDetectLongPolling,this.experimentalLongPollingOptions=lF(e.experimentalLongPollingOptions??{}),function(e){if(void 0!==e.timeoutSeconds){if(isNaN(e.timeoutSeconds))throw new W(H.INVALID_ARGUMENT,`invalid long polling timeout: ${e.timeoutSeconds} (must not be NaN)`);if(e.timeoutSeconds<5)throw new W(H.INVALID_ARGUMENT,`invalid long polling timeout: ${e.timeoutSeconds} (minimum allowed value is 5)`);if(e.timeoutSeconds>30)throw new W(H.INVALID_ARGUMENT,`invalid long polling timeout: ${e.timeoutSeconds} (maximum allowed value is 30)`)}}(this.experimentalLongPollingOptions),this.useFetchStreams=!!e.useFetchStreams}isEqual(e){var t,n;return this.host===e.host&&this.ssl===e.ssl&&this.credentials===e.credentials&&this.cacheSizeBytes===e.cacheSizeBytes&&this.experimentalForceLongPolling===e.experimentalForceLongPolling&&this.experimentalAutoDetectLongPolling===e.experimentalAutoDetectLongPolling&&(t=this.experimentalLongPollingOptions,n=e.experimentalLongPollingOptions,t.timeoutSeconds===n.timeoutSeconds)&&this.ignoreUndefinedProperties===e.ignoreUndefinedProperties&&this.useFetchStreams===e.useFetchStreams}}class lU{constructor(e,t,n,r){this._authCredentials=e,this._appCheckCredentials=t,this._databaseId=n,this._app=r,this.type="firestore-lite",this._persistenceKey="(lite)",this._settings=new lj({}),this._settingsFrozen=!1,this._emulatorOptions={},this._terminateTask="notTerminated"}get app(){if(!this._app)throw new W(H.FAILED_PRECONDITION,"Firestore was not initialized using the Firebase SDK. 'app' is not available");return this._app}get _initialized(){return this._settingsFrozen}get _terminated(){return"notTerminated"!==this._terminateTask}_setSettings(e){if(this._settingsFrozen)throw new W(H.FAILED_PRECONDITION,"Firestore has already been started and its settings can no longer be changed. You can only modify settings before calling any other methods on a Firestore object.");this._settings=new lj(e),this._emulatorOptions=e.emulatorOptions||{},void 0!==e.credentials&&(this._authCredentials=function(e){if(!e)return new X;switch(e.type){case"firstParty":return new en(e.sessionIndex||"0",e.iamToken||null,e.authTokenFactory||null);case"provider":return e.client;default:throw new W(H.INVALID_ARGUMENT,"makeAuthCredentialsProvider failed due to invalid credential type")}}(e.credentials))}_getSettings(){return this._settings}_getEmulatorOptions(){return this._emulatorOptions}_freezeSettings(){return this._settingsFrozen=!0,this._settings}_delete(){return"notTerminated"===this._terminateTask&&(this._terminateTask=this._terminate()),this._terminateTask}async _restart(){"notTerminated"===this._terminateTask?await this._terminate():this._terminateTask="notTerminated"}toJSON(){return{app:this._app,databaseId:this._databaseId,settings:this._settings}}_terminate(){let e;return(e=lV.get(this))&&(q("ComponentProvider","Removing Datastore"),lV.delete(this),e.terminate()),Promise.resolve()}}class lq{constructor(e,t,n){this.converter=t,this._query=n,this.type="query",this.firestore=e}withConverter(e){return new lq(this.firestore,e,this._query)}}class lB{constructor(e,t,n){this.converter=t,this._key=n,this.type="document",this.firestore=e}get _path(){return this._key.path}get id(){return this._key.path.lastSegment()}get path(){return this._key.path.canonicalString()}get parent(){return new lz(this.firestore,this.converter,this._key.path.popLast())}withConverter(e){return new lB(this.firestore,e,this._key)}toJSON(){return{type:lB._jsonSchemaVersion,referencePath:this._key.toString()}}static fromJSON(e,t,n){if(eS(t,lB._jsonSchema))return new lB(e,n||null,new eg(ed.fromString(t.referencePath)))}}lB._jsonSchemaVersion="firestore/documentReference/1.0",lB._jsonSchema={type:eI("string",lB._jsonSchemaVersion),referencePath:eI("string")};class lz extends lq{constructor(e,t,n){super(e,t,ro(n)),this._path=n,this.type="collection"}get id(){return this._query.path.lastSegment()}get path(){return this._query.path.canonicalString()}get parent(){let e=this._path.popLast();return e.isEmpty()?null:new lB(this.firestore,null,new eg(e))}withConverter(e){return new lz(this.firestore,e,this._path)}}function l$(e,t,...n){if(e=(0,k.getModularInstance)(e),1==arguments.length&&(t=es.newId()),ep("doc","path",t),e instanceof lU){let r=ed.fromString(t,...n);return ey(r),new lB(e,null,new eg(r))}{if(!(e instanceof lB||e instanceof lz))throw new W(H.INVALID_ARGUMENT,"Expected first argument to doc() to be a CollectionReference, a DocumentReference or FirebaseFirestore");let r=e._path.child(ed.fromString(t,...n));return ey(r),new lB(e.firestore,e instanceof lz?e.converter:null,new eg(r))}}function lG(e,t){return e=(0,k.getModularInstance)(e),t=(0,k.getModularInstance)(t),e instanceof lq&&t instanceof lq&&e.firestore===t.firestore&&rg(e._query,t._query)&&e.converter===t.converter}let lK="AsyncQueue";class lQ{constructor(e=Promise.resolve()){this.Yu=[],this.ec=!1,this.tc=[],this.nc=null,this.rc=!1,this.sc=!1,this.oc=[],this.M_=new aH(this,"async_queue_retry"),this._c=()=>{let e=aK();e&&q(lK,"Visibility state changed to "+e.visibilityState),this.M_.w_()},this.ac=e;const t=aK();t&&"function"==typeof t.addEventListener&&t.addEventListener("visibilitychange",this._c)}get isShuttingDown(){return this.ec}enqueueAndForget(e){this.enqueue(e)}enqueueAndForgetEvenWhileRestricted(e){this.uc(),this.cc(e)}enterRestrictedMode(e){if(!this.ec){this.ec=!0,this.sc=e||!1;let t=aK();t&&"function"==typeof t.removeEventListener&&t.removeEventListener("visibilitychange",this._c)}}enqueue(e){if(this.uc(),this.ec)return new Promise(()=>{});let t=new J;return this.cc(()=>this.ec&&this.sc?Promise.resolve():(e().then(t.resolve,t.reject),t.promise)).then(()=>t.promise)}enqueueRetryable(e){this.enqueueAndForget(()=>(this.Yu.push(e),this.lc()))}async lc(){if(0!==this.Yu.length){try{await this.Yu[0](),this.Yu.shift(),this.M_.reset()}catch(e){if(!eQ(e))throw e;q(lK,"Operation failed with retryable error: "+e)}this.Yu.length>0&&this.M_.p_(()=>this.lc())}}cc(e){let t=this.ac.then(()=>(this.rc=!0,e().catch(e=>{throw this.nc=e,this.rc=!1,B("INTERNAL UNHANDLED ERROR: ",lH(e)),e}).then(e=>(this.rc=!1,e))));return this.ac=t,t}enqueueAfterDelay(e,t,n){this.uc(),this.oc.indexOf(e)>-1&&(t=0);let r=ob.createAndSchedule(this,e,t,n,e=>this.hc(e));return this.tc.push(r),r}uc(){this.nc&&G(47125,{Pc:lH(this.nc)})}verifyOperationInProgress(){}async Tc(){let e;do e=this.ac,await e;while(e!==this.ac)}Ic(e){for(let t of this.tc)if(t.timerId===e)return!0;return!1}Ec(e){return this.Tc().then(()=>{for(let t of(this.tc.sort((e,t)=>e.targetTimeMs-t.targetTimeMs),this.tc))if(t.skipDelay(),"all"!==e&&t.timerId===e)break;return this.Tc()})}Rc(e){this.oc.push(e)}hc(e){let t=this.tc.indexOf(e);this.tc.splice(t,1)}}function lH(e){let t=e.message||"";return e.stack&&(t=e.stack.includes(e.message)?e.stack:e.message+"\n"+e.stack),t}class lW{constructor(){this._progressObserver={},this._taskCompletionResolver=new J,this._lastProgress={taskState:"Running",totalBytes:0,totalDocuments:0,bytesLoaded:0,documentsLoaded:0}}onProgress(e,t,n){this._progressObserver={next:e,error:t,complete:n}}catch(e){return this._taskCompletionResolver.promise.catch(e)}then(e,t){return this._taskCompletionResolver.promise.then(e,t)}_completeWith(e){this._updateProgress(e),this._progressObserver.complete&&this._progressObserver.complete(),this._taskCompletionResolver.resolve(e)}_failWith(e){this._lastProgress.taskState="Error",this._progressObserver.next&&this._progressObserver.next(this._lastProgress),this._progressObserver.error&&this._progressObserver.error(e),this._taskCompletionResolver.reject(e)}_updateProgress(e){this._lastProgress=e,this._progressObserver.next&&this._progressObserver.next(e)}}class lJ extends lU{constructor(e,t,n,r){super(e,t,n,r),this.type="firestore",this._queue=new lQ,this._persistenceKey=r?.name||"[DEFAULT]"}async _terminate(){if(this._firestoreClient){let e=this._firestoreClient.terminate();this._queue=new lQ(e),this._firestoreClient=void 0,await e}}}function lY(e){if(e._terminated)throw new W(H.FAILED_PRECONDITION,"The client has already been terminated.");return e._firestoreClient||function(e){var t,n,r,i,s;let a,o=e._freezeSettings(),l=(t=e._databaseId,n=e._app?.options.appId||"",r=e._persistenceKey,i=e._app?.options.apiKey,new nd(t,n,r,o.host,o.ssl,o.experimentalForceLongPolling,o.experimentalAutoDetectLongPolling,lF(o.experimentalLongPollingOptions),o.useFetchStreams,o.isUsingEmulator,i));e._componentsProvider||o.localCache?._offlineComponentProvider&&o.localCache?._onlineComponentProvider&&(e._componentsProvider={_offline:o.localCache._offlineComponentProvider,_online:o.localCache._onlineComponentProvider}),e._firestoreClient=new lE(e._authCredentials,e._appCheckCredentials,e._queue,l,e._componentsProvider&&(s=e._componentsProvider,a=s?._online.build(),{_offline:s?._offline.build(a),_online:a}))}(e),e._firestoreClient}function lX(e,t){let n=lY(e=ex(e,lJ)),r=new lW;return function(e,t,n,r){var i;let s=(i=aQ(t),new lb(function(e,t){if(e instanceof Uint8Array)return lw(e,void 0);if(e instanceof ArrayBuffer)return lw(new Uint8Array(e),void 0);if(e instanceof ReadableStream)return e.getReader();throw Error("Source of `toByteStreamReader` has to be a ArrayBuffer or ReadableStream")}("string"==typeof n?ir().encode(n):n),i));e.asyncQueue.enqueueAndForget(async()=>{var t;(async function(e,t,n){try{var r,i;let s,a=await t.getMetadata();if(await (r=e.localStore,s=i_(a.createTime),r.persistence.runTransaction("hasNewerBundle","readonly",e=>r.Pi.getBundleMetadata(e,a.id)).then(e=>!!e&&e.createTime.compareTo(s)>=0)))return await t.close(),n._completeWith({taskState:"Success",documentsLoaded:a.totalDocuments,bytesLoaded:a.totalBytes,totalDocuments:a.totalDocuments,totalBytes:a.totalBytes}),Promise.resolve(new Set);n._updateProgress(oV(a));let o=new oF(a,t.serializer),l=await t.Su();for(;l;){let e=await o.Ga(l);e&&n._updateProgress(e),l=await t.Su()}let u=await o.ja(e.localStore);return await o9(e,u.Ja,void 0),await (i=e.localStore,i.persistence.runTransaction("Save bundle","readwrite",e=>i.Pi.saveBundleMetadata(e,a))),n._completeWith(u.progress),Promise.resolve(u.Ha)}catch(e){return z(oq,`Loading bundle failed with ${e}`),n._failWith(e),Promise.resolve(new Set)}})(t=await lk(e),s,r).then(e=>{t.sharedClientState.notifyBundleLoaded(e)})})}(n,e._databaseId,t,r),r}class lZ{constructor(e){this._byteString=e}static fromBase64String(e){try{return new lZ(ne.fromBase64String(e))}catch(e){throw new W(H.INVALID_ARGUMENT,"Failed to construct data from Base64 string: "+e)}}static fromUint8Array(e){return new lZ(ne.fromUint8Array(e))}toBase64(){return this._byteString.toBase64()}toUint8Array(){return this._byteString.toUint8Array()}toString(){return"Bytes(base64: "+this.toBase64()+")"}isEqual(e){return this._byteString.isEqual(e._byteString)}toJSON(){return{type:lZ._jsonSchemaVersion,bytes:this.toBase64()}}static fromJSON(e){if(eS(e,lZ._jsonSchema))return lZ.fromBase64String(e.bytes)}}lZ._jsonSchemaVersion="firestore/bytes/1.0",lZ._jsonSchema={type:eI("string",lZ._jsonSchemaVersion),bytes:eI("string")};class l0{constructor(...e){for(let t=0;t<e.length;++t)if(0===e[t].length)throw new W(H.INVALID_ARGUMENT,"Invalid field name at argument $(i + 1). Field names must not be empty.");this._internalPath=new em(e)}isEqual(e){return this._internalPath.isEqual(e._internalPath)}}class l1{constructor(e){this._methodName=e}}class l2{constructor(e,t){if(!isFinite(e)||e<-90||e>90)throw new W(H.INVALID_ARGUMENT,"Latitude must be a number between -90 and 90, but was: "+e);if(!isFinite(t)||t<-180||t>180)throw new W(H.INVALID_ARGUMENT,"Longitude must be a number between -180 and 180, but was: "+t);this._lat=e,this._long=t}get latitude(){return this._lat}get longitude(){return this._long}isEqual(e){return this._lat===e._lat&&this._long===e._long}_compareTo(e){return ea(this._lat,e._lat)||ea(this._long,e._long)}toJSON(){return{latitude:this._lat,longitude:this._long,type:l2._jsonSchemaVersion}}static fromJSON(e){if(eS(e,l2._jsonSchema))return new l2(e.latitude,e.longitude)}}l2._jsonSchemaVersion="firestore/geoPoint/1.0",l2._jsonSchema={type:eI("string",l2._jsonSchemaVersion),latitude:eI("number"),longitude:eI("number")};class l5{constructor(e){this._values=(e||[]).map(e=>e)}toArray(){return this._values.map(e=>e)}isEqual(e){return function(e,t){if(e.length!==t.length)return!1;for(let n=0;n<e.length;++n)if(e[n]!==t[n])return!1;return!0}(this._values,e._values)}toJSON(){return{type:l5._jsonSchemaVersion,vectorValues:this._values}}static fromJSON(e){if(eS(e,l5._jsonSchema)){if(Array.isArray(e.vectorValues)&&e.vectorValues.every(e=>"number"==typeof e))return new l5(e.vectorValues);throw new W(H.INVALID_ARGUMENT,"Expected 'vectorValues' field to be a number array")}}}l5._jsonSchemaVersion="firestore/vectorValue/1.0",l5._jsonSchema={type:eI("string",l5._jsonSchemaVersion),vectorValues:eI("object")};let l4=/^__.*__$/;class l3{constructor(e,t,n){this.data=e,this.fieldMask=t,this.fieldTransforms=n}toMutation(e,t){return null!==this.fieldMask?new rX(e,this.data,this.fieldMask,t,this.fieldTransforms):new rY(e,this.data,t,this.fieldTransforms)}}class l6{constructor(e,t,n){this.data=e,this.fieldMask=t,this.fieldTransforms=n}toMutation(e,t){return new rX(e,this.data,this.fieldMask,t,this.fieldTransforms)}}function l8(e){switch(e){case 0:case 2:case 1:return!0;case 3:case 4:return!1;default:throw G(40011,{dataSource:e})}}class l7{constructor(e,t,n,r,i,s){this.settings=e,this.databaseId=t,this.serializer=n,this.ignoreUndefinedProperties=r,void 0===i&&this.validatePath(),this.fieldTransforms=i||[],this.fieldMask=s||[]}get path(){return this.settings.path}get dataSource(){return this.settings.dataSource}contextWith(e){return new l7({...this.settings,...e},this.databaseId,this.serializer,this.ignoreUndefinedProperties,this.fieldTransforms,this.fieldMask)}childContextForField(e){let t=this.path?.child(e),n=this.contextWith({path:t,arrayElement:!1});return n.validatePathSegment(e),n}childContextForFieldPath(e){let t=this.path?.child(e),n=this.contextWith({path:t,arrayElement:!1});return n.validatePath(),n}childContextForArray(e){return this.contextWith({path:void 0,arrayElement:!0})}createError(e){return um(e,this.settings.methodName,this.settings.hasConverter||!1,this.path,this.settings.targetDoc)}contains(e){return void 0!==this.fieldMask.find(t=>e.isPrefixOf(t))||void 0!==this.fieldTransforms.find(t=>e.isPrefixOf(t.field))}validatePath(){if(this.path)for(let e=0;e<this.path.length;e++)this.validatePathSegment(this.path.get(e))}validatePathSegment(e){if(0===e.length)throw this.createError("Document fields must not be empty");if(l8(this.dataSource)&&l4.test(e))throw this.createError('Document fields cannot begin and end with "__"')}}class l9{constructor(e,t,n){this.databaseId=e,this.ignoreUndefinedProperties=t,this.serializer=n||aQ(e)}createContext(e,t,n,r=!1){return new l7({dataSource:e,methodName:t,targetDoc:n,path:em.emptyPath(),arrayElement:!1,hasConverter:r},this.databaseId,this.serializer,this.ignoreUndefinedProperties)}}function ue(e){let t=e._freezeSettings(),n=aQ(e._databaseId);return new l9(e._databaseId,!!t.ignoreUndefinedProperties,n)}function ut(e,t,n,r,i,s={}){let a,o,l=e.createContext(s.merge||s.mergeFields?2:0,t,n,i);uh("Data must be an object, but it was:",l,r);let u=ul(r,l);if(s.merge)a=new t7(l.fieldMask),o=l.fieldTransforms;else if(s.mergeFields){let e=[];for(let r of s.mergeFields){let i=uc(t,r,n);if(!l.contains(i))throw new W(H.INVALID_ARGUMENT,`Field '${i}' is specified in your field mask but missing from your input data.`);ug(e,i)||e.push(i)}a=new t7(e),o=l.fieldTransforms.filter(e=>a.covers(e.field))}else a=null,o=l.fieldTransforms;return new l3(new nU(u),a,o)}class un extends l1{_toFieldTransform(e){if(2!==e.dataSource)throw 1===e.dataSource?e.createError(`${this._methodName}() can only appear at the top level of your update data`):e.createError(`${this._methodName}() cannot be used with set() unless you pass {merge:true}`);return e.fieldMask.push(e.path),null}isEqual(e){return e instanceof un}}class ur extends l1{_toFieldTransform(e){return new rz(e.path,new rM)}isEqual(e){return e instanceof ur}}function ui(e,t,n,r){let i=e.createContext(1,t,n);uh("Data must be an object, but it was:",i,r);let s=[],a=nU.empty();return t0(r,(e,r)=>{let o=uf(t,e,n);r=(0,k.getModularInstance)(r);let l=i.childContextForFieldPath(o);if(r instanceof un)s.push(o);else{let e=uo(r,l);null!=e&&(s.push(o),a.set(o,e))}}),new l6(a,new t7(s),i.fieldTransforms)}function us(e,t,n,r,i,s){let a=e.createContext(1,t,n),o=[uc(t,r,n)],l=[i];if(s.length%2!=0)throw new W(H.INVALID_ARGUMENT,`Function ${t}() needs to be called with an even number of arguments that alternate between field names and values.`);for(let e=0;e<s.length;e+=2)o.push(uc(t,s[e])),l.push(s[e+1]);let u=[],h=nU.empty();for(let e=o.length-1;e>=0;--e)if(!ug(u,o[e])){let t=o[e],n=l[e];n=(0,k.getModularInstance)(n);let r=a.childContextForFieldPath(t);if(n instanceof un)u.push(t);else{let e=uo(n,r);null!=e&&(u.push(t),h.set(t,e))}}return new l6(h,new t7(u),a.fieldTransforms)}function ua(e,t,n,r=!1){return uo(n,e.createContext(r?4:3,t))}function uo(e,t){if(uu(e=(0,k.getModularInstance)(e)))return uh("Unsupported field value:",t,e),ul(e,t);if(e instanceof l1)return function(e,t){if(!l8(t.dataSource))throw t.createError(`${e._methodName}() can only be used with update() and set()`);if(!t.path)throw t.createError(`${e._methodName}() is not currently supported inside arrays`);let n=e._toFieldTransform(t);n&&t.fieldTransforms.push(n)}(e,t),null;if(void 0===e&&t.ignoreUndefinedProperties)return null;if(t.path&&t.fieldMask.push(t.path),e instanceof Array){if(t.settings.arrayElement&&4!==t.dataSource)throw t.createError("Nested arrays are not supported");let n=[],r=0;for(let i of e){let e=uo(i,t.childContextForArray(r));null==e&&(e={nullValue:"NULL_VALUE"}),n.push(e),r++}return{arrayValue:{values:n}}}return function(e,t){var n,r,i;if(null===(e=(0,k.getModularInstance)(e)))return{nullValue:"NULL_VALUE"};if("number"==typeof e)return n=t.serializer,e4(r=e)?rR(r):rk(n,r);if("boolean"==typeof e)return{booleanValue:e};if("string"==typeof e)return{stringValue:e};if(e instanceof Date){let n=eE.fromDate(e);return{timestampValue:iS(t.serializer,n)}}if(e instanceof eE){let n=new eE(e.seconds,1e3*Math.floor(e.nanoseconds/1e3));return{timestampValue:iS(t.serializer,n)}}if(e instanceof l2)return{geoPointValue:{latitude:e.latitude,longitude:e.longitude}};if(e instanceof lZ)return{bytesValue:iE(t.serializer,e._byteString)};if(e instanceof lB){let n=t.databaseId,r=e.firestore._databaseId;if(!r.isEqual(n))throw t.createError(`Document reference is for database ${r.projectId}/${r.database} but should be for database ${n.projectId}/${n.database}`);return{referenceValue:iC(e.firestore._databaseId||t.databaseId,e._key.path)}}if(e instanceof l5)return{mapValue:{fields:{[ng]:{stringValue:nw},[nv]:{arrayValue:{values:((i=e)instanceof l5?i.toArray():i).map(e=>{if("number"!=typeof e)throw t.createError("VectorValues must only contain numeric values.");return rk(t.serializer,e)})}}}}};if(iK(e))return e._toProto(t.serializer);throw t.createError(`Unsupported field value: ${eb(e)}`)}(e,t)}function ul(e,t){let n={};return t1(e)?t.path&&t.path.length>0&&t.fieldMask.push(t.path):t0(e,(e,r)=>{let i=uo(r,t.childContextForField(e));null!=i&&(n[e]=i)}),{mapValue:{fields:n}}}function uu(e){return!("object"!=typeof e||null===e||e instanceof Array||e instanceof Date||e instanceof eE||e instanceof l2||e instanceof lZ||e instanceof lB||e instanceof l1||e instanceof l5||iK(e))}function uh(e,t,n){if(!uu(n)||!ev(n)){let r=eb(n);throw"an object"===r?t.createError(e+" a custom object"):t.createError(e+" "+r)}}function uc(e,t,n){if((t=(0,k.getModularInstance)(t))instanceof l0)return t._internalPath;if("string"==typeof t)return uf(e,t);throw um("Field path arguments must be of type string or ",e,!1,void 0,n)}let ud=RegExp("[~\\*/\\[\\]]");function uf(e,t,n){if(t.search(ud)>=0)throw um(`Invalid field path (${t}). Paths must not contain '~', '*', '/', '[', or ']'`,e,!1,void 0,n);try{return new l0(...t.split("."))._internalPath}catch(r){throw um(`Invalid field path (${t}). Paths must not be empty, begin with '.', end with '.', or contain '..'`,e,!1,void 0,n)}}function um(e,t,n,r,i){let s=r&&!r.isEmpty(),a=void 0!==i,o=`Function ${t}() called with invalid data`;n&&(o+=" (via `toFirestore()`)"),o+=". ";let l="";return(s||a)&&(l+=" (found",s&&(l+=` in field ${r}`),a&&(l+=` in document ${i}`),l+=")"),new W(H.INVALID_ARGUMENT,o+e+l)}function ug(e,t){return e.some(e=>e.isEqual(t))}class up{convertValue(e,t="none"){switch(nx(e)){case 0:return null;case 1:return e.booleanValue;case 2:return nr(e.integerValue||e.doubleValue);case 3:return this.convertTimestamp(e.timestampValue);case 4:return this.convertServerTimestamp(e,t);case 5:return e.stringValue;case 6:return this.convertBytes(ni(e.bytesValue));case 7:return this.convertReference(e.referenceValue);case 8:return this.convertGeoPoint(e.geoPointValue);case 9:return this.convertArray(e.arrayValue,t);case 11:return this.convertObject(e.mapValue,t);case 10:return this.convertVectorValue(e.mapValue);default:throw G(62114,{value:e})}}convertObject(e,t){return this.convertObjectMap(e.fields,t)}convertObjectMap(e,t="none"){let n={};return t0(e,(e,r)=>{n[e]=this.convertValue(r,t)}),n}convertVectorValue(e){return new l5(e.fields?.[nv].arrayValue?.values?.map(e=>nr(e.doubleValue)))}convertGeoPoint(e){return new l2(nr(e.latitude),nr(e.longitude))}convertArray(e,t){return(e.values||[]).map(e=>this.convertValue(e,t))}convertServerTimestamp(e,t){switch(t){case"previous":let n=nh(e);return null==n?null:this.convertValue(n,t);case"estimate":return this.convertTimestamp(nc(e));default:return null}}convertTimestamp(e){let t=nn(e);return new eE(t.seconds,t.nanos)}convertDocumentKey(e,t){let n=ed.fromString(e);Q(iG(n),9688,{name:e});let r=new nm(n.get(1),n.get(3)),i=new eg(n.popFirst(5));return r.isEqual(t)||B(`Document ${i} contains a document reference within a different database (${r.projectId}/${r.database}) which is not supported. It will be treated as a reference in the current database (${t.projectId}/${t.database}) instead.`),i}}class uy extends up{constructor(e){super(),this.firestore=e}convertBytes(e){return new lZ(e)}convertReference(e){let t=this.convertDocumentKey(e,this.firestore._databaseId);return new lB(this.firestore,null,t)}}function uw(){return new ur("serverTimestamp")}let uv="@firebase/firestore",ub="4.10.0";function ux(e){if("object"!=typeof e||null===e)return!1;for(let t of["next","error","complete"])if(t in e&&"function"==typeof e[t])return!0;return!1}class uT{constructor(e="count",t){this._internalFieldPath=t,this.type="AggregateField",this.aggregateType=e}}class uI{constructor(e,t,n){this._userDataWriter=t,this._data=n,this.type="AggregateQuerySnapshot",this.query=e}data(){return this._userDataWriter.convertObjectMap(this._data)}_fieldsProto(){return new nU({mapValue:{fields:this._data}}).clone().value.mapValue.fields}}class uS{constructor(e,t,n,r,i){this._firestore=e,this._userDataWriter=t,this._key=n,this._document=r,this._converter=i}get id(){return this._key.path.lastSegment()}get ref(){return new lB(this._firestore,this._converter,this._key)}exists(){return null!==this._document}data(){if(this._document){if(this._converter){let e=new uE(this._firestore,this._userDataWriter,this._key,this._document,null);return this._converter.fromFirestore(e)}return this._userDataWriter.convertValue(this._document.data.value)}}_fieldsProto(){return this._document?.data.clone().value.mapValue.fields??void 0}get(e){if(this._document){let t=this._document.data.field(uc("DocumentSnapshot.get",e));if(null!==t)return this._userDataWriter.convertValue(t)}}}class uE extends uS{data(){return super.data()}}function u_(e){if("L"===e.limitType&&0===e.explicitOrderBy.length)throw new W(H.UNIMPLEMENTED,"limitToLast() queries require specifying at least one orderBy() clause")}class uC{}class uA extends uC{}function uN(e,t,...n){let r=[];for(let i of(t instanceof uC&&r.push(t),function(e){let t=e.filter(e=>e instanceof uR).length,n=e.filter(e=>e instanceof uD).length;if(t>1||t>0&&n>0)throw new W(H.INVALID_ARGUMENT,"InvalidQuery. When using composite filters, you cannot use more than one filter at the top level. Consider nesting the multiple filters within an `and(...)` statement. For example: change `query(query, where(...), or(...))` to `query(query, and(where(...), or(...)))`.")}(r=r.concat(n)),r))e=i._apply(e);return e}class uD extends uA{constructor(e,t,n){super(),this._field=e,this._op=t,this._value=n,this.type="where"}static _create(e,t,n){return new uD(e,t,n)}_apply(e){let t=this._parse(e);return uW(e._query,t),new lq(e.firestore,e.converter,rf(e._query,t))}_parse(e){let t=ue(e.firestore);return function(e,t,n,r,i,s,a){let o;if(i.isKeyField()){if("array-contains"===s||"array-contains-any"===s)throw new W(H.INVALID_ARGUMENT,`Invalid Query. You can't perform '${s}' queries on documentId().`);if("in"===s||"not-in"===s){uH(a,s);let t=[];for(let n of a)t.push(uQ(r,e,n));o={arrayValue:{values:t}}}else o=uQ(r,e,a)}else"in"!==s&&"not-in"!==s&&"array-contains-any"!==s||uH(a,s),o=ua(n,t,a,"in"===s||"not-in"===s);return nQ.create(i,s,o)}(e._query,"where",t,e.firestore._databaseId,this._field,this._op,this._value)}}function uk(e,t,n){let r=uc("where",e);return uD._create(r,t,n)}class uR extends uC{constructor(e,t){super(),this.type=e,this._queryConstraints=t}static _create(e,t){return new uR(e,t)}_parse(e){let t=this._queryConstraints.map(t=>t._parse(e)).filter(e=>e.getFilters().length>0);return 1===t.length?t[0]:nH.create(t,this._getOperator())}_apply(e){let t=this._parse(e);return 0===t.getFilters().length?e:(function(e,t){let n=e;for(let e of t.getFlattenedFilters())uW(n,e),n=rf(n,e)}(e._query,t),new lq(e.firestore,e.converter,rf(e._query,t)))}_getQueryConstraints(){return this._queryConstraints}_getOperator(){return"and"===this.type?"and":"or"}}function uP(...e){return e.forEach(e=>uJ("or",e)),uR._create("or",e)}function uO(...e){return e.forEach(e=>uJ("and",e)),uR._create("and",e)}class uM extends uA{constructor(e,t){super(),this._field=e,this._direction=t,this.type="orderBy"}static _create(e,t){return new uM(e,t)}_apply(e){var t;let n,r=function(e,t,n){if(null!==e.startAt)throw new W(H.INVALID_ARGUMENT,"Invalid query. You must not call startAt() or startAfter() before calling orderBy().");if(null!==e.endAt)throw new W(H.INVALID_ARGUMENT,"Invalid query. You must not call endAt() or endBefore() before calling orderBy().");return new nG(t,n)}(e._query,this._field,this._direction);return new lq(e.firestore,e.converter,(t=e._query,n=t.explicitOrderBy.concat([r]),new ra(t.path,t.collectionGroup,n,t.filters.slice(),t.limit,t.limitType,t.startAt,t.endAt)))}}function uF(e,t="asc"){let n=uc("orderBy",e);return uM._create(n,t)}class uV extends uA{constructor(e,t,n){super(),this.type=e,this._limit=t,this._limitType=n}static _create(e,t,n){return new uV(e,t,n)}_apply(e){return new lq(e.firestore,e.converter,rm(e._query,this._limit,this._limitType))}}function uL(e){return eT("limit",e),uV._create("limit",e,"F")}function uj(e){return eT("limitToLast",e),uV._create("limitToLast",e,"L")}class uU extends uA{constructor(e,t,n){super(),this.type=e,this._docOrFields=t,this._inclusive=n}static _create(e,t,n){return new uU(e,t,n)}_apply(e){var t;let n=uK(e,this.type,this._docOrFields,this._inclusive);return new lq(e.firestore,e.converter,(t=e._query,new ra(t.path,t.collectionGroup,t.explicitOrderBy.slice(),t.filters.slice(),t.limit,t.limitType,n,t.endAt)))}}function uq(...e){return uU._create("startAt",e,!0)}function uB(...e){return uU._create("startAfter",e,!1)}class uz extends uA{constructor(e,t,n){super(),this.type=e,this._docOrFields=t,this._inclusive=n}static _create(e,t,n){return new uz(e,t,n)}_apply(e){var t;let n=uK(e,this.type,this._docOrFields,this._inclusive);return new lq(e.firestore,e.converter,(t=e._query,new ra(t.path,t.collectionGroup,t.explicitOrderBy.slice(),t.filters.slice(),t.limit,t.limitType,t.startAt,n)))}}function u$(...e){return uz._create("endBefore",e,!1)}function uG(...e){return uz._create("endAt",e,!0)}function uK(e,t,n,r){if(n[0]=(0,k.getModularInstance)(n[0]),n[0]instanceof uS)return function(e,t,n,r,i){if(!r)throw new W(H.NOT_FOUND,`Can't use a DocumentSnapshot that doesn't exist for ${n}().`);let s=[];for(let n of rh(e))if(n.field.isKeyField())s.push(nA(t,r.key));else{let e=r.data.field(n.field);if(nu(e))throw new W(H.INVALID_ARGUMENT,'Invalid query. You are trying to start or end a query using a document for which the field "'+n.field+'" is an uncommitted server timestamp. (Since the value of this field is unknown, you cannot start/end a query with it.)');if(null===e){let e=n.field.canonicalString();throw new W(H.INVALID_ARGUMENT,`Invalid query. You are trying to start or end a query using a document for which the field '${e}' (used as the orderBy) does not exist.`)}s.push(e)}return new nB(s,i)}(e._query,e.firestore._databaseId,t,n[0]._document,r);{let i=ue(e.firestore);return function(e,t,n,r,i,s){let a=e.explicitOrderBy;if(i.length>a.length)throw new W(H.INVALID_ARGUMENT,`Too many arguments provided to ${r}(). The number of arguments must be less than or equal to the number of orderBy() clauses`);let o=[];for(let s=0;s<i.length;s++){let l=i[s];if(a[s].field.isKeyField()){if("string"!=typeof l)throw new W(H.INVALID_ARGUMENT,`Invalid query. Expected a string for document ID in ${r}(), but got a ${typeof l}`);if(!ru(e)&&-1!==l.indexOf("/"))throw new W(H.INVALID_ARGUMENT,`Invalid query. When querying a collection and ordering by documentId(), the value passed to ${r}() must be a plain document ID, but '${l}' contains a slash.`);let n=e.path.child(ed.fromString(l));if(!eg.isDocumentKey(n))throw new W(H.INVALID_ARGUMENT,`Invalid query. When querying a collection group and ordering by documentId(), the value passed to ${r}() must result in a valid document path, but '${n}' is not because it contains an odd number of segments.`);let i=new eg(n);o.push(nA(t,i))}else{let e=ua(n,r,l);o.push(e)}}return new nB(o,s)}(e._query,e.firestore._databaseId,i,t,n,r)}}function uQ(e,t,n){if("string"==typeof(n=(0,k.getModularInstance)(n))){if(""===n)throw new W(H.INVALID_ARGUMENT,"Invalid query. When querying with documentId(), you must provide a valid document ID, but it was an empty string.");if(!ru(t)&&-1!==n.indexOf("/"))throw new W(H.INVALID_ARGUMENT,`Invalid query. When querying a collection by documentId(), you must provide a plain document ID, but '${n}' contains a '/' character.`);let r=t.path.child(ed.fromString(n));if(!eg.isDocumentKey(r))throw new W(H.INVALID_ARGUMENT,`Invalid query. When querying a collection group by documentId(), the value provided must result in a valid document path, but '${r}' is not because it has an odd number of segments (${r.length}).`);return nA(e,new eg(r))}if(n instanceof lB)return nA(e,n._key);throw new W(H.INVALID_ARGUMENT,`Invalid query. When querying with documentId(), you must provide a valid string or a DocumentReference, but it was: ${eb(n)}.`)}function uH(e,t){if(!Array.isArray(e)||0===e.length)throw new W(H.INVALID_ARGUMENT,`Invalid Query. A non-empty array is required for '${t.toString()}' filters.`)}function uW(e,t){let n=function(e,t){for(let n of e)for(let e of n.getFlattenedFilters())if(t.indexOf(e.op)>=0)return e.op;return null}(e.filters,function(e){switch(e){case"!=":return["!=","not-in"];case"array-contains-any":case"in":return["not-in"];case"not-in":return["array-contains-any","in","not-in","!="];default:return[]}}(t.op));if(null!==n)throw n===t.op?new W(H.INVALID_ARGUMENT,`Invalid query. You cannot use more than one '${t.op.toString()}' filter.`):new W(H.INVALID_ARGUMENT,`Invalid query. You cannot use '${t.op.toString()}' filters with '${n.toString()}' filters.`)}function uJ(e,t){if(!(t instanceof uD||t instanceof uR))throw new W(H.INVALID_ARGUMENT,`Function ${e}() requires AppliableConstraints created with a call to 'where(...)', 'or(...)', or 'and(...)'.`)}function uY(e,t,n){return e?n&&(n.merge||n.mergeFields)?e.toFirestore(t,n):e.toFirestore(t):t}class uX extends up{constructor(e){super(),this.firestore=e}convertBytes(e){return new lZ(e)}convertReference(e){let t=this.convertDocumentKey(e,this.firestore._databaseId);return new lB(this.firestore,null,t)}}function uZ(e){return new uT("sum",uc("sum",e))}function u0(e){return new uT("avg",uc("average",e))}function u1(){return new uT("count")}function u2(e,t){return e instanceof uT&&t instanceof uT&&e.aggregateType===t.aggregateType&&e._internalFieldPath?.canonicalString()===t._internalFieldPath?.canonicalString()}function u5(e,t){return lG(e.query,t.query)&&(0,k.deepEqual)(e.data(),t.data())}function u4(e){return u3(e,{count:u1()})}function u3(e,t){var n;let r,i=ex(e.firestore,lJ),s=lY(i),a=function(e,t){let n=[];for(let r in e)Object.prototype.hasOwnProperty.call(e,r)&&n.push(t(e[r],r,e));return n}(t,(e,t)=>new r8(t,e.aggregateType,e._internalFieldPath));return(n=e._query,r=new J,s.asyncQueue.enqueueAndForget(async()=>{try{let e=await lR(s);r.resolve(async function(e,t,n){let{request:r,gt:i,parent:s}=function(e,t,n,r){let{ft:i,parent:s}=iq(e,t),a={},o=[],l=0;return n.forEach(e=>{let t="aggregate_"+l++;a[t]=e.alias,"count"===e.aggregateType?o.push({alias:t,count:{}}):"avg"===e.aggregateType?o.push({alias:t,avg:{field:iz(e.fieldPath)}}):"sum"===e.aggregateType&&o.push({alias:t,sum:{field:iz(e.fieldPath)}})}),{request:{structuredAggregationQuery:{aggregations:o,structuredQuery:i.structuredQuery},parent:i.parent},gt:a,parent:s}}(e.serializer,(t.Re||(t.Re=rd(t,t.explicitOrderBy)),t.Re),n);e.connection.Ko||delete r.parent;let a=(await e.jo("RunAggregationQuery",e.serializer.databaseId,s,r,1)).filter(e=>!!e.result);Q(1===a.length,64727);let o=a[0].result?.aggregateFields;return Object.keys(o).reduce((e,t)=>(e[i[t]]=o[t],e),{})}(e,n,a))}catch(e){r.reject(e)}}),r.promise).then(t=>new uI(e,new uy(i),t))}class u6{constructor(e){this.kind="memory",this._onlineComponentProvider=ly.provider,this._offlineComponentProvider=e?.garbageCollector?e.garbageCollector._offlineComponentProvider:{build:()=>new lm(void 0)}}toJSON(){return{kind:this.kind}}}class u8{constructor(e){let t;this.kind="persistent",e?.tabManager?(e.tabManager._initialize(e),t=e.tabManager):(t=ha(void 0))._initialize(e),this._onlineComponentProvider=t._onlineComponentProvider,this._offlineComponentProvider=t._offlineComponentProvider}toJSON(){return{kind:this.kind}}}class u7{constructor(){this.kind="memoryEager",this._offlineComponentProvider=lf.provider}toJSON(){return{kind:this.kind}}}class u9{constructor(e){this.kind="memoryLru",this._offlineComponentProvider={build:()=>new lm(e)}}toJSON(){return{kind:this.kind}}}function he(){return new u7}function ht(e){return new u9(e?.cacheSizeBytes)}function hn(e){return new u6(e)}function hr(e){return new u8(e)}class hi{constructor(e){this.forceOwnership=e,this.kind="persistentSingleTab"}toJSON(){return{kind:this.kind}}_initialize(e){this._onlineComponentProvider=ly.provider,this._offlineComponentProvider={build:t=>new lg(t,e?.cacheSizeBytes,this.forceOwnership)}}}class hs{constructor(){this.kind="PersistentMultipleTab"}toJSON(){return{kind:this.kind}}_initialize(e){this._onlineComponentProvider=ly.provider,this._offlineComponentProvider={build:t=>new lp(t,e?.cacheSizeBytes)}}}function ha(e){return new hi(e?.forceOwnership)}function ho(){return new hs}let hl="NOT SUPPORTED";class hu{constructor(e,t){this.hasPendingWrites=e,this.fromCache=t}isEqual(e){return this.hasPendingWrites===e.hasPendingWrites&&this.fromCache===e.fromCache}}class hh extends uS{constructor(e,t,n,r,i,s){super(e,t,n,r,s),this._firestore=e,this._firestoreImpl=e,this.metadata=i}exists(){return super.exists()}data(e={}){if(this._document){if(this._converter){let t=new hd(this._firestore,this._userDataWriter,this._key,this._document,this.metadata,null);return this._converter.fromFirestore(t,e)}return this._userDataWriter.convertValue(this._document.data.value,e.serverTimestamps)}}get(e,t={}){if(this._document){let n=this._document.data.field(uc("DocumentSnapshot.get",e));if(null!==n)return this._userDataWriter.convertValue(n,t.serverTimestamps)}}toJSON(){if(this.metadata.hasPendingWrites)throw new W(H.FAILED_PRECONDITION,"DocumentSnapshot.toJSON() attempted to serialize a document with pending writes. Await waitForPendingWrites() before invoking toJSON().");let e=this._document,t={};return t.type=hh._jsonSchemaVersion,t.bundle="",t.bundleSource="DocumentSnapshot",t.bundleName=this._key.toString(),e&&e.isValidDocument()&&e.isFoundDocument()&&(this._userDataWriter.convertObjectMap(e.data.value.mapValue.fields,"previous"),this._firestore,this.ref.path,t.bundle="NOT SUPPORTED"),t}}function hc(e,t,n){if(eS(t,hh._jsonSchema)){var r;if(t.bundle===hl)throw new W(H.INVALID_ARGUMENT,"The provided JSON object was created in a client environment, which is not supported.");let i=aQ(e._databaseId),s=(r=t.bundle,new lx(r,i)),a=s.t(),o=new oF(s.getMetadata(),i);for(let e of a)o.o(e);let l=o.documents;if(1!==l.length)throw new W(H.INVALID_ARGUMENT,`Expected bundle data to contain 1 document, but it contains ${l.length} documents.`);let u=iV(i,l[0].document),h=new eg(ed.fromString(t.bundleName));return new hh(e,new uX(e),h,u,new hu(!1,!1),n||null)}}hh._jsonSchemaVersion="firestore/documentSnapshot/1.0",hh._jsonSchema={type:eI("string",hh._jsonSchemaVersion),bundleSource:eI("string","DocumentSnapshot"),bundleName:eI("string"),bundle:eI("string")};class hd extends hh{data(e={}){return super.data(e)}}class hf{constructor(e,t,n,r){this._firestore=e,this._userDataWriter=t,this._snapshot=r,this.metadata=new hu(r.hasPendingWrites,r.fromCache),this.query=n}get docs(){let e=[];return this.forEach(t=>e.push(t)),e}get size(){return this._snapshot.docs.size}get empty(){return 0===this.size}forEach(e,t){this._snapshot.docs.forEach(n=>{e.call(t,new hd(this._firestore,this._userDataWriter,n.key,n,new hu(this._snapshot.mutatedKeys.has(n.key),this._snapshot.fromCache),this.query.converter))})}docChanges(e={}){let t=!!e.includeMetadataChanges;if(t&&this._snapshot.excludesMetadataChanges)throw new W(H.INVALID_ARGUMENT,"To include metadata changes with your document changes, you must also pass { includeMetadataChanges:true } to onSnapshot().");return this._cachedChanges&&this._cachedChangesIncludeMetadataChanges===t||(this._cachedChanges=function(e,t){if(e._snapshot.oldDocs.isEmpty()){let t=0;return e._snapshot.docChanges.map(n=>{let r=new hd(e._firestore,e._userDataWriter,n.doc.key,n.doc,new hu(e._snapshot.mutatedKeys.has(n.doc.key),e._snapshot.fromCache),e.query.converter);return n.doc,{type:"added",doc:r,oldIndex:-1,newIndex:t++}})}{let n=e._snapshot.oldDocs;return e._snapshot.docChanges.filter(e=>t||3!==e.type).map(t=>{let r=new hd(e._firestore,e._userDataWriter,t.doc.key,t.doc,new hu(e._snapshot.mutatedKeys.has(t.doc.key),e._snapshot.fromCache),e.query.converter),i=-1,s=-1;return 0!==t.type&&(i=n.indexOf(t.doc.key),n=n.delete(t.doc.key)),1!==t.type&&(s=(n=n.add(t.doc)).indexOf(t.doc.key)),{type:function(e){switch(e){case 0:return"added";case 2:case 3:return"modified";case 1:return"removed";default:return G(61501,{type:e})}}(t.type),doc:r,oldIndex:i,newIndex:s}})}}(this,t),this._cachedChangesIncludeMetadataChanges=t),this._cachedChanges}toJSON(){if(this.metadata.hasPendingWrites)throw new W(H.FAILED_PRECONDITION,"QuerySnapshot.toJSON() attempted to serialize a document with pending writes. Await waitForPendingWrites() before invoking toJSON().");let e={};e.type=hf._jsonSchemaVersion,e.bundleSource="QuerySnapshot",e.bundleName=es.newId(),this._firestore._databaseId.database,this._firestore._databaseId.projectId;let t=[],n=[],r=[];return this.docs.forEach(e=>{null!==e._document&&(t.push(e._document),n.push(this._userDataWriter.convertObjectMap(e._document.data.value.mapValue.fields,"previous")),r.push(e.ref.path))}),this._firestore,this.query._query,e.bundleName,e.bundle="NOT SUPPORTED",e}}function hm(e,t,n){if(eS(t,hf._jsonSchema)){var r;if(t.bundle===hl)throw new W(H.INVALID_ARGUMENT,"The provided JSON object was created in a client environment, which is not supported.");let i=aQ(e._databaseId),s=(r=t.bundle,new lx(r,i)),a=s.t(),o=new oF(s.getMetadata(),i);for(let e of a)o.o(e);if(1!==o.queries.length)throw new W(H.INVALID_ARGUMENT,`Snapshot data expected 1 query but found ${o.queries.length} queries.`);let l=i2(o.queries[0].bundledQuery),u=o.documents,h=new oT;u.map(e=>{let t=iV(i,e.document);h=h.add(t)});let c=oS.fromInitialDocuments(l,h,rN(),!1,!1),d=new lq(e,n||null,l);return new hf(e,new uX(e),d,c)}}function hg(e,t){return e instanceof hh&&t instanceof hh?e._firestore===t._firestore&&e._key.isEqual(t._key)&&(null===e._document?null===t._document:e._document.isEqual(t._document))&&e._converter===t._converter:e instanceof hf&&t instanceof hf&&e._firestore===t._firestore&&lG(e.query,t.query)&&e.metadata.isEqual(t.metadata)&&e._snapshot.isEqual(t._snapshot)}hf._jsonSchemaVersion="firestore/querySnapshot/1.0",hf._jsonSchema={type:eI("string",hf._jsonSchemaVersion),bundleSource:eI("string","QuerySnapshot"),bundleName:eI("string"),bundle:eI("string")};let hp={maxAttempts:5};class hy{constructor(e,t){this._firestore=e,this._commitHandler=t,this._mutations=[],this._committed=!1,this._dataReader=ue(e)}set(e,t,n){this._verifyNotCommitted();let r=hw(e,this._firestore),i=uY(r.converter,t,n),s=ut(this._dataReader,"WriteBatch.set",r._key,i,null!==r.converter,n);return this._mutations.push(s.toMutation(r._key,rG.none())),this}update(e,t,n,...r){let i;this._verifyNotCommitted();let s=hw(e,this._firestore);return i="string"==typeof(t=(0,k.getModularInstance)(t))||t instanceof l0?us(this._dataReader,"WriteBatch.update",s._key,t,n,r):ui(this._dataReader,"WriteBatch.update",s._key,t),this._mutations.push(i.toMutation(s._key,rG.exists(!0))),this}delete(e){this._verifyNotCommitted();let t=hw(e,this._firestore);return this._mutations=this._mutations.concat(new r2(t._key,rG.none())),this}commit(){return this._verifyNotCommitted(),this._committed=!0,this._mutations.length>0?this._commitHandler(this._mutations):Promise.resolve()}_verifyNotCommitted(){if(this._committed)throw new W(H.FAILED_PRECONDITION,"A write batch can no longer be used after commit() has been called.")}}function hw(e,t){if((e=(0,k.getModularInstance)(e)).firestore!==t)throw new W(H.INVALID_ARGUMENT,"Provided document reference is from a different Firestore instance.");return e}class hv{constructor(e,t){this._firestore=e,this._transaction=t,this._dataReader=ue(e)}get(e){let t=hw(e,this._firestore),n=new uX(this._firestore);return this._transaction.lookup([t._key]).then(e=>{if(!e||1!==e.length)return G(24041);let r=e[0];if(r.isFoundDocument())return new uS(this._firestore,n,r.key,r,t.converter);if(r.isNoDocument())return new uS(this._firestore,n,t._key,null,t.converter);throw G(18433,{doc:r})})}set(e,t,n){let r=hw(e,this._firestore),i=uY(r.converter,t,n),s=ut(this._dataReader,"Transaction.set",r._key,i,null!==r.converter,n);return this._transaction.set(r._key,s),this}update(e,t,n,...r){let i,s=hw(e,this._firestore);return i="string"==typeof(t=(0,k.getModularInstance)(t))||t instanceof l0?us(this._dataReader,"Transaction.update",s._key,t,n,r):ui(this._dataReader,"Transaction.update",s._key,t),this._transaction.update(s._key,i),this}delete(e){let t=hw(e,this._firestore);return this._transaction.delete(t._key),this}}class hb extends hv{constructor(e,t){super(e,t),this._firestore=e}get(e){let t=hw(e,this._firestore),n=new uy(this._firestore);return super.get(e).then(e=>new hh(this._firestore,n,t._key,e._document,new hu(!1,!1),t.converter))}}function hx(e,t,n){var r,i;let s;e=ex(e,lJ);let a={...hp,...n};if(a.maxAttempts<1)throw new W(H.INVALID_ARGUMENT,"Max attempts must be at least 1");return r=lY(e),i=n=>t(new hb(e,n)),s=new J,r.asyncQueue.enqueueAndForget(async()=>{let e=await lR(r);new lI(r.asyncQueue,e,a,i,s).ju()}),s.promise}function hT(e){e=ex(e,lB);let t=ex(e.firestore,lJ);return lO(lY(t),e._key).then(n=>hF(t,e,n))}function hI(e){var t;let n;e=ex(e,lB);let r=ex(e.firestore,lJ),i=lY(r),s=new uy(r);return(t=e._key,n=new J,i.asyncQueue.enqueueAndForget(async()=>(async function(e,t,n){try{let r=await e.persistence.runTransaction("read document","readonly",n=>e.localDocuments.getDocument(n,t));r.isFoundDocument()?n.resolve(r):r.isNoDocument()?n.resolve(null):n.reject(new W(H.UNAVAILABLE,"Failed to get document from cache. (However, this document may exist on the server. Run again without setting 'source' in the GetOptions to attempt to retrieve the document from the server.)"))}catch(r){let e=ox(r,`Failed to get document '${t} from cache`);n.reject(e)}})(await lD(i),t,n)),n.promise).then(t=>new hh(r,s,e._key,t,new hu(null!==t&&t.hasLocalMutations,!0),e.converter))}function hS(e){e=ex(e,lB);let t=ex(e.firestore,lJ);return lO(lY(t),e._key,{source:"server"}).then(n=>hF(t,e,n))}function hE(e){e=ex(e,lq);let t=ex(e.firestore,lJ),n=lY(t),r=new uy(t);return u_(e._query),lM(n,e._query).then(n=>new hf(t,r,e,n))}function h_(e){var t;let n;e=ex(e,lq);let r=ex(e.firestore,lJ),i=lY(r),s=new uy(r);return(t=e._query,n=new J,i.asyncQueue.enqueueAndForget(async()=>(async function(e,t,n){try{let r=await af(e,t,!0),i=new oU(t,r.ks),s=i.ru(r.documents),a=i.applyChanges(s,!1);n.resolve(a.snapshot)}catch(r){let e=ox(r,`Failed to execute query '${t} against cache`);n.reject(e)}})(await lD(i),t,n)),n.promise).then(t=>new hf(r,s,e,t))}function hC(e){e=ex(e,lq);let t=ex(e.firestore,lJ),n=lY(t),r=new uy(t);return lM(n,e._query,{source:"server"}).then(n=>new hf(t,r,e,n))}function hA(e,t,n){e=ex(e,lB);let r=ex(e.firestore,lJ),i=uY(e.converter,t,n),s=ue(r);return hM(r,[ut(s,"setDoc",e._key,i,null!==e.converter,n).toMutation(e._key,rG.none())])}function hN(e,t,n,...r){e=ex(e,lB);let i=ex(e.firestore,lJ),s=ue(i);return hM(i,[("string"==typeof(t=(0,k.getModularInstance)(t))||t instanceof l0?us(s,"updateDoc",e._key,t,n,r):ui(s,"updateDoc",e._key,t)).toMutation(e._key,rG.exists(!0))])}function hD(e){return hM(ex(e.firestore,lJ),[new r2(e._key,rG.none())])}function hk(e,t){let n=ex(e.firestore,lJ),r=l$(e),i=uY(e.converter,t);return hM(n,[ut(ue(e.firestore),"addDoc",r._key,i,null!==e.converter,{}).toMutation(r._key,rG.exists(!1))]).then(()=>r)}function hR(e,...t){var n;let r,i,s,a,o;e=(0,k.getModularInstance)(e);let l={includeMetadataChanges:!1,source:"default"},u=0;"object"!=typeof t[0]||ux(t[u])||(l=t[u++]);let h={includeMetadataChanges:l.includeMetadataChanges,source:l.source};if(ux(t[u])){let e=t[u];t[u]=e.next?.bind(e),t[u+1]=e.error?.bind(e),t[u+2]=e.complete?.bind(e)}if(e instanceof lB)i=ex(e.firestore,lJ),s=ro(e._key.path),r={next:n=>{t[u]&&t[u](hF(i,e,n))},error:t[u+1],complete:t[u+2]};else{let n=ex(e,lq);i=ex(n.firestore,lJ),s=n._query;let a=new uy(i);r={next:e=>{t[u]&&t[u](new hf(i,a,n,e))},error:t[u+1],complete:t[u+2]},u_(e._query)}return n=lY(i),o=new oP(s,a=new lv(r),h),n.asyncQueue.enqueueAndForget(async()=>oA(await lP(n),o)),()=>{a.Nu(),n.asyncQueue.enqueueAndForget(async()=>oN(await lP(n),o))}}function hP(e,t,...n){var r,i,s,a,o,l;let u=(0,k.getModularInstance)(e),h=function(e){let t={bundle:"",bundleName:"",bundleSource:""};for(let n of["bundle","bundleName","bundleSource"]){if(!(n in e)){t.error=`snapshotJson missing required field: ${n}`;break}let r=e[n];if("string"!=typeof r){t.error=`snapshotJson field '${n}' must be a string.`;break}if(0===r.length){t.error=`snapshotJson field '${n}' cannot be an empty string.`;break}"bundle"===n?t.bundle=r:"bundleName"===n?t.bundleName=r:"bundleSource"===n&&(t.bundleSource=r)}return t}(t);if(h.error)throw new W(H.INVALID_ARGUMENT,h.error);let c,d=0;if("object"!=typeof n[0]||ux(n[d])||(c=n[d++]),"QuerySnapshot"===h.bundleSource){let e,t,a=null;if("object"==typeof n[d]&&ux(n[d])){let e=n[d++];a={next:e.next,error:e.error,complete:e.complete}}else a={next:n[d++],error:n[d++],complete:n[d++]};return r=c,i=a,s=n[d],t=!1,lX(u,h.bundle).then(()=>{var e,t,n;return e=u,t=h.bundleName,(n=lY(e=ex(e,lJ)),n.asyncQueue.enqueue(async()=>{var e;return e=await lD(n),e.persistence.runTransaction("Get named query","readonly",n=>e.Pi.getNamedQuery(n,t))})).then(t=>t?new lq(e,null,t.query):null)}).then(n=>{n&&!t&&(s&&n.withConverter(s),e=hR(n,r||{},i))}).catch(e=>(i.error&&i.error(e),()=>{})),()=>{t||(t=!0,e&&e())}}if("DocumentSnapshot"===h.bundleSource){let e,t,r=null;if("object"==typeof n[d]&&ux(n[d])){let e=n[d++];r={next:e.next,error:e.error,complete:e.complete}}else r={next:n[d++],error:n[d++],complete:n[d++]};return a=c,o=r,l=n[d],t=!1,lX(u,h.bundle).then(()=>{t||(e=hR(new lB(u,l||null,eg.fromPath(h.bundleName)),a||{},o))}).catch(e=>(o.error&&o.error(e),()=>{})),()=>{t||(t=!0,e&&e())}}throw new W(H.INVALID_ARGUMENT,`unsupported bundle source: ${h.bundleSource}`)}function hO(e,t){let n,r=lY(e=ex(e,lJ));return n=new lv(ux(t)?t:{next:t}),r.asyncQueue.enqueueAndForget(async()=>{var e;return e=await lP(r),void(e.Ca.add(n),n.next())}),()=>{n.Nu(),r.asyncQueue.enqueueAndForget(async()=>{var e;return e=await lP(r),void e.Ca.delete(n)})}}function hM(e,t){var n;let r;return n=lY(e),r=new J,n.asyncQueue.enqueueAndForget(async()=>oY(await lk(n),t,r)),r.promise}function hF(e,t,n){let r=n.docs.get(t._key),i=new uy(e);return new hh(e,i,t._key,r,new hu(n.hasPendingWrites,n.fromCache),t.converter)}function hV(e){return lY(e=ex(e,lJ)),new hy(e,t=>hM(e,t))}function hL(e,t){let n=lY(e=ex(e,lJ));if(!n._uninitializedComponentsProvider||"memory"===n._uninitializedComponentsProvider._offline.kind)return z("Cannot enable indexes when persistence is disabled"),Promise.resolve();let r=function(e){let t="string"==typeof e?function(e){try{return JSON.parse(e)}catch(e){throw new W(H.INVALID_ARGUMENT,"Failed to parse JSON: "+e?.message)}}(e):e,n=[];if(Array.isArray(t.indexes))for(let e of t.indexes){let t=hj(e,"collectionGroup"),r=[];if(Array.isArray(e.fields))for(let t of e.fields){let e=uf("setIndexConfiguration",hj(t,"fieldPath"));"CONTAINS"===t.arrayConfig?r.push(new ek(e,2)):"ASCENDING"===t.order?r.push(new ek(e,0)):"DESCENDING"===t.order&&r.push(new ek(e,1))}n.push(new eC(eC.UNKNOWN_ID,t,r,eR.empty()))}return n}(t);return n.asyncQueue.enqueue(async()=>(async function(e,t){let n=e.indexManager,r=[];return e.persistence.runTransaction("Configure indexes","readwrite",e=>n.getFieldIndexes(e).next(i=>(function(e,t,n,r,i){t=[...t],(e=[...e]).sort(n),t.sort(n);let s=e.length,a=t.length,o=0,l=0;for(;o<a&&l<s;){let s=n(e[l],t[o]);s<0?i(e[l++]):s>0?r(t[o++]):(o++,l++)}for(;o<a;)r(t[o++]);for(;l<s;)i(e[l++])})(i,t,eD,t=>{r.push(n.addFieldIndex(e,t))},t=>{r.push(n.deleteFieldIndex(e,t))})).next(()=>eU.waitFor(r)))})(await lD(n),r))}function hj(e,t){if("string"!=typeof e[t])throw new W(H.INVALID_ARGUMENT,"Missing string value for: "+t);return e[t]}class hU{constructor(e){this._firestore=e,this.type="PersistentCacheIndexManager"}}function hq(e){e=ex(e,lJ);let t=hK.get(e);if(t)return t;let n=lY(e);if("persistent"!==n._uninitializedComponentsProvider?._offline.kind)return null;let r=new hU(e);return hK.set(e,r),r}function hB(e){hG(e,!0)}function hz(e){hG(e,!1)}function h$(e){var t;(t=lY(e._firestore)).asyncQueue.enqueue(async()=>{var e;let n;return n=(e=await lD(t)).indexManager,e.persistence.runTransaction("Delete All Indexes","readwrite",e=>n.deleteAllFieldIndexes(e))}).then(e=>q("deleting all persistent cache indexes succeeded")).catch(e=>z("deleting all persistent cache indexes failed",e))}function hG(e,t){var n;(n=lY(e._firestore),n.asyncQueue.enqueue(async()=>{var e;return e=await lD(n),void(e.Cs.As=t)})).then(e=>q(`setting persistent cache index auto creation isEnabled=${t} succeeded`)).catch(e=>z(`setting persistent cache index auto creation isEnabled=${t} failed`,e))}let hK=new WeakMap;class hQ{constructor(){throw Error("instances of this class should not be created")}static onExistenceFilterMismatch(e){return hH.instance.onExistenceFilterMismatch(e)}}class hH{constructor(){this.i=new Map}static get instance(){return hW||function(e){if(it)throw Error("a TestingHooksSpi instance is already set");it=e}(hW=new hH),hW}u(e){this.i.forEach(t=>t(e))}onExistenceFilterMismatch(e){let t=Symbol(),n=this.i;return n.set(t,e),()=>n.delete(t)}}let hW=null;!function(e=!0){L=C.SDK_VERSION,(0,C._registerComponent)(new A.Component("firestore",(t,{instanceIdentifier:n,options:r})=>{let i=t.getProvider("app").getImmediate(),s=new lJ(new ee(t.getProvider("auth-internal")),new ei(i,t.getProvider("app-check-internal")),function(e,t){if(!Object.prototype.hasOwnProperty.apply(e.options,["projectId"]))throw new W(H.INVALID_ARGUMENT,'"projectId" not provided in firebase.initializeApp.');return new nm(e.options.projectId,t)}(i,n),i);return r={useFetchStreams:e,...r},s._setSettings(r),s},"PUBLIC").setMultipleInstances(!0)),(0,C.registerVersion)(uv,ub,void 0),(0,C.registerVersion)(uv,ub,"esm2020")}(),e.s(["AggregateField",()=>uT,"AggregateQuerySnapshot",()=>uI,"DocumentSnapshot",()=>hh,"PersistentCacheIndexManager",()=>hU,"QueryCompositeFilterConstraint",()=>uR,"QueryConstraint",()=>uA,"QueryDocumentSnapshot",()=>hd,"QueryEndAtConstraint",()=>uz,"QueryFieldFilterConstraint",()=>uD,"QueryLimitConstraint",()=>uV,"QueryOrderByConstraint",()=>uM,"QuerySnapshot",()=>hf,"QueryStartAtConstraint",()=>uU,"SnapshotMetadata",()=>hu,"Transaction",()=>hb,"WriteBatch",()=>hy,"_TestingHooks",()=>hQ,"addDoc",()=>hk,"aggregateFieldEqual",()=>u2,"aggregateQuerySnapshotEqual",()=>u5,"and",()=>uO,"average",()=>u0,"count",()=>u1,"deleteAllPersistentCacheIndexes",()=>h$,"deleteDoc",()=>hD,"disablePersistentCacheIndexAutoCreation",()=>hz,"documentSnapshotFromJSON",()=>hc,"enablePersistentCacheIndexAutoCreation",()=>hB,"endAt",()=>uG,"endBefore",()=>u$,"executeWrite",()=>hM,"getAggregateFromServer",()=>u3,"getCountFromServer",()=>u4,"getDoc",()=>hT,"getDocFromCache",()=>hI,"getDocFromServer",()=>hS,"getDocs",()=>hE,"getDocsFromCache",()=>h_,"getDocsFromServer",()=>hC,"getPersistentCacheIndexManager",()=>hq,"limit",()=>uL,"limitToLast",()=>uj,"memoryEagerGarbageCollector",()=>he,"memoryLocalCache",()=>hn,"memoryLruGarbageCollector",()=>ht,"onSnapshot",()=>hR,"onSnapshotResume",()=>hP,"onSnapshotsInSync",()=>hO,"or",()=>uP,"orderBy",()=>uF,"persistentLocalCache",()=>hr,"persistentMultipleTabManager",()=>ho,"persistentSingleTabManager",()=>ha,"query",()=>uN,"querySnapshotFromJSON",()=>hm,"runTransaction",()=>hx,"setDoc",()=>hA,"setIndexConfiguration",()=>hL,"snapshotEqual",()=>hg,"startAfter",()=>uB,"startAt",()=>uq,"sum",()=>uZ,"updateDoc",()=>hN,"where",()=>uk,"writeBatch",()=>hV],63802),e.i(63802),e.i(14539);var hJ=e.i(76510);t=function(e,t){let n="object"==typeof e?e:(0,C.getApp)(),r=(0,C._getProvider)(n,"firestore").getImmediate({identifier:"string"==typeof e?e:nf});if(!r._initialized){let e=(0,k.getDefaultEmulatorHostnameAndPort)("firestore");e&&function(e,t,n,r={}){e=ex(e,lU);let i=(0,k.isCloudWorkstation)(t),s=e._getSettings(),a={...s,emulatorOptions:e._getEmulatorOptions()},o=`${t}:${n}`;i&&((0,k.pingServer)(`https://${o}`),(0,k.updateEmulatorBanner)("Firestore",!0)),s.host!==lL&&s.host!==o&&z("Host has been set in both settings() and connectFirestoreEmulator(), emulator host will be used.");let l={...s,host:o,ssl:i,emulatorOptions:r};if(!(0,k.deepEqual)(l,a)&&(e._setSettings(l),r.mockUserToken)){let t,n;if("string"==typeof r.mockUserToken)t=r.mockUserToken,n=V.MOCK_USER;else{t=(0,k.createMockUserToken)(r.mockUserToken,e._app?.options.projectId);let i=r.mockUserToken.sub||r.mockUserToken.user_id;if(!i)throw new W(H.INVALID_ARGUMENT,"mockUserToken must contain 'sub' or 'user_id' field!");n=new V(i)}e._authCredentials=new Z(new Y(t,n))}}(r,...e)}return r}(0===(0,hJ.getApps)().length?(0,hJ.initializeApp)({apiKey:"AIzaSyAZ4t2IgeCSBCA_7Di9HvE3KC1WzrsH3q0",authDomain:"web-cot-aya.firebaseapp.com",projectId:"web-cot-aya",storageBucket:"web-cot-aya.firebasestorage.app",messagingSenderId:"58467911514",appId:"1:58467911514:web:1c96e90359f42befac5563"}):(0,hJ.getApps)()[0]);let hY=(0,v.default)(()=>e.A(57481).then(e=>e.PDFViewer),{loadableGenerated:{modules:[96898]},ssr:!1,loading:()=>(0,p.jsx)("p",{children:"Cargando previsualizaciÃ³n..."})});function hX(){let e=(0,w.useParams)(),n=(0,w.useRouter)(),{id:r}=e,{user:i}=(0,S.useAuth)(),{quotation:s,activeUsers:a,loading:o,error:l,updateQuotation:u}=function(e){let[n,r]=(0,y.useState)(null),[i,s]=(0,y.useState)([]),[a,o]=(0,y.useState)(!0),[l,u]=(0,y.useState)(null),{user:h}=(0,S.useAuth)();return(0,y.useEffect)(()=>{let n,i;if(!e||!t)return;let a=hR(l$(t,"quotations",e),e=>{e.exists()?(r({id:e.id,...e.data()}),u(null)):u("Quotation not found"),o(!1)},e=>{console.error("Error listening to quotation:",e),u(e.message),o(!1)}),l=function(e,t,...n){if(e=(0,k.getModularInstance)(e),ep("collection","path",t),e instanceof lU){let r=ed.fromString(t,...n);return ew(r),new lz(e,null,r)}{if(!(e instanceof lB||e instanceof lz))throw new W(H.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");let r=e._path.child(ed.fromString(t,...n));return ew(r),new lz(e.firestore,null,r)}}(t,"quotations",e,"activeUsers"),c=hR(l,e=>{s(e.docs.map(e=>({id:e.id,...e.data()})))}),d=!1;return h&&hk(l,{uid:h.uid,displayName:h.displayName||h.email,firstName:h.firstName,photoURL:h.photoURL,email:h.email,joinedAt:uw(),lastSeen:uw()}).then(e=>{n=e,i=setInterval(()=>{n&&!d&&hA(n,{lastSeen:uw()},{merge:!0}).catch(e=>{"not-found"!==e.code&&console.error("Heartbeat error:",e)})},3e4)}).catch(e=>{console.error("Error adding user to active users:",e)}),()=>{d=!0,a(),c(),i&&clearInterval(i),n&&hD(n).catch(e=>{"not-found"!==e.code&&console.error("Error removing user:",e)})}},[e,h]),{quotation:n,activeUsers:i,loading:a,error:l,updateQuotation:async n=>{if(e&&t)try{let r=l$(t,"quotations",e);await hN(r,{...n,updatedAt:new Date().toISOString()})}catch(e){throw console.error("Error updating quotation:",e),e}}}}(r),[h,c]=(0,y.useState)({clientName:"",clientRuc:"",clientAddress:"",code:"",items:[{description:"Servicio Ejemplo",quantity:1,price:100}],globalProfitPercentage:"",globalOtherCosts:""}),[d,f]=(0,y.useState)(!1),[m,g]=(0,y.useState)(!1),[v,b]=(0,y.useState)([]),[x,T]=(0,y.useState)({}),C=(0,y.useRef)(!1),[A,N]=(0,y.useState)(h),D=(0,y.useRef)(null);(0,y.useEffect)(()=>{s&&(C.current=!0,c({...s,clientName:s.clientName||"",clientRuc:s.clientRuc||"",clientAddress:s.clientAddress||"",items:s.items&&s.items.length>0?s.items:[{description:"",quantity:1,price:0}],globalProfitPercentage:s.globalProfitPercentage||"",globalOtherCosts:s.globalOtherCosts||""}))},[s]),(0,y.useEffect)(()=>{a&&b(a)},[a]),(0,y.useEffect)(()=>(D.current&&clearTimeout(D.current),D.current=setTimeout(()=>{N(h)},1e3),()=>{D.current&&clearTimeout(D.current)}),[h]);let R=e=>{},P=e=>{},O=(e,t={})=>{let n=x[e];return n?{...t,borderColor:n.color||"#3b82f6",boxShadow:`0 0 0 2px ${n.color||"#3b82f6"}20`,transition:"all 0.2s",position:"relative"}:{...t,width:"100%",padding:"0.75rem",borderRadius:"6px",border:"1px solid #ccc"}},M=e=>{let t=x[e];return t?(0,p.jsx)("div",{style:{position:"absolute",top:"-18px",right:"0",background:t.color||"#3b82f6",color:"white",fontSize:"0.65rem",padding:"2px 6px",borderRadius:"4px 4px 0 0",zIndex:10},children:t.firstName}):null},F=async(e,t)=>{if(c({...h,[e]:t}),r&&u)try{g(!0),await u({[e]:t}),g(!1)}catch(e){console.error("Error updating quotation:",e),g(!1)}},V=async e=>{let t=h.clientProfiles?.find(t=>t.id===parseInt(e)),n={...h,clientProfileId:e?parseInt(e):null,clientName:t&&t.name||"",clientRuc:t&&t.ruc||"",clientAddress:t&&t.address||""};if(c(n),r&&u)try{await u({clientProfileId:n.clientProfileId,clientName:n.clientName,clientRuc:n.clientRuc,clientAddress:n.clientAddress})}catch(e){console.error("Error updating client profile:",e)}},L=async(e,t,n)=>{let i=[...h.items];if(i[e][t]=n,c({...h,items:i}),r&&u)try{g(!0),await u({items:i}),g(!1)}catch(e){console.error("Error updating items:",e),g(!1)}},j=async()=>{let e=[...h.items,{description:"",quantity:1,price:0}];if(c({...h,items:e}),r&&u)try{await u({items:e})}catch(e){console.error("Error adding item:",e)}},U=async()=>{f(!0);try{u&&await u(h),f(!1)}catch(e){console.error(e),f(!1)}};h.items&&h.items.reduce((e,t)=>e+t.quantity*t.price,0),h.companyProfiles?.find(e=>e.id===h.companyProfileId)||h.companyProfiles?.find(e=>e.isDefault);let q=A.items?A.items.reduce((e,t)=>e+t.quantity*t.price,0):0,B=A.companyProfiles?.find(e=>e.id===A.companyProfileId)||A.companyProfiles?.find(e=>e.isDefault)||{},z={...A,total:q,company:B,notes:void 0!==A.notes?A.notes:A.generalConditions?.text||""};return(0,p.jsxs)(E.ProtectedRoute,{children:[(0,p.jsx)(_,{activeUsers:v}),(0,p.jsxs)("div",{style:{display:"flex",height:"100vh",overflow:"hidden",marginLeft:"80px"},children:[(0,p.jsxs)("div",{style:{width:"50%",padding:"2rem",overflowY:"auto",borderRight:"1px solid #e2e8f0",backgroundColor:"#f8fafc"},children:[(0,p.jsxs)("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"2rem"},children:[(0,p.jsx)("h1",{style:{color:"#1e293b"},children:"Editor de CotizaciÃ³n"}),(0,p.jsxs)("div",{style:{display:"flex",gap:"15px",alignItems:"center"},children:[(0,p.jsx)("button",{className:"btn",style:{background:"#64748b",color:"white"},onClick:()=>n.push("/"),children:"â† MenÃº Principal"}),(0,p.jsxs)("span",{style:{fontSize:"0.8rem",color:m?"#f59e0b":"#22c55e",display:"flex",alignItems:"center",gap:"4px"},children:[(0,p.jsx)("span",{style:{width:"8px",height:"8px",borderRadius:"50%",background:m?"#f59e0b":"#22c55e"}}),m?"Guardando...":"Guardado"]}),(0,p.jsx)("button",{className:"btn btn-primary",onClick:U,disabled:d,children:d?"Guardando...":"Guardar Cambios"})]})]}),(0,p.jsxs)("div",{className:"card-editor",style:{marginBottom:"1.5rem",position:"relative"},children:[(0,p.jsx)("label",{style:{display:"block",fontWeight:"bold",marginBottom:"0.5rem",color:"#1e293b"},children:"Empresa Emisora"}),M("companyProfileId"),(0,p.jsxs)("select",{value:h.companyProfileId||"",onChange:e=>F("companyProfileId",parseInt(e.target.value)),onFocus:()=>R("companyProfileId"),onBlur:()=>P("companyProfileId"),style:O("companyProfileId"),children:[(0,p.jsx)("option",{value:"",children:"Seleccionar Empresa..."}),h.companyProfiles&&h.companyProfiles.map(e=>(0,p.jsxs)("option",{value:e.id,children:[e.name," ",e.isDefault?"(Predeterminada)":""]},e.id))]})]}),(0,p.jsxs)("div",{className:"card-editor",style:{marginBottom:"1.5rem",position:"relative"},children:[(0,p.jsx)("label",{style:{display:"block",fontWeight:"bold",marginBottom:"0.5rem",color:"#1e293b"},children:"Perfil de Cliente"}),M("clientProfileId"),(0,p.jsxs)("select",{value:h.clientProfileId||"",onChange:e=>V(e.target.value),onFocus:()=>R("clientProfileId"),onBlur:()=>P("clientProfileId"),style:O("clientProfileId"),children:[(0,p.jsx)("option",{value:"",children:"Seleccionar Cliente..."}),h.clientProfiles&&h.clientProfiles.map(e=>(0,p.jsxs)("option",{value:e.id,children:[e.name," ",e.isDefault?"(Predeterminado)":""]},e.id))]})]}),(0,p.jsx)("div",{className:"card-editor",style:{marginBottom:"2rem"},children:(0,p.jsxs)("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr 1fr",gap:"1rem"},children:[(0,p.jsxs)("div",{style:{position:"relative"},children:[(0,p.jsx)("label",{style:{display:"block",fontWeight:"bold",marginBottom:"0.5rem",color:"#1e293b"},children:"Nombre de Cliente"}),M("clientName"),(0,p.jsx)("input",{type:"text",value:h.clientName||"",onChange:e=>F("clientName",e.target.value),onFocus:()=>R("clientName"),onBlur:()=>P("clientName"),style:O("clientName"),placeholder:"Juan PÃ©rez"})]}),(0,p.jsxs)("div",{style:{position:"relative"},children:[(0,p.jsx)("label",{style:{display:"block",fontWeight:"bold",marginBottom:"0.5rem",color:"#1e293b"},children:"RUC"}),M("clientRuc"),(0,p.jsx)("input",{type:"text",value:h.clientRuc||"",onChange:e=>F("clientRuc",e.target.value),onFocus:()=>R("clientRuc"),onBlur:()=>P("clientRuc"),style:O("clientRuc"),placeholder:"12345678901"})]}),(0,p.jsxs)("div",{style:{position:"relative"},children:[(0,p.jsx)("label",{style:{display:"block",fontWeight:"bold",marginBottom:"0.5rem",color:"#1e293b"},children:"DirecciÃ³n"}),M("clientAddress"),(0,p.jsx)("input",{type:"text",value:h.clientAddress||"",onChange:e=>F("clientAddress",e.target.value),onFocus:()=>R("clientAddress"),onBlur:()=>P("clientAddress"),style:O("clientAddress"),placeholder:"Calle Falsa 123"})]}),(0,p.jsxs)("div",{style:{gridColumn:"span 3",marginTop:"1rem",position:"relative"},children:[(0,p.jsx)("label",{style:{display:"block",fontWeight:"bold",marginBottom:"0.5rem",color:"#1e293b"},children:"2. DescripciÃ³n del Servicio o Producto"}),M("serviceDescription"),(0,p.jsx)("textarea",{value:h.serviceDescription||"",onChange:e=>F("serviceDescription",e.target.value),onFocus:()=>R("serviceDescription"),onBlur:()=>P("serviceDescription"),style:O("serviceDescription",{minHeight:"80px"}),placeholder:"Describa brevemente el servicio o producto a cotizar..."})]})]})}),(0,p.jsx)("h3",{style:{color:"#1e293b"},children:"ConfiguraciÃ³n Global de Precios (Interno)"}),(0,p.jsxs)("div",{className:"card-editor",style:{marginBottom:"2rem",backgroundColor:"#fff",border:"1px solid #e2e8f0"},children:[(0,p.jsxs)("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr 1fr",gap:"1rem",alignItems:"flex-end"},children:[(0,p.jsxs)("div",{style:{position:"relative"},children:[(0,p.jsx)("label",{style:{display:"block",fontSize:"0.8rem",fontWeight:"bold",marginBottom:"0.5rem",color:"#1e293b"},children:"% Ganancia Global"}),M("globalProfitPercentage"),(0,p.jsx)("input",{type:"number",value:h.globalProfitPercentage||"",onChange:e=>F("globalProfitPercentage",e.target.value),onFocus:()=>R("globalProfitPercentage"),onBlur:()=>P("globalProfitPercentage"),style:O("globalProfitPercentage"),placeholder:"0"})]}),(0,p.jsxs)("div",{style:{position:"relative"},children:[(0,p.jsx)("label",{style:{display:"block",fontSize:"0.8rem",fontWeight:"bold",marginBottom:"0.5rem",color:"#1e293b"},children:"% Otros Global"}),M("globalOtherCosts"),(0,p.jsx)("input",{type:"number",value:h.globalOtherCosts||"",onChange:e=>F("globalOtherCosts",e.target.value),onFocus:()=>R("globalOtherCosts"),onBlur:()=>P("globalOtherCosts"),style:O("globalOtherCosts"),placeholder:"0"})]}),(0,p.jsx)("button",{className:"btn",style:{background:"#334155",color:"white",padding:"0.75rem"},onClick:()=>{let e=parseFloat(h.globalProfitPercentage||0),t=parseFloat(h.globalOtherCosts||0);F("items",h.items.map(n=>{let r=parseFloat(n.basePrice||0);return{...n,profitPercentage:h.globalProfitPercentage,otherCosts:h.globalOtherCosts,price:(r*(1+(e+t)/100)).toFixed(2)}}))},children:"Aplicar a todos los Ã­tems"})]}),(0,p.jsx)("p",{style:{fontSize:"0.7rem",color:"#64748b",marginTop:"0.75rem"},children:"* Esto actualizarÃ¡ los porcentajes y recalcularÃ¡ el Precio U. de cada Ã­tem basado en su Costo Base."})]}),(0,p.jsx)("h3",{style:{color:"#1e293b"},children:"Ãtems"}),h.items&&h.items.map((e,t)=>(0,p.jsx)("div",{className:"card-editor",style:{marginBottom:"1rem",padding:"1.25rem"},children:(0,p.jsxs)("div",{style:{display:"grid",gridTemplateColumns:"2fr 1fr 1fr 1fr 1fr",gap:"0.75rem",marginBottom:"0.75rem"},children:[(0,p.jsxs)("div",{style:{gridColumn:"span 5",position:"relative"},children:[M(`item_${t}_description`),(0,p.jsx)("input",{placeholder:"DescripciÃ³n del Ã­tem",style:O(`item_${t}_description`,{width:"100%",padding:"0.5rem",borderRadius:"4px",border:"1px solid #ccc"}),value:e.description,onChange:e=>L(t,"description",e.target.value),onFocus:()=>R(`item_${t}_description`),onBlur:()=>P(`item_${t}_description`)})]}),(0,p.jsxs)("div",{style:{position:"relative"},children:[(0,p.jsx)("label",{style:{fontSize:"0.7rem",color:"#334155",display:"block",fontWeight:"bold"},children:"Cant."}),M(`item_${t}_quantity`),(0,p.jsx)("input",{type:"number",style:O(`item_${t}_quantity`,{width:"100%",padding:"0.5rem",borderRadius:"4px",border:"1px solid #ccc"}),value:e.quantity,onChange:e=>L(t,"quantity",e.target.value),onFocus:()=>R(`item_${t}_quantity`),onBlur:()=>P(`item_${t}_quantity`)})]}),(0,p.jsxs)("div",{style:{position:"relative"},children:[(0,p.jsx)("label",{style:{fontSize:"0.7rem",color:"#334155",display:"block",fontWeight:"bold"},children:"Costo Base"}),M(`item_${t}_basePrice`),(0,p.jsx)("input",{type:"number",placeholder:"0.00",style:O(`item_${t}_basePrice`,{width:"100%",padding:"0.5rem",borderRadius:"4px",border:"1px solid #ccc"}),value:e.basePrice||"",onChange:n=>{let r=parseFloat(n.target.value)||0,i=parseFloat(e.profitPercentage)||0,s=parseFloat(e.otherCosts)||0;L(t,"basePrice",n.target.value),L(t,"price",(r*(1+(i+s)/100)).toFixed(2))},onFocus:()=>R(`item_${t}_basePrice`),onBlur:()=>P(`item_${t}_basePrice`)})]}),(0,p.jsxs)("div",{style:{position:"relative"},children:[(0,p.jsx)("label",{style:{fontSize:"0.7rem",color:"#334155",display:"block",fontWeight:"bold"},children:"% Gan."}),M(`item_${t}_profitPercentage`),(0,p.jsx)("input",{type:"number",placeholder:"0",style:O(`item_${t}_profitPercentage`,{width:"100%",padding:"0.5rem",borderRadius:"4px",border:"1px solid #ccc"}),value:e.profitPercentage||"",onChange:n=>{let r=parseFloat(n.target.value)||0,i=parseFloat(e.basePrice||0),s=parseFloat(e.otherCosts||0);L(t,"profitPercentage",n.target.value),L(t,"price",(i*(1+(r+s)/100)).toFixed(2))},onFocus:()=>R(`item_${t}_profitPercentage`),onBlur:()=>P(`item_${t}_profitPercentage`)})]}),(0,p.jsxs)("div",{style:{position:"relative"},children:[(0,p.jsx)("label",{style:{fontSize:"0.7rem",color:"#334155",display:"block",fontWeight:"bold"},children:"% Otros"}),M(`item_${t}_otherCosts`),(0,p.jsx)("input",{type:"number",placeholder:"0",style:O(`item_${t}_otherCosts`,{width:"100%",padding:"0.5rem",borderRadius:"4px",border:"1px solid #ccc"}),value:e.otherCosts||"",onChange:n=>{let r=parseFloat(e.profitPercentage||0),i=parseFloat(e.basePrice||0),s=parseFloat(n.target.value)||0;L(t,"otherCosts",n.target.value),L(t,"price",(i*(1+(r+s)/100)).toFixed(2))},onFocus:()=>R(`item_${t}_otherCosts`),onBlur:()=>P(`item_${t}_otherCosts`)})]}),(0,p.jsxs)("div",{style:{position:"relative"},children:[(0,p.jsx)("label",{style:{fontSize:"0.7rem",color:"#334155",display:"block",fontWeight:"bold"},children:"Precio U."}),M(`item_${t}_price`),(0,p.jsx)("input",{type:"number",step:"0.01",style:O(`item_${t}_price`,{width:"100%",padding:"0.5rem",borderRadius:"4px",border:"1px solid #22c55e",backgroundColor:"#f0fdf4"}),value:e.price,onChange:e=>L(t,"price",e.target.value),onFocus:()=>R(`item_${t}_price`),onBlur:()=>P(`item_${t}_price`)})]})]})},t)),(0,p.jsx)("button",{onClick:j,className:"btn",style:{background:"#e5e7eb",color:"#374151",marginBottom:"2rem"},children:"+ Agregar Ãtem"}),(0,p.jsx)("h3",{style:{color:"#1e293b"},children:"Notas / Condiciones"}),(0,p.jsxs)("div",{className:"card-editor",style:{position:"relative"},children:[M("notes"),(0,p.jsx)("textarea",{value:void 0!==h.notes?h.notes:h.generalConditions?.text||"",onChange:e=>F("notes",e.target.value),onFocus:()=>R("notes"),onBlur:()=>P("notes"),rows:6,style:O("notes",{width:"100%",padding:"0.75rem",borderRadius:"6px",border:"1px solid #ccc",fontFamily:"inherit"}),placeholder:"Notas adicionales para esta cotizaciÃ³n..."})]})]}),(0,p.jsx)("div",{style:{width:"50%",backgroundColor:"#525659",display:"flex",justifyContent:"center",alignItems:"center"},children:(0,p.jsx)(hY,{width:"100%",height:"100%",style:{border:"none"},showToolbar:!0,children:(0,p.jsx)(I,{data:z})})})]})]})}e.s(["default",()=>hX],54995)}]);